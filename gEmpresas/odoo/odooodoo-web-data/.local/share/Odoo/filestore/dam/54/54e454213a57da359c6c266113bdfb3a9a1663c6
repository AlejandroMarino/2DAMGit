
/* /point_of_sale/static/lib/html2canvas.js defined in bundle 'point_of_sale.assets' */
(function(window,document,undefined){"use strict";var _html2canvas={},previousElement,computedCSS,html2canvas;_html2canvas.Util={};_html2canvas.Util.log=function(a){if(_html2canvas.logging&&window.console&&window.console.log){window.console.log(a);}};_html2canvas.Util.trimText=(function(isNative){return function(input){return isNative?isNative.apply(input):((input||'')+'').replace(/^\s+|\s+$/g,'');};})(String.prototype.trim);_html2canvas.Util.asFloat=function(v){return parseFloat(v);};(function(){var TEXT_SHADOW_PROPERTY=/((rgba|rgb)\([^\)]+\)(\s-?\d+px){0,})/g;var TEXT_SHADOW_VALUES=/(-?\d+px)|(#.+)|(rgb\(.+\))|(rgba\(.+\))/g;_html2canvas.Util.parseTextShadows=function(value){if(!value||value==='none'){return[];}
var shadows=value.match(TEXT_SHADOW_PROPERTY),results=[];for(var i=0;shadows&&(i<shadows.length);i++){var s=shadows[i].match(TEXT_SHADOW_VALUES);results.push({color:s[0],offsetX:s[1]?s[1].replace('px',''):0,offsetY:s[2]?s[2].replace('px',''):0,blur:s[3]?s[3].replace('px',''):0});}
return results;};})();_html2canvas.Util.parseBackgroundImage=function(value){var whitespace=' \r\n\t',method,definition,prefix,prefix_i,block,results=[],c,mode=0,numParen=0,quote,args;var appendResult=function(){if(method){if(definition.substr(0,1)==='"'){definition=definition.substr(1,definition.length-2);}
if(definition){args.push(definition);}
if(method.substr(0,1)==='-'&&(prefix_i=method.indexOf('-',1)+1)>0){prefix=method.substr(0,prefix_i);method=method.substr(prefix_i);}
results.push({prefix:prefix,method:method.toLowerCase(),value:block,args:args});}
args=[];method=prefix=definition=block='';};appendResult();for(var i=0,ii=value.length;i<ii;i++){c=value[i];if(mode===0&&whitespace.indexOf(c)>-1){continue;}
switch(c){case'"':if(!quote){quote=c;}
else if(quote===c){quote=null;}
break;case'(':if(quote){break;}
else if(mode===0){mode=1;block+=c;continue;}else{numParen++;}
break;case')':if(quote){break;}
else if(mode===1){if(numParen===0){mode=0;block+=c;appendResult();continue;}else{numParen--;}}
break;case',':if(quote){break;}
else if(mode===0){appendResult();continue;}
else if(mode===1){if(numParen===0&&!method.match(/^url$/i)){args.push(definition);definition='';block+=c;continue;}}
break;}
block+=c;if(mode===0){method+=c;}
else{definition+=c;}}
appendResult();return results;};_html2canvas.Util.Bounds=function(element){var clientRect,bounds={};if(element.getBoundingClientRect){clientRect=element.getBoundingClientRect();bounds.top=clientRect.top;bounds.bottom=clientRect.bottom||(clientRect.top+clientRect.height);bounds.left=clientRect.left;bounds.width=element.offsetWidth;bounds.height=element.offsetHeight;}
return bounds;};_html2canvas.Util.OffsetBounds=function(element){var parent=element.offsetParent?_html2canvas.Util.OffsetBounds(element.offsetParent):{top:0,left:0};return{top:element.offsetTop+parent.top,bottom:element.offsetTop+element.offsetHeight+parent.top,left:element.offsetLeft+parent.left,width:element.offsetWidth,height:element.offsetHeight};};function toPX(element,attribute,value){var rsLeft=element.runtimeStyle&&element.runtimeStyle[attribute],left,style=element.style;if(!/^-?[0-9]+\.?[0-9]*(?:px)?$/i.test(value)&&/^-?\d/.test(value)){left=style.left;if(rsLeft){element.runtimeStyle.left=element.currentStyle.left;}
style.left=attribute==="fontSize"?"1em":(value||0);value=style.pixelLeft+"px";style.left=left;if(rsLeft){element.runtimeStyle.left=rsLeft;}}
if(!/^(thin|medium|thick)$/i.test(value)){return Math.round(parseFloat(value))+"px";}
return value;}
function asInt(val){return parseInt(val,10);}
function parseBackgroundSizePosition(value,element,attribute,index){value=(value||'').split(',');value=value[index||0]||value[0]||'auto';value=_html2canvas.Util.trimText(value).split(' ');if(attribute==='backgroundSize'&&(!value[0]||value[0].match(/cover|contain|auto/))){}else{value[0]=(value[0].indexOf("%")===-1)?toPX(element,attribute+"X",value[0]):value[0];if(value[1]===undefined){if(attribute==='backgroundSize'){value[1]='auto';return value;}else{value[1]=value[0];}}
value[1]=(value[1].indexOf("%")===-1)?toPX(element,attribute+"Y",value[1]):value[1];}
return value;}
_html2canvas.Util.getCSS=function(element,attribute,index){if(previousElement!==element){computedCSS=document.defaultView.getComputedStyle(element,null);}
var value=computedCSS[attribute];if(/^background(Size|Position)$/.test(attribute)){return parseBackgroundSizePosition(value,element,attribute,index);}else if(/border(Top|Bottom)(Left|Right)Radius/.test(attribute)){var arr=value.split(" ");if(arr.length<=1){arr[1]=arr[0];}
return arr.map(asInt);}
return value;};_html2canvas.Util.resizeBounds=function(current_width,current_height,target_width,target_height,stretch_mode){var target_ratio=target_width/target_height,current_ratio=current_width/current_height,output_width,output_height;if(!stretch_mode||stretch_mode==='auto'){output_width=target_width;output_height=target_height;}else if(target_ratio<current_ratio^stretch_mode==='contain'){output_height=target_height;output_width=target_height*current_ratio;}else{output_width=target_width;output_height=target_width/current_ratio;}
return{width:output_width,height:output_height};};function backgroundBoundsFactory(prop,el,bounds,image,imageIndex,backgroundSize){var bgposition=_html2canvas.Util.getCSS(el,prop,imageIndex),topPos,left,percentage,val;if(bgposition.length===1){val=bgposition[0];bgposition=[];bgposition[0]=val;bgposition[1]=val;}
if(bgposition[0].toString().indexOf("%")!==-1){percentage=(parseFloat(bgposition[0])/100);left=bounds.width*percentage;if(prop!=='backgroundSize'){left-=(backgroundSize||image).width*percentage;}}else{if(prop==='backgroundSize'){if(bgposition[0]==='auto'){left=image.width;}else{if(/contain|cover/.test(bgposition[0])){var resized=_html2canvas.Util.resizeBounds(image.width,image.height,bounds.width,bounds.height,bgposition[0]);left=resized.width;topPos=resized.height;}else{left=parseInt(bgposition[0],10);}}}else{left=parseInt(bgposition[0],10);}}
if(bgposition[1]==='auto'){topPos=left/image.width*image.height;}else if(bgposition[1].toString().indexOf("%")!==-1){percentage=(parseFloat(bgposition[1])/100);topPos=bounds.height*percentage;if(prop!=='backgroundSize'){topPos-=(backgroundSize||image).height*percentage;}}else{topPos=parseInt(bgposition[1],10);}
return[left,topPos];}
_html2canvas.Util.BackgroundPosition=function(el,bounds,image,imageIndex,backgroundSize){var result=backgroundBoundsFactory('backgroundPosition',el,bounds,image,imageIndex,backgroundSize);return{left:result[0],top:result[1]};};_html2canvas.Util.BackgroundSize=function(el,bounds,image,imageIndex){var result=backgroundBoundsFactory('backgroundSize',el,bounds,image,imageIndex);return{width:result[0],height:result[1]};};_html2canvas.Util.Extend=function(options,defaults){for(var key in options){if(options.hasOwnProperty(key)){defaults[key]=options[key];}}
return defaults;};_html2canvas.Util.Children=function(elem){var children;try{children=(elem.nodeName&&elem.nodeName.toUpperCase()==="IFRAME")?elem.contentDocument||elem.contentWindow.document:(function(array){var ret=[];if(array!==null){(function(first,second){var i=first.length,j=0;if(typeof second.length==="number"){for(var l=second.length;j<l;j++){first[i++]=second[j];}}else{while(second[j]!==undefined){first[i++]=second[j++];}}
first.length=i;return first;})(ret,array);}
return ret;})(elem.childNodes);}catch(ex){_html2canvas.Util.log("html2canvas.Util.Children failed with exception: "+ex.message);children=[];}
return children;};_html2canvas.Util.isTransparent=function(backgroundColor){return(backgroundColor==="transparent"||backgroundColor==="rgba(0, 0, 0, 0)"||backgroundColor===undefined);};_html2canvas.Util.Font=(function(){var fontData={};return function(font,fontSize,doc){if(fontData[font+"-"+fontSize]!==undefined){return fontData[font+"-"+fontSize];}
var container=doc.createElement('div'),img=doc.createElement('img'),span=doc.createElement('span'),sampleText='Hidden Text',baseline,middle,metricsObj;container.style.visibility="hidden";container.style.fontFamily=font;container.style.fontSize=fontSize;container.style.margin=0;container.style.padding=0;doc.body.appendChild(container);img.src="data:image/gif;base64,R0lGODlhAQABAIABAP///wAAACwAAAAAAQABAAACAkQBADs=";img.width=1;img.height=1;img.style.margin=0;img.style.padding=0;img.style.verticalAlign="baseline";span.style.fontFamily=font;span.style.fontSize=fontSize;span.style.margin=0;span.style.padding=0;span.appendChild(doc.createTextNode(sampleText));container.appendChild(span);container.appendChild(img);baseline=(img.offsetTop-span.offsetTop)+1;container.removeChild(span);container.appendChild(doc.createTextNode(sampleText));container.style.lineHeight="normal";img.style.verticalAlign="super";middle=(img.offsetTop-container.offsetTop)+1;metricsObj={baseline:baseline,lineWidth:1,middle:middle};fontData[font+"-"+fontSize]=metricsObj;doc.body.removeChild(container);return metricsObj;};})();(function(){var Util=_html2canvas.Util,Generate={};_html2canvas.Generate=Generate;var reGradients=[/^(-webkit-linear-gradient)\(([a-z\s]+)([\w\d\.\s,%\(\)]+)\)$/,/^(-o-linear-gradient)\(([a-z\s]+)([\w\d\.\s,%\(\)]+)\)$/,/^(-webkit-gradient)\((linear|radial),\s((?:\d{1,3}%?)\s(?:\d{1,3}%?),\s(?:\d{1,3}%?)\s(?:\d{1,3}%?))([\w\d\.\s,%\(\)\-]+)\)$/,/^(-moz-linear-gradient)\(((?:\d{1,3}%?)\s(?:\d{1,3}%?))([\w\d\.\s,%\(\)]+)\)$/,/^(-webkit-radial-gradient)\(((?:\d{1,3}%?)\s(?:\d{1,3}%?)),\s(\w+)\s([a-z\-]+)([\w\d\.\s,%\(\)]+)\)$/,/^(-moz-radial-gradient)\(((?:\d{1,3}%?)\s(?:\d{1,3}%?)),\s(\w+)\s?([a-z\-]*)([\w\d\.\s,%\(\)]+)\)$/,/^(-o-radial-gradient)\(((?:\d{1,3}%?)\s(?:\d{1,3}%?)),\s(\w+)\s([a-z\-]+)([\w\d\.\s,%\(\)]+)\)$/];Generate.parseGradient=function(css,bounds){var gradient,i,len=reGradients.length,m1,stop,m2,m2Len,step,m3,tl,tr,br,bl;for(i=0;i<len;i+=1){m1=css.match(reGradients[i]);if(m1){break;}}
if(m1){switch(m1[1]){case'-webkit-linear-gradient':case'-o-linear-gradient':gradient={type:'linear',x0:null,y0:null,x1:null,y1:null,colorStops:[]};m2=m1[2].match(/\w+/g);if(m2){m2Len=m2.length;for(i=0;i<m2Len;i+=1){switch(m2[i]){case'top':gradient.y0=0;gradient.y1=bounds.height;break;case'right':gradient.x0=bounds.width;gradient.x1=0;break;case'bottom':gradient.y0=bounds.height;gradient.y1=0;break;case'left':gradient.x0=0;gradient.x1=bounds.width;break;}}}
if(gradient.x0===null&&gradient.x1===null){gradient.x0=gradient.x1=bounds.width/2;}
if(gradient.y0===null&&gradient.y1===null){gradient.y0=gradient.y1=bounds.height/2;}
m2=m1[3].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\)(?:\s\d{1,3}(?:%|px))?)+/g);if(m2){m2Len=m2.length;step=1/Math.max(m2Len-1,1);for(i=0;i<m2Len;i+=1){m3=m2[i].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\s*(\d{1,3})?(%|px)?/);if(m3[2]){stop=parseFloat(m3[2]);if(m3[3]==='%'){stop/=100;}else{stop/=bounds.width;}}else{stop=i*step;}
gradient.colorStops.push({color:m3[1],stop:stop});}}
break;case'-webkit-gradient':gradient={type:m1[2]==='radial'?'circle':m1[2],x0:0,y0:0,x1:0,y1:0,colorStops:[]};m2=m1[3].match(/(\d{1,3})%?\s(\d{1,3})%?,\s(\d{1,3})%?\s(\d{1,3})%?/);if(m2){gradient.x0=(m2[1]*bounds.width)/100;gradient.y0=(m2[2]*bounds.height)/100;gradient.x1=(m2[3]*bounds.width)/100;gradient.y1=(m2[4]*bounds.height)/100;}
m2=m1[4].match(/((?:from|to|color-stop)\((?:[0-9\.]+,\s)?(?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\)\))+/g);if(m2){m2Len=m2.length;for(i=0;i<m2Len;i+=1){m3=m2[i].match(/(from|to|color-stop)\(([0-9\.]+)?(?:,\s)?((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\)/);stop=parseFloat(m3[2]);if(m3[1]==='from'){stop=0.0;}
if(m3[1]==='to'){stop=1.0;}
gradient.colorStops.push({color:m3[3],stop:stop});}}
break;case'-moz-linear-gradient':gradient={type:'linear',x0:0,y0:0,x1:0,y1:0,colorStops:[]};m2=m1[2].match(/(\d{1,3})%?\s(\d{1,3})%?/);if(m2){gradient.x0=(m2[1]*bounds.width)/100;gradient.y0=(m2[2]*bounds.height)/100;gradient.x1=bounds.width-gradient.x0;gradient.y1=bounds.height-gradient.y0;}
m2=m1[3].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\)(?:\s\d{1,3}%)?)+/g);if(m2){m2Len=m2.length;step=1/Math.max(m2Len-1,1);for(i=0;i<m2Len;i+=1){m3=m2[i].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\s*(\d{1,3})?(%)?/);if(m3[2]){stop=parseFloat(m3[2]);if(m3[3]){stop/=100;}}else{stop=i*step;}
gradient.colorStops.push({color:m3[1],stop:stop});}}
break;case'-webkit-radial-gradient':case'-moz-radial-gradient':case'-o-radial-gradient':gradient={type:'circle',x0:0,y0:0,x1:bounds.width,y1:bounds.height,cx:0,cy:0,rx:0,ry:0,colorStops:[]};m2=m1[2].match(/(\d{1,3})%?\s(\d{1,3})%?/);if(m2){gradient.cx=(m2[1]*bounds.width)/100;gradient.cy=(m2[2]*bounds.height)/100;}
m2=m1[3].match(/\w+/);m3=m1[4].match(/[a-z\-]*/);if(m2&&m3){switch(m3[0]){case'farthest-corner':case'cover':case'':tl=Math.sqrt(Math.pow(gradient.cx,2)+Math.pow(gradient.cy,2));tr=Math.sqrt(Math.pow(gradient.cx,2)+Math.pow(gradient.y1-gradient.cy,2));br=Math.sqrt(Math.pow(gradient.x1-gradient.cx,2)+Math.pow(gradient.y1-gradient.cy,2));bl=Math.sqrt(Math.pow(gradient.x1-gradient.cx,2)+Math.pow(gradient.cy,2));gradient.rx=gradient.ry=Math.max(tl,tr,br,bl);break;case'closest-corner':tl=Math.sqrt(Math.pow(gradient.cx,2)+Math.pow(gradient.cy,2));tr=Math.sqrt(Math.pow(gradient.cx,2)+Math.pow(gradient.y1-gradient.cy,2));br=Math.sqrt(Math.pow(gradient.x1-gradient.cx,2)+Math.pow(gradient.y1-gradient.cy,2));bl=Math.sqrt(Math.pow(gradient.x1-gradient.cx,2)+Math.pow(gradient.cy,2));gradient.rx=gradient.ry=Math.min(tl,tr,br,bl);break;case'farthest-side':if(m2[0]==='circle'){gradient.rx=gradient.ry=Math.max(gradient.cx,gradient.cy,gradient.x1-gradient.cx,gradient.y1-gradient.cy);}else{gradient.type=m2[0];gradient.rx=Math.max(gradient.cx,gradient.x1-gradient.cx);gradient.ry=Math.max(gradient.cy,gradient.y1-gradient.cy);}
break;case'closest-side':case'contain':if(m2[0]==='circle'){gradient.rx=gradient.ry=Math.min(gradient.cx,gradient.cy,gradient.x1-gradient.cx,gradient.y1-gradient.cy);}else{gradient.type=m2[0];gradient.rx=Math.min(gradient.cx,gradient.x1-gradient.cx);gradient.ry=Math.min(gradient.cy,gradient.y1-gradient.cy);}
break;}}
m2=m1[5].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\)(?:\s\d{1,3}(?:%|px))?)+/g);if(m2){m2Len=m2.length;step=1/Math.max(m2Len-1,1);for(i=0;i<m2Len;i+=1){m3=m2[i].match(/((?:rgb|rgba)\(\d{1,3},\s\d{1,3},\s\d{1,3}(?:,\s[0-9\.]+)?\))\s*(\d{1,3})?(%|px)?/);if(m3[2]){stop=parseFloat(m3[2]);if(m3[3]==='%'){stop/=100;}else{stop/=bounds.width;}}else{stop=i*step;}
gradient.colorStops.push({color:m3[1],stop:stop});}}
break;}}
return gradient;};function addScrollStops(grad){return function(colorStop){try{grad.addColorStop(colorStop.stop,colorStop.color);}
catch(e){Util.log(['failed to add color stop: ',e,'; tried to add: ',colorStop]);}};}
Generate.Gradient=function(src,bounds){if(bounds.width===0||bounds.height===0){return;}
var canvas=document.createElement('canvas'),ctx=canvas.getContext('2d'),gradient,grad;canvas.width=bounds.width;canvas.height=bounds.height;gradient=_html2canvas.Generate.parseGradient(src,bounds);if(gradient){switch(gradient.type){case'linear':grad=ctx.createLinearGradient(gradient.x0,gradient.y0,gradient.x1,gradient.y1);gradient.colorStops.forEach(addScrollStops(grad));ctx.fillStyle=grad;ctx.fillRect(0,0,bounds.width,bounds.height);break;case'circle':grad=ctx.createRadialGradient(gradient.cx,gradient.cy,0,gradient.cx,gradient.cy,gradient.rx);gradient.colorStops.forEach(addScrollStops(grad));ctx.fillStyle=grad;ctx.fillRect(0,0,bounds.width,bounds.height);break;case'ellipse':var canvasRadial=document.createElement('canvas'),ctxRadial=canvasRadial.getContext('2d'),ri=Math.max(gradient.rx,gradient.ry),di=ri*2;canvasRadial.width=canvasRadial.height=di;grad=ctxRadial.createRadialGradient(gradient.rx,gradient.ry,0,gradient.rx,gradient.ry,ri);gradient.colorStops.forEach(addScrollStops(grad));ctxRadial.fillStyle=grad;ctxRadial.fillRect(0,0,di,di);ctx.fillStyle=gradient.colorStops[gradient.colorStops.length-1].color;ctx.fillRect(0,0,canvas.width,canvas.height);ctx.drawImage(canvasRadial,gradient.cx-gradient.rx,gradient.cy-gradient.ry,2*gradient.rx,2*gradient.ry);break;}}
return canvas;};Generate.ListAlpha=function(number){var tmp="",modulus;do{modulus=number%26;tmp=String.fromCharCode((modulus)+64)+tmp;number=number/26;}while((number*26)>26);return tmp;};Generate.ListRoman=function(number){var romanArray=["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"],decimal=[1000,900,500,400,100,90,50,40,10,9,5,4,1],roman="",v,len=romanArray.length;if(number<=0||number>=4000){return number;}
for(v=0;v<len;v+=1){while(number>=decimal[v]){number-=decimal[v];roman+=romanArray[v];}}
return roman;};})();function h2cRenderContext(width,height){var storage=[];return{storage:storage,width:width,height:height,clip:function(){storage.push({type:"function",name:"clip",'arguments':arguments});},translate:function(){storage.push({type:"function",name:"translate",'arguments':arguments});},fill:function(){storage.push({type:"function",name:"fill",'arguments':arguments});},save:function(){storage.push({type:"function",name:"save",'arguments':arguments});},restore:function(){storage.push({type:"function",name:"restore",'arguments':arguments});},fillRect:function(){storage.push({type:"function",name:"fillRect",'arguments':arguments});},createPattern:function(){storage.push({type:"function",name:"createPattern",'arguments':arguments});},drawShape:function(){var shape=[];storage.push({type:"function",name:"drawShape",'arguments':shape});return{moveTo:function(){shape.push({name:"moveTo",'arguments':arguments});},lineTo:function(){shape.push({name:"lineTo",'arguments':arguments});},arcTo:function(){shape.push({name:"arcTo",'arguments':arguments});},bezierCurveTo:function(){shape.push({name:"bezierCurveTo",'arguments':arguments});},quadraticCurveTo:function(){shape.push({name:"quadraticCurveTo",'arguments':arguments});}};},drawImage:function(){storage.push({type:"function",name:"drawImage",'arguments':arguments});},fillText:function(){storage.push({type:"function",name:"fillText",'arguments':arguments});},setVariable:function(variable,value){storage.push({type:"variable",name:variable,'arguments':value});return value;}};}
_html2canvas.Parse=function(images,options){window.scroll(0,0);var element=((options.elements===undefined)?document.body:options.elements[0]),numDraws=0,doc=element.ownerDocument,Util=_html2canvas.Util,support=Util.Support(options,doc),ignoreElementsRegExp=new RegExp("("+options.ignoreElements+")"),body=doc.body,getCSS=Util.getCSS,pseudoHide="___html2canvas___pseudoelement",hidePseudoElements=doc.createElement('style');hidePseudoElements.innerHTML='.'+pseudoHide+'-before:before { content: "" !important; display: none !important; }'+'.'+pseudoHide+'-after:after { content: "" !important; display: none !important; }';body.appendChild(hidePseudoElements);images=images||{};function documentWidth(){return Math.max(Math.max(doc.body.scrollWidth,doc.documentElement.scrollWidth),Math.max(doc.body.offsetWidth,doc.documentElement.offsetWidth),Math.max(doc.body.clientWidth,doc.documentElement.clientWidth));}
function documentHeight(){return Math.max(Math.max(doc.body.scrollHeight,doc.documentElement.scrollHeight),Math.max(doc.body.offsetHeight,doc.documentElement.offsetHeight),Math.max(doc.body.clientHeight,doc.documentElement.clientHeight));}
function getCSSInt(element,attribute){var val=parseInt(getCSS(element,attribute),10);return(isNaN(val))?0:val;}
function renderRect(ctx,x,y,w,h,bgcolor){if(bgcolor!=="transparent"){ctx.setVariable("fillStyle",bgcolor);ctx.fillRect(x,y,w,h);numDraws+=1;}}
function capitalize(m,p1,p2){if(m.length>0){return p1+p2.toUpperCase();}}
function textTransform(text,transform){switch(transform){case"lowercase":return text.toLowerCase();case"capitalize":return text.replace(/(^|\s|:|-|\(|\))([a-z])/g,capitalize);case"uppercase":return text.toUpperCase();default:return text;}}
function noLetterSpacing(letter_spacing){return(/^(normal|none|0px)$/.test(letter_spacing));}
function drawText(currentText,x,y,ctx){if(currentText!==null&&Util.trimText(currentText).length>0){ctx.fillText(currentText,x,y);numDraws+=1;}}
function setTextVariables(ctx,el,text_decoration,color){var align=false,bold=getCSS(el,"fontWeight"),family=getCSS(el,"fontFamily"),size=getCSS(el,"fontSize"),shadows=Util.parseTextShadows(getCSS(el,"textShadow"));switch(parseInt(bold,10)){case 401:bold="bold";break;case 400:bold="normal";break;}
ctx.setVariable("fillStyle",color);ctx.setVariable("font",[getCSS(el,"fontStyle"),getCSS(el,"fontVariant"),bold,size,family].join(" "));ctx.setVariable("textAlign",(align)?"right":"left");if(shadows.length){ctx.setVariable("shadowColor",shadows[0].color);ctx.setVariable("shadowOffsetX",shadows[0].offsetX);ctx.setVariable("shadowOffsetY",shadows[0].offsetY);ctx.setVariable("shadowBlur",shadows[0].blur);}
if(text_decoration!=="none"){return Util.Font(family,size,doc);}}
function renderTextDecoration(ctx,text_decoration,bounds,metrics,color){switch(text_decoration){case"underline":renderRect(ctx,bounds.left,Math.round(bounds.top+metrics.baseline+metrics.lineWidth),bounds.width,1,color);break;case"overline":renderRect(ctx,bounds.left,Math.round(bounds.top),bounds.width,1,color);break;case"line-through":renderRect(ctx,bounds.left,Math.ceil(bounds.top+metrics.middle+metrics.lineWidth),bounds.width,1,color);break;}}
function getTextBounds(state,text,textDecoration,isLast,transform){var bounds;if(support.rangeBounds&&!transform){if(textDecoration!=="none"||Util.trimText(text).length!==0){bounds=textRangeBounds(text,state.node,state.textOffset);}
state.textOffset+=text.length;}else if(state.node&&typeof state.node.nodeValue==="string"){var newTextNode=(isLast)?state.node.splitText(text.length):null;bounds=textWrapperBounds(state.node,transform);state.node=newTextNode;}
return bounds;}
function textRangeBounds(text,textNode,textOffset){var range=doc.createRange();range.setStart(textNode,textOffset);range.setEnd(textNode,textOffset+text.length);return range.getBoundingClientRect();}
function textWrapperBounds(oldTextNode,transform){var parent=oldTextNode.parentNode,wrapElement=doc.createElement('wrapper'),backupText=oldTextNode.cloneNode(true);wrapElement.appendChild(oldTextNode.cloneNode(true));parent.replaceChild(wrapElement,oldTextNode);var bounds=transform?Util.OffsetBounds(wrapElement):Util.Bounds(wrapElement);parent.replaceChild(backupText,wrapElement);return bounds;}
function renderText(el,textNode,stack){var ctx=stack.ctx,color=getCSS(el,"color"),textDecoration=getCSS(el,"textDecoration"),textAlign=getCSS(el,"textAlign"),metrics,textList,state={node:textNode,textOffset:0};if(Util.trimText(textNode.nodeValue).length>0){textNode.nodeValue=textTransform(textNode.nodeValue,getCSS(el,"textTransform"));textAlign=textAlign.replace(["-webkit-auto"],["auto"]);textList=(!options.letterRendering&&/^(left|right|justify|auto|center)$/.test(textAlign)&&noLetterSpacing(getCSS(el,"letterSpacing")))?textNode.nodeValue.split(/(\b| )/):textNode.nodeValue.split("");metrics=setTextVariables(ctx,el,textDecoration,color);if(options.chinese){textList.forEach(function(word,index){if(/.*[\u4E00-\u9FA5].*$/.test(word)){word=word.split("");word.unshift(index,1);textList.splice.apply(textList,word);}});}
textList.forEach(function(text,index){var bounds=getTextBounds(state,text,textDecoration,(index<textList.length-1),stack.transform.matrix);if(bounds){drawText(text,bounds.left,bounds.bottom,ctx);renderTextDecoration(ctx,textDecoration,bounds,metrics,color);}});}}
function listPosition(element,val){var boundElement=doc.createElement("boundelement"),originalType,bounds;boundElement.style.display="inline";originalType=element.style.listStyleType;element.style.listStyleType="none";boundElement.appendChild(doc.createTextNode(val));element.insertBefore(boundElement,element.firstChild);bounds=Util.Bounds(boundElement);element.removeChild(boundElement);element.style.listStyleType=originalType;return bounds;}
function elementIndex(el){var i=-1,count=1,childs=el.parentNode.childNodes;if(el.parentNode){while(childs[++i]!==el){if(childs[i].nodeType===1){count++;}}
return count;}else{return-1;}}
function listItemText(element,type){var currentIndex=elementIndex(element),text;switch(type){case"decimal":text=currentIndex;break;case"decimal-leading-zero":text=(currentIndex.toString().length===1)?currentIndex="0"+currentIndex.toString():currentIndex.toString();break;case"upper-roman":text=_html2canvas.Generate.ListRoman(currentIndex);break;case"lower-roman":text=_html2canvas.Generate.ListRoman(currentIndex).toLowerCase();break;case"lower-alpha":text=_html2canvas.Generate.ListAlpha(currentIndex).toLowerCase();break;case"upper-alpha":text=_html2canvas.Generate.ListAlpha(currentIndex);break;}
return text+". ";}
function renderListItem(element,stack,elBounds){var x,text,ctx=stack.ctx,type=getCSS(element,"listStyleType"),listBounds;if(/^(decimal|decimal-leading-zero|upper-alpha|upper-latin|upper-roman|lower-alpha|lower-greek|lower-latin|lower-roman)$/i.test(type)){text=listItemText(element,type);listBounds=listPosition(element,text);setTextVariables(ctx,element,"none",getCSS(element,"color"));if(getCSS(element,"listStylePosition")==="inside"){ctx.setVariable("textAlign","left");x=elBounds.left;}else{return;}
drawText(text,x,listBounds.bottom,ctx);}}
function loadImage(src){var img=images[src];return(img&&img.succeeded===true)?img.img:false;}
function clipBounds(src,dst){var x=Math.max(src.left,dst.left),y=Math.max(src.top,dst.top),x2=Math.min((src.left+src.width),(dst.left+dst.width)),y2=Math.min((src.top+src.height),(dst.top+dst.height));return{left:x,top:y,width:x2-x,height:y2-y};}
function setZ(element,stack,parentStack){var newContext,isPositioned=stack.cssPosition!=='static',zIndex=isPositioned?getCSS(element,'zIndex'):'auto',opacity=getCSS(element,'opacity'),isFloated=getCSS(element,'cssFloat')!=='none';stack.zIndex=newContext=h2czContext(zIndex);newContext.isPositioned=isPositioned;newContext.isFloated=isFloated;newContext.opacity=opacity;newContext.ownStacking=(zIndex!=='auto'||opacity<1);if(parentStack){parentStack.zIndex.children.push(stack);}}
function renderImage(ctx,element,image,bounds,borders){var paddingLeft=getCSSInt(element,'paddingLeft'),paddingTop=getCSSInt(element,'paddingTop'),paddingRight=getCSSInt(element,'paddingRight'),paddingBottom=getCSSInt(element,'paddingBottom');drawImage(ctx,image,0,0,image.width,image.height,bounds.left+paddingLeft+borders[3].width,bounds.top+paddingTop+borders[0].width,bounds.width-(borders[1].width+borders[3].width+paddingLeft+paddingRight),bounds.height-(borders[0].width+borders[2].width+paddingTop+paddingBottom));}
function getBorderData(element){return["Top","Right","Bottom","Left"].map(function(side){return{width:getCSSInt(element,'border'+side+'Width'),color:getCSS(element,'border'+side+'Color')};});}
function getBorderRadiusData(element){return["TopLeft","TopRight","BottomRight","BottomLeft"].map(function(side){return getCSS(element,'border'+side+'Radius');});}
var getCurvePoints=(function(kappa){return function(x,y,r1,r2){var ox=(r1)*kappa,oy=(r2)*kappa,xm=x+r1,ym=y+r2;return{topLeft:bezierCurve({x:x,y:ym},{x:x,y:ym-oy},{x:xm-ox,y:y},{x:xm,y:y}),topRight:bezierCurve({x:x,y:y},{x:x+ox,y:y},{x:xm,y:ym-oy},{x:xm,y:ym}),bottomRight:bezierCurve({x:xm,y:y},{x:xm,y:y+oy},{x:x+ox,y:ym},{x:x,y:ym}),bottomLeft:bezierCurve({x:xm,y:ym},{x:xm-ox,y:ym},{x:x,y:y+oy},{x:x,y:y})};};})(4*((Math.sqrt(2)-1)/3));function bezierCurve(start,startControl,endControl,end){var lerp=function(a,b,t){return{x:a.x+(b.x-a.x)*t,y:a.y+(b.y-a.y)*t};};return{start:start,startControl:startControl,endControl:endControl,end:end,subdivide:function(t){var ab=lerp(start,startControl,t),bc=lerp(startControl,endControl,t),cd=lerp(endControl,end,t),abbc=lerp(ab,bc,t),bccd=lerp(bc,cd,t),dest=lerp(abbc,bccd,t);return[bezierCurve(start,ab,abbc,dest),bezierCurve(dest,bccd,cd,end)];},curveTo:function(borderArgs){borderArgs.push(["bezierCurve",startControl.x,startControl.y,endControl.x,endControl.y,end.x,end.y]);},curveToReversed:function(borderArgs){borderArgs.push(["bezierCurve",endControl.x,endControl.y,startControl.x,startControl.y,start.x,start.y]);}};}
function parseCorner(borderArgs,radius1,radius2,corner1,corner2,x,y){if(radius1[0]>0||radius1[1]>0){borderArgs.push(["line",corner1[0].start.x,corner1[0].start.y]);corner1[0].curveTo(borderArgs);corner1[1].curveTo(borderArgs);}else{borderArgs.push(["line",x,y]);}
if(radius2[0]>0||radius2[1]>0){borderArgs.push(["line",corner2[0].start.x,corner2[0].start.y]);}}
function drawSide(borderData,radius1,radius2,outer1,inner1,outer2,inner2){var borderArgs=[];if(radius1[0]>0||radius1[1]>0){borderArgs.push(["line",outer1[1].start.x,outer1[1].start.y]);outer1[1].curveTo(borderArgs);}else{borderArgs.push(["line",borderData.c1[0],borderData.c1[1]]);}
if(radius2[0]>0||radius2[1]>0){borderArgs.push(["line",outer2[0].start.x,outer2[0].start.y]);outer2[0].curveTo(borderArgs);borderArgs.push(["line",inner2[0].end.x,inner2[0].end.y]);inner2[0].curveToReversed(borderArgs);}else{borderArgs.push(["line",borderData.c2[0],borderData.c2[1]]);borderArgs.push(["line",borderData.c3[0],borderData.c3[1]]);}
if(radius1[0]>0||radius1[1]>0){borderArgs.push(["line",inner1[1].end.x,inner1[1].end.y]);inner1[1].curveToReversed(borderArgs);}else{borderArgs.push(["line",borderData.c4[0],borderData.c4[1]]);}
return borderArgs;}
function calculateCurvePoints(bounds,borderRadius,borders){var x=bounds.left,y=bounds.top,width=bounds.width,height=bounds.height,tlh=borderRadius[0][0],tlv=borderRadius[0][1],trh=borderRadius[1][0],trv=borderRadius[1][1],brh=borderRadius[2][0],brv=borderRadius[2][1],blh=borderRadius[3][0],blv=borderRadius[3][1],topWidth=width-trh,rightHeight=height-brv,bottomWidth=width-brh,leftHeight=height-blv;return{topLeftOuter:getCurvePoints(x,y,tlh,tlv).topLeft.subdivide(0.5),topLeftInner:getCurvePoints(x+borders[3].width,y+borders[0].width,Math.max(0,tlh-borders[3].width),Math.max(0,tlv-borders[0].width)).topLeft.subdivide(0.5),topRightOuter:getCurvePoints(x+topWidth,y,trh,trv).topRight.subdivide(0.5),topRightInner:getCurvePoints(x+Math.min(topWidth,width+borders[3].width),y+borders[0].width,(topWidth>width+borders[3].width)?0:trh-borders[3].width,trv-borders[0].width).topRight.subdivide(0.5),bottomRightOuter:getCurvePoints(x+bottomWidth,y+rightHeight,brh,brv).bottomRight.subdivide(0.5),bottomRightInner:getCurvePoints(x+Math.min(bottomWidth,width+borders[3].width),y+Math.min(rightHeight,height+borders[0].width),Math.max(0,brh-borders[1].width),Math.max(0,brv-borders[2].width)).bottomRight.subdivide(0.5),bottomLeftOuter:getCurvePoints(x,y+leftHeight,blh,blv).bottomLeft.subdivide(0.5),bottomLeftInner:getCurvePoints(x+borders[3].width,y+leftHeight,Math.max(0,blh-borders[3].width),Math.max(0,blv-borders[2].width)).bottomLeft.subdivide(0.5)};}
function getBorderClip(element,borderPoints,borders,radius,bounds){var backgroundClip=getCSS(element,'backgroundClip'),borderArgs=[];switch(backgroundClip){case"content-box":case"padding-box":parseCorner(borderArgs,radius[0],radius[1],borderPoints.topLeftInner,borderPoints.topRightInner,bounds.left+borders[3].width,bounds.top+borders[0].width);parseCorner(borderArgs,radius[1],radius[2],borderPoints.topRightInner,borderPoints.bottomRightInner,bounds.left+bounds.width-borders[1].width,bounds.top+borders[0].width);parseCorner(borderArgs,radius[2],radius[3],borderPoints.bottomRightInner,borderPoints.bottomLeftInner,bounds.left+bounds.width-borders[1].width,bounds.top+bounds.height-borders[2].width);parseCorner(borderArgs,radius[3],radius[0],borderPoints.bottomLeftInner,borderPoints.topLeftInner,bounds.left+borders[3].width,bounds.top+bounds.height-borders[2].width);break;default:parseCorner(borderArgs,radius[0],radius[1],borderPoints.topLeftOuter,borderPoints.topRightOuter,bounds.left,bounds.top);parseCorner(borderArgs,radius[1],radius[2],borderPoints.topRightOuter,borderPoints.bottomRightOuter,bounds.left+bounds.width,bounds.top);parseCorner(borderArgs,radius[2],radius[3],borderPoints.bottomRightOuter,borderPoints.bottomLeftOuter,bounds.left+bounds.width,bounds.top+bounds.height);parseCorner(borderArgs,radius[3],radius[0],borderPoints.bottomLeftOuter,borderPoints.topLeftOuter,bounds.left,bounds.top+bounds.height);break;}
return borderArgs;}
function parseBorders(element,bounds,borders){var x=bounds.left,y=bounds.top,width=bounds.width,height=bounds.height,borderSide,bx,by,bw,bh,borderArgs,borderRadius=getBorderRadiusData(element),borderPoints=calculateCurvePoints(bounds,borderRadius,borders),borderData={clip:getBorderClip(element,borderPoints,borders,borderRadius,bounds),borders:[]};for(borderSide=0;borderSide<4;borderSide++){if(borders[borderSide].width>0){bx=x;by=y;bw=width;bh=height-(borders[2].width);switch(borderSide){case 0:bh=borders[0].width;borderArgs=drawSide({c1:[bx,by],c2:[bx+bw,by],c3:[bx+bw-borders[1].width,by+bh],c4:[bx+borders[3].width,by+bh]},borderRadius[0],borderRadius[1],borderPoints.topLeftOuter,borderPoints.topLeftInner,borderPoints.topRightOuter,borderPoints.topRightInner);break;case 1:bx=x+width-(borders[1].width);bw=borders[1].width;borderArgs=drawSide({c1:[bx+bw,by],c2:[bx+bw,by+bh+borders[2].width],c3:[bx,by+bh],c4:[bx,by+borders[0].width]},borderRadius[1],borderRadius[2],borderPoints.topRightOuter,borderPoints.topRightInner,borderPoints.bottomRightOuter,borderPoints.bottomRightInner);break;case 2:by=(by+height)-(borders[2].width);bh=borders[2].width;borderArgs=drawSide({c1:[bx+bw,by+bh],c2:[bx,by+bh],c3:[bx+borders[3].width,by],c4:[bx+bw-borders[3].width,by]},borderRadius[2],borderRadius[3],borderPoints.bottomRightOuter,borderPoints.bottomRightInner,borderPoints.bottomLeftOuter,borderPoints.bottomLeftInner);break;case 3:bw=borders[3].width;borderArgs=drawSide({c1:[bx,by+bh+borders[2].width],c2:[bx,by],c3:[bx+bw,by+borders[0].width],c4:[bx+bw,by+bh]},borderRadius[3],borderRadius[0],borderPoints.bottomLeftOuter,borderPoints.bottomLeftInner,borderPoints.topLeftOuter,borderPoints.topLeftInner);break;}
borderData.borders.push({args:borderArgs,color:borders[borderSide].color});}}
return borderData;}
function createShape(ctx,args){var shape=ctx.drawShape();args.forEach(function(border,index){shape[(index===0)?"moveTo":border[0]+"To"].apply(null,border.slice(1));});return shape;}
function renderBorders(ctx,borderArgs,color){if(color!=="transparent"){ctx.setVariable("fillStyle",color);createShape(ctx,borderArgs);ctx.fill();numDraws+=1;}}
function renderFormValue(el,bounds,stack){var valueWrap=doc.createElement('valuewrap'),cssPropertyArray=['lineHeight','textAlign','fontFamily','color','fontSize','paddingLeft','paddingTop','width','height','border','borderLeftWidth','borderTopWidth'],textValue,textNode;cssPropertyArray.forEach(function(property){try{valueWrap.style[property]=getCSS(el,property);}catch(e){Util.log("html2canvas: Parse: Exception caught in renderFormValue: "+e.message);}});valueWrap.style.borderColor="black";valueWrap.style.borderStyle="solid";valueWrap.style.display="block";valueWrap.style.position="absolute";if(/^(submit|reset|button|text|password)$/.test(el.type)||el.nodeName==="SELECT"){valueWrap.style.lineHeight=getCSS(el,"height");}
valueWrap.style.top=bounds.top+"px";valueWrap.style.left=bounds.left+"px";textValue=(el.nodeName==="SELECT")?(el.options[el.selectedIndex]||0).text:el.value;if(!textValue){textValue=el.placeholder;}
textNode=doc.createTextNode(textValue);valueWrap.appendChild(textNode);body.appendChild(valueWrap);renderText(el,textNode,stack);body.removeChild(valueWrap);}
function drawImage(ctx){ctx.drawImage.apply(ctx,Array.prototype.slice.call(arguments,1));numDraws+=1;}
function getPseudoElement(el,which){var elStyle=window.getComputedStyle(el,which);if(!elStyle||!elStyle.content||elStyle.content==="none"||elStyle.content==="-moz-alt-content"||elStyle.display==="none"){return;}
var content=elStyle.content+'',first=content.substr(0,1);if(first===content.substr(content.length-1)&&first.match(/'|"/)){content=content.substr(1,content.length-2);}
var isImage=content.substr(0,3)==='url',elps=document.createElement(isImage?'img':'span');elps.className=pseudoHide+"-before "+pseudoHide+"-after";Object.keys(elStyle).filter(indexedProperty).forEach(function(prop){try{elps.style[prop]=elStyle[prop];}catch(e){Util.log(['Tried to assign readonly property ',prop,'Error:',e]);}});if(isImage){elps.src=Util.parseBackgroundImage(content)[0].args[0];}else{elps.innerHTML=content;}
return elps;}
function indexedProperty(property){return(isNaN(window.parseInt(property,10)));}
function injectPseudoElements(el,stack){var before=getPseudoElement(el,':before'),after=getPseudoElement(el,':after');if(!before&&!after){return;}
if(before){el.className+=" "+pseudoHide+"-before";el.parentNode.insertBefore(before,el);parseElement(before,stack,true);el.parentNode.removeChild(before);el.className=el.className.replace(pseudoHide+"-before","").trim();}
if(after){el.className+=" "+pseudoHide+"-after";el.appendChild(after);parseElement(after,stack,true);el.removeChild(after);el.className=el.className.replace(pseudoHide+"-after","").trim();}}
function renderBackgroundRepeat(ctx,image,backgroundPosition,bounds){var offsetX=Math.round(bounds.left+backgroundPosition.left),offsetY=Math.round(bounds.top+backgroundPosition.top);ctx.createPattern(image);ctx.translate(offsetX,offsetY);ctx.fill();ctx.translate(-offsetX,-offsetY);}
function backgroundRepeatShape(ctx,image,backgroundPosition,bounds,left,top,width,height){var args=[];args.push(["line",Math.round(left),Math.round(top)]);args.push(["line",Math.round(left+width),Math.round(top)]);args.push(["line",Math.round(left+width),Math.round(height+top)]);args.push(["line",Math.round(left),Math.round(height+top)]);createShape(ctx,args);ctx.save();ctx.clip();renderBackgroundRepeat(ctx,image,backgroundPosition,bounds);ctx.restore();}
function renderBackgroundColor(ctx,backgroundBounds,bgcolor){renderRect(ctx,backgroundBounds.left,backgroundBounds.top,backgroundBounds.width,backgroundBounds.height,bgcolor);}
function renderBackgroundRepeating(el,bounds,ctx,image,imageIndex){var backgroundSize=Util.BackgroundSize(el,bounds,image,imageIndex),backgroundPosition=Util.BackgroundPosition(el,bounds,image,imageIndex,backgroundSize),backgroundRepeat=getCSS(el,"backgroundRepeat").split(",").map(Util.trimText);image=resizeImage(image,backgroundSize);backgroundRepeat=backgroundRepeat[imageIndex]||backgroundRepeat[0];switch(backgroundRepeat){case"repeat-x":backgroundRepeatShape(ctx,image,backgroundPosition,bounds,bounds.left,bounds.top+backgroundPosition.top,99999,image.height);break;case"repeat-y":backgroundRepeatShape(ctx,image,backgroundPosition,bounds,bounds.left+backgroundPosition.left,bounds.top,image.width,99999);break;case"no-repeat":backgroundRepeatShape(ctx,image,backgroundPosition,bounds,bounds.left+backgroundPosition.left,bounds.top+backgroundPosition.top,image.width,image.height);break;default:renderBackgroundRepeat(ctx,image,backgroundPosition,{top:bounds.top,left:bounds.left,width:image.width,height:image.height});break;}}
function renderBackgroundImage(element,bounds,ctx){var backgroundImage=getCSS(element,"backgroundImage"),backgroundImages=Util.parseBackgroundImage(backgroundImage),image,imageIndex=backgroundImages.length;while(imageIndex--){backgroundImage=backgroundImages[imageIndex];if(!backgroundImage.args||backgroundImage.args.length===0){continue;}
var key=backgroundImage.method==='url'?backgroundImage.args[0]:backgroundImage.value;image=loadImage(key);if(image){renderBackgroundRepeating(element,bounds,ctx,image,imageIndex);}else{Util.log("html2canvas: Error loading background:",backgroundImage);}}}
function resizeImage(image,bounds){if(image.width===bounds.width&&image.height===bounds.height){return image;}
var ctx,canvas=doc.createElement('canvas');canvas.width=bounds.width;canvas.height=bounds.height;ctx=canvas.getContext("2d");drawImage(ctx,image,0,0,image.width,image.height,0,0,bounds.width,bounds.height);return canvas;}
function setOpacity(ctx,element,parentStack){return ctx.setVariable("globalAlpha",getCSS(element,"opacity")*((parentStack)?parentStack.opacity:1));}
function removePx(str){return str.replace("px","");}
var transformRegExp=/(matrix)\((.+)\)/;function getTransform(element,parentStack){var transform=getCSS(element,"transform")||getCSS(element,"-webkit-transform")||getCSS(element,"-moz-transform")||getCSS(element,"-ms-transform")||getCSS(element,"-o-transform");var transformOrigin=getCSS(element,"transform-origin")||getCSS(element,"-webkit-transform-origin")||getCSS(element,"-moz-transform-origin")||getCSS(element,"-ms-transform-origin")||getCSS(element,"-o-transform-origin")||"0px 0px";transformOrigin=transformOrigin.split(" ").map(removePx).map(Util.asFloat);var matrix;if(transform&&transform!=="none"){var match=transform.match(transformRegExp);if(match){switch(match[1]){case"matrix":matrix=match[2].split(",").map(Util.trimText).map(Util.asFloat);break;}}}
return{origin:transformOrigin,matrix:matrix};}
function createStack(element,parentStack,bounds,transform){var ctx=h2cRenderContext((!parentStack)?documentWidth():bounds.width,(!parentStack)?documentHeight():bounds.height),stack={ctx:ctx,opacity:setOpacity(ctx,element,parentStack),cssPosition:getCSS(element,"position"),borders:getBorderData(element),transform:transform,clip:(parentStack&&parentStack.clip)?Util.Extend({},parentStack.clip):null};setZ(element,stack,parentStack);if(options.useOverflow===true&&/(hidden|scroll|auto)/.test(getCSS(element,"overflow"))===true&&/(BODY)/i.test(element.nodeName)===false){stack.clip=(stack.clip)?clipBounds(stack.clip,bounds):bounds;}
return stack;}
function getBackgroundBounds(borders,bounds,clip){var backgroundBounds={left:bounds.left+borders[3].width,top:bounds.top+borders[0].width,width:bounds.width-(borders[1].width+borders[3].width),height:bounds.height-(borders[0].width+borders[2].width)};if(clip){backgroundBounds=clipBounds(backgroundBounds,clip);}
return backgroundBounds;}
function getBounds(element,transform){var bounds=(transform.matrix)?Util.OffsetBounds(element):Util.Bounds(element);transform.origin[0]+=bounds.left;transform.origin[1]+=bounds.top;return bounds;}
function renderElement(element,parentStack,pseudoElement,ignoreBackground){var transform=getTransform(element,parentStack),bounds=getBounds(element,transform),image,stack=createStack(element,parentStack,bounds,transform),borders=stack.borders,ctx=stack.ctx,backgroundBounds=getBackgroundBounds(borders,bounds,stack.clip),borderData=parseBorders(element,bounds,borders),backgroundColor=(ignoreElementsRegExp.test(element.nodeName))?"#efefef":getCSS(element,"backgroundColor");createShape(ctx,borderData.clip);ctx.save();ctx.clip();if(backgroundBounds.height>0&&backgroundBounds.width>0&&!ignoreBackground){renderBackgroundColor(ctx,bounds,backgroundColor);renderBackgroundImage(element,backgroundBounds,ctx);}else if(ignoreBackground){stack.backgroundColor=backgroundColor;}
ctx.restore();borderData.borders.forEach(function(border){renderBorders(ctx,border.args,border.color);});if(!pseudoElement){injectPseudoElements(element,stack);}
switch(element.nodeName){case"IMG":if((image=loadImage(element.getAttribute('src')))){renderImage(ctx,element,image,bounds,borders);}else{Util.log("html2canvas: Error loading <img>:"+element.getAttribute('src'));}
break;case"INPUT":if(/^(text|url|email|submit|button|reset)$/.test(element.type)&&(element.value||element.placeholder||"").length>0){renderFormValue(element,bounds,stack);}
break;case"TEXTAREA":if((element.value||element.placeholder||"").length>0){renderFormValue(element,bounds,stack);}
break;case"SELECT":if((element.options||element.placeholder||"").length>0){renderFormValue(element,bounds,stack);}
break;case"LI":renderListItem(element,stack,backgroundBounds);break;case"CANVAS":renderImage(ctx,element,element,bounds,borders);break;}
return stack;}
function isElementVisible(element){return(getCSS(element,'display')!=="none"&&getCSS(element,'visibility')!=="hidden"&&!element.hasAttribute("data-html2canvas-ignore"));}
function parseElement(element,stack,pseudoElement){if(isElementVisible(element)){stack=renderElement(element,stack,pseudoElement,false)||stack;if(!ignoreElementsRegExp.test(element.nodeName)){parseChildren(element,stack,pseudoElement);}}}
function parseChildren(element,stack,pseudoElement){Util.Children(element).forEach(function(node){if(node.nodeType===node.ELEMENT_NODE){parseElement(node,stack,pseudoElement);}else if(node.nodeType===node.TEXT_NODE){renderText(element,node,stack);}});}
function init(){var background=getCSS(document.documentElement,"backgroundColor"),transparentBackground=(Util.isTransparent(background)&&element===document.body),stack=renderElement(element,null,false,transparentBackground);parseChildren(element,stack);if(transparentBackground){background=stack.backgroundColor;}
body.removeChild(hidePseudoElements);return{backgroundColor:background,stack:stack};}
return init();};function h2czContext(zindex){return{zindex:zindex,children:[]};}
_html2canvas.Preload=function(options){var images={numLoaded:0,numFailed:0,numTotal:0,cleanupDone:false},pageOrigin,Util=_html2canvas.Util,methods,i,count=0,element=options.elements[0]||document.body,doc=element.ownerDocument,domImages=element.getElementsByTagName('img'),imgLen=domImages.length,link=doc.createElement("a"),supportCORS=(function(img){return(img.crossOrigin!==undefined);})(new Image()),timeoutTimer;link.href=window.location.href;pageOrigin=link.protocol+link.host;function isSameOrigin(url){link.href=url;link.href=link.href;var origin=link.protocol+link.host;return(origin===pageOrigin);}
function start(){Util.log("html2canvas: start: images: "+images.numLoaded+" / "+images.numTotal+" (failed: "+images.numFailed+")");if(!images.firstRun&&images.numLoaded>=images.numTotal){Util.log("Finished loading images: # "+images.numTotal+" (failed: "+images.numFailed+")");if(typeof options.complete==="function"){options.complete(images);}}}
function proxyGetImage(url,img,imageObj){var callback_name,scriptUrl=options.proxy,script;link.href=url;url=link.href;callback_name='html2canvas_'+(count++);imageObj.callbackname=callback_name;if(scriptUrl.indexOf("?")>-1){scriptUrl+="&";}else{scriptUrl+="?";}
scriptUrl+='url='+encodeURIComponent(url)+'&callback='+callback_name;script=doc.createElement("script");window[callback_name]=function(a){if(a.substring(0,6)==="error:"){imageObj.succeeded=false;images.numLoaded++;images.numFailed++;start();}else{setImageLoadHandlers(img,imageObj);img.src=a;}
window[callback_name]=undefined;try{delete window[callback_name];}catch(ex){}
script.parentNode.removeChild(script);script=null;delete imageObj.script;delete imageObj.callbackname;};script.setAttribute("type","text/javascript");script.setAttribute("src",scriptUrl);imageObj.script=script;window.document.body.appendChild(script);}
function loadPseudoElement(element,type){var style=window.getComputedStyle(element,type),content=style.content;if(content.substr(0,3)==='url'){methods.loadImage(_html2canvas.Util.parseBackgroundImage(content)[0].args[0]);}
loadBackgroundImages(style.backgroundImage,element);}
function loadPseudoElementImages(element){loadPseudoElement(element,":before");loadPseudoElement(element,":after");}
function loadGradientImage(backgroundImage,bounds){var img=_html2canvas.Generate.Gradient(backgroundImage,bounds);if(img!==undefined){images[backgroundImage]={img:img,succeeded:true};images.numTotal++;images.numLoaded++;start();}}
function invalidBackgrounds(background_image){return(background_image&&background_image.method&&background_image.args&&background_image.args.length>0);}
function loadBackgroundImages(background_image,el){var bounds;_html2canvas.Util.parseBackgroundImage(background_image).filter(invalidBackgrounds).forEach(function(background_image){if(background_image.method==='url'){methods.loadImage(background_image.args[0]);}else if(background_image.method.match(/\-?gradient$/)){if(bounds===undefined){bounds=_html2canvas.Util.Bounds(el);}
loadGradientImage(background_image.value,bounds);}});}
function getImages(el){var elNodeType=false;try{Util.Children(el).forEach(getImages);}
catch(e){}
try{elNodeType=el.nodeType;}catch(ex){elNodeType=false;Util.log("html2canvas: failed to access some element's nodeType - Exception: "+ex.message);}
if(elNodeType===1||elNodeType===undefined){loadPseudoElementImages(el);try{loadBackgroundImages(Util.getCSS(el,'backgroundImage'),el);}catch(e){Util.log("html2canvas: failed to get background-image - Exception: "+e.message);}
loadBackgroundImages(el);}}
function setImageLoadHandlers(img,imageObj){img.onload=function(){if(imageObj.timer!==undefined){window.clearTimeout(imageObj.timer);}
images.numLoaded++;imageObj.succeeded=true;img.onerror=img.onload=null;start();};img.onerror=function(){if(img.crossOrigin==="anonymous"){window.clearTimeout(imageObj.timer);if(options.proxy){var src=img.src;img=new Image();imageObj.img=img;img.src=src;proxyGetImage(img.src,img,imageObj);return;}}
images.numLoaded++;images.numFailed++;imageObj.succeeded=false;img.onerror=img.onload=null;start();};}
methods={loadImage:function(src){var img,imageObj;if(src&&images[src]===undefined){img=new Image();if(src.match(/data:image\/.*;base64,/i)){img.src=src.replace(/url\(['"]{0,}|['"]{0,}\)$/ig,'');imageObj=images[src]={img:img};images.numTotal++;setImageLoadHandlers(img,imageObj);}else if(isSameOrigin(src)||options.allowTaint===true){imageObj=images[src]={img:img};images.numTotal++;setImageLoadHandlers(img,imageObj);img.src=src;}else if(supportCORS&&!options.allowTaint&&options.useCORS){img.crossOrigin="anonymous";imageObj=images[src]={img:img};images.numTotal++;setImageLoadHandlers(img,imageObj);img.src=src;}else if(options.proxy){imageObj=images[src]={img:img};images.numTotal++;proxyGetImage(src,img,imageObj);}}},cleanupDOM:function(cause){var img,src;if(!images.cleanupDone){if(cause&&typeof cause==="string"){Util.log("html2canvas: Cleanup because: "+cause);}else{Util.log("html2canvas: Cleanup after timeout: "+options.timeout+" ms.");}
for(src in images){if(images.hasOwnProperty(src)){img=images[src];if(typeof img==="object"&&img.callbackname&&img.succeeded===undefined){window[img.callbackname]=undefined;try{delete window[img.callbackname];}catch(ex){}
if(img.script&&img.script.parentNode){img.script.setAttribute("src","about:blank");img.script.parentNode.removeChild(img.script);}
images.numLoaded++;images.numFailed++;Util.log("html2canvas: Cleaned up failed img: '"+src+"' Steps: "+images.numLoaded+" / "+images.numTotal);}}}
if(window.stop!==undefined){window.stop();}else if(document.execCommand!==undefined){document.execCommand("Stop",false);}
if(document.close!==undefined){document.close();}
images.cleanupDone=true;if(!(cause&&typeof cause==="string")){start();}}},renderingDone:function(){if(timeoutTimer){window.clearTimeout(timeoutTimer);}}};if(options.timeout>0){timeoutTimer=window.setTimeout(methods.cleanupDOM,options.timeout);}
Util.log('html2canvas: Preload starts: finding background-images');images.firstRun=true;getImages(element);Util.log('html2canvas: Preload: Finding images');for(i=0;i<imgLen;i+=1){methods.loadImage(domImages[i].getAttribute("src"));}
images.firstRun=false;Util.log('html2canvas: Preload: Done.');if(images.numTotal===images.numLoaded){start();}
return methods;};_html2canvas.Renderer=function(parseQueue,options){function createRenderQueue(parseQueue){var queue=[],rootContext;rootContext=(function buildStackingContext(rootNode){var rootContext={};function insert(context,node,specialParent){var zi=(node.zIndex.zindex==='auto')?0:Number(node.zIndex.zindex),contextForChildren=context,isPositioned=node.zIndex.isPositioned,isFloated=node.zIndex.isFloated,stub={node:node},childrenDest=specialParent;if(node.zIndex.ownStacking){contextForChildren=stub.context={'!':[{node:node,children:[]}]};childrenDest=undefined;}else if(isPositioned||isFloated){childrenDest=stub.children=[];}
if(zi===0&&specialParent){specialParent.push(stub);}else{if(!context[zi]){context[zi]=[];}
context[zi].push(stub);}
node.zIndex.children.forEach(function(childNode){insert(contextForChildren,childNode,childrenDest);});}
insert(rootContext,rootNode);return rootContext;})(parseQueue);function sortZ(context){Object.keys(context).sort().forEach(function(zi){var nonPositioned=[],floated=[],positioned=[],list=[];context[zi].forEach(function(v){if(v.node.zIndex.isPositioned||v.node.zIndex.opacity<1){positioned.push(v);}else if(v.node.zIndex.isFloated){floated.push(v);}else{nonPositioned.push(v);}});(function walk(arr){arr.forEach(function(v){list.push(v);if(v.children){walk(v.children);}});})(nonPositioned.concat(floated,positioned));list.forEach(function(v){if(v.context){sortZ(v.context);}else{queue.push(v.node);}});});}
sortZ(rootContext);return queue;}
function getRenderer(rendererName){var renderer;if(typeof options.renderer==="string"&&_html2canvas.Renderer[rendererName]!==undefined){renderer=_html2canvas.Renderer[rendererName](options);}else if(typeof rendererName==="function"){renderer=rendererName(options);}else{throw new Error("Unknown renderer");}
if(typeof renderer!=="function"){throw new Error("Invalid renderer defined");}
return renderer;}
return getRenderer(options.renderer)(parseQueue,options,document,createRenderQueue(parseQueue.stack),_html2canvas);};_html2canvas.Util.Support=function(options,doc){function supportSVGRendering(){var img=new Image(),canvas=doc.createElement("canvas"),ctx=(canvas.getContext===undefined)?false:canvas.getContext("2d");if(ctx===false){return false;}
canvas.width=canvas.height=10;img.src=["data:image/svg+xml,","<svg xmlns='http://www.w3.org/2000/svg' width='10' height='10'>","<foreignObject width='10' height='10'>","<div xmlns='http://www.w3.org/1999/xhtml' style='width:10;height:10;'>","sup","</div>","</foreignObject>","</svg>"].join("");try{ctx.drawImage(img,0,0);canvas.toDataURL();}catch(e){return false;}
_html2canvas.Util.log('html2canvas: Parse: SVG powered rendering available');return true;}
function supportRangeBounds(){var r,testElement,rangeBounds,rangeHeight,support=false;if(doc.createRange){r=doc.createRange();if(r.getBoundingClientRect){testElement=doc.createElement('boundtest');testElement.style.height="123px";testElement.style.display="block";doc.body.appendChild(testElement);r.selectNode(testElement);rangeBounds=r.getBoundingClientRect();rangeHeight=rangeBounds.height;if(rangeHeight===123){support=true;}
doc.body.removeChild(testElement);}}
return support;}
return{rangeBounds:supportRangeBounds(),svgRendering:options.svgRendering&&supportSVGRendering()};};window.html2canvas=function(elements,opts){elements=(elements.length)?elements:[elements];var queue,canvas,options={logging:false,elements:elements,background:"#fff",proxy:null,timeout:0,useCORS:false,allowTaint:false,svgRendering:false,ignoreElements:"IFRAME|OBJECT|PARAM",useOverflow:true,letterRendering:false,chinese:false,width:null,height:null,taintTest:true,renderer:"Canvas"};options=_html2canvas.Util.Extend(opts,options);_html2canvas.logging=options.logging;options.complete=function(images){if(typeof options.onpreloaded==="function"){if(options.onpreloaded(images)===false){return;}}
queue=_html2canvas.Parse(images,options);if(typeof options.onparsed==="function"){if(options.onparsed(queue)===false){return;}}
canvas=_html2canvas.Renderer(queue,options);if(typeof options.onrendered==="function"){options.onrendered(canvas);}};window.setTimeout(function(){_html2canvas.Preload(options);},0);return{render:function(queue,opts){return _html2canvas.Renderer(queue,_html2canvas.Util.Extend(opts,options));},parse:function(images,opts){return _html2canvas.Parse(images,_html2canvas.Util.Extend(opts,options));},preload:function(opts){return _html2canvas.Preload(_html2canvas.Util.Extend(opts,options));},log:_html2canvas.Util.log};};window.html2canvas.log=_html2canvas.Util.log;window.html2canvas.Renderer={Canvas:undefined};_html2canvas.Renderer.Canvas=function(options){options=options||{};var doc=document,safeImages=[],testCanvas=document.createElement("canvas"),testctx=testCanvas.getContext("2d"),Util=_html2canvas.Util,canvas=options.canvas||doc.createElement('canvas');function createShape(ctx,args){ctx.beginPath();args.forEach(function(arg){ctx[arg.name].apply(ctx,arg['arguments']);});ctx.closePath();}
function safeImage(item){if(safeImages.indexOf(item['arguments'][0].src)===-1){testctx.drawImage(item['arguments'][0],0,0);try{testctx.getImageData(0,0,1,1);}catch(e){testCanvas=doc.createElement("canvas");testctx=testCanvas.getContext("2d");return false;}
safeImages.push(item['arguments'][0].src);}
return true;}
function renderItem(ctx,item){switch(item.type){case"variable":ctx[item.name]=item['arguments'];break;case"function":switch(item.name){case"createPattern":if(item['arguments'][0].width>0&&item['arguments'][0].height>0){try{ctx.fillStyle=ctx.createPattern(item['arguments'][0],"repeat");}
catch(e){Util.log("html2canvas: Renderer: Error creating pattern",e.message);}}
break;case"drawShape":createShape(ctx,item['arguments']);break;case"drawImage":if(item['arguments'][8]>0&&item['arguments'][7]>0){if(!options.taintTest||(options.taintTest&&safeImage(item))){ctx.drawImage.apply(ctx,item['arguments']);}}
break;default:ctx[item.name].apply(ctx,item['arguments']);}
break;}}
return function(parsedData,options,document,queue,_html2canvas){var ctx=canvas.getContext("2d"),newCanvas,bounds,fstyle,zStack=parsedData.stack;canvas.width=canvas.style.width=options.width||zStack.ctx.width;canvas.height=canvas.style.height=options.height||zStack.ctx.height;fstyle=ctx.fillStyle;ctx.fillStyle=(Util.isTransparent(zStack.backgroundColor)&&options.background!==undefined)?options.background:parsedData.backgroundColor;ctx.fillRect(0,0,canvas.width,canvas.height);ctx.fillStyle=fstyle;queue.forEach(function(storageContext){ctx.textBaseline="bottom";ctx.save();if(storageContext.transform.matrix){ctx.translate(storageContext.transform.origin[0],storageContext.transform.origin[1]);ctx.transform.apply(ctx,storageContext.transform.matrix);ctx.translate(-storageContext.transform.origin[0],-storageContext.transform.origin[1]);}
if(storageContext.clip){ctx.beginPath();ctx.rect(storageContext.clip.left,storageContext.clip.top,storageContext.clip.width,storageContext.clip.height);ctx.clip();}
if(storageContext.ctx.storage){storageContext.ctx.storage.forEach(function(item){renderItem(ctx,item);});}
ctx.restore();});Util.log("html2canvas: Renderer: Canvas renderer done - returning canvas obj");if(options.elements.length===1){if(typeof options.elements[0]==="object"&&options.elements[0].nodeName!=="BODY"){bounds=_html2canvas.Util.Bounds(options.elements[0]);newCanvas=document.createElement('canvas');newCanvas.width=Math.ceil(bounds.width);newCanvas.height=Math.ceil(bounds.height);ctx=newCanvas.getContext("2d");ctx.drawImage(canvas,bounds.left,bounds.top,bounds.width,bounds.height,0,0,bounds.width,bounds.height);canvas=null;return newCanvas;}}
return canvas;};};})(window,document);;

/* /point_of_sale/static/lib/backbone/backbone.js defined in bundle 'point_of_sale.assets' */
(function(){var root=this;var previousBackbone=root.Backbone;var array=[];var push=array.push;var slice=array.slice;var splice=array.splice;var Backbone;if(typeof exports!=='undefined'){Backbone=exports;}else{Backbone=root.Backbone={};}
Backbone.VERSION='1.1.0';var _=root._;if(!_&&(typeof require!=='undefined'))_=require('underscore');Backbone.$=root.jQuery||root.Zepto||root.ender||root.$;Backbone.noConflict=function(){root.Backbone=previousBackbone;return this;};Backbone.emulateHTTP=false;Backbone.emulateJSON=false;var Events=Backbone.Events={on:function(name,callback,context){if(!eventsApi(this,'on',name,[callback,context])||!callback)return this;this._events||(this._events={});var events=this._events[name]||(this._events[name]=[]);events.push({callback:callback,context:context,ctx:context||this});return this;},once:function(name,callback,context){if(!eventsApi(this,'once',name,[callback,context])||!callback)return this;var self=this;var once=_.once(function(){self.off(name,once);callback.apply(this,arguments);});once._callback=callback;return this.on(name,once,context);},off:function(name,callback,context){var retain,ev,events,names,i,l,j,k;if(!this._events||!eventsApi(this,'off',name,[callback,context]))return this;if(!name&&!callback&&!context){this._events={};return this;}
names=name?[name]:_.keys(this._events);for(i=0,l=names.length;i<l;i++){name=names[i];if(events=this._events[name]){this._events[name]=retain=[];if(callback||context){for(j=0,k=events.length;j<k;j++){ev=events[j];if((callback&&callback!==ev.callback&&callback!==ev.callback._callback)||(context&&context!==ev.context)){retain.push(ev);}}}
if(!retain.length)delete this._events[name];}}
return this;},trigger:function(name){if(!this._events)return this;var args=slice.call(arguments,1);if(!eventsApi(this,'trigger',name,args))return this;var events=this._events[name];var allEvents=this._events.all;if(events)triggerEvents(events,args);if(allEvents)triggerEvents(allEvents,arguments);return this;},stopListening:function(obj,name,callback){var listeningTo=this._listeningTo;if(!listeningTo)return this;var remove=!name&&!callback;if(!callback&&typeof name==='object')callback=this;if(obj)(listeningTo={})[obj._listenId]=obj;for(var id in listeningTo){obj=listeningTo[id];obj.off(name,callback,this);if(remove||_.isEmpty(obj._events))delete this._listeningTo[id];}
return this;}};var eventSplitter=/\s+/;var eventsApi=function(obj,action,name,rest){if(!name)return true;if(typeof name==='object'){for(var key in name){obj[action].apply(obj,[key,name[key]].concat(rest));}
return false;}
if(eventSplitter.test(name)){var names=name.split(eventSplitter);for(var i=0,l=names.length;i<l;i++){obj[action].apply(obj,[names[i]].concat(rest));}
return false;}
return true;};var triggerEvents=function(events,args){var ev,i=-1,l=events.length,a1=args[0],a2=args[1],a3=args[2];switch(args.length){case 0:while(++i<l)(ev=events[i]).callback.call(ev.ctx);return;case 1:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1);return;case 2:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1,a2);return;case 3:while(++i<l)(ev=events[i]).callback.call(ev.ctx,a1,a2,a3);return;default:while(++i<l)(ev=events[i]).callback.apply(ev.ctx,args);}};var listenMethods={listenTo:'on',listenToOnce:'once'};_.each(listenMethods,function(implementation,method){Events[method]=function(obj,name,callback){var listeningTo=this._listeningTo||(this._listeningTo={});var id=obj._listenId||(obj._listenId=_.uniqueId('l'));listeningTo[id]=obj;if(!callback&&typeof name==='object')callback=this;obj[implementation](name,callback,this);return this;};});Events.bind=Events.on;Events.unbind=Events.off;_.extend(Backbone,Events);var Model=Backbone.Model=function(attributes,options){var attrs=attributes||{};options||(options={});this.cid=_.uniqueId('c');this.attributes={};if(options.collection)this.collection=options.collection;if(options.parse)attrs=this.parse(attrs,options)||{};attrs=_.defaults({},attrs,_.result(this,'defaults'));this.set(attrs,options);this.changed={};this.initialize.apply(this,arguments);};_.extend(Model.prototype,Events,{changed:null,validationError:null,idAttribute:'id',initialize:function(){},toJSON:function(options){return _.clone(this.attributes);},sync:function(){return Backbone.sync.apply(this,arguments);},get:function(attr){return this.attributes[attr];},escape:function(attr){return _.escape(this.get(attr));},has:function(attr){return this.get(attr)!=null;},set:function(key,val,options){var attr,attrs,unset,changes,silent,changing,prev,current;if(key==null)return this;if(typeof key==='object'){attrs=key;options=val;}else{(attrs={})[key]=val;}
options||(options={});if(!this._validate(attrs,options))return false;unset=options.unset;silent=options.silent;changes=[];changing=this._changing;this._changing=true;if(!changing){this._previousAttributes=_.clone(this.attributes);this.changed={};}
current=this.attributes,prev=this._previousAttributes;if(this.idAttribute in attrs)this.id=attrs[this.idAttribute];for(attr in attrs){val=attrs[attr];if(!_.isEqual(current[attr],val))changes.push(attr);if(!_.isEqual(prev[attr],val)){this.changed[attr]=val;}else{delete this.changed[attr];}
unset?delete current[attr]:current[attr]=val;}
if(!silent){if(changes.length)this._pending=true;for(var i=0,l=changes.length;i<l;i++){this.trigger('change:'+changes[i],this,current[changes[i]],options);}}
if(changing)return this;if(!silent){while(this._pending){this._pending=false;this.trigger('change',this,options);}}
this._pending=false;this._changing=false;return this;},unset:function(attr,options){return this.set(attr,void 0,_.extend({},options,{unset:true}));},clear:function(options){var attrs={};for(var key in this.attributes)attrs[key]=void 0;return this.set(attrs,_.extend({},options,{unset:true}));},hasChanged:function(attr){if(attr==null)return!_.isEmpty(this.changed);return _.has(this.changed,attr);},changedAttributes:function(diff){if(!diff)return this.hasChanged()?_.clone(this.changed):false;var val,changed=false;var old=this._changing?this._previousAttributes:this.attributes;for(var attr in diff){if(_.isEqual(old[attr],(val=diff[attr])))continue;(changed||(changed={}))[attr]=val;}
return changed;},previous:function(attr){if(attr==null||!this._previousAttributes)return null;return this._previousAttributes[attr];},previousAttributes:function(){return _.clone(this._previousAttributes);},fetch:function(options){options=options?_.clone(options):{};if(options.parse===void 0)options.parse=true;var model=this;var success=options.success;options.success=function(resp){if(!model.set(model.parse(resp,options),options))return false;if(success)success(model,resp,options);model.trigger('sync',model,resp,options);};wrapError(this,options);return this.sync('read',this,options);},save:function(key,val,options){var attrs,method,xhr,attributes=this.attributes;if(key==null||typeof key==='object'){attrs=key;options=val;}else{(attrs={})[key]=val;}
options=_.extend({validate:true},options);if(attrs&&!options.wait){if(!this.set(attrs,options))return false;}else{if(!this._validate(attrs,options))return false;}
if(attrs&&options.wait){this.attributes=_.extend({},attributes,attrs);}
if(options.parse===void 0)options.parse=true;var model=this;var success=options.success;options.success=function(resp){model.attributes=attributes;var serverAttrs=model.parse(resp,options);if(options.wait)serverAttrs=_.extend(attrs||{},serverAttrs);if(_.isObject(serverAttrs)&&!model.set(serverAttrs,options)){return false;}
if(success)success(model,resp,options);model.trigger('sync',model,resp,options);};wrapError(this,options);method=this.isNew()?'create':(options.patch?'patch':'update');if(method==='patch')options.attrs=attrs;xhr=this.sync(method,this,options);if(attrs&&options.wait)this.attributes=attributes;return xhr;},destroy:function(options){options=options?_.clone(options):{};var model=this;var success=options.success;var destroy=function(){model.trigger('destroy',model,model.collection,options);};options.success=function(resp){if(options.wait||model.isNew())destroy();if(success)success(model,resp,options);if(!model.isNew())model.trigger('sync',model,resp,options);};if(this.isNew()){options.success();return false;}
wrapError(this,options);var xhr=this.sync('delete',this,options);if(!options.wait)destroy();return xhr;},url:function(){var base=_.result(this,'urlRoot')||_.result(this.collection,'url')||urlError();if(this.isNew())return base;return base+(base.charAt(base.length-1)==='/'?'':'/')+encodeURIComponent(this.id);},parse:function(resp,options){return resp;},clone:function(){return new this.constructor(this.attributes);},isNew:function(){return this.id==null;},isValid:function(options){return this._validate({},_.extend(options||{},{validate:true}));},_validate:function(attrs,options){if(!options.validate||!this.validate)return true;attrs=_.extend({},this.attributes,attrs);var error=this.validationError=this.validate(attrs,options)||null;if(!error)return true;this.trigger('invalid',this,error,_.extend(options,{validationError:error}));return false;}});var modelMethods=['keys','values','pairs','invert','pick','omit'];_.each(modelMethods,function(method){Model.prototype[method]=function(){var args=slice.call(arguments);args.unshift(this.attributes);return _[method].apply(_,args);};});var Collection=Backbone.Collection=function(models,options){options||(options={});if(options.model)this.model=options.model;if(options.comparator!==void 0)this.comparator=options.comparator;this._reset();this.initialize.apply(this,arguments);if(models)this.reset(models,_.extend({silent:true},options));};var setOptions={add:true,remove:true,merge:true};var addOptions={add:true,remove:false};_.extend(Collection.prototype,Events,{model:Model,initialize:function(){},toJSON:function(options){return this.map(function(model){return model.toJSON(options);});},sync:function(){return Backbone.sync.apply(this,arguments);},add:function(models,options){return this.set(models,_.extend({merge:false},options,addOptions));},remove:function(models,options){var singular=!_.isArray(models);models=singular?[models]:_.clone(models);options||(options={});var i,l,index,model;for(i=0,l=models.length;i<l;i++){model=models[i]=this.get(models[i]);if(!model)continue;delete this._byId[model.id];delete this._byId[model.cid];index=this.indexOf(model);this.models.splice(index,1);this.length--;if(!options.silent){options.index=index;model.trigger('remove',model,this,options);}
this._removeReference(model);}
return singular?models[0]:models;},set:function(models,options){options=_.defaults({},options,setOptions);if(options.parse)models=this.parse(models,options);var singular=!_.isArray(models);models=singular?(models?[models]:[]):_.clone(models);var i,l,id,model,attrs,existing,sort;var at=options.at;var targetModel=this.model;var sortable=this.comparator&&(at==null)&&options.sort!==false;var sortAttr=_.isString(this.comparator)?this.comparator:null;var toAdd=[],toRemove=[],modelMap={};var add=options.add,merge=options.merge,remove=options.remove;var order=!sortable&&add&&remove?[]:false;for(i=0,l=models.length;i<l;i++){attrs=models[i];if(attrs instanceof Model){id=model=attrs;}else{id=attrs[targetModel.prototype.idAttribute];}
if(existing=this.get(id)){if(remove)modelMap[existing.cid]=true;if(merge){attrs=attrs===model?model.attributes:attrs;if(options.parse)attrs=existing.parse(attrs,options);existing.set(attrs,options);if(sortable&&!sort&&existing.hasChanged(sortAttr))sort=true;}
models[i]=existing;}else if(add){model=models[i]=this._prepareModel(attrs,options);if(!model)continue;toAdd.push(model);model.on('all',this._onModelEvent,this);this._byId[model.cid]=model;if(model.id!=null)this._byId[model.id]=model;}
if(order)order.push(existing||model);}
if(remove){for(i=0,l=this.length;i<l;++i){if(!modelMap[(model=this.models[i]).cid])toRemove.push(model);}
if(toRemove.length)this.remove(toRemove,options);}
if(toAdd.length||(order&&order.length)){if(sortable)sort=true;this.length+=toAdd.length;if(at!=null){for(i=0,l=toAdd.length;i<l;i++){this.models.splice(at+i,0,toAdd[i]);}}else{if(order)this.models.length=0;var orderedModels=order||toAdd;for(i=0,l=orderedModels.length;i<l;i++){this.models.push(orderedModels[i]);}}}
if(sort)this.sort({silent:true});if(!options.silent){for(i=0,l=toAdd.length;i<l;i++){(model=toAdd[i]).trigger('add',model,this,options);}
if(sort||(order&&order.length))this.trigger('sort',this,options);}
return singular?models[0]:models;},reset:function(models,options){options||(options={});for(var i=0,l=this.models.length;i<l;i++){this._removeReference(this.models[i]);}
options.previousModels=this.models;this._reset();models=this.add(models,_.extend({silent:true},options));if(!options.silent)this.trigger('reset',this,options);return models;},push:function(model,options){return this.add(model,_.extend({at:this.length},options));},pop:function(options){var model=this.at(this.length-1);this.remove(model,options);return model;},unshift:function(model,options){return this.add(model,_.extend({at:0},options));},shift:function(options){var model=this.at(0);this.remove(model,options);return model;},slice:function(){return slice.apply(this.models,arguments);},get:function(obj){if(obj==null)return void 0;return this._byId[obj.id]||this._byId[obj.cid]||this._byId[obj];},at:function(index){return this.models[index];},where:function(attrs,first){if(_.isEmpty(attrs))return first?void 0:[];return this[first?'find':'filter'](function(model){for(var key in attrs){if(attrs[key]!==model.get(key))return false;}
return true;});},findWhere:function(attrs){return this.where(attrs,true);},sort:function(options){if(!this.comparator)throw new Error('Cannot sort a set without a comparator');options||(options={});if(_.isString(this.comparator)||this.comparator.length===1){this.models=this.sortBy(this.comparator,this);}else{this.models.sort(_.bind(this.comparator,this));}
if(!options.silent)this.trigger('sort',this,options);return this;},pluck:function(attr){return _.invoke(this.models,'get',attr);},fetch:function(options){options=options?_.clone(options):{};if(options.parse===void 0)options.parse=true;var success=options.success;var collection=this;options.success=function(resp){var method=options.reset?'reset':'set';collection[method](resp,options);if(success)success(collection,resp,options);collection.trigger('sync',collection,resp,options);};wrapError(this,options);return this.sync('read',this,options);},create:function(model,options){options=options?_.clone(options):{};if(!(model=this._prepareModel(model,options)))return false;if(!options.wait)this.add(model,options);var collection=this;var success=options.success;options.success=function(model,resp,options){if(options.wait)collection.add(model,options);if(success)success(model,resp,options);};model.save(null,options);return model;},parse:function(resp,options){return resp;},clone:function(){return new this.constructor(this.models);},_reset:function(){this.length=0;this.models=[];this._byId={};},_prepareModel:function(attrs,options){if(attrs instanceof Model){if(!attrs.collection)attrs.collection=this;return attrs;}
options=options?_.clone(options):{};options.collection=this;var model=new this.model(attrs,options);if(!model.validationError)return model;this.trigger('invalid',this,model.validationError,options);return false;},_removeReference:function(model){if(this===model.collection)delete model.collection;model.off('all',this._onModelEvent,this);},_onModelEvent:function(event,model,collection,options){if((event==='add'||event==='remove')&&collection!==this)return;if(event==='destroy')this.remove(model,options);if(model&&event==='change:'+model.idAttribute){delete this._byId[model.previous(model.idAttribute)];if(model.id!=null)this._byId[model.id]=model;}
this.trigger.apply(this,arguments);}});var methods=['forEach','each','map','collect','reduce','foldl','inject','reduceRight','foldr','find','detect','filter','select','reject','every','all','some','any','include','contains','invoke','max','min','toArray','size','first','head','take','initial','rest','tail','drop','last','without','difference','indexOf','shuffle','lastIndexOf','isEmpty','chain'];_.each(methods,function(method){Collection.prototype[method]=function(){var args=slice.call(arguments);args.unshift(this.models);return _[method].apply(_,args);};});var attributeMethods=['groupBy','countBy','sortBy'];_.each(attributeMethods,function(method){Collection.prototype[method]=function(value,context){var iterator=_.isFunction(value)?value:function(model){return model.get(value);};return _[method](this.models,iterator,context);};});var View=Backbone.View=function(options){this.cid=_.uniqueId('view');options||(options={});_.extend(this,_.pick(options,viewOptions));this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents();};var delegateEventSplitter=/^(\S+)\s*(.*)$/;var viewOptions=['model','collection','el','id','attributes','className','tagName','events'];_.extend(View.prototype,Events,{tagName:'div',$:function(selector){return this.$el.find(selector);},initialize:function(){},render:function(){return this;},remove:function(){this.$el.remove();this.stopListening();return this;},setElement:function(element,delegate){if(this.$el)this.undelegateEvents();this.$el=element instanceof Backbone.$?element:Backbone.$(element);this.el=this.$el[0];if(delegate!==false)this.delegateEvents();return this;},delegateEvents:function(events){if(!(events||(events=_.result(this,'events'))))return this;this.undelegateEvents();for(var key in events){var method=events[key];if(!_.isFunction(method))method=this[events[key]];if(!method)continue;var match=key.match(delegateEventSplitter);var eventName=match[1],selector=match[2];method=_.bind(method,this);eventName+='.delegateEvents'+this.cid;if(selector===''){this.$el.on(eventName,method);}else{this.$el.on(eventName,selector,method);}}
return this;},undelegateEvents:function(){this.$el.off('.delegateEvents'+this.cid);return this;},_ensureElement:function(){if(!this.el){var attrs=_.extend({},_.result(this,'attributes'));if(this.id)attrs.id=_.result(this,'id');if(this.className)attrs['class']=_.result(this,'className');var $el=Backbone.$('<'+_.result(this,'tagName')+'>').attr(attrs);this.setElement($el,false);}else{this.setElement(_.result(this,'el'),false);}}});Backbone.sync=function(method,model,options){var type=methodMap[method];_.defaults(options||(options={}),{emulateHTTP:Backbone.emulateHTTP,emulateJSON:Backbone.emulateJSON});var params={type:type,dataType:'json'};if(!options.url){params.url=_.result(model,'url')||urlError();}
if(options.data==null&&model&&(method==='create'||method==='update'||method==='patch')){params.contentType='application/json';params.data=JSON.stringify(options.attrs||model.toJSON(options));}
if(options.emulateJSON){params.contentType='application/x-www-form-urlencoded';params.data=params.data?{model:params.data}:{};}
if(options.emulateHTTP&&(type==='PUT'||type==='DELETE'||type==='PATCH')){params.type='POST';if(options.emulateJSON)params.data._method=type;var beforeSend=options.beforeSend;options.beforeSend=function(xhr){xhr.setRequestHeader('X-HTTP-Method-Override',type);if(beforeSend)return beforeSend.apply(this,arguments);};}
if(params.type!=='GET'&&!options.emulateJSON){params.processData=false;}
if(params.type==='PATCH'&&noXhrPatch){params.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP");};}
var xhr=options.xhr=Backbone.ajax(_.extend(params,options));model.trigger('request',model,xhr,options);return xhr;};var noXhrPatch=typeof window!=='undefined'&&!!window.ActiveXObject&&!(window.XMLHttpRequest&&(new XMLHttpRequest).dispatchEvent);var methodMap={'create':'POST','update':'PUT','patch':'PATCH','delete':'DELETE','read':'GET'};Backbone.ajax=function(){return Backbone.$.ajax.apply(Backbone.$,arguments);};var Router=Backbone.Router=function(options){options||(options={});if(options.routes)this.routes=options.routes;this._bindRoutes();this.initialize.apply(this,arguments);};var optionalParam=/\((.*?)\)/g;var namedParam=/(\(\?)?:\w+/g;var splatParam=/\*\w+/g;var escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g;_.extend(Router.prototype,Events,{initialize:function(){},route:function(route,name,callback){if(!_.isRegExp(route))route=this._routeToRegExp(route);if(_.isFunction(name)){callback=name;name='';}
if(!callback)callback=this[name];var router=this;Backbone.history.route(route,function(fragment){var args=router._extractParameters(route,fragment);callback&&callback.apply(router,args);router.trigger.apply(router,['route:'+name].concat(args));router.trigger('route',name,args);Backbone.history.trigger('route',router,name,args);});return this;},navigate:function(fragment,options){Backbone.history.navigate(fragment,options);return this;},_bindRoutes:function(){if(!this.routes)return;this.routes=_.result(this,'routes');var route,routes=_.keys(this.routes);while((route=routes.pop())!=null){this.route(route,this.routes[route]);}},_routeToRegExp:function(route){route=route.replace(escapeRegExp,'\\$&').replace(optionalParam,'(?:$1)?').replace(namedParam,function(match,optional){return optional?match:'([^\/]+)';}).replace(splatParam,'(.*?)');return new RegExp('^'+route+'$');},_extractParameters:function(route,fragment){var params=route.exec(fragment).slice(1);return _.map(params,function(param){return param?decodeURIComponent(param):null;});}});var History=Backbone.History=function(){this.handlers=[];_.bindAll(this,'checkUrl');if(typeof window!=='undefined'){this.location=window.location;this.history=window.history;}};var routeStripper=/^[#\/]|\s+$/g;var rootStripper=/^\/+|\/+$/g;var isExplorer=/msie [\w.]+/;var trailingSlash=/\/$/;var pathStripper=/[?#].*$/;History.started=false;_.extend(History.prototype,Events,{interval:50,getHash:function(window){var match=(window||this).location.href.match(/#(.*)$/);return match?match[1]:'';},getFragment:function(fragment,forcePushState){if(fragment==null){if(this._hasPushState||!this._wantsHashChange||forcePushState){fragment=this.location.pathname;var root=this.root.replace(trailingSlash,'');if(!fragment.indexOf(root))fragment=fragment.slice(root.length);}else{fragment=this.getHash();}}
return fragment.replace(routeStripper,'');},start:function(options){if(History.started)throw new Error("Backbone.history has already been started");History.started=true;this.options=_.extend({root:'/'},this.options,options);this.root=this.options.root;this._wantsHashChange=this.options.hashChange!==false;this._wantsPushState=!!this.options.pushState;this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var fragment=this.getFragment();var docMode=document.documentMode;var oldIE=(isExplorer.exec(navigator.userAgent.toLowerCase())&&(!docMode||docMode<=7));this.root=('/'+this.root+'/').replace(rootStripper,'/');if(oldIE&&this._wantsHashChange){this.iframe=Backbone.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo('body')[0].contentWindow;this.navigate(fragment);}
if(this._hasPushState){Backbone.$(window).on('popstate',this.checkUrl);}else if(this._wantsHashChange&&('onhashchange'in window)&&!oldIE){Backbone.$(window).on('hashchange',this.checkUrl);}else if(this._wantsHashChange){this._checkUrlInterval=setInterval(this.checkUrl,this.interval);}
this.fragment=fragment;var loc=this.location;var atRoot=loc.pathname.replace(/[^\/]$/,'$&/')===this.root;if(this._wantsHashChange&&this._wantsPushState){if(!this._hasPushState&&!atRoot){this.fragment=this.getFragment(null,true);this.location.replace(this.root+this.location.search+'#'+this.fragment);return true;}else if(this._hasPushState&&atRoot&&loc.hash){this.fragment=this.getHash().replace(routeStripper,'');this.history.replaceState({},document.title,this.root+this.fragment+loc.search);}}
if(!this.options.silent)return this.loadUrl();},stop:function(){Backbone.$(window).off('popstate',this.checkUrl).off('hashchange',this.checkUrl);clearInterval(this._checkUrlInterval);History.started=false;},route:function(route,callback){this.handlers.unshift({route:route,callback:callback});},checkUrl:function(e){var current=this.getFragment();if(current===this.fragment&&this.iframe){current=this.getFragment(this.getHash(this.iframe));}
if(current===this.fragment)return false;if(this.iframe)this.navigate(current);this.loadUrl();},loadUrl:function(fragment){fragment=this.fragment=this.getFragment(fragment);return _.any(this.handlers,function(handler){if(handler.route.test(fragment)){handler.callback(fragment);return true;}});},navigate:function(fragment,options){if(!History.started)return false;if(!options||options===true)options={trigger:!!options};var url=this.root+(fragment=this.getFragment(fragment||''));fragment=fragment.replace(pathStripper,'');if(this.fragment===fragment)return;this.fragment=fragment;if(fragment===''&&url!=='/')url=url.slice(0,-1);if(this._hasPushState){this.history[options.replace?'replaceState':'pushState']({},document.title,url);}else if(this._wantsHashChange){this._updateHash(this.location,fragment,options.replace);if(this.iframe&&(fragment!==this.getFragment(this.getHash(this.iframe)))){if(!options.replace)this.iframe.document.open().close();this._updateHash(this.iframe.location,fragment,options.replace);}}else{return this.location.assign(url);}
if(options.trigger)return this.loadUrl(fragment);},_updateHash:function(location,fragment,replace){if(replace){var href=location.href.replace(/(javascript:|#).*$/,'');location.replace(href+'#'+fragment);}else{location.hash='#'+fragment;}}});Backbone.history=new History;var extend=function(protoProps,staticProps){var parent=this;var child;if(protoProps&&_.has(protoProps,'constructor')){child=protoProps.constructor;}else{child=function(){return parent.apply(this,arguments);};}
_.extend(child,parent,staticProps);var Surrogate=function(){this.constructor=child;};Surrogate.prototype=parent.prototype;child.prototype=new Surrogate;if(protoProps)_.extend(child.prototype,protoProps);child.__super__=parent.prototype;return child;};Model.extend=Collection.extend=Router.extend=View.extend=History.extend=extend;var urlError=function(){throw new Error('A "url" property or function must be specified');};var wrapError=function(model,options){var error=options.error;options.error=function(resp){if(error)error(model,resp,options);model.trigger('error',model,resp,options);};};}).call(this);;

/* /point_of_sale/static/lib/waitfont.js defined in bundle 'point_of_sale.assets' */
(function(){function waitForWebfonts(fonts,callback){var loadedFonts=0;for(var i=0,l=fonts.length;i<l;++i){(function(font){var node=document.createElement('span');node.innerHTML='giItT1WQy@!-/#';node.style.position='absolute';node.style.left='-10000px';node.style.top='-10000px';node.style.fontSize='300px';node.style.fontFamily='sans-serif';node.style.fontVariant='normal';node.style.fontStyle='normal';node.style.fontWeight='normal';node.style.letterSpacing='0';document.body.appendChild(node);var width=node.offsetWidth;node.style.fontFamily=font;var interval;function checkFont(){if(node&&node.offsetWidth!=width){++loadedFonts;node.parentNode.removeChild(node);node=null;}
if(loadedFonts>=fonts.length){if(interval){clearInterval(interval);}
if(loadedFonts==fonts.length){callback();return true;}}};if(!checkFont()){interval=setInterval(checkFont,50);}})(fonts[i]);}}
window.waitForWebfonts=waitForWebfonts;})();;

/* /point_of_sale/static/lib/sha1.js defined in bundle 'point_of_sale.assets' */
'use strict';var Sha1={};Sha1.hash=function(msg){msg=msg.utf8Encode();var K=[0x5a827999,0x6ed9eba1,0x8f1bbcdc,0xca62c1d6];msg+=String.fromCharCode(0x80);var l=msg.length/4+2;var N=Math.ceil(l/16);var M=new Array(N);for(var i=0;i<N;i++){M[i]=new Array(16);for(var j=0;j<16;j++){M[i][j]=(msg.charCodeAt(i*64+j*4)<<24)|(msg.charCodeAt(i*64+j*4+1)<<16)|(msg.charCodeAt(i*64+j*4+2)<<8)|(msg.charCodeAt(i*64+j*4+3));}}
M[N-1][14]=((msg.length-1)*8)/Math.pow(2,32);M[N-1][14]=Math.floor(M[N-1][14]);M[N-1][15]=((msg.length-1)*8)&0xffffffff;var H0=0x67452301;var H1=0xefcdab89;var H2=0x98badcfe;var H3=0x10325476;var H4=0xc3d2e1f0;var W=new Array(80);var a,b,c,d,e;for(var i=0;i<N;i++){for(var t=0;t<16;t++)W[t]=M[i][t];for(var t=16;t<80;t++)W[t]=Sha1.ROTL(W[t-3]^W[t-8]^W[t-14]^W[t-16],1);a=H0;b=H1;c=H2;d=H3;e=H4;for(var t=0;t<80;t++){var s=Math.floor(t/20);var T=(Sha1.ROTL(a,5)+Sha1.f(s,b,c,d)+e+K[s]+W[t])&0xffffffff;e=d;d=c;c=Sha1.ROTL(b,30);b=a;a=T;}
H0=(H0+a)&0xffffffff;H1=(H1+b)&0xffffffff;H2=(H2+c)&0xffffffff;H3=(H3+d)&0xffffffff;H4=(H4+e)&0xffffffff;}
return Sha1.toHexStr(H0)+Sha1.toHexStr(H1)+Sha1.toHexStr(H2)+
Sha1.toHexStr(H3)+Sha1.toHexStr(H4);};Sha1.f=function(s,x,y,z){switch(s){case 0:return(x&y)^(~x&z);case 1:return x^y^z;case 2:return(x&y)^(x&z)^(y&z);case 3:return x^y^z;}};Sha1.ROTL=function(x,n){return(x<<n)|(x>>>(32-n));};Sha1.toHexStr=function(n){var s="",v;for(var i=7;i>=0;i--){v=(n>>>(i*4))&0xf;s+=v.toString(16);}
return s;};if(typeof String.prototype.utf8Encode=='undefined'){String.prototype.utf8Encode=function(){return unescape(encodeURIComponent(this));};}
if(typeof String.prototype.utf8Decode=='undefined'){String.prototype.utf8Decode=function(){try{return decodeURIComponent(escape(this));}catch(e){return this;}};}
if(typeof module!='undefined'&&module.exports)module.exports=Sha1;if(typeof define=='function'&&define.amd)define([],function(){return Sha1;});;

/* /point_of_sale/static/src/js/utils.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.utils',function(require){'use strict';const{EventBus}=owl.core;function getFileAsText(file){return new Promise((resolve,reject)=>{if(!file){reject();}else{const reader=new FileReader();reader.addEventListener('load',function(){resolve(reader.result);});reader.addEventListener('abort',reject);reader.addEventListener('error',reject);reader.readAsText(file);}});}
let timer=null;const nextFrame=()=>{return new Promise((resolve)=>{cancelAnimationFrame(timer);timer=requestAnimationFrame(()=>{resolve();});});};function isRpcError(error){return(!(error instanceof Error)&&error.message&&[100,200,404,-32098].includes(error.message.code));}
return{getFileAsText,nextFrame,isRpcError,posbus:new EventBus()};});;

/* /point_of_sale/static/src/js/ClassRegistry.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ClassRegistry',function(require){'use strict';class ClassRegistry{constructor(){this.baseNameMap={};this.includedMap=new Map();this.extendedCBMap=new Map();this.extendedSuperMap=new Map();this.cache=new Map();}
add(baseClass){this.includedMap.set(baseClass,[]);this.baseNameMap[baseClass.name]=baseClass;}
addByExtending(baseClassCB,base){this.extendedCBMap.set(baseClassCB,[baseClassCB]);this.extendedSuperMap.set(baseClassCB,base);this.baseNameMap[baseClassCB.name]=baseClassCB;}
extend(base,extensionCB){if(typeof base==='string'){base=this.baseNameMap[base];}
let extensionArray;if(this.includedMap.get(base)){extensionArray=this.includedMap.get(base);}else if(this.extendedCBMap.get(base)){extensionArray=this.extendedCBMap.get(base);}else{throw new Error(`'${base.name}' is not in the Registry. Add it to Registry before extending.`);}
extensionArray.push(extensionCB);const locOfNewExtension=extensionArray.length-1;const self=this;const oldCompiled=this.isFrozen?this.cache.get(base):null;return{remove(){extensionArray.splice(locOfNewExtension,1);self._recompute(base,oldCompiled);},compile(){self._recompute(base);}};}
_compile(base){let res;if(this.includedMap.has(base)){res=this.includedMap.get(base).reduce((acc,ext)=>ext(acc),base);}else{const superClass=this.extendedSuperMap.get(base);const extensionCBs=this.extendedCBMap.get(base);res=extensionCBs.reduce((acc,ext)=>ext(acc),this._compile(superClass));}
Object.defineProperty(res,'name',{value:base.name});return res;}
get(base){if(typeof base==='string'){base=this.baseNameMap[base];}
if(this.isFrozen){return this.cache.get(base);}
return this._compile(base);}
freeze(){for(let[baseClass,extensionCBs]of this.includedMap.entries()){const compiled=extensionCBs.reduce((acc,ext)=>ext(acc),baseClass);this.cache.set(baseClass,compiled);}
const remaining=[];for(let[baseClassCB,extensionCBArray]of this.extendedCBMap.entries()){const compiled=this.cache.get(this.extendedSuperMap.get(baseClassCB));if(!compiled){remaining.push([baseClassCB,extensionCBArray]);continue;}
const extendedClass=extensionCBArray.reduce((acc,extensionCB)=>extensionCB(acc),compiled);this.cache.set(baseClassCB,extendedClass);}
for(let[baseClassCB,extensionCBArray]of remaining){const compiled=this.cache.get(this.extendedSuperMap.get(baseClassCB));const extendedClass=extensionCBArray.reduce((acc,extensionCB)=>extensionCB(acc),compiled);this.cache.set(baseClassCB,extendedClass);}
for(let[base,compiledClass]of this.cache.entries()){Object.defineProperty(compiledClass,'name',{value:base.name});}
this.isFrozen=true;}
_recompute(base,old){if(typeof base==='string'){base=this.baseNameMap[base];}
return old?old:this._compile(base);}}
return ClassRegistry;});;

/* /point_of_sale/static/src/js/PosComponent.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.PosComponent',function(require){'use strict';const{Component}=owl;class PosComponent extends Component{showPopup(name,props){return new Promise((resolve)=>{this.trigger('show-popup',{name,props,resolve});});}
showTempScreen(name,props){return new Promise((resolve)=>{this.trigger('show-temp-screen',{name,props,resolve});});}
showScreen(name,props){this.trigger('show-main-screen',{name,props});}
playSound(name){this.trigger('play-sound',name);}
setSyncStatus(status,pending){this.trigger('set-sync-status',{status,pending});}}
return PosComponent;});;

/* /point_of_sale/static/src/js/PosContext.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.PosContext',function(require){'use strict';const{Context}=owl;return{orderManagement:new Context({searchString:'',selectedOrder:null}),chrome:new Context({showOrderSelector:true}),};});;

/* /point_of_sale/static/src/js/ComponentRegistry.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ComponentRegistry',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const ClassRegistry=require('point_of_sale.ClassRegistry');class ComponentRegistry extends ClassRegistry{freeze(){super.freeze();PosComponent.components={};for(let[base,compiledClass]of this.cache.entries()){PosComponent.components[base.name]=compiledClass;}}
_recompute(base,old){const res=super._recompute(base,old);if(typeof base==='string'){base=this.baseNameMap[base];}
PosComponent.components[base.name]=res;return res;}}
return ComponentRegistry;});;

/* /point_of_sale/static/src/js/Registries.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.Registries',function(require){'use strict';const ComponentRegistry=require('point_of_sale.ComponentRegistry');return{Component:new ComponentRegistry()};});;

/* /point_of_sale/static/src/js/db.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.DB',function(require){"use strict";var core=require('web.core');var utils=require('web.utils');var PosDB=core.Class.extend({name:'openerp_pos_db',limit:100,init:function(options){options=options||{};this.name=options.name||this.name;this.limit=options.limit||this.limit;if(options.uuid){this.name=this.name+'_'+options.uuid;}
this.cache={};this.product_by_id={};this.product_by_barcode={};this.product_by_category_id={};this.partner_sorted=[];this.partner_by_id={};this.partner_by_barcode={};this.partner_search_string="";this.partner_write_date=null;this.category_by_id={};this.root_category_id=0;this.category_products={};this.category_ancestors={};this.category_childs={};this.category_parent={};this.category_search_string={};},set_uuid:function(uuid){this.name=this.name+'_'+uuid;},get_category_by_id:function(categ_id){if(categ_id instanceof Array){var list=[];for(var i=0,len=categ_id.length;i<len;i++){var cat=this.category_by_id[categ_id[i]];if(cat){list.push(cat);}else{console.error("get_category_by_id: no category has id:",categ_id[i]);}}
return list;}else{return this.category_by_id[categ_id];}},get_category_childs_ids:function(categ_id){return this.category_childs[categ_id]||[];},get_category_ancestors_ids:function(categ_id){return this.category_ancestors[categ_id]||[];},get_category_parent_id:function(categ_id){return this.category_parent[categ_id]||this.root_category_id;},add_categories:function(categories){var self=this;if(!this.category_by_id[this.root_category_id]){this.category_by_id[this.root_category_id]={id:this.root_category_id,name:'Root',};}
categories.forEach(function(cat){self.category_by_id[cat.id]=cat;});categories.forEach(function(cat){var parent_id=cat.parent_id[0];if(!(parent_id&&self.category_by_id[parent_id])){parent_id=self.root_category_id;}
self.category_parent[cat.id]=parent_id;if(!self.category_childs[parent_id]){self.category_childs[parent_id]=[];}
self.category_childs[parent_id].push(cat.id);});function make_ancestors(cat_id,ancestors){self.category_ancestors[cat_id]=ancestors;ancestors=ancestors.slice(0);ancestors.push(cat_id);var childs=self.category_childs[cat_id]||[];for(var i=0,len=childs.length;i<len;i++){make_ancestors(childs[i],ancestors);}}
make_ancestors(this.root_category_id,[]);},category_contains:function(categ_id,product_id){var product=this.product_by_id[product_id];if(product){var cid=product.pos_categ_id[0];while(cid&&cid!==categ_id){cid=this.category_parent[cid];}
return!!cid;}
return false;},load:function(store,deft){if(this.cache[store]!==undefined){return this.cache[store];}
var data=localStorage[this.name+'_'+store];if(data!==undefined&&data!==""){data=JSON.parse(data);this.cache[store]=data;return data;}else{return deft;}},save:function(store,data){localStorage[this.name+'_'+store]=JSON.stringify(data);this.cache[store]=data;},_product_search_string:function(product){var str=product.display_name;if(product.barcode){str+='|'+product.barcode;}
if(product.default_code){str+='|'+product.default_code;}
if(product.description){str+='|'+product.description;}
if(product.description_sale){str+='|'+product.description_sale;}
str=product.id+':'+str.replace(/:/g,'')+'\n';return str;},add_products:function(products){var stored_categories=this.product_by_category_id;if(!products instanceof Array){products=[products];}
for(var i=0,len=products.length;i<len;i++){var product=products[i];if(product.id in this.product_by_id)continue;if(product.available_in_pos){var search_string=utils.unaccent(this._product_search_string(product));var categ_id=product.pos_categ_id?product.pos_categ_id[0]:this.root_category_id;product.product_tmpl_id=product.product_tmpl_id[0];if(!stored_categories[categ_id]){stored_categories[categ_id]=[];}
stored_categories[categ_id].push(product.id);if(this.category_search_string[categ_id]===undefined){this.category_search_string[categ_id]='';}
this.category_search_string[categ_id]+=search_string;var ancestors=this.get_category_ancestors_ids(categ_id)||[];for(var j=0,jlen=ancestors.length;j<jlen;j++){var ancestor=ancestors[j];if(!stored_categories[ancestor]){stored_categories[ancestor]=[];}
stored_categories[ancestor].push(product.id);if(this.category_search_string[ancestor]===undefined){this.category_search_string[ancestor]='';}
this.category_search_string[ancestor]+=search_string;}}
this.product_by_id[product.id]=product;if(product.barcode){this.product_by_barcode[product.barcode]=product;}}},_partner_search_string:function(partner){var str=partner.name||'';if(partner.barcode){str+='|'+partner.barcode;}
if(partner.address){str+='|'+partner.address;}
if(partner.phone){str+='|'+partner.phone.split(' ').join('');}
if(partner.mobile){str+='|'+partner.mobile.split(' ').join('');}
if(partner.email){str+='|'+partner.email;}
if(partner.vat){str+='|'+partner.vat;}
str=''+partner.id+':'+str.replace(':','').replace(/\n/g,' ')+'\n';return str;},add_partners:function(partners){var updated_count=0;var new_write_date='';var partner;for(var i=0,len=partners.length;i<len;i++){partner=partners[i];var local_partner_date=(this.partner_write_date||'').replace(/^(\d{4}-\d{2}-\d{2}) ((\d{2}:?){3})$/,'$1T$2Z');var dist_partner_date=(partner.write_date||'').replace(/^(\d{4}-\d{2}-\d{2}) ((\d{2}:?){3})$/,'$1T$2Z');if(this.partner_write_date&&this.partner_by_id[partner.id]&&new Date(local_partner_date).getTime()+1000>=new Date(dist_partner_date).getTime()){continue;}else if(new_write_date<partner.write_date){new_write_date=partner.write_date;}
if(!this.partner_by_id[partner.id]){this.partner_sorted.push(partner.id);}
this.partner_by_id[partner.id]=partner;updated_count+=1;}
this.partner_write_date=new_write_date||this.partner_write_date;if(updated_count){this.partner_search_string="";this.partner_by_barcode={};for(var id in this.partner_by_id){partner=this.partner_by_id[id];if(partner.barcode){this.partner_by_barcode[partner.barcode]=partner;}
partner.address=(partner.street?partner.street+', ':'')+
(partner.zip?partner.zip+', ':'')+
(partner.city?partner.city+', ':'')+
(partner.state_id?partner.state_id[1]+', ':'')+
(partner.country_id?partner.country_id[1]:'');this.partner_search_string+=this._partner_search_string(partner);}
this.partner_search_string=utils.unaccent(this.partner_search_string);}
return updated_count;},get_partner_write_date:function(){return this.partner_write_date||"1970-01-01 00:00:00";},get_partner_by_id:function(id){return this.partner_by_id[id];},get_partner_by_barcode:function(barcode){return this.partner_by_barcode[barcode];},get_partners_sorted:function(max_count){max_count=max_count?Math.min(this.partner_sorted.length,max_count):this.partner_sorted.length;var partners=[];for(var i=0;i<max_count;i++){partners.push(this.partner_by_id[this.partner_sorted[i]]);}
return partners;},search_partner:function(query){try{query=query.replace(/[\[\]\(\)\+\*\?\.\-\!\&\^\$\|\~\_\{\}\:\,\\\/]/g,'.');query=query.replace(/ /g,'.+');var re=RegExp("([0-9]+):.*?"+utils.unaccent(query),"gi");}catch(e){return[];}
var results=[];for(var i=0;i<this.limit;i++){var r=re.exec(this.partner_search_string);if(r){var id=Number(r[1]);results.push(this.get_partner_by_id(id));}else{break;}}
return results;},clear:function(){for(var i=0,len=arguments.length;i<len;i++){localStorage.removeItem(this.name+'_'+arguments[i]);}},_count_props:function(obj){var count=0;for(var prop in obj){if(obj.hasOwnProperty(prop)){count++;}}
return count;},get_product_by_id:function(id){return this.product_by_id[id];},get_product_by_barcode:function(barcode){if(this.product_by_barcode[barcode]){return this.product_by_barcode[barcode];}else{return undefined;}},get_product_by_category:function(category_id){var product_ids=this.product_by_category_id[category_id];var list=[];if(product_ids){for(var i=0,len=Math.min(product_ids.length,this.limit);i<len;i++){list.push(this.product_by_id[product_ids[i]]);}}
return list;},search_product_in_category:function(category_id,query){try{query=query.replace(/[\[\]\(\)\+\*\?\.\-\!\&\^\$\|\~\_\{\}\:\,\\\/]/g,'.');query=query.replace(/ /g,'.+');var re=RegExp("([0-9]+):.*?"+utils.unaccent(query),"gi");}catch(e){return[];}
var results=[];for(var i=0;i<this.limit;i++){var r=re.exec(this.category_search_string[category_id]);if(r){var id=Number(r[1]);results.push(this.get_product_by_id(id));}else{break;}}
return results;},is_product_in_category:function(category_ids,product_id){if(!(category_ids instanceof Array)){category_ids=[category_ids];}
var cat=this.get_product_by_id(product_id).pos_categ_id[0];while(cat){for(var i=0;i<category_ids.length;i++){if(cat==category_ids[i]){return true;}}
cat=this.get_category_parent_id(cat);}
return false;},add_order:function(order){var order_id=order.uid;var orders=this.load('orders',[]);for(var i=0,len=orders.length;i<len;i++){if(orders[i].id===order_id){orders[i].data=order;this.save('orders',orders);return order_id;}}
this.remove_unpaid_order(order);orders.push({id:order_id,data:order});this.save('orders',orders);return order_id;},remove_order:function(order_id){var orders=this.load('orders',[]);orders=_.filter(orders,function(order){return order.id!==order_id;});this.save('orders',orders);},remove_all_orders:function(){this.save('orders',[]);},get_orders:function(){return this.load('orders',[]);},get_order:function(order_id){var orders=this.get_orders();for(var i=0,len=orders.length;i<len;i++){if(orders[i].id===order_id){return orders[i];}}
return undefined;},save_unpaid_order:function(order){var order_id=order.uid;var orders=this.load('unpaid_orders',[]);var serialized=order.export_as_JSON();for(var i=0;i<orders.length;i++){if(orders[i].id===order_id){orders[i].data=serialized;this.save('unpaid_orders',orders);return order_id;}}
orders.push({id:order_id,data:serialized});this.save('unpaid_orders',orders);return order_id;},remove_unpaid_order:function(order){var orders=this.load('unpaid_orders',[]);orders=_.filter(orders,function(o){return o.id!==order.uid;});this.save('unpaid_orders',orders);},remove_all_unpaid_orders:function(){this.save('unpaid_orders',[]);},get_unpaid_orders:function(){var saved=this.load('unpaid_orders',[]);var orders=[];for(var i=0;i<saved.length;i++){orders.push(saved[i].data);}
return orders;},get_unpaid_orders_to_sync:function(ids){var saved=this.load('unpaid_orders',[]);var orders=[];saved.forEach(function(o){if(ids.includes(o.id)&&(o.data.server_id||o.data.lines.length||o.data.statement_ids.length)){orders.push(o);}});return orders;},set_order_to_remove_from_server:function(order){if(order.server_id!==undefined){var to_remove=this.load('unpaid_orders_to_remove',[]);to_remove.push(order.server_id);this.save('unpaid_orders_to_remove',to_remove);}},get_ids_to_remove_from_server:function(){return this.load('unpaid_orders_to_remove',[]);},set_ids_removed_from_server:function(ids){var to_remove=this.load('unpaid_orders_to_remove',[]);to_remove=_.filter(to_remove,function(id){return!ids.includes(id);});this.save('unpaid_orders_to_remove',to_remove);},set_cashier:function(cashier){this.save('cashier',cashier||null);},get_cashier:function(){return this.load('cashier');}});return PosDB;});;

/* /point_of_sale/static/src/js/models.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.models',function(require){"use strict";const{Context}=owl;var BarcodeParser=require('barcodes.BarcodeParser');var BarcodeReader=require('point_of_sale.BarcodeReader');var PosDB=require('point_of_sale.DB');var devices=require('point_of_sale.devices');var concurrency=require('web.concurrency');var config=require('web.config');var core=require('web.core');var field_utils=require('web.field_utils');var time=require('web.time');var utils=require('web.utils');var QWeb=core.qweb;var _t=core._t;var Mutex=concurrency.Mutex;var round_di=utils.round_decimals;var round_pr=utils.round_precision;var exports={};exports.PosModel=Backbone.Model.extend({initialize:function(attributes){Backbone.Model.prototype.initialize.call(this,attributes);var self=this;this.flush_mutex=new Mutex();this.env=this.get('env');this.rpc=this.get('rpc');this.session=this.get('session');this.do_action=this.get('do_action');this.setLoadingMessage=this.get('setLoadingMessage');this.setLoadingProgress=this.get('setLoadingProgress');this.showLoadingSkip=this.get('showLoadingSkip');this.proxy=new devices.ProxyDevice(this);this.barcode_reader=new BarcodeReader({'pos':this,proxy:this.proxy});this.proxy_queue=new devices.JobQueue();this.db=new PosDB();this.debug=config.isDebug();this.company_logo=null;this.company_logo_base64='';this.currency=null;this.company=null;this.user=null;this.users=[];this.employee={name:null,id:null,barcode:null,user_id:null,pin:null};this.employees=[];this.partners=[];this.taxes=[];this.pos_session=null;this.config=null;this.units=[];this.units_by_id={};this.uom_unit_id=null;this.default_pricelist=null;this.order_sequence=1;window.posmodel=this;this.validated_orders_name_server_id_map={};var given_config=new RegExp('[\?&]config_id=([^&#]*)').exec(window.location.href);this.config_id=given_config&&given_config[1]&&parseInt(given_config[1])||false;this.set({'synch':{status:'connected',pending:0},'orders':new OrderCollection(),'selectedOrder':null,'selectedClient':null,'cashier':null,'selectedCategoryId':null,});this.get('orders').on('remove',function(order,_unused_,options){self.on_removed_order(order,options.index,options.reason);});function update_client(){var order=self.get_order();this.set('selectedClient',order?order.get_client():null);}
this.get('orders').on('add remove change',update_client,this);this.on('change:selectedOrder',update_client,this);this.ready=this.load_server_data().then(function(){return self.after_load_server_data();});},after_load_server_data:function(){this.load_orders();this.set_start_order();if(this.config.use_proxy){if(this.config.iface_customer_facing_display){this.on('change:selectedOrder',this.send_current_order_to_customer_facing_display,this);}
return this.connect_to_proxy();}
return Promise.resolve();},destroy:function(){this.proxy.disconnect();this.barcode_reader.disconnect_from_proxy();},connect_to_proxy:function(){var self=this;return new Promise(function(resolve,reject){self.barcode_reader.disconnect_from_proxy();self.setLoadingMessage(_t('Connecting to the IoT Box'),0);self.showLoadingSkip(function(){self.proxy.stop_searching();});self.proxy.autoconnect({force_ip:self.config.proxy_ip||undefined,progress:function(prog){self.setLoadingProgress(prog);},}).then(function(){if(self.config.iface_scan_via_proxy){self.barcode_reader.connect_to_proxy();}
resolve();},function(statusText,url){if(statusText=='error'&&window.location.protocol=='https:'){reject({title:_t('HTTPS connection to IoT Box failed'),body:_.str.sprintf(_t('Make sure you are using IoT Box v18.12 or higher. Navigate to %s to accept the certificate of your IoT Box.'),url),popup:'alert',});}else{resolve();}});});},models:[{label:'version',loaded:function(self){return self.session.rpc('/web/webclient/version_info',{}).then(function(version){self.version=version;});},},{model:'res.company',fields:['currency_id','email','website','company_registry','vat','name','phone','partner_id','country_id','state_id','tax_calculation_rounding_method'],ids:function(self){return[self.session.user_context.allowed_company_ids[0]];},loaded:function(self,companies){self.company=companies[0];},},{model:'decimal.precision',fields:['name','digits'],loaded:function(self,dps){self.dp={};for(var i=0;i<dps.length;i++){self.dp[dps[i].name]=dps[i].digits;}},},{model:'uom.uom',fields:[],domain:null,context:function(self){return{active_test:false};},loaded:function(self,units){self.units=units;_.each(units,function(unit){self.units_by_id[unit.id]=unit;});}},{model:'ir.model.data',fields:['res_id'],domain:function(){return[['name','=','product_uom_unit']];},loaded:function(self,unit){self.uom_unit_id=unit[0].res_id;}},{model:'res.partner',label:'load_partners',fields:['name','street','city','state_id','country_id','vat','lang','phone','zip','mobile','email','barcode','write_date','property_account_position_id','property_product_pricelist'],loaded:function(self,partners){self.partners=partners;self.db.add_partners(partners);},},{model:'res.country.state',fields:['name','country_id'],loaded:function(self,states){self.states=states;},},{model:'res.country',fields:['name','vat_label','code'],loaded:function(self,countries){self.countries=countries;self.company.country=null;for(var i=0;i<countries.length;i++){if(countries[i].id===self.company.country_id[0]){self.company.country=countries[i];}}},},{model:'res.lang',fields:['name','code'],loaded:function(self,langs){self.langs=langs;},},{model:'account.tax',fields:['name','amount','price_include','include_base_amount','amount_type','children_tax_ids'],domain:function(self){return[['company_id','=',self.company&&self.company.id||false]]},loaded:function(self,taxes){self.taxes=taxes;self.taxes_by_id={};_.each(taxes,function(tax){self.taxes_by_id[tax.id]=tax;});_.each(self.taxes_by_id,function(tax){tax.children_tax_ids=_.map(tax.children_tax_ids,function(child_tax_id){return self.taxes_by_id[child_tax_id];});});return new Promise(function(resolve,reject){var tax_ids=_.pluck(self.taxes,'id');self.rpc({model:'account.tax',method:'get_real_tax_amount',args:[tax_ids],}).then(function(taxes){_.each(taxes,function(tax){self.taxes_by_id[tax.id].amount=tax.amount;});resolve();});});},},{model:'pos.session',fields:['id','name','user_id','config_id','start_at','stop_at','sequence_number','payment_method_ids','cash_register_id','state'],domain:function(self){var domain=[['state','in',['opening_control','opened']],['rescue','=',false],];if(self.config_id)domain.push(['config_id','=',self.config_id]);return domain;},loaded:function(self,pos_sessions,tmp){self.pos_session=pos_sessions[0];self.pos_session.login_number=odoo.login_number;self.config_id=self.config_id||self.pos_session&&self.pos_session.config_id[0];tmp.payment_method_ids=pos_sessions[0].payment_method_ids;},},{model:'pos.config',fields:[],domain:function(self){return[['id','=',self.config_id]];},loaded:function(self,configs){self.config=configs[0];self.config.use_proxy=self.config.is_posbox&&(self.config.iface_electronic_scale||self.config.iface_print_via_proxy||self.config.iface_scan_via_proxy||self.config.iface_customer_facing_display);self.db.set_uuid(self.config.uuid);self.set_cashier(self.get_cashier());self.db.save('pos_session_id',self.pos_session.id);var orders=self.db.get_orders();for(var i=0;i<orders.length;i++){self.pos_session.sequence_number=Math.max(self.pos_session.sequence_number,orders[i].data.sequence_number+1);}},},{model:'stock.picking.type',fields:['use_create_lots','use_existing_lots'],domain:function(self){return[['id','=',self.config.picking_type_id[0]]];},loaded:function(self,picking_type){self.picking_type=picking_type[0];},},{model:'res.users',fields:['name','company_id','id','groups_id','lang'],domain:function(self){return[['company_ids','in',self.config.company_id[0]],'|',['groups_id','=',self.config.group_pos_manager_id[0]],['groups_id','=',self.config.group_pos_user_id[0]]];},loaded:function(self,users){users.forEach(function(user){user.role='cashier';user.groups_id.some(function(group_id){if(group_id===self.config.group_pos_manager_id[0]){user.role='manager';return true;}});if(user.id===self.session.uid){self.user=user;self.employee.name=user.name;self.employee.role=user.role;self.employee.user_id=[user.id,user.name];}});self.users=users;self.employees=[self.employee];self.set_cashier(self.employee);},},{model:'product.pricelist',fields:['name','display_name','discount_policy'],domain:function(self){if(self.config.use_pricelist){return[['id','in',self.config.available_pricelist_ids]];}else{return[['id','=',self.config.pricelist_id[0]]];}},loaded:function(self,pricelists){_.map(pricelists,function(pricelist){pricelist.items=[];});self.default_pricelist=_.findWhere(pricelists,{id:self.config.pricelist_id[0]});self.pricelists=pricelists;},},{model:'account.bank.statement',fields:['id','balance_start'],domain:function(self){return[['id','=',self.pos_session.cash_register_id[0]]];},loaded:function(self,statement){self.bank_statement=statement[0];},},{model:'product.pricelist.item',domain:function(self){return[['pricelist_id','in',_.pluck(self.pricelists,'id')]];},loaded:function(self,pricelist_items){var pricelist_by_id={};_.each(self.pricelists,function(pricelist){pricelist_by_id[pricelist.id]=pricelist;});_.each(pricelist_items,function(item){var pricelist=pricelist_by_id[item.pricelist_id[0]];pricelist.items.push(item);item.base_pricelist=pricelist_by_id[item.base_pricelist_id[0]];});},},{model:'product.category',fields:['name','parent_id'],loaded:function(self,product_categories){var category_by_id={};_.each(product_categories,function(category){category_by_id[category.id]=category;});_.each(product_categories,function(category){category.parent=category_by_id[category.parent_id[0]];});self.product_categories=product_categories;},},{model:'res.currency',fields:['name','symbol','position','rounding','rate'],ids:function(self){return[self.config.currency_id[0],self.company.currency_id[0]];},loaded:function(self,currencies){self.currency=currencies[0];if(self.currency.rounding>0&&self.currency.rounding<1){self.currency.decimals=Math.ceil(Math.log(1.0/self.currency.rounding)/Math.log(10));}else{self.currency.decimals=0;}
self.company_currency=currencies[1];},},{model:'pos.category',fields:['id','name','parent_id','child_id','write_date'],domain:function(self){return self.config.limit_categories&&self.config.iface_available_categ_ids.length?[['id','in',self.config.iface_available_categ_ids]]:[];},loaded:function(self,categories){self.db.add_categories(categories);},},{model:'product.product',fields:['display_name','lst_price','standard_price','categ_id','pos_categ_id','taxes_id','barcode','default_code','to_weight','uom_id','description_sale','description','product_tmpl_id','tracking','write_date','available_in_pos','attribute_line_ids'],order:_.map(['sequence','default_code','name'],function(name){return{name:name};}),domain:function(self){var domain=['&','&',['sale_ok','=',true],['available_in_pos','=',true],'|',['company_id','=',self.config.company_id[0]],['company_id','=',false]];if(self.config.limit_categories&&self.config.iface_available_categ_ids.length){domain.unshift('&');domain.push(['pos_categ_id','in',self.config.iface_available_categ_ids]);}
if(self.config.iface_tipproduct){domain.unshift(['id','=',self.config.tip_product_id[0]]);domain.unshift('|');}
return domain;},context:function(self){return{display_default_code:false};},loaded:function(self,products){var using_company_currency=self.config.currency_id[0]===self.company.currency_id[0];var conversion_rate=self.currency.rate/self.company_currency.rate;self.db.add_products(_.map(products,function(product){if(!using_company_currency){product.lst_price=round_pr(product.lst_price*conversion_rate,self.currency.rounding);}
product.categ=_.findWhere(self.product_categories,{'id':product.categ_id[0]});product.pos=self;return new exports.Product({},product);}));},},{model:'product.attribute',fields:['name','display_type'],condition:function(self){return self.config.product_configurator;},domain:function(){return[['create_variant','=','no_variant']];},loaded:function(self,product_attributes,tmp){tmp.product_attributes_by_id={};_.map(product_attributes,function(product_attribute){tmp.product_attributes_by_id[product_attribute.id]=product_attribute;});}},{model:'product.attribute.value',fields:['name','attribute_id','is_custom','html_color'],condition:function(self){return self.config.product_configurator;},domain:function(self,tmp){return[['attribute_id','in',_.keys(tmp.product_attributes_by_id).map(parseFloat)]];},loaded:function(self,pavs,tmp){tmp.pav_by_id={};_.map(pavs,function(pav){tmp.pav_by_id[pav.id]=pav;});}},{model:'product.template.attribute.value',fields:['product_attribute_value_id','attribute_id','attribute_line_id','price_extra'],condition:function(self){return self.config.product_configurator;},domain:function(self,tmp){return[['attribute_id','in',_.keys(tmp.product_attributes_by_id).map(parseFloat)]];},loaded:function(self,ptavs,tmp){self.attributes_by_ptal_id={};_.map(ptavs,function(ptav){if(!self.attributes_by_ptal_id[ptav.attribute_line_id[0]]){self.attributes_by_ptal_id[ptav.attribute_line_id[0]]={id:ptav.attribute_line_id[0],name:tmp.product_attributes_by_id[ptav.attribute_id[0]].name,display_type:tmp.product_attributes_by_id[ptav.attribute_id[0]].display_type,values:[],};}
self.attributes_by_ptal_id[ptav.attribute_line_id[0]].values.push({id:ptav.product_attribute_value_id[0],name:tmp.pav_by_id[ptav.product_attribute_value_id[0]].name,is_custom:tmp.pav_by_id[ptav.product_attribute_value_id[0]].is_custom,html_color:tmp.pav_by_id[ptav.product_attribute_value_id[0]].html_color,price_extra:ptav.price_extra,});});}},{model:'account.cash.rounding',fields:['name','rounding','rounding_method'],domain:function(self){return[['id','=',self.config.rounding_method[0]]];},loaded:function(self,cash_rounding){self.cash_rounding=cash_rounding;}},{model:'pos.payment.method',fields:['name','is_cash_count','use_payment_terminal'],domain:function(self){return['|',['active','=',false],['active','=',true]];},loaded:function(self,payment_methods){self.payment_methods=payment_methods.sort(function(a,b){if(a.is_cash_count&&!b.is_cash_count){return-1;}else if(!a.is_cash_count&&b.is_cash_count){return 1;}else{return a.id-b.id;}});self.payment_methods_by_id={};_.each(self.payment_methods,function(payment_method){self.payment_methods_by_id[payment_method.id]=payment_method;var PaymentInterface=self.electronic_payment_interfaces[payment_method.use_payment_terminal];if(PaymentInterface){payment_method.payment_terminal=new PaymentInterface(self,payment_method);}});}},{model:'account.fiscal.position',fields:[],domain:function(self){return[['id','in',self.config.fiscal_position_ids]];},loaded:function(self,fiscal_positions){self.fiscal_positions=fiscal_positions;}},{model:'account.fiscal.position.tax',fields:[],domain:function(self){var fiscal_position_tax_ids=[];self.fiscal_positions.forEach(function(fiscal_position){fiscal_position.tax_ids.forEach(function(tax_id){fiscal_position_tax_ids.push(tax_id);});});return[['id','in',fiscal_position_tax_ids]];},loaded:function(self,fiscal_position_taxes){self.fiscal_position_taxes=fiscal_position_taxes;self.fiscal_positions.forEach(function(fiscal_position){fiscal_position.fiscal_position_taxes_by_id={};fiscal_position.tax_ids.forEach(function(tax_id){var fiscal_position_tax=_.find(fiscal_position_taxes,function(fiscal_position_tax){return fiscal_position_tax.id===tax_id;});fiscal_position.fiscal_position_taxes_by_id[fiscal_position_tax.id]=fiscal_position_tax;});});}},{label:'fonts',loaded:function(){return new Promise(function(resolve,reject){waitForWebfonts(['Lato','Inconsolata'],function(){resolve();});setTimeout(resolve,5000);});},},{label:'pictures',loaded:function(self){self.company_logo=new Image();return new Promise(function(resolve,reject){self.company_logo.onload=function(){var img=self.company_logo;var ratio=1;var targetwidth=300;var maxheight=150;if(img.width!==targetwidth){ratio=targetwidth/img.width;}
if(img.height*ratio>maxheight){ratio=maxheight/img.height;}
var width=Math.floor(img.width*ratio);var height=Math.floor(img.height*ratio);var c=document.createElement('canvas');c.width=width;c.height=height;var ctx=c.getContext('2d');ctx.drawImage(self.company_logo,0,0,width,height);self.company_logo_base64=c.toDataURL();resolve();};self.company_logo.onerror=function(){reject();};self.company_logo.crossOrigin="anonymous";self.company_logo.src='/web/binary/company_logo'+'?dbname='+self.session.db+'&company='+self.company.id+'&_'+Math.random();});},},{label:'barcodes',loaded:function(self){var barcode_parser=new BarcodeParser({'nomenclature_id':self.config.barcode_nomenclature_id});self.barcode_reader.set_barcode_parser(barcode_parser);return barcode_parser.is_loaded();},},],load_server_data:function(){var self=this;var progress=0;var progress_step=1.0/self.models.length;var tmp={};var loaded=new Promise(function(resolve,reject){function load_model(index){if(index>=self.models.length){resolve();}else{var model=self.models[index];self.setLoadingMessage(_t('Loading')+' '+(model.label||model.model||''),progress);var cond=typeof model.condition==='function'?model.condition(self,tmp):true;if(!cond){load_model(index+1);return;}
var fields=typeof model.fields==='function'?model.fields(self,tmp):model.fields;var domain=typeof model.domain==='function'?model.domain(self,tmp):model.domain;var context=typeof model.context==='function'?model.context(self,tmp):model.context||{};var ids=typeof model.ids==='function'?model.ids(self,tmp):model.ids;var order=typeof model.order==='function'?model.order(self,tmp):model.order;progress+=progress_step;if(model.model){var params={model:model.model,context:_.extend(context,self.session.user_context||{}),};if(model.ids){params.method='read';params.args=[ids,fields];}else{params.method='search_read';params.domain=domain;params.fields=fields;params.orderBy=order;}
self.rpc(params).then(function(result){try{Promise.resolve(model.loaded(self,result,tmp)).then(function(){load_model(index+1);},function(err){reject(err);});}catch(err){console.error(err.message,err.stack);reject(err);}},function(err){reject(err);});}else if(model.loaded){try{Promise.resolve(model.loaded(self,tmp)).then(function(){load_model(index+1);},function(err){reject(err);});}catch(err){reject(err);}}else{load_model(index+1);}}}
try{return load_model(0);}catch(err){return Promise.reject(err);}});return loaded;},prepare_new_partners_domain:function(){return[['write_date','>',this.db.get_partner_write_date()]];},load_new_partners:function(){var self=this;return new Promise(function(resolve,reject){var fields=_.find(self.models,function(model){return model.label==='load_partners';}).fields;var domain=self.prepare_new_partners_domain();self.rpc({model:'res.partner',method:'search_read',args:[domain,fields],},{timeout:3000,shadow:true,}).then(function(partners){if(self.db.add_partners(partners)){resolve();}else{reject(new Error('Failed in updating partners.'));}},function(type,err){reject();});});},on_removed_order:function(removed_order,index,reason){var order_list=this.get_order_list();if((reason==='abandon'||removed_order.temporary)&&order_list.length>0){this.set_order(order_list[index]||order_list[order_list.length-1],{silent:true});}else{this.add_new_order({silent:true});}},get_cashier:function(){if(this.db.load('pos_session_id')!==this.pos_session.id){this.set_cashier(this.employee);}
return this.db.get_cashier()||this.get('cashier')||this.employee;},set_cashier:function(employee){this.set('cashier',employee);this.db.set_cashier(this.get('cashier'));},add_new_order:function(options){var order=new exports.Order({},{pos:this});this.get('orders').add(order);this.set('selectedOrder',order,options);return order;},load_orders:function(){var jsons=this.db.get_unpaid_orders();var orders=[];for(var i=0;i<jsons.length;i++){var json=jsons[i];if(json.pos_session_id===this.pos_session.id){orders.push(new exports.Order({},{pos:this,json:json,}));}}
for(var i=0;i<jsons.length;i++){var json=jsons[i];if(json.pos_session_id!==this.pos_session.id&&(json.lines.length>0||json.statement_ids.length>0)){orders.push(new exports.Order({},{pos:this,json:json,}));}else if(json.pos_session_id!==this.pos_session.id){this.db.remove_unpaid_order(jsons[i]);}}
orders=orders.sort(function(a,b){return a.sequence_number-b.sequence_number;});if(orders.length){this.get('orders').add(orders);}},set_start_order:function(){var orders=this.get('orders').models;if(orders.length&&!this.get('selectedOrder')){this.set('selectedOrder',orders[0]);}else{this.add_new_order();}},get_order:function(){return this.get('selectedOrder');},get_client:function(){var order=this.get_order();if(order){return order.get_client();}
return null;},set_order:function(order,options){this.set({selectedOrder:order},options);},get_order_list:function(){return this.get('orders').models;},delete_current_order:function(){var order=this.get_order();if(order){order.destroy({'reason':'abandon'});}},_convert_product_img_to_base64:function(product,url){return new Promise(function(resolve,reject){var img=new Image();img.onload=function(){var canvas=document.createElement('CANVAS');var ctx=canvas.getContext('2d');canvas.height=this.height;canvas.width=this.width;ctx.drawImage(this,0,0);var dataURL=canvas.toDataURL('image/jpeg');product.image_base64=dataURL;canvas=null;resolve();};img.crossOrigin='use-credentials';img.src=url;});},send_current_order_to_customer_facing_display:function(){var self=this;this.render_html_for_customer_facing_display().then(function(rendered_html){self.proxy.update_customer_facing_display(rendered_html);});},render_html_for_customer_facing_display:function(){var self=this;var order=this.get_order();var rendered_html=this.config.customer_facing_display_html;var get_image_promises=[];if(order){order.get_orderlines().forEach(function(orderline){var product=orderline.product;var image_url=`/web/image?model=product.product&field=image_128&id=${product.id}&write_date=${product.write_date}&unique=1`;if(!product.image_base64){get_image_promises.push(self._convert_product_img_to_base64(product,image_url));}});}
return Promise.all(get_image_promises).then(function(){var rendered_order_lines="";var rendered_payment_lines="";var order_total_with_tax=self.format_currency(0);if(order){rendered_order_lines=QWeb.render('CustomerFacingDisplayOrderLines',{'orderlines':order.get_orderlines(),'pos':self,});rendered_payment_lines=QWeb.render('CustomerFacingDisplayPaymentLines',{'order':order,'pos':self,});order_total_with_tax=self.format_currency(order.get_total_with_tax());}
var $rendered_html=$(rendered_html);$rendered_html.find('.pos_orderlines_list').html(rendered_order_lines);$rendered_html.find('.pos-total').find('.pos_total-amount').html(order_total_with_tax);var pos_change_title=$rendered_html.find('.pos-change_title').text();$rendered_html.find('.pos-paymentlines').html(rendered_payment_lines);$rendered_html.find('.pos-change_title').text(pos_change_title);rendered_html=_.reduce($rendered_html,function(memory,current_element){return memory+$(current_element).prop('outerHTML');},"");rendered_html=QWeb.render('CustomerFacingDisplayHead',{origin:window.location.origin})+rendered_html;return rendered_html;});},push_orders:function(order,opts){opts=opts||{};var self=this;if(order){this.db.add_order(order.export_as_JSON());}
return new Promise(function(resolve,reject){self.flush_mutex.exec(function(){var flushed=self._flush_orders(self.db.get_orders(),opts);flushed.then(resolve,reject);return flushed;});});},push_single_order:function(order,opts){opts=opts||{};const self=this;const order_id=self.db.add_order(order.export_as_JSON());return new Promise(function(resolve,reject){self.flush_mutex.exec(function(){var order=self.db.get_order(order_id);if(order){var flushed=self._flush_orders([order],opts);}else{var flushed=Promise.resolve([]);}
flushed.then(resolve,reject);return flushed;});});},push_and_invoice_order:function(order){var self=this;var invoiced=new Promise(function(resolveInvoiced,rejectInvoiced){if(!order.get_client()){rejectInvoiced({code:400,message:'Missing Customer',data:{}});}
else{var order_id=self.db.add_order(order.export_as_JSON());self.flush_mutex.exec(function(){var done=new Promise(function(resolveDone,rejectDone){var transfer=self._flush_orders([self.db.get_order(order_id)],{timeout:30000,to_invoice:true});transfer.catch(function(error){rejectInvoiced(error);rejectDone();});transfer.then(function(order_server_id){if(order_server_id.length){self.do_action('point_of_sale.pos_invoice_report',{additional_context:{active_ids:order_server_id,}}).then(function(){resolveInvoiced(order_server_id);resolveDone();}).guardedCatch(function(error){rejectInvoiced({code:401,message:'Backend Invoice',data:{order:order}});rejectDone();});}else if(order_server_id.length){resolveInvoiced(order_server_id);resolveDone();}else{rejectInvoiced({code:401,message:'Backend Invoice',data:{order:order}});rejectDone();}});return done;});});}});return invoiced;},_flush_orders:function(orders,options){var self=this;this.set_synch('connecting',orders.length);return this._save_to_server(orders,options).then(function(server_ids){self.set_synch('connected');for(let i=0;i<server_ids.length;i++){self.validated_orders_name_server_id_map[server_ids[i].pos_reference]=server_ids[i].id;}
return _.pluck(server_ids,'id');}).catch(function(error){self.set_synch(self.get('failed')?'error':'disconnected');return Promise.reject(error);});},set_synch:function(status,pending){if(['connected','connecting','error','disconnected'].indexOf(status)===-1){console.error(status,' is not a known connection state.');}
pending=pending||this.db.get_orders().length+this.db.get_ids_to_remove_from_server().length;this.set('synch',{status,pending});},_save_to_server:function(orders,options){if(!orders||!orders.length){return Promise.resolve([]);}
options=options||{};var self=this;var timeout=typeof options.timeout==='number'?options.timeout:30000*orders.length;var order_ids_to_sync=_.pluck(orders,'id');var args=[_.map(orders,function(order){order.to_invoice=options.to_invoice||false;return order;})];args.push(options.draft||false);return this.rpc({model:'pos.order',method:'create_from_ui',args:args,kwargs:{context:this.session.user_context},},{timeout:timeout,shadow:!options.to_invoice}).then(function(server_ids){_.each(order_ids_to_sync,function(order_id){self.db.remove_order(order_id);});self.set('failed',false);return server_ids;}).catch(function(reason){var error=reason.message;console.warn('Failed to send orders:',orders);if(error.code===200){if((!self.get('failed')||options.show_error)&&!options.to_invoice){self.set('failed',error);throw error;}}
throw error;});},_remove_from_server:function(server_ids,options){options=options||{};if(!server_ids||!server_ids.length){return Promise.resolve([]);}
var self=this;var timeout=typeof options.timeout==='number'?options.timeout:7500*server_ids.length;return this.rpc({model:'pos.order',method:'remove_from_ui',args:[server_ids],kwargs:{context:this.session.user_context},},{timeout:timeout,shadow:true,}).then(function(data){return self._post_remove_from_server(server_ids,data)}).catch(function(reason){var error=reason.message;if(error.code===200){if(error.data.exception_type=='warning'){delete error.data.debug;}}
console.warn('Failed to remove orders:',server_ids);throw error;});},_post_remove_from_server(server_ids,data){this.db.set_ids_removed_from_server(server_ids);return server_ids;},scan_product:function(parsed_code){var selectedOrder=this.get_order();var product=this.db.get_product_by_barcode(parsed_code.base_code);if(!product){return false;}
if(parsed_code.type==='price'){selectedOrder.add_product(product,{price:parsed_code.value,extras:{price_manually_set:true}});}else if(parsed_code.type==='weight'){selectedOrder.add_product(product,{quantity:parsed_code.value,merge:false});}else if(parsed_code.type==='discount'){selectedOrder.add_product(product,{discount:parsed_code.value,merge:false});}else{selectedOrder.add_product(product);}
return true;},export_paid_orders:function(){return JSON.stringify({'paid_orders':this.db.get_orders(),'session':this.pos_session.name,'session_id':this.pos_session.id,'date':(new Date()).toUTCString(),'version':this.version.server_version_info,},null,2);},export_unpaid_orders:function(){return JSON.stringify({'unpaid_orders':this.db.get_unpaid_orders(),'session':this.pos_session.name,'session_id':this.pos_session.id,'date':(new Date()).toUTCString(),'version':this.version.server_version_info,},null,2);},import_orders:function(str){var json=JSON.parse(str);var report={paid:0,unpaid:0,unpaid_skipped_existing:0,unpaid_skipped_session:0,unpaid_skipped_sessions:[],};if(json.paid_orders){for(var i=0;i<json.paid_orders.length;i++){this.db.add_order(json.paid_orders[i].data);}
report.paid=json.paid_orders.length;this.push_orders();}
if(json.unpaid_orders){var orders=[];var existing=this.get_order_list();var existing_uids={};var skipped_sessions={};for(var i=0;i<existing.length;i++){existing_uids[existing[i].uid]=true;}
for(var i=0;i<json.unpaid_orders.length;i++){var order=json.unpaid_orders[i];if(order.pos_session_id!==this.pos_session.id){report.unpaid_skipped_session+=1;skipped_sessions[order.pos_session_id]=true;}else if(existing_uids[order.uid]){report.unpaid_skipped_existing+=1;}else{orders.push(new exports.Order({},{pos:this,json:order,}));}}
orders=orders.sort(function(a,b){return a.sequence_number-b.sequence_number;});if(orders.length){report.unpaid=orders.length;this.get('orders').add(orders);}
report.unpaid_skipped_sessions=_.keys(skipped_sessions);}
return report;},_load_orders:function(){var jsons=this.db.get_unpaid_orders();var orders=[];var not_loaded_count=0;for(var i=0;i<jsons.length;i++){var json=jsons[i];if(json.pos_session_id===this.pos_session.id){orders.push(new exports.Order({},{pos:this,json:json,}));}else{not_loaded_count+=1;}}
if(not_loaded_count){console.info('There are '+not_loaded_count+' locally saved unpaid orders belonging to another session');}
orders=orders.sort(function(a,b){return a.sequence_number-b.sequence_number;});if(orders.length){this.get('orders').add(orders);}},_compute_all:function(tax,base_amount,quantity,price_exclude){if(price_exclude===undefined)
var price_include=tax.price_include;else
var price_include=!price_exclude;if(tax.amount_type==='fixed'){var sign_base_amount=Math.sign(base_amount)||1;return tax.amount*sign_base_amount*Math.abs(quantity);}
if(tax.amount_type==='percent'&&!price_include){return base_amount*tax.amount/100;}
if(tax.amount_type==='percent'&&price_include){return base_amount-(base_amount/(1+tax.amount/100));}
if(tax.amount_type==='division'&&!price_include){return base_amount/(1-tax.amount/100)-base_amount;}
if(tax.amount_type==='division'&&price_include){return base_amount-(base_amount*(tax.amount/100));}
return false;},compute_all:function(taxes,price_unit,quantity,currency_rounding,handle_price_include=true){var self=this;var _collect_taxes=function(taxes,all_taxes){taxes.sort(function(tax1,tax2){return tax1.sequence-tax2.sequence;});_(taxes).each(function(tax){if(tax.amount_type==='group')
all_taxes=_collect_taxes(tax.children_tax_ids,all_taxes);else
all_taxes.push(tax);});return all_taxes;}
var collect_taxes=function(taxes){return _collect_taxes(taxes,[]);}
taxes=collect_taxes(taxes);var round_tax=this.company.tax_calculation_rounding_method!='round_globally';var initial_currency_rounding=currency_rounding;if(!round_tax)
currency_rounding=currency_rounding*0.00001;var recompute_base=function(base_amount,fixed_amount,percent_amount,division_amount){return(base_amount-fixed_amount)/(1.0+percent_amount/100.0)*(100-division_amount)/100;}
var base=round_pr(price_unit*quantity,initial_currency_rounding);var sign=1;if(base<0){base=-base;sign=-1;}else if(utils.float_is_zero(base,this.currency.decimals)&&quantity<0){sign=-1}
var total_included_checkpoints={};var i=taxes.length-1;var store_included_tax_total=true;var incl_fixed_amount=0.0;var incl_percent_amount=0.0;var incl_division_amount=0.0;var cached_tax_amounts={};if(handle_price_include){_(taxes.reverse()).each(function(tax){if(tax.include_base_amount){base=recompute_base(base,incl_fixed_amount,incl_percent_amount,incl_division_amount);incl_fixed_amount=0.0;incl_percent_amount=0.0;incl_division_amount=0.0;store_included_tax_total=true;}
if(tax.price_include){if(tax.amount_type==='percent')
incl_percent_amount+=tax.amount;else if(tax.amount_type==='division')
incl_division_amount+=tax.amount;else if(tax.amount_type==='fixed')
incl_fixed_amount+=Math.abs(quantity)*tax.amount
else{var tax_amount=self._compute_all(tax,base,quantity);incl_fixed_amount+=tax_amount;cached_tax_amounts[i]=tax_amount;}
if(store_included_tax_total){total_included_checkpoints[i]=base;store_included_tax_total=false;}}
i-=1;});}
var total_excluded=round_pr(recompute_base(base,incl_fixed_amount,incl_percent_amount,incl_division_amount),initial_currency_rounding);var total_included=total_excluded;base=total_excluded;var skip_checkpoint=false;var taxes_vals=[];i=0;var cumulated_tax_included_amount=0;_(taxes.reverse()).each(function(tax){if(!skip_checkpoint&&tax.price_include&&total_included_checkpoints[i]!==undefined){var tax_amount=total_included_checkpoints[i]-(base+cumulated_tax_included_amount);cumulated_tax_included_amount=0;}else
var tax_amount=self._compute_all(tax,base,quantity,true);tax_amount=round_pr(tax_amount,currency_rounding);if(tax.price_include&&total_included_checkpoints[i]===undefined)
cumulated_tax_included_amount+=tax_amount;taxes_vals.push({'id':tax.id,'name':tax.name,'amount':sign*tax_amount,'base':sign*round_pr(base,currency_rounding),});if(tax.include_base_amount){base+=tax_amount;if(!tax.price_include)
skip_checkpoint=true;}
total_included+=tax_amount;i+=1;});return{'taxes':taxes_vals,'total_excluded':sign*round_pr(total_excluded,this.currency.rounding),'total_included':sign*round_pr(total_included,this.currency.rounding),}},_map_tax_fiscal_position:function(tax,order=false){var self=this;var current_order=order||this.get_order();var order_fiscal_position=current_order&&current_order.fiscal_position;var taxes=[];if(order_fiscal_position){var tax_mappings=_.filter(order_fiscal_position.fiscal_position_taxes_by_id,function(fiscal_position_tax){return fiscal_position_tax.tax_src_id[0]===tax.id;});if(tax_mappings&&tax_mappings.length){_.each(tax_mappings,function(tm){if(tm.tax_dest_id){var taxe=self.taxes_by_id[tm.tax_dest_id[0]];if(taxe){taxes.push(taxe);}}});}else{taxes.push(tax);}}else{taxes.push(tax);}
return taxes;},get_taxes_after_fp:function(taxes_ids,order=false){var self=this;var taxes=this.taxes;var product_taxes=[];_(taxes_ids).each(function(el){var tax=_.detect(taxes,function(t){return t.id===el;});product_taxes.push.apply(product_taxes,self._map_tax_fiscal_position(tax,order));});product_taxes=_.uniq(product_taxes,function(tax){return tax.id;});return product_taxes;},_trigger_up:function(ev){if(ev.is_stopped()){return;}
const payload=ev.data;if(ev.name==='call_service'){let args=payload.args||[];if(payload.service==='ajax'&&payload.method==='rpc'){args=args.concat(ev.target);}
const service=this.env.services[payload.service];const result=service[payload.method].apply(service,args);payload.callback(result);}},electronic_payment_interfaces:{},format_currency:function(amount,precision){var currency=this&&this.currency?this.currency:{symbol:'$',position:'after',rounding:0.01,decimals:2};amount=this.format_currency_no_symbol(amount,precision,currency);if(currency.position==='after'){return amount+' '+(currency.symbol||'');}else{return(currency.symbol||'')+' '+amount;}},format_currency_no_symbol:function(amount,precision,currency){if(!currency){currency=this&&this.currency?this.currency:{symbol:'$',position:'after',rounding:0.01,decimals:2};}
var decimals=currency.decimals;if(precision&&this.dp[precision]!==undefined){decimals=this.dp[precision];}
if(typeof amount==='number'){amount=round_di(amount,decimals).toFixed(decimals);amount=field_utils.format.float(round_di(amount,decimals),{digits:[69,decimals],});}
return amount;},format_pr:function(value,precision){var decimals=precision>0?Math.max(0,Math.ceil(Math.log(1.0/precision)/Math.log(10))):0;return value.toFixed(decimals);},formatFixed:function(value){const currency=this.currency||{decimals:2};return`${Number(value.toFixed(currency.decimals || 0))}`;},disallowLineQuantityChange(){return false;},getCurrencySymbol(){return this.currency?this.currency.symbol:'$';},htmlToImgLetterRendering(){return false;},});exports.register_payment_method=function(use_payment_terminal,ImplementedPaymentInterface){exports.PosModel.prototype.electronic_payment_interfaces[use_payment_terminal]=ImplementedPaymentInterface;};exports.load_fields=function(model_name,fields){if(!(fields instanceof Array)){fields=[fields];}
var models=exports.PosModel.prototype.models;for(var i=0;i<models.length;i++){var model=models[i];if(model.model===model_name){if((model.fields instanceof Array)&&model.fields.length>0){model.fields=model.fields.concat(fields||[]);}}}};exports.load_models=function(models,options){options=options||{};if(!(models instanceof Array)){models=[models];}
var pmodels=exports.PosModel.prototype.models;var index=pmodels.length;if(options.before){for(var i=0;i<pmodels.length;i++){if(pmodels[i].model===options.before||pmodels[i].label===options.before){index=i;break;}}}else if(options.after){for(var i=0;i<pmodels.length;i++){if(pmodels[i].model===options.after||pmodels[i].label===options.after){index=i+1;}}}
pmodels.splice.apply(pmodels,[index,0].concat(models));};exports.Product=Backbone.Model.extend({initialize:function(attr,options){_.extend(this,options);},isAllowOnlyOneLot:function(){const productUnit=this.get_unit();return this.tracking==='lot'||!productUnit||!productUnit.is_pos_groupable;},get_unit:function(){var unit_id=this.uom_id;if(!unit_id){return undefined;}
unit_id=unit_id[0];if(!this.pos){return undefined;}
return this.pos.units_by_id[unit_id];},get_price:function(pricelist,quantity,price_extra){var self=this;var date=moment();if(pricelist===undefined){alert(_t('An error occurred when loading product prices. '+'Make sure all pricelists are available in the POS.'));}
var category_ids=[];var category=this.categ;while(category){category_ids.push(category.id);category=category.parent;}
var pricelist_items=_.filter(pricelist.items,function(item){return(!item.product_tmpl_id||item.product_tmpl_id[0]===self.product_tmpl_id)&&(!item.product_id||item.product_id[0]===self.id)&&(!item.categ_id||_.contains(category_ids,item.categ_id[0]))&&(!item.date_start||moment.utc(item.date_start).isSameOrBefore(date))&&(!item.date_end||moment.utc(item.date_end).isSameOrAfter(date));});var price=self.lst_price;if(price_extra){price+=price_extra;}
_.find(pricelist_items,function(rule){if(rule.min_quantity&&quantity<rule.min_quantity){return false;}
if(rule.base==='pricelist'){price=self.get_price(rule.base_pricelist,quantity);}else if(rule.base==='standard_price'){price=self.standard_price;}
if(rule.compute_price==='fixed'){price=rule.fixed_price;return true;}else if(rule.compute_price==='percentage'){price=price-(price*(rule.percent_price/100));return true;}else{var price_limit=price;price=price-(price*(rule.price_discount/100));if(rule.price_round){price=round_pr(price,rule.price_round);}
if(rule.price_surcharge){price+=rule.price_surcharge;}
if(rule.price_min_margin){price=Math.max(price,price_limit+rule.price_min_margin);}
if(rule.price_max_margin){price=Math.min(price,price_limit+rule.price_max_margin);}
return true;}
return false;});return price;},get_display_price:function(pricelist,quantity){if(this.pos.config.iface_tax_included==='total'){const taxes=this.pos.get_taxes_after_fp(this.taxes_id);const allPrices=this.pos.compute_all(taxes,this.get_price(pricelist,quantity),1,this.pos.currency.rounding);return allPrices.total_included;}else{return this.get_price(pricelist,quantity);}}});var orderline_id=1;exports.Orderline=Backbone.Model.extend({initialize:function(attr,options){this.pos=options.pos;this.order=options.order;if(options.json){try{this.init_from_JSON(options.json);}catch(error){console.error('ERROR: attempting to recover product ID',options.json.product_id,'not available in the point of sale. Correct the product or clean the browser cache.');}
return;}
this.product=options.product;this.set_product_lot(this.product);this.set_quantity(1);this.discount=0;this.discountStr='0';this.selected=false;this.description='';this.price_extra=0;this.full_product_name='';this.id=orderline_id++;this.price_manually_set=false;if(options.price){this.set_unit_price(options.price);}else{this.set_unit_price(this.product.get_price(this.order.pricelist,this.get_quantity()));}},init_from_JSON:function(json){this.product=this.pos.db.get_product_by_id(json.product_id);this.set_product_lot(this.product);this.price=json.price_unit;this.set_discount(json.discount);this.set_quantity(json.qty,'do not recompute unit price');this.set_description(json.description);this.set_price_extra(json.price_extra);this.set_full_product_name(json.full_product_name);this.id=json.id?json.id:orderline_id++;orderline_id=Math.max(this.id+1,orderline_id);var pack_lot_lines=json.pack_lot_ids;for(var i=0;i<pack_lot_lines.length;i++){var packlotline=pack_lot_lines[i][2];var pack_lot_line=new exports.Packlotline({},{'json':_.extend(packlotline,{'order_line':this})});this.pack_lot_lines.add(pack_lot_line);}},clone:function(){var orderline=new exports.Orderline({},{pos:this.pos,order:this.order,product:this.product,price:this.price,});orderline.order=null;orderline.quantity=this.quantity;orderline.quantityStr=this.quantityStr;orderline.discount=this.discount;orderline.price=this.price;orderline.selected=false;orderline.price_manually_set=this.price_manually_set;return orderline;},getPackLotLinesToEdit:function(isAllowOnlyOneLot){const currentPackLotLines=this.pack_lot_lines.models;let nExtraLines=Math.abs(this.quantity)-currentPackLotLines.length;nExtraLines=Math.ceil(nExtraLines);nExtraLines=nExtraLines>0?nExtraLines:1;const tempLines=currentPackLotLines.map(lotLine=>({id:lotLine.cid,text:lotLine.get('lot_name'),})).concat(Array.from(Array(nExtraLines)).map(_=>({text:'',})));return isAllowOnlyOneLot?[tempLines[0]]:tempLines;},setPackLotLines:function({modifiedPackLotLines,newPackLotLines}){let lotLinesToRemove=[];for(let lotLine of this.pack_lot_lines.models){const modifiedLotName=modifiedPackLotLines[lotLine.cid];if(modifiedLotName){lotLine.set({lot_name:modifiedLotName});}else{lotLinesToRemove.push(lotLine);}}
for(let lotLine of lotLinesToRemove){lotLine.remove();}
let newPackLotLine;for(let newLotLine of newPackLotLines){newPackLotLine=new exports.Packlotline({},{order_line:this});newPackLotLine.set({lot_name:newLotLine.lot_name});this.pack_lot_lines.add(newPackLotLine);}
if(!this.product.to_weight){this.pack_lot_lines.set_quantity_by_lot();}},set_product_lot:function(product){this.has_product_lot=product.tracking!=='none';this.pack_lot_lines=this.has_product_lot&&new PacklotlineCollection(null,{'order_line':this});},set_discount:function(discount){var parsed_discount=typeof(discount)==='number'?discount:isNaN(parseFloat(discount))?0:field_utils.parse.float(''+discount);var disc=Math.min(Math.max(parsed_discount||0,0),100);this.discount=disc;this.discountStr=''+disc;this.trigger('change',this);},get_discount:function(){return this.discount;},get_discount_str:function(){return this.discountStr;},set_description:function(description){this.description=description||'';},set_price_extra:function(price_extra){this.price_extra=parseFloat(price_extra)||0.0;},set_full_product_name:function(full_product_name){this.full_product_name=full_product_name||'';},get_price_extra:function(){return this.price_extra;},set_quantity:function(quantity,keep_price){this.order.assert_editable();if(quantity==='remove'){this.order.remove_orderline(this);return;}else{var quant=typeof(quantity)==='number'?quantity:(field_utils.parse.float(''+quantity)||0);var unit=this.get_unit();if(unit){if(unit.rounding){var decimals=this.pos.dp['Product Unit of Measure'];var rounding=Math.max(unit.rounding,Math.pow(10,-decimals));this.quantity=round_pr(quant,rounding);this.quantityStr=field_utils.format.float(this.quantity,{digits:[69,decimals]});}else{this.quantity=round_pr(quant,1);this.quantityStr=this.quantity.toFixed(0);}}else{this.quantity=quant;this.quantityStr=''+this.quantity;}}
if(!keep_price&&!this.price_manually_set&&!(this.pos.config.product_configurator&&_.some(this.product.attribute_line_ids,(id)=>id in this.pos.attributes_by_ptal_id))){this.set_unit_price(this.product.get_price(this.order.pricelist,this.get_quantity(),this.get_price_extra()));this.order.fix_tax_included_price(this);}
this.trigger('change',this);},get_quantity:function(){return this.quantity;},get_quantity_str:function(){return this.quantityStr;},get_quantity_str_with_unit:function(){var unit=this.get_unit();if(unit&&!unit.is_pos_groupable){return this.quantityStr+' '+unit.name;}else{return this.quantityStr;}},get_lot_lines:function(){return this.pack_lot_lines.models;},get_required_number_of_lots:function(){var lots_required=1;if(this.product.tracking=='serial'){lots_required=Math.abs(this.quantity);}
return lots_required;},has_valid_product_lot:function(){if(!this.has_product_lot){return true;}
var valid_product_lot=this.pack_lot_lines.get_valid_lots();return this.get_required_number_of_lots()===valid_product_lot.length;},get_unit:function(){return this.product.get_unit();},get_product:function(){return this.product;},get_full_product_name:function(){if(this.full_product_name){return this.full_product_name}
var full_name=this.product.display_name;if(this.description){full_name+=` (${this.description})`;}
return full_name;},set_selected:function(selected){this.selected=selected;this.trigger('change',this);this.trigger('new-orderline-selected');},is_selected:function(){return this.selected;},can_be_merged_with:function(orderline){var price=parseFloat(round_di(this.price||0,this.pos.dp['Product Price']).toFixed(this.pos.dp['Product Price']));var order_line_price=orderline.get_product().get_price(orderline.order.pricelist,this.get_quantity());order_line_price=round_di(orderline.compute_fixed_price(order_line_price),this.pos.currency.decimals);if(this.get_product().id!==orderline.get_product().id){return false;}else if(!this.get_unit()||!this.get_unit().is_pos_groupable){return false;}else if(this.get_discount()>0){return false;}else if(!utils.float_is_zero(price-order_line_price-orderline.get_price_extra(),this.pos.currency.decimals)){return false;}else if(this.product.tracking=='lot'&&(this.pos.picking_type.use_create_lots||this.pos.picking_type.use_existing_lots)){return false;}else if(this.description!==orderline.description){return false;}else{return true;}},merge:function(orderline){this.order.assert_editable();this.set_quantity(this.get_quantity()+orderline.get_quantity());},export_as_JSON:function(){var pack_lot_ids=[];if(this.has_product_lot){this.pack_lot_lines.each(_.bind(function(item){return pack_lot_ids.push([0,0,item.export_as_JSON()]);},this));}
return{qty:this.get_quantity(),price_unit:this.get_unit_price(),price_subtotal:this.get_price_without_tax(),price_subtotal_incl:this.get_price_with_tax(),discount:this.get_discount(),product_id:this.get_product().id,tax_ids:[[6,false,_.map(this.get_applicable_taxes(),function(tax){return tax.id;})]],id:this.id,pack_lot_ids:pack_lot_ids,description:this.description,full_product_name:this.get_full_product_name(),price_extra:this.get_price_extra(),};},export_for_printing:function(){return{id:this.id,quantity:this.get_quantity(),unit_name:this.get_unit().name,is_in_unit:this.get_unit().id==this.pos.uom_unit_id,price:this.get_unit_display_price(),discount:this.get_discount(),product_name:this.get_product().display_name,product_name_wrapped:this.generate_wrapped_product_name(),price_lst:this.get_lst_price(),display_discount_policy:this.display_discount_policy(),price_display_one:this.get_display_price_one(),price_display:this.get_display_price(),price_with_tax:this.get_price_with_tax(),price_without_tax:this.get_price_without_tax(),price_with_tax_before_discount:this.get_price_with_tax_before_discount(),tax:this.get_tax(),product_description:this.get_product().description,product_description_sale:this.get_product().description_sale,pack_lot_lines:this.get_lot_lines()};},generate_wrapped_product_name:function(){var MAX_LENGTH=24;var wrapped=[];var name=this.get_full_product_name();var current_line="";while(name.length>0){var space_index=name.indexOf(" ");if(space_index===-1){space_index=name.length;}
if(current_line.length+space_index>MAX_LENGTH){if(current_line.length){wrapped.push(current_line);}
current_line="";}
current_line+=name.slice(0,space_index+1);name=name.slice(space_index+1);}
if(current_line.length){wrapped.push(current_line);}
return wrapped;},set_unit_price:function(price){this.order.assert_editable();var parsed_price=!isNaN(price)?price:isNaN(parseFloat(price))?0:field_utils.parse.float(''+price)
this.price=round_di(parsed_price||0,this.pos.dp['Product Price']);this.trigger('change',this);},get_unit_price:function(){var digits=this.pos.dp['Product Price'];return parseFloat(round_di(this.price||0,digits).toFixed(digits));},get_unit_display_price:function(){if(this.pos.config.iface_tax_included==='total'){var quantity=this.quantity;this.quantity=1.0;var price=this.get_all_prices().priceWithTax;this.quantity=quantity;return price;}else{return this.get_unit_price();}},get_base_price:function(){var rounding=this.pos.currency.rounding;return round_pr(this.get_unit_price()*this.get_quantity()*(1-this.get_discount()/100),rounding);},get_taxes_after_fp:function(taxes_ids){return this.pos.get_taxes_after_fp(taxes_ids,this.order);},get_display_price_one:function(){var rounding=this.pos.currency.rounding;var price_unit=this.get_unit_price();if(this.pos.config.iface_tax_included!=='total'){return round_pr(price_unit*(1.0-(this.get_discount()/100.0)),rounding);}else{var product=this.get_product();var taxes_ids=product.taxes_id;var product_taxes=this.get_taxes_after_fp(taxes_ids);var all_taxes=this.compute_all(product_taxes,price_unit,1,this.pos.currency.rounding);return round_pr(all_taxes.total_included*(1-this.get_discount()/100),rounding);}},get_display_price:function(){if(this.pos.config.iface_tax_included==='total'){return this.get_price_with_tax();}else{return this.get_base_price();}},get_taxed_lst_unit_price:function(){var lst_price=this.get_lst_price();if(this.pos.config.iface_tax_included==='total'){var product=this.get_product();var taxes_ids=product.taxes_id;var product_taxes=this.get_taxes_after_fp(taxes_ids);return this.compute_all(product_taxes,lst_price,1,this.pos.currency.rounding).total_included;}
return lst_price;},get_price_without_tax:function(){return this.get_all_prices().priceWithoutTax;},get_price_with_tax:function(){return this.get_all_prices().priceWithTax;},get_price_with_tax_before_discount:function(){return this.get_all_prices().priceWithTaxBeforeDiscount;},get_tax:function(){return this.get_all_prices().tax;},get_applicable_taxes:function(){var i;var ptaxes_ids=this.get_product().taxes_id;var ptaxes_set={};for(i=0;i<ptaxes_ids.length;i++){ptaxes_set[ptaxes_ids[i]]=true;}
var taxes=[];for(i=0;i<this.pos.taxes.length;i++){if(ptaxes_set[this.pos.taxes[i].id]){taxes.push(this.pos.taxes[i]);}}
return taxes;},get_tax_details:function(){return this.get_all_prices().taxDetails;},get_taxes:function(){var taxes_ids=this.get_product().taxes_id;var taxes=[];for(var i=0;i<taxes_ids.length;i++){if(this.pos.taxes_by_id[taxes_ids[i]]){taxes.push(this.pos.taxes_by_id[taxes_ids[i]]);}}
return taxes;},_map_tax_fiscal_position:function(tax,order=false){return this.pos._map_tax_fiscal_position(tax,order);},_compute_all:function(tax,base_amount,quantity,price_exclude){return this.pos._compute_all(tax,base_amount,quantity,price_exclude)},compute_all:function(taxes,price_unit,quantity,currency_rounding,handle_price_include=true){return this.pos.compute_all(taxes,price_unit,quantity,currency_rounding,handle_price_include)},get_all_prices:function(){var price_unit=this.get_unit_price()*(1.0-(this.get_discount()/100.0));var taxtotal=0;var product=this.get_product();var taxes_ids=_.filter(product.taxes_id,t=>t in this.pos.taxes_by_id);var taxdetail={};var product_taxes=this.get_taxes_after_fp(taxes_ids);var all_taxes=this.compute_all(product_taxes,price_unit,this.get_quantity(),this.pos.currency.rounding);var all_taxes_before_discount=this.compute_all(product_taxes,this.get_unit_price(),this.get_quantity(),this.pos.currency.rounding);_(all_taxes.taxes).each(function(tax){taxtotal+=tax.amount;taxdetail[tax.id]=tax.amount;});return{"priceWithTax":all_taxes.total_included,"priceWithoutTax":all_taxes.total_excluded,"priceSumTaxVoid":all_taxes.total_void,"priceWithTaxBeforeDiscount":all_taxes_before_discount.total_included,"tax":taxtotal,"taxDetails":taxdetail,};},display_discount_policy:function(){return this.order.pricelist.discount_policy;},compute_fixed_price:function(price){var order=this.order;if(order.fiscal_position){var taxes=this.get_taxes();var mapped_included_taxes=[];var new_included_taxes=[];var self=this;_(taxes).each(function(tax){var line_taxes=self._map_tax_fiscal_position(tax,order);if(line_taxes.length&&line_taxes[0].price_include){new_included_taxes=new_included_taxes.concat(line_taxes);}
if(tax.price_include&&!_.contains(line_taxes,tax)){mapped_included_taxes.push(tax);}});if(mapped_included_taxes.length>0){if(new_included_taxes.length>0){var price_without_taxes=this.compute_all(mapped_included_taxes,price,1,order.pos.currency.rounding,true).total_excluded
return this.compute_all(new_included_taxes,price_without_taxes,1,order.pos.currency.rounding,false).total_included}
else{return this.compute_all(mapped_included_taxes,price,1,order.pos.currency.rounding,true).total_excluded;}}}
return price;},get_fixed_lst_price:function(){return this.compute_fixed_price(this.get_lst_price());},get_lst_price:function(){return this.product.lst_price;},set_lst_price:function(price){this.order.assert_editable();this.product.lst_price=round_di(parseFloat(price)||0,this.pos.dp['Product Price']);this.trigger('change',this);},is_last_line:function(){var order=this.pos.get_order();var last_id=Object.keys(order.orderlines._byId)[Object.keys(order.orderlines._byId).length-1];var selectedLine=order?order.selected_orderline:null;return!selectedLine?false:last_id===selectedLine.cid;},});var OrderlineCollection=Backbone.Collection.extend({model:exports.Orderline,});exports.Packlotline=Backbone.Model.extend({defaults:{lot_name:null},initialize:function(attributes,options){this.order_line=options.order_line;if(options.json){this.init_from_JSON(options.json);return;}},init_from_JSON:function(json){this.order_line=json.order_line;this.set_lot_name(json.lot_name);},set_lot_name:function(name){this.set({lot_name:_.str.trim(name)||null});},get_lot_name:function(){return this.get('lot_name');},export_as_JSON:function(){return{lot_name:this.get_lot_name(),};},add:function(){var order_line=this.order_line,index=this.collection.indexOf(this);var new_lot_model=new exports.Packlotline({},{'order_line':this.order_line});this.collection.add(new_lot_model,{at:index+1});return new_lot_model;},remove:function(){this.collection.remove(this);}});var PacklotlineCollection=Backbone.Collection.extend({model:exports.Packlotline,initialize:function(models,options){this.order_line=options.order_line;},get_valid_lots:function(){return this.filter(function(model){return model.get('lot_name');});},set_quantity_by_lot:function(){var valid_lots_quantity=this.get_valid_lots().length;if(this.order_line.quantity<0){valid_lots_quantity=-valid_lots_quantity;}
this.order_line.set_quantity(valid_lots_quantity);}});exports.Paymentline=Backbone.Model.extend({initialize:function(attributes,options){this.pos=options.pos;this.order=options.order;this.amount=0;this.selected=false;this.cashier_receipt='';this.ticket='';this.payment_status='';this.card_type='';this.cardholder_name='';this.transaction_id='';if(options.json){this.init_from_JSON(options.json);return;}
this.payment_method=options.payment_method;if(this.payment_method===undefined){throw new Error(_t('Please configure a payment method in your POS.'));}
this.name=this.payment_method.name;},init_from_JSON:function(json){this.amount=json.amount;this.payment_method=this.pos.payment_methods_by_id[json.payment_method_id];this.can_be_reversed=json.can_be_reversed;this.name=this.payment_method.name;this.payment_status=json.payment_status;this.ticket=json.ticket;this.card_type=json.card_type;this.cardholder_name=json.cardholder_name;this.transaction_id=json.transaction_id;this.is_change=json.is_change;},set_amount:function(value){this.order.assert_editable();this.amount=round_di(parseFloat(value)||0,this.pos.currency.decimals);if(this.pos.config.iface_customer_facing_display)this.pos.send_current_order_to_customer_facing_display();this.trigger('change',this);},get_amount:function(){return this.amount;},get_amount_str:function(){return field_utils.format.float(this.amount,{digits:[69,this.pos.currency.decimals]});},set_selected:function(selected){if(this.selected!==selected){this.selected=selected;this.trigger('change',this);}},get_payment_status:function(){return this.payment_status;},set_payment_status:function(value){this.payment_status=value;this.trigger('change',this);},is_done:function(){return this.get_payment_status()?this.get_payment_status()==='done'||this.get_payment_status()==='reversed':true;},set_cashier_receipt:function(value){this.cashier_receipt=value;this.trigger('change',this);},set_receipt_info:function(value){this.ticket+=value;this.trigger('change',this);},export_as_JSON:function(){return{name:time.datetime_to_str(new Date()),payment_method_id:this.payment_method.id,amount:this.get_amount(),payment_status:this.payment_status,can_be_reversed:this.can_be_resersed,ticket:this.ticket,card_type:this.card_type,cardholder_name:this.cardholder_name,transaction_id:this.transaction_id,};},export_for_printing:function(){return{cid:this.cid,amount:this.get_amount(),name:this.name,ticket:this.ticket,};},is_electronic:function(){return Boolean(this.get_payment_status());},});var PaymentlineCollection=Backbone.Collection.extend({model:exports.Paymentline,});exports.Order=Backbone.Model.extend({initialize:function(attributes,options){Backbone.Model.prototype.initialize.apply(this,arguments);var self=this;options=options||{};this.locked=false;this.pos=options.pos;this.selected_orderline=undefined;this.selected_paymentline=undefined;this.screen_data={};this.temporary=options.temporary||false;this.creation_date=new Date();this.to_invoice=false;this.orderlines=new OrderlineCollection();this.paymentlines=new PaymentlineCollection();this.pos_session_id=this.pos.pos_session.id;this.employee=this.pos.employee;this.finalized=false;this.set_pricelist(this.pos.default_pricelist);this.set({client:null});this.uiState={ReceiptScreen:new Context({inputEmail:'',emailSuccessful:null,emailNotice:'',}),TipScreen:new Context({inputTipAmount:'',})};if(options.json){this.init_from_JSON(options.json);}else{this.sequence_number=this.pos.pos_session.sequence_number++;this.uid=this.generate_unique_id();this.name=_.str.sprintf(_t("Order %s"),this.uid);this.validation_date=undefined;this.fiscal_position=_.find(this.pos.fiscal_positions,function(fp){return fp.id===self.pos.config.default_fiscal_position_id[0];});}
this.on('change',function(){this.save_to_db("order:change");},this);this.orderlines.on('change',function(){this.save_to_db("orderline:change");},this);this.orderlines.on('add',function(){this.save_to_db("orderline:add");},this);this.orderlines.on('remove',function(){this.save_to_db("orderline:remove");},this);this.paymentlines.on('change',function(){this.save_to_db("paymentline:change");},this);this.paymentlines.on('add',function(){this.save_to_db("paymentline:add");},this);this.paymentlines.on('remove',function(){this.save_to_db("paymentline:rem");},this);if(this.pos.config.iface_customer_facing_display){this.paymentlines.on('add',this.pos.send_current_order_to_customer_facing_display,this.pos);this.paymentlines.on('remove',this.pos.send_current_order_to_customer_facing_display,this.pos);}
this.save_to_db();return this;},save_to_db:function(){if(!this.temporary&&!this.locked){this.assert_editable();this.pos.db.save_unpaid_order(this);}},init_from_JSON:function(json){var client;if(json.pos_session_id!==this.pos.pos_session.id){this.sequence_number=this.pos.pos_session.sequence_number++;}else{this.sequence_number=json.sequence_number;this.pos.pos_session.sequence_number=Math.max(this.sequence_number+1,this.pos.pos_session.sequence_number);}
this.session_id=this.pos.pos_session.id;this.uid=json.uid;this.name=_.str.sprintf(_t("Order %s"),this.uid);this.validation_date=json.creation_date;this.server_id=json.server_id?json.server_id:false;this.user_id=json.user_id;if(json.fiscal_position_id){var fiscal_position=_.find(this.pos.fiscal_positions,function(fp){return fp.id===json.fiscal_position_id;});if(fiscal_position){this.fiscal_position=fiscal_position;}else{console.error('ERROR: trying to load a fiscal position not available in the pos');}}
if(json.pricelist_id){this.pricelist=_.find(this.pos.pricelists,function(pricelist){return pricelist.id===json.pricelist_id;});}else{this.pricelist=this.pos.default_pricelist;}
if(json.partner_id){client=this.pos.db.get_partner_by_id(json.partner_id);if(!client){console.error('ERROR: trying to load a partner not available in the pos');}}else{client=null;}
this.set_client(client);this.temporary=false;this.to_invoice=false;var orderlines=json.lines;for(var i=0;i<orderlines.length;i++){var orderline=orderlines[i][2];if(this.pos.db.get_product_by_id(orderline.product_id)){this.add_orderline(new exports.Orderline({},{pos:this.pos,order:this,json:orderline}));}}
var paymentlines=json.statement_ids;for(var i=0;i<paymentlines.length;i++){var paymentline=paymentlines[i][2];var newpaymentline=new exports.Paymentline({},{pos:this.pos,order:this,json:paymentline});this.paymentlines.add(newpaymentline);if(i===paymentlines.length-1){this.select_paymentline(newpaymentline);}}
this.locked=['paid','done','invoiced'].includes(json.state);this.state=json.state;this.amount_return=json.amount_return;this.account_move=json.account_move;this.backendId=json.id;this.isFromClosedSession=json.is_session_closed;this.is_tipped=json.is_tipped||false;this.tip_amount=json.tip_amount||0;},export_as_JSON:function(){var orderLines,paymentLines;orderLines=[];this.orderlines.each(_.bind(function(item){return orderLines.push([0,0,item.export_as_JSON()]);},this));paymentLines=[];this.paymentlines.each(_.bind(function(item){return paymentLines.push([0,0,item.export_as_JSON()]);},this));var json={name:this.get_name(),amount_paid:this.get_total_paid()-this.get_change(),amount_total:this.get_total_with_tax(),amount_tax:this.get_total_tax(),amount_return:this.get_change(),lines:orderLines,statement_ids:paymentLines,pos_session_id:this.pos_session_id,pricelist_id:this.pricelist?this.pricelist.id:false,partner_id:this.get_client()?this.get_client().id:false,user_id:this.pos.user.id,uid:this.uid,sequence_number:this.sequence_number,creation_date:this.validation_date||this.creation_date,fiscal_position_id:this.fiscal_position?this.fiscal_position.id:false,server_id:this.server_id?this.server_id:false,to_invoice:this.to_invoice?this.to_invoice:false,is_tipped:this.is_tipped||false,tip_amount:this.tip_amount||0,};if(!this.is_paid&&this.user_id){json.user_id=this.user_id;}
return json;},export_for_printing:function(){var orderlines=[];var self=this;this.orderlines.each(function(orderline){orderlines.push(orderline.export_for_printing());});var paymentlines=this.paymentlines.models.filter(function(paymentline){return!paymentline.is_change;}).map(function(paymentline){return paymentline.export_for_printing();});var client=this.get('client');var cashier=this.pos.get_cashier();var company=this.pos.company;var date=new Date();function is_html(subreceipt){return subreceipt?(subreceipt.split('\n')[0].indexOf('<!DOCTYPE QWEB')>=0):false;}
function render_html(subreceipt){if(!is_html(subreceipt)){return subreceipt;}else{subreceipt=subreceipt.split('\n').slice(1).join('\n');var qweb=new QWeb2.Engine();qweb.debug=config.isDebug();qweb.default_dict=_.clone(QWeb.default_dict);qweb.add_template('<templates><t t-name="subreceipt">'+subreceipt+'</t></templates>');return qweb.render('subreceipt',{'pos':self.pos,'order':self,'receipt':receipt});}}
var receipt={orderlines:orderlines,paymentlines:paymentlines,subtotal:this.get_subtotal(),total_with_tax:this.get_total_with_tax(),total_rounded:this.get_total_with_tax()+this.get_rounding_applied(),total_without_tax:this.get_total_without_tax(),total_tax:this.get_total_tax(),total_paid:this.get_total_paid(),total_discount:this.get_total_discount(),rounding_applied:this.get_rounding_applied(),tax_details:this.get_tax_details(),change:this.locked?this.amount_return:this.get_change(),name:this.get_name(),client:client?client:null,invoice_id:null,cashier:cashier?cashier.name:null,precision:{price:2,money:2,quantity:3,},date:{year:date.getFullYear(),month:date.getMonth(),date:date.getDate(),day:date.getDay(),hour:date.getHours(),minute:date.getMinutes(),isostring:date.toISOString(),localestring:this.formatted_validation_date,},company:{email:company.email,website:company.website,company_registry:company.company_registry,contact_address:company.partner_id[1],vat:company.vat,vat_label:company.country&&company.country.vat_label||_t('Tax ID'),name:company.name,phone:company.phone,logo:this.pos.company_logo_base64,},currency:this.pos.currency,};if(is_html(this.pos.config.receipt_header)){receipt.header='';receipt.header_html=render_html(this.pos.config.receipt_header);}else{receipt.header=this.pos.config.receipt_header||'';}
if(is_html(this.pos.config.receipt_footer)){receipt.footer='';receipt.footer_html=render_html(this.pos.config.receipt_footer);}else{receipt.footer=this.pos.config.receipt_footer||'';}
return receipt;},is_empty:function(){return this.orderlines.models.length===0;},generate_unique_id:function(){function zero_pad(num,size){var s=""+num;while(s.length<size){s="0"+s;}
return s;}
return zero_pad(this.pos.pos_session.id,5)+'-'+
zero_pad(this.pos.pos_session.login_number,3)+'-'+
zero_pad(this.sequence_number,4);},get_name:function(){return this.name;},assert_editable:function(){if(this.finalized){throw new Error('Finalized Order cannot be modified');}},add_orderline:function(line){this.assert_editable();if(line.order){line.order.remove_orderline(line);}
line.order=this;this.orderlines.add(line);this.select_orderline(this.get_last_orderline());},get_orderline:function(id){var orderlines=this.orderlines.models;for(var i=0;i<orderlines.length;i++){if(orderlines[i].id===id){return orderlines[i];}}
return null;},get_orderlines:function(){return this.orderlines.models;},get_last_orderline:function(){return this.orderlines.at(this.orderlines.length-1);},get_tip:function(){var tip_product=this.pos.db.get_product_by_id(this.pos.config.tip_product_id[0]);var lines=this.get_orderlines();if(!tip_product){return 0;}else{for(var i=0;i<lines.length;i++){if(lines[i].get_product()===tip_product){return lines[i].get_unit_price();}}
return 0;}},initialize_validation_date:function(){this.validation_date=new Date();this.formatted_validation_date=field_utils.format.datetime(moment(this.validation_date),{},{timezone:false});},set_tip:function(tip){var tip_product=this.pos.db.get_product_by_id(this.pos.config.tip_product_id[0]);var lines=this.get_orderlines();if(tip_product){for(var i=0;i<lines.length;i++){if(lines[i].get_product()===tip_product){lines[i].set_unit_price(tip);lines[i].set_lst_price(tip);lines[i].price_manually_set=true;lines[i].order.tip_amount=tip;return;}}
return this.add_product(tip_product,{is_tip:true,quantity:1,price:tip,lst_price:tip,extras:{price_manually_set:true},});}},set_pricelist:function(pricelist){var self=this;this.pricelist=pricelist;var lines_to_recompute=_.filter(this.get_orderlines(),function(line){return!line.price_manually_set;});_.each(lines_to_recompute,function(line){line.set_unit_price(line.product.get_price(self.pricelist,line.get_quantity(),line.get_price_extra()));self.fix_tax_included_price(line);});this.trigger('change');},remove_orderline:function(line){this.assert_editable();this.orderlines.remove(line);this.select_orderline(this.get_last_orderline());},fix_tax_included_price:function(line){line.set_unit_price(line.compute_fixed_price(line.price));},add_product:function(product,options){if(this._printed){this.destroy();return this.pos.get_order().add_product(product,options);}
this.assert_editable();options=options||{};var line=new exports.Orderline({},{pos:this.pos,order:this,product:product});this.fix_tax_included_price(line);if(options.quantity!==undefined){line.set_quantity(options.quantity);}
if(options.price_extra!==undefined){line.price_extra=options.price_extra;line.set_unit_price(line.product.get_price(this.pricelist,line.get_quantity(),options.price_extra));this.fix_tax_included_price(line);}
if(options.price!==undefined){line.set_unit_price(options.price);this.fix_tax_included_price(line);}
if(options.lst_price!==undefined){line.set_lst_price(options.lst_price);}
if(options.discount!==undefined){line.set_discount(options.discount);}
if(options.description!==undefined){line.description+=options.description;}
if(options.extras!==undefined){for(var prop in options.extras){line[prop]=options.extras[prop];}}
if(options.is_tip){this.is_tipped=true;this.tip_amount=options.price;}
var to_merge_orderline;for(var i=0;i<this.orderlines.length;i++){if(this.orderlines.at(i).can_be_merged_with(line)&&options.merge!==false){to_merge_orderline=this.orderlines.at(i);}}
if(to_merge_orderline){to_merge_orderline.merge(line);this.select_orderline(to_merge_orderline);}else{this.orderlines.add(line);this.select_orderline(this.get_last_orderline());}
if(options.draftPackLotLines){this.selected_orderline.setPackLotLines(options.draftPackLotLines);}
if(this.pos.config.iface_customer_facing_display){this.pos.send_current_order_to_customer_facing_display();}},get_selected_orderline:function(){return this.selected_orderline;},select_orderline:function(line){if(line){if(line!==this.selected_orderline){if(this.selected_orderline){this.selected_orderline.set_selected(false);}
this.selected_orderline=line;this.selected_orderline.set_selected(true);}}else{this.selected_orderline=undefined;}},deselect_orderline:function(){if(this.selected_orderline){this.selected_orderline.set_selected(false);this.selected_orderline=undefined;}},add_paymentline:function(payment_method){this.assert_editable();if(this.electronic_payment_in_progress()){return false;}else{var newPaymentline=new exports.Paymentline({},{order:this,payment_method:payment_method,pos:this.pos});newPaymentline.set_amount(this.get_due());this.paymentlines.add(newPaymentline);this.select_paymentline(newPaymentline);if(this.pos.config.cash_rounding){this.selected_paymentline.set_amount(0);this.selected_paymentline.set_amount(this.get_due());}
if(payment_method.payment_terminal){newPaymentline.set_payment_status('pending');}
return newPaymentline;}},get_paymentlines:function(){return this.paymentlines.models;},get_paymentline:function(cid){var lines=this.get_paymentlines();return lines.find(function(line){return line.cid===cid;});},remove_paymentline:function(line){this.assert_editable();if(this.selected_paymentline===line){this.select_paymentline(undefined);}
this.paymentlines.remove(line);},clean_empty_paymentlines:function(){var lines=this.paymentlines.models;var empty=[];for(var i=0;i<lines.length;i++){if(!lines[i].get_amount()){empty.push(lines[i]);}}
for(var i=0;i<empty.length;i++){this.remove_paymentline(empty[i]);}},select_paymentline:function(line){if(line!==this.selected_paymentline){if(this.selected_paymentline){this.selected_paymentline.set_selected(false);}
this.selected_paymentline=line;if(this.selected_paymentline){this.selected_paymentline.set_selected(true);}
this.trigger('change:selected_paymentline',this.selected_paymentline);}},electronic_payment_in_progress:function(){return this.get_paymentlines().some(function(pl){if(pl.payment_status){return!['done','reversed'].includes(pl.payment_status);}else{return false;}});},stop_electronic_payment:function(){var lines=this.get_paymentlines();var line=lines.find(function(line){var status=line.get_payment_status();return status&&!['done','reversed','reversing','pending','retry'].includes(status);});if(line){line.set_payment_status('waitingCancel');line.payment_method.payment_terminal.send_payment_cancel(this,line.cid).finally(function(){line.set_payment_status('retry');});}},get_subtotal:function(){return round_pr(this.orderlines.reduce((function(sum,orderLine){return sum+orderLine.get_display_price();}),0),this.pos.currency.rounding);},get_total_with_tax:function(){return this.get_total_without_tax()+this.get_total_tax();},get_total_without_tax:function(){return round_pr(this.orderlines.reduce((function(sum,orderLine){return sum+orderLine.get_price_without_tax();}),0),this.pos.currency.rounding);},get_total_discount:function(){return round_pr(this.orderlines.reduce((function(sum,orderLine){sum+=(orderLine.get_unit_price()*(orderLine.get_discount()/100)*orderLine.get_quantity());if(orderLine.display_discount_policy()==='without_discount'){sum+=((orderLine.get_lst_price()-orderLine.get_unit_price())*orderLine.get_quantity());}
return sum;}),0),this.pos.currency.rounding);},get_total_tax:function(){if(this.pos.company.tax_calculation_rounding_method==="round_globally"){var groupTaxes={};this.orderlines.each(function(line){var taxDetails=line.get_tax_details();var taxIds=Object.keys(taxDetails);for(var t=0;t<taxIds.length;t++){var taxId=taxIds[t];if(!(taxId in groupTaxes)){groupTaxes[taxId]=0;}
groupTaxes[taxId]+=taxDetails[taxId];}});var sum=0;var taxIds=Object.keys(groupTaxes);for(var j=0;j<taxIds.length;j++){var taxAmount=groupTaxes[taxIds[j]];sum+=round_pr(taxAmount,this.pos.currency.rounding);}
return sum;}else{return round_pr(this.orderlines.reduce((function(sum,orderLine){return sum+orderLine.get_tax();}),0),this.pos.currency.rounding);}},get_total_paid:function(){return round_pr(this.paymentlines.reduce((function(sum,paymentLine){if(paymentLine.is_done()){sum+=paymentLine.get_amount();}
return sum;}),0),this.pos.currency.rounding);},get_tax_details:function(){var details={};var fulldetails=[];this.orderlines.each(function(line){var ldetails=line.get_tax_details();for(var id in ldetails){if(ldetails.hasOwnProperty(id)){details[id]=(details[id]||0)+ldetails[id];}}});for(var id in details){if(details.hasOwnProperty(id)){fulldetails.push({amount:details[id],tax:this.pos.taxes_by_id[id],name:this.pos.taxes_by_id[id].name});}}
return fulldetails;},get_total_for_category_with_tax:function(categ_id){var total=0;var self=this;if(categ_id instanceof Array){for(var i=0;i<categ_id.length;i++){total+=this.get_total_for_category_with_tax(categ_id[i]);}
return total;}
this.orderlines.each(function(line){if(self.pos.db.category_contains(categ_id,line.product.id)){total+=line.get_price_with_tax();}});return total;},get_total_for_taxes:function(tax_id){var total=0;if(!(tax_id instanceof Array)){tax_id=[tax_id];}
var tax_set={};for(var i=0;i<tax_id.length;i++){tax_set[tax_id[i]]=true;}
this.orderlines.each(function(line){var taxes_ids=line.get_product().taxes_id;for(var i=0;i<taxes_ids.length;i++){if(tax_set[taxes_ids[i]]){total+=line.get_price_with_tax();return;}}});return total;},get_change:function(paymentline){if(!paymentline){var change=this.get_total_paid()-this.get_total_with_tax()-this.get_rounding_applied();}else{var change=-this.get_total_with_tax();var lines=this.paymentlines.models;for(var i=0;i<lines.length;i++){change+=lines[i].get_amount();if(lines[i]===paymentline){break;}}}
return round_pr(Math.max(0,change),this.pos.currency.rounding);},get_due:function(paymentline){if(!paymentline){var due=this.get_total_with_tax()-this.get_total_paid()+this.get_rounding_applied();}else{var due=this.get_total_with_tax();var lines=this.paymentlines.models;for(var i=0;i<lines.length;i++){if(lines[i]===paymentline){break;}else{due-=lines[i].get_amount();}}}
return round_pr(due,this.pos.currency.rounding);},get_rounding_applied:function(){if(this.pos.config.cash_rounding){const only_cash=this.pos.config.only_round_cash_method;const paymentlines=this.get_paymentlines();const last_line=paymentlines?paymentlines[paymentlines.length-1]:false;const last_line_is_cash=last_line?last_line.payment_method.is_cash_count==true:false;if(!only_cash||(only_cash&&last_line_is_cash)){var remaining=this.get_total_with_tax()-this.get_total_paid();var total=round_pr(remaining,this.pos.cash_rounding[0].rounding);var sign=remaining>0?1.0:-1.0;var rounding_applied=total-remaining;rounding_applied*=sign;if(utils.float_is_zero(rounding_applied,this.pos.currency.decimals)){return 0;}else if(Math.abs(this.get_total_with_tax())<this.pos.cash_rounding[0].rounding){return 0;}else if(this.pos.cash_rounding[0].rounding_method==="UP"&&rounding_applied<0&&remaining>0){rounding_applied+=this.pos.cash_rounding[0].rounding;}
else if(this.pos.cash_rounding[0].rounding_method==="UP"&&rounding_applied>0&&remaining<0){rounding_applied-=this.pos.cash_rounding[0].rounding;}
else if(this.pos.cash_rounding[0].rounding_method==="DOWN"&&rounding_applied>0&&remaining>0){rounding_applied-=this.pos.cash_rounding[0].rounding;}
else if(this.pos.cash_rounding[0].rounding_method==="DOWN"&&rounding_applied<0&&remaining<0){rounding_applied+=this.pos.cash_rounding[0].rounding;}
return sign*rounding_applied;}
else{return 0;}}
return 0;},has_not_valid_rounding:function(){if(!this.pos.config.cash_rounding||this.get_total_with_tax()<this.pos.cash_rounding[0].rounding)
return false;const only_cash=this.pos.config.only_round_cash_method;var lines=this.paymentlines.models;for(var i=0;i<lines.length;i++){var line=lines[i];if(only_cash&&!line.payment_method.is_cash_count)
continue;if(!utils.float_is_zero(line.amount-round_pr(line.amount,this.pos.cash_rounding[0].rounding),6))
return line;}
return false;},is_paid:function(){return this.get_due()<=0&&this.check_paymentlines_rounding();},is_paid_with_cash:function(){return!!this.paymentlines.find(function(pl){return pl.payment_method.is_cash_count;});},check_paymentlines_rounding:function(){if(this.pos.config.cash_rounding){var cash_rounding=this.pos.cash_rounding[0].rounding;var default_rounding=this.pos.currency.rounding;for(var id in this.get_paymentlines()){var line=this.get_paymentlines()[id];var diff=round_pr(round_pr(line.amount,cash_rounding)-round_pr(line.amount,default_rounding),default_rounding);if(this.get_total_with_tax()<this.pos.cash_rounding[0].rounding)
return true;if(diff&&line.payment_method.is_cash_count){return false;}else if(!this.pos.config.only_round_cash_method&&diff){return false;}}
return true;}
return true;},finalize:function(){this.destroy();},destroy:function(){Backbone.Model.prototype.destroy.apply(this,arguments);this.pos.db.remove_unpaid_order(this);},set_to_invoice:function(to_invoice){this.assert_editable();this.to_invoice=to_invoice;},is_to_invoice:function(){return this.to_invoice;},set_client:function(client){this.assert_editable();this.set('client',client);},get_client:function(){return this.get('client');},get_client_name:function(){var client=this.get('client');return client?client.name:"";},get_cardholder_name:function(){var card_payment_line=this.paymentlines.find(pl=>pl.cardholder_name);return card_payment_line?card_payment_line.cardholder_name:"";},set_screen_data:function(value){this.screen_data['value']=value;},get_screen_data:function(){const screen=this.screen_data['value'];if(!screen){if(this.get_paymentlines().length>0)return{name:'PaymentScreen'};return{name:'ProductScreen'};}
if(!this.finalized&&this.get_paymentlines().length>0){return{name:'PaymentScreen'};}
return screen;},wait_for_push_order:function(){return false;},getOrderReceiptEnv:function(){return{order:this,receipt:this.export_for_printing(),orderlines:this.get_orderlines(),paymentlines:this.get_paymentlines(),};},updatePricelist:function(newClient){let newClientPricelist,newClientFiscalPosition;const defaultFiscalPosition=this.pos.fiscal_positions.find((position)=>position.id===this.pos.config.default_fiscal_position_id[0]);if(newClient){newClientFiscalPosition=newClient.property_account_position_id?this.pos.fiscal_positions.find((position)=>position.id===newClient.property_account_position_id[0]):defaultFiscalPosition;newClientPricelist=this.pos.pricelists.find((pricelist)=>pricelist.id===newClient.property_product_pricelist[0])||this.pos.default_pricelist;}else{newClientFiscalPosition=defaultFiscalPosition;newClientPricelist=this.pos.default_pricelist;}
this.fiscal_position=newClientFiscalPosition;this.set_pricelist(newClientPricelist);}});var OrderCollection=Backbone.Collection.extend({model:exports.Order,});return exports;});;

/* /point_of_sale/static/src/js/keyboard.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.keyboard',function(require){"use strict";var Widget=require('web.Widget');var OnscreenKeyboardWidget=Widget.extend({template:'OnscreenKeyboardSimple',init:function(parent,options){this._super(parent,options);options=options||{};this.keyboard_model=options.keyboard_model||'simple';if(this.keyboard_model==='full'){this.template='OnscreenKeyboardFull';}
this.input_selector=options.input_selector||'.searchbox input';this.$target=null;this.capslock=false;this.shift=false;this.numlock=false;},connect:function(target){var self=this;this.$target=$(target);this.$target.focus(function(){self.show();});},generateEvent:function(type,key){var event=document.createEvent("KeyboardEvent");var initMethod=event.initKeyboardEvent?'initKeyboardEvent':'initKeyEvent';event[initMethod](type,true,true,window,false,false,false,false,((typeof key.code==='undefined')?key.char.charCodeAt(0):key.code),((typeof key.char==='undefined')?String.fromCharCode(key.code):key.char));return event;},writeCharacter:function(character){var input=this.$target[0];input.dispatchEvent(this.generateEvent('keypress',{char:character}));if(character!=='\n'){input.value+=character;}
input.dispatchEvent(this.generateEvent('keyup',{char:character}));},deleteCharacter:function(){var input=this.$target[0];input.dispatchEvent(this.generateEvent('keypress',{code:8}));input.value=input.value.substr(0,input.value.length-1);input.dispatchEvent(this.generateEvent('keyup',{code:8}));},deleteAllCharacters:function(){var input=this.$target[0];if(input.value){input.dispatchEvent(this.generateEvent('keypress',{code:8}));input.value="";input.dispatchEvent(this.generateEvent('keyup',{code:8}));}},show:function(){$('.keyboard_frame').show().css({'height':'235px'});},hide:function(){$('.keyboard_frame').css({'height':'0'}).hide();this.reset();},toggleShift:function(){$('.letter').toggleClass('uppercase');$('.symbol span').toggle();this.shift=(this.shift===true)?false:true;this.capslock=false;},toggleCapsLock:function(){$('.letter').toggleClass('uppercase');this.capslock=true;},toggleNumLock:function(){$('.symbol span').toggle();$('.numlock span').toggle();this.numlock=(this.numlock===true)?false:true;},removeShift:function(){if(this.shift===true){$('.symbol span').toggle();if(this.capslock===false)$('.letter').toggleClass('uppercase');this.shift=false;}},reset:function(){if(this.shift){this.toggleShift();}
if(this.capslock){this.toggleCapsLock();}
if(this.numlock){this.toggleNumLock();}},start:function(){var self=this;$('.close_button').click(function(){self.deleteAllCharacters();self.hide();});$('.keyboard li').click(function(){var $this=$(this),character=$this.html();if($this.hasClass('left-shift')||$this.hasClass('right-shift')){self.toggleShift();return false;}
if($this.hasClass('capslock')){self.toggleCapsLock();return false;}
if($this.hasClass('delete')){self.deleteCharacter();return false;}
if($this.hasClass('numlock')){self.toggleNumLock();return false;}
if($this.hasClass('symbol'))character=$('span:visible',$this).html();if($this.hasClass('space'))character=' ';if($this.hasClass('tab'))character="\t";if($this.hasClass('return'))character="\n";if($this.hasClass('uppercase'))character=character.toUpperCase();self.removeShift();self.writeCharacter(character);});},});return{OnscreenKeyboardWidget:OnscreenKeyboardWidget,};});;

/* /point_of_sale/static/src/js/barcode_reader.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.BarcodeReader',function(require){"use strict";var core=require('web.core');var BarcodeReader=core.Class.extend({actions:['product','cashier','client',],init:function(attributes){this.pos=attributes.pos;this.action_callbacks={};this.exclusive_callbacks={};this.proxy=attributes.proxy;this.remote_scanning=false;this.remote_active=0;this.barcode_parser=attributes.barcode_parser;this.action_callback_stack=[];core.bus.on('barcode_scanned',this,function(barcode){this.scan(barcode);});},set_barcode_parser:function(barcode_parser){this.barcode_parser=barcode_parser;},set_action_callback:function(name,callback){if(this.action_callbacks[name]){this.action_callbacks[name].add(callback);}else{this.action_callbacks[name]=new Set([callback]);}},remove_action_callback:function(name,callback){if(!callback){delete this.action_callbacks[name];return;}
const callbacks=this.action_callbacks[name];if(callbacks){callbacks.delete(callback);if(callbacks.size===0){delete this.action_callbacks[name];}}},set_exclusive_callback:function(name,callback){if(this.exclusive_callbacks[name]){this.exclusive_callbacks[name].add(callback);}else{this.exclusive_callbacks[name]=new Set([callback]);}},remove_exclusive_callback:function(name,callback){if(!callback){delete this.exclusive_callbacks[name];return;}
const callbacks=this.exclusive_callbacks[name];if(callbacks){callbacks.delete(callback);if(callbacks.size===0){delete this.exclusive_callbacks[name];}}},scan:function(code){if(!code)return;const callbacks=Object.keys(this.exclusive_callbacks).length?this.exclusive_callbacks:this.action_callbacks;const parsed_result=this.barcode_parser.parse_barcode(code);if(callbacks[parsed_result.type]){[...callbacks[parsed_result.type]].map((cb)=>cb(parsed_result));}else if(callbacks.error){[...callbacks.error].map((cb)=>cb(parsed_result));}else{console.warn('Ignored Barcode Scan:',parsed_result);}},connect_to_proxy:function(){var self=this;this.remote_scanning=true;if(this.remote_active>=1){return;}
this.remote_active=1;function waitforbarcode(){return self.proxy.connection.rpc('/hw_proxy/scanner',{},{shadow:true,timeout:7500}).then(function(barcode){if(!self.remote_scanning){self.remote_active=0;return;}
self.scan(barcode);waitforbarcode();},function(){if(!self.remote_scanning){self.remote_active=0;return;}
waitforbarcode();});}
waitforbarcode();},disconnect_from_proxy:function(){this.remote_scanning=false;},});return BarcodeReader;});;

/* /point_of_sale/static/src/js/printers.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.Printer',function(require){"use strict";var Session=require('web.Session');var core=require('web.core');const{Gui}=require('point_of_sale.Gui');var _t=core._t;class PrintResult{constructor({successful,message}){this.successful=successful;this.message=message;}}
class PrintResultGenerator{IoTActionError(){return new PrintResult({successful:false,message:{title:_t('Connection to IoT Box failed'),body:_t('Please check if the IoT Box is still connected.'),},});}
IoTResultError(){return new PrintResult({successful:false,message:{title:_t('Connection to the printer failed'),body:_t('Please check if the printer is still connected.'),},});}
Successful(){return new PrintResult({successful:true,});}}
var PrinterMixin={init:function(pos){this.receipt_queue=[];this.printResultGenerator=new PrintResultGenerator();this.pos=pos;},print_receipt:async function(receipt){if(receipt){this.receipt_queue.push(receipt);}
let image,sendPrintResult;while(this.receipt_queue.length>0){receipt=this.receipt_queue.shift();image=await this.htmlToImg(receipt);try{sendPrintResult=await this.send_printing_job(image);}catch(error){this.receipt_queue.length=0;return this.printResultGenerator.IoTActionError();}
if(!sendPrintResult||sendPrintResult.result===false){this.receipt_queue.length=0;return this.printResultGenerator.IoTResultError();}}
return this.printResultGenerator.Successful();},process_canvas:function(canvas){return canvas.toDataURL('image/jpeg').replace('data:image/jpeg;base64,','');},htmlToImg:function(receipt){var self=this;$('.pos-receipt-print').html(receipt);var promise=new Promise(function(resolve,reject){self.receipt=$('.pos-receipt-print>.pos-receipt');html2canvas(self.receipt[0],{onparsed:function(queue){queue.stack.ctx.height=Math.ceil(self.receipt.outerHeight()+self.receipt.offset().top);queue.stack.ctx.width=Math.ceil(self.receipt.outerWidth()+self.receipt.offset().left);},onrendered:function(canvas){$('.pos-receipt-print').empty();resolve(self.process_canvas(canvas));},letterRendering:self.pos.htmlToImgLetterRendering(),})});return promise;},_onIoTActionResult:function(data){if(this.pos&&(data===false||data.result===false)){Gui.showPopup('ErrorPopup',{'title':_t('Connection to the printer failed'),'body':_t('Please check if the printer is still connected.'),});}},_onIoTActionFail:function(){if(this.pos){Gui.showPopup('ErrorPopup',{'title':_t('Connection to IoT Box failed'),'body':_t('Please check if the IoT Box is still connected.'),});}},}
var Printer=core.Class.extend(PrinterMixin,{init:function(url,pos){PrinterMixin.init.call(this,pos);this.connection=new Session(undefined,url||'http://localhost:8069',{use_cors:true});},open_cashbox:function(){var self=this;return this.connection.rpc('/hw_proxy/default_printer_action',{data:{action:'cashbox'}}).then(self._onIoTActionResult.bind(self)).guardedCatch(self._onIoTActionFail.bind(self));},send_printing_job:function(img){return this.connection.rpc('/hw_proxy/default_printer_action',{data:{action:'print_receipt',receipt:img,}});},});return{PrinterMixin:PrinterMixin,Printer:Printer,PrintResult,PrintResultGenerator,}});;

/* /point_of_sale/static/src/js/Gui.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.Gui',function(require){'use strict';const config={};const configureGui=({component})=>{config.component=component;config.availableMethods=new Set(['showPopup','showTempScreen','playSound','setSyncStatus',]);};const Gui=new Proxy(config,{get(target,key){const{component,availableMethods}=target;if(!component)throw new Error(`Call 'configureGui' before using Gui.`);const isMounted=component.__owl__.status===3;if(availableMethods.has(key)&&isMounted){return component[key].bind(component);}},});return{configureGui,Gui};});;

/* /point_of_sale/static/src/js/PopupControllerMixin.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.PopupControllerMixin',function(require){'use strict';const{useState}=owl;const{useListener}=require('web.custom_hooks');const PopupControllerMixin=x=>class extends x{constructor(){super(...arguments);useListener('show-popup',this.__showPopup);useListener('close-popup',this.__closePopup);this.popup=useState({isShown:false,name:null,component:null});this.popupProps={};}
__showPopup(event){const{name,props,resolve}=event.detail;const popupConstructor=this.constructor.components[name];if(popupConstructor.dontShow){resolve();return;}
this.popup.isShown=true;this.popup.name=name;this.popup.component=popupConstructor;this.popupProps=Object.assign({},props,{resolve});}
__closePopup(){this.popup.isShown=false;}};return PopupControllerMixin;});;

/* /point_of_sale/static/src/js/ControlButtonsMixin.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ControlButtonsMixin',function(require){'use strict';const Registries=require('point_of_sale.Registries');const ControlButtonsMixin=(x)=>{class Extended extends x{get controlButtons(){return this.constructor.controlButtons.filter((cb)=>{return cb.condition.bind(this)();}).map((cb)=>Object.assign({},cb,{component:Registries.Component.get(cb.component)}));}}
Extended.controlButtons=[];Extended.addControlButton=function(controlButton){if(!controlButton.name){controlButton.name=controlButton.component.name;}
if(!controlButton.position){this.controlButtons.push(controlButton);}else{const[locator,relativeTo]=controlButton.position;let whereIndex=-1;for(let i=0;i<this.controlButtons.length;i++){if(this.controlButtons[i].name===relativeTo){if(['before','replace'].includes(locator)){whereIndex=i;}else if(locator==='after'){whereIndex=i+1;}
break;}}
if(whereIndex>-1){this.controlButtons.splice(whereIndex,locator==='replace'?1:0,controlButton);}else{let warningMessage=`'${controlButton.name}' has invalid 'position' ([${locator}, ${relativeTo}]).`+'It is pushed to the controlButtons stack instead.';console.warn(warningMessage);this.controlButtons.push(controlButton);}}};return Extended;};return ControlButtonsMixin;});;

/* /point_of_sale/static/src/js/Chrome.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.Chrome',function(require){'use strict';const{useState,useRef,useContext}=owl.hooks;const{debounce}=owl.utils;const{loadCSS}=require('web.ajax');const{useListener}=require('web.custom_hooks');const{CrashManager}=require('web.CrashManager');const{BarcodeEvents}=require('barcodes.BarcodeEvents');const PosComponent=require('point_of_sale.PosComponent');const NumberBuffer=require('point_of_sale.NumberBuffer');const PopupControllerMixin=require('point_of_sale.PopupControllerMixin');const Registries=require('point_of_sale.Registries');const IndependentToOrderScreen=require('point_of_sale.IndependentToOrderScreen');const contexts=require('point_of_sale.PosContext');const models=require('point_of_sale.models');class Chrome extends PopupControllerMixin(PosComponent){constructor(){super(...arguments);useListener('show-main-screen',this.__showScreen);useListener('toggle-debug-widget',debounce(this._toggleDebugWidget,100));useListener('show-temp-screen',this.__showTempScreen);useListener('close-temp-screen',this.__closeTempScreen);useListener('close-pos',this._closePos);useListener('loading-skip-callback',()=>this._loadingSkipCallback());useListener('play-sound',this._onPlaySound);useListener('set-sync-status',this._onSetSyncStatus);NumberBuffer.activate();this.chromeContext=useContext(contexts.chrome);this.state=useState({uiState:'LOADING',debugWidgetIsShown:true,hasBigScrollBars:false,sound:{src:null},});this.loading=useState({message:'Loading',skipButtonIsShown:false,});this.mainScreen=useState({name:null,component:null});this.mainScreenProps={};this.tempScreen=useState({isShown:false,name:null,component:null});this.tempScreenProps={};this.progressbar=useRef('progressbar');this.previous_touch_y_coordinate=-1;}
mounted(){$(document).off();$(window).off();$('html').off();$('body').off();BarcodeEvents.start();}
willUnmount(){BarcodeEvents.stop();}
destroy(){super.destroy(...arguments);this.env.pos.destroy();}
catchError(error){console.error(error);}
get clientScreenButtonIsShown(){return(this.env.pos.config.use_proxy&&this.env.pos.config.iface_customer_facing_display);}
get startScreen(){if(this.state.uiState!=='READY'){console.warn(`Accessing startScreen of Chrome component before 'state.uiState' to be 'READY' is not recommended.`);}
return{name:'ProductScreen'};}
async start(){try{const posModelDefaultAttributes={env:this.env,rpc:this.rpc.bind(this),session:this.env.session,do_action:this.props.webClient.do_action.bind(this.props.webClient),setLoadingMessage:this.setLoadingMessage.bind(this),showLoadingSkip:this.showLoadingSkip.bind(this),setLoadingProgress:this.setLoadingProgress.bind(this),};this.env.pos=new models.PosModel(posModelDefaultAttributes);await this.env.pos.ready;this._buildChrome();this._closeOtherTabs();this.env.pos.set('selectedCategoryId',this.env.pos.config.iface_start_categ_id?this.env.pos.config.iface_start_categ_id[0]:0);this.state.uiState='READY';this.env.pos.on('change:selectedOrder',this._showSavedScreen,this);this._showStartScreen();if(_.isEmpty(this.env.pos.db.product_by_category_id)){this._loadDemoData();}
setTimeout(()=>{this.env.pos.push_orders();this._preloadImages();});}catch(error){let title='Unknown Error',body;if(error.message&&[100,200,404,-32098].includes(error.message.code)){if(error.message.code===-32098){title='Network Failure (XmlHttpRequestError)';body='The Point of Sale could not be loaded due to a network problem.\n'+'Please check your internet connection.';}else if(error.message.code===200){title=error.message.data.message||this.env._t('Server Error');body=error.message.data.debug||this.env._t('The server encountered an error while receiving your order.');}}else if(error instanceof Error){title=error.message;body=error.stack;}
await this.showPopup('ErrorTracebackPopup',{title,body,exitButtonIsShown:true,});}}
_showStartScreen(){const{name,props}=this.startScreen;this.showScreen(name,props);}
_showSavedScreen(pos,newSelectedOrder){const{name,props}=this._getSavedScreen(newSelectedOrder);this.showScreen(name,props);}
_getSavedScreen(order){return order.get_screen_data();}
__showTempScreen(event){const{name,props,resolve}=event.detail;this.tempScreen.isShown=true;this.tempScreen.name=name;this.tempScreen.component=this.constructor.components[name];this.tempScreenProps=Object.assign({},props,{resolve});}
__closeTempScreen(){this.tempScreen.isShown=false;}
__showScreen({detail:{name,props={}}}){const component=this.constructor.components[name];this.mainScreen.name=name;this.mainScreen.component=component;this.mainScreenProps=props;this.chromeContext.showOrderSelector=!component.hideOrderSelector;if(!(component.prototype instanceof IndependentToOrderScreen)&&name!=="ReprintReceiptScreen"){this._setScreenData(name,props);}}
_setScreenData(name,props){const order=this.env.pos.get_order();if(order){order.set_screen_data({name,props});}}
async _closePos(){if(!this.env.pos||this.env.pos.db.get_orders().length===0){window.location='/web#action=point_of_sale.action_client_pos_menu';}
if(this.env.pos.db.get_orders().length){try{await this.env.pos.push_orders();window.location='/web#action=point_of_sale.action_client_pos_menu';}catch(error){console.warn(error);const reason=this.env.pos.get('failed')?this.env._t('Some orders could not be submitted to '+'the server due to configuration errors. '+'You can exit the Point of Sale, but do '+'not close the session before the issue '+'has been resolved.'):this.env._t('Some orders could not be submitted to '+'the server due to internet connection issues. '+'You can exit the Point of Sale, but do '+'not close the session before the issue '+'has been resolved.');const{confirmed}=await this.showPopup('ConfirmPopup',{title:this.env._t('Offline Orders'),body:reason,});if(confirmed){this.state.uiState='CLOSING';this.loading.skipButtonIsShown=false;this.setLoadingMessage(this.env._t('Closing ...'));window.location='/web#action=point_of_sale.action_client_pos_menu';}}}}
_toggleDebugWidget(){this.state.debugWidgetIsShown=!this.state.debugWidgetIsShown;}
_onPlaySound({detail:name}){let src;if(name==='error'){src="/point_of_sale/static/src/sounds/error.wav";}else if(name==='bell'){src="/point_of_sale/static/src/sounds/bell.wav";}
this.state.sound.src=src;}
_onSetSyncStatus({detail:{status,pending}}){this.env.pos.set('synch',{status,pending});}
setLoadingProgress(fac){if(this.progressbar.el){this.progressbar.el.style.width=`${Math.floor(fac * 100)}%`;}}
setLoadingMessage(msg,progress){this.loading.message=msg;if(typeof progress!=='undefined'){this.setLoadingProgress(progress);}}
showLoadingSkip(callback){if(callback){this.loading.skipButtonIsShown=true;this._loadingSkipCallback=callback;}}
get isTicketScreenShown(){return this.mainScreen.name==='TicketScreen';}
async _loadDemoData(){const{confirmed}=await this.showPopup('ConfirmPopup',{title:this.env._t('You do not have any products'),body:this.env._t('Would you like to load demo data?'),});if(confirmed){await this.rpc({'route':'/pos/load_onboarding_data',});this.env.pos.load_server_data();}}
_preloadImages(){for(let product of this.env.pos.db.get_product_by_category(0)){const image=new Image();image.src=`/web/image?model=product.product&field=image_128&id=${product.id}&write_date=${product.write_date}&unique=1`;}
for(let category of Object.values(this.env.pos.db.category_by_id)){if(category.id==0)continue;const image=new Image();image.src=`/web/image?model=pos.category&field=image_128&id=${category.id}&write_date=${category.write_date}&unique=1`;}
const staticImages=['backspace.png','bc-arrow-big.png'];for(let imageName of staticImages){const image=new Image();image.src=`/point_of_sale/static/src/img/${imageName}`;}}
_buildChrome(){if($.browser.chrome){var chrome_version=$.browser.version.split('.')[0];if(parseInt(chrome_version,10)>=50){loadCSS('/point_of_sale/static/src/css/chrome50.css');}}
if(this.env.pos.config.iface_big_scrollbars){this.state.hasBigScrollBars=true;}
this._disableBackspaceBack();this._replaceCrashmanager();}
_replaceCrashmanager(){var self=this;CrashManager.include({show_warning:function(error){if(self.env.pos){self.showPopup('ErrorPopup',{title:error.data.title.toString(),body:error.data.message,});}else{this._super(error);}},show_error:function(error){if(self.env.pos){self.showPopup('ErrorTracebackPopup',{title:error.type,body:error.message+'\n'+error.data.debug+'\n',});}else{this._super(error);}},});}
_disableBackspaceBack(){$(document).on('keydown',function(e){if(e.which===8&&!$(e.target).is('input, textarea')){e.preventDefault();}});}
_closeOtherTabs(){localStorage['message']='';localStorage['message']=JSON.stringify({message:'close_tabs',session:this.env.pos.pos_session.id,});window.addEventListener('storage',(event)=>{if(event.key==='message'&&event.newValue){const msg=JSON.parse(event.newValue);if(msg.message==='close_tabs'&&msg.session==this.env.pos.pos_session.id){console.info('POS / Session opened in another window. EXITING POS');this._closePos();}}},false);}}
Chrome.template='Chrome';Registries.Component.add(Chrome);return Chrome;});;

/* /point_of_sale/static/src/js/devices.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.devices',function(require){"use strict";var core=require('web.core');var mixins=require('web.mixins');var Session=require('web.Session');var Printer=require('point_of_sale.Printer').Printer;var JobQueue=function(){var queue=[];var running=false;var scheduled_end_time=0;var end_of_queue=Promise.resolve();var stoprepeat=false;var run=function(){var runNextJob=function(){if(queue.length===0){running=false;scheduled_end_time=0;return Promise.resolve();}
running=true;var job=queue[0];if(!job.opts.repeat||stoprepeat){queue.shift();stoprepeat=false;}
scheduled_end_time=(new Date()).getTime()+(job.opts.duration||0);var prom=job.fun()||Promise.resolve();var always=function(){return new Promise(function(resolve,reject){setTimeout(resolve,Math.max(0,scheduled_end_time-(new Date()).getTime()));});};return prom.then(always,always).then(runNextJob);};if(!running){end_of_queue=runNextJob();}};this.schedule=function(fun,opts){queue.push({fun:fun,opts:opts||{}});if(!running){run();}};this.clear=function(){queue=_.filter(queue,function(job){return job.opts.important===true;});};this.stoprepeat=function(){stoprepeat=true;};this.finished=function(){return end_of_queue;};};var ProxyDevice=core.Class.extend(mixins.PropertiesMixin,{init:function(parent,options){mixins.PropertiesMixin.init.call(this);var self=this;this.setParent(parent);options=options||{};this.pos=parent;this.weighing=false;this.debug_weight=0;this.use_debug_weight=false;this.paying=false;this.default_payment_status={status:'waiting',message:'',payment_method:undefined,receipt_client:undefined,receipt_shop:undefined,};this.custom_payment_status=this.default_payment_status;this.notifications={};this.bypass_proxy=false;this.connection=null;this.host='';this.keptalive=false;this.set('status',{});this.set_connection_status('disconnected');this.on('change:status',this,function(eh,status){status=status.newValue;if(status.status==='connected'&&self.printer){self.printer.print_receipt();}});this.posbox_supports_display=true;window.hw_proxy=this;},set_connection_status:function(status,drivers,msg=''){var oldstatus=this.get('status');var newstatus={};newstatus.status=status;newstatus.drivers=status==='disconnected'?{}:oldstatus.drivers;newstatus.drivers=drivers?drivers:newstatus.drivers;newstatus.msg=msg;this.set('status',newstatus);},disconnect:function(){if(this.get('status').status!=='disconnected'){this.connection.destroy();this.set_connection_status('disconnected');}},connect:function(url){var self=this;this.connection=new Session(undefined,url,{use_cors:true});this.host=url;if(this.pos.config.iface_print_via_proxy){this.connect_to_printer();}
this.set_connection_status('connecting',{});return this.message('handshake').then(function(response){if(response){self.set_connection_status('connected');localStorage.hw_proxy_url=url;self.keepalive();}else{self.set_connection_status('disconnected');console.error('Connection refused by the Proxy');}},function(){self.set_connection_status('disconnected');console.error('Could not connect to the Proxy');});},connect_to_printer:function(){this.printer=new Printer(this.host,this.pos);},autoconnect:function(options){var self=this;this.set_connection_status('connecting',{});if(this.pos.config.iface_print_via_proxy){this.connect_to_printer();}
var found_url=new Promise(function(){});if(options.force_ip){found_url=this.try_hard_to_connect(options.force_ip,options);}else if(localStorage.hw_proxy_url){found_url=this.try_hard_to_connect(localStorage.hw_proxy_url,options).catch(function(){if(window.location.protocol!='https:'){return self.find_proxy(options);}});}else{if(window.location.protocol!='https:'){found_url=this.find_proxy(options);}}
var successProm=found_url.then(function(url){return self.connect(url);});successProm.catch(function(){self.set_connection_status('disconnected');});return successProm;},keepalive:function(){var self=this;function status(){var always=function(){setTimeout(status,5000);};self.connection.rpc('/hw_proxy/status_json',{},{shadow:true,timeout:2500}).then(function(driver_status){self.set_connection_status('connected',driver_status);},function(){if(self.get('status').status!=='connecting'){self.set_connection_status('disconnected');}}).then(always,always);}
if(!this.keptalive){this.keptalive=true;status();}},message:function(name,params){var callbacks=this.notifications[name]||[];for(var i=0;i<callbacks.length;i++){callbacks[i](params);}
if(this.get('status').status!=='disconnected'){return this.connection.rpc('/hw_proxy/'+name,params||{},{shadow:true});}else{return Promise.reject();}},try_hard_to_connect:function(url,options){options=options||{};var protocol=window.location.protocol;var port=(!options.port&&protocol=="https:")?':443':':'+(options.port||'8069');this.set_connection_status('connecting');if(url.indexOf('//')<0){url=protocol+'//'+url;}
if(url.indexOf(':',5)<0){url=url+port;}
function try_real_hard_to_connect(url,retries){return Promise.resolve($.ajax({url:url+'/hw_proxy/hello',method:'GET',timeout:1000,}).then(function(){return Promise.resolve(url);},function(resp){if(retries>0){return try_real_hard_to_connect(url,retries-1);}else{return Promise.reject([resp.statusText,url]);}}));}
return try_real_hard_to_connect(url,3);},find_proxy:function(options){options=options||{};var self=this;var port=':'+(options.port||'8069');var urls=[];var found=false;var parallel=8;var threads=[];var progress=0;urls.push('http://localhost'+port);for(var i=0;i<256;i++){urls.push('http://192.168.0.'+i+port);urls.push('http://192.168.1.'+i+port);urls.push('http://10.0.0.'+i+port);}
var prog_inc=1/urls.length;function update_progress(){progress=found?1:progress+prog_inc;if(options.progress){options.progress(progress);}}
function thread(){var url=urls.shift();if(!url||found||!self.searching_for_proxy){return Promise.resolve();}
return Promise.resolve($.ajax({url:url+'/hw_proxy/hello',method:'GET',timeout:400,}).then(function(){found=true;update_progress();return Promise.resolve(url);},function(){update_progress();return thread();}));}
this.searching_for_proxy=true;var len=Math.min(parallel,urls.length);for(i=0;i<len;i++){threads.push(thread());}
return new Promise(function(resolve,reject){Promise.all(threads).then(function(results){var urls=[];for(var i=0;i<results.length;i++){if(results[i]){urls.push(results[i]);}}
resolve(urls[0]);});});},stop_searching:function(){this.searching_for_proxy=false;this.set_connection_status('disconnected');},add_notification:function(name,callback){if(!this.notifications[name]){this.notifications[name]=[];}
this.notifications[name].push(callback);},scale_read:function(){var self=this;if(self.use_debug_weight){return Promise.resolve({weight:this.debug_weight,unit:'Kg',info:'ok'});}
return new Promise(function(resolve,reject){self.message('scale_read',{}).then(function(weight){resolve(weight);},function(){resolve({weight:0.0,unit:'Kg',info:'ok'});});});},debug_set_weight:function(kg){this.use_debug_weight=true;this.debug_weight=kg;},debug_reset_weight:function(){this.use_debug_weight=false;this.debug_weight=0;},update_customer_facing_display:function(html){if(this.posbox_supports_display){return this.message('customer_facing_display',{html:html},{timeout:5000});}},take_ownership_over_client_screen:function(html){return this.message("take_control",{html:html});},test_ownership_of_client_screen:function(){if(this.connection){return this.message("test_ownership",{});}
return Promise.reject({abort:true});},log:function(){return this.message('log',{'arguments':_.toArray(arguments)});},});return{JobQueue:JobQueue,ProxyDevice:ProxyDevice,};});;

/* /point_of_sale/static/src/js/payment.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.PaymentInterface',function(require){"use strict";var core=require('web.core');var PaymentInterface=core.Class.extend({init:function(pos,payment_method){this.pos=pos;this.payment_method=payment_method;this.supports_reversals=false;},enable_reversals:function(){this.supports_reversals=true;},send_payment_request:function(cid){},send_payment_cancel:function(order,cid){},send_payment_reversal:function(cid){},close:function(){},});return PaymentInterface;});;

/* /point_of_sale/static/src/js/custom_hooks.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.custom_hooks',function(require){'use strict';const{Component}=owl;const{onMounted,onPatched,onWillUnmount}=owl.hooks;function useErrorHandlers(){const component=Component.current;component._handlePushOrderError=async function(error){if(error.message==='Backend Invoice'){await this.showPopup('ConfirmPopup',{title:this.env._t('Please print the invoice from the backend'),body:this.env._t('The order has been synchronized earlier. Please make the invoice from the backend for the order: ')+error.data.order.name,});}else if(error.code<0){const title=this.env._t('Unable to sync order');const body=this.env._t('Check the internet connection then try to sync again by clicking on the red wifi button (upper right of the screen).');await this.showPopup('OfflineErrorPopup',{title,body});}else if(error.code===200){await this.showPopup('ErrorTracebackPopup',{title:error.data.message||this.env._t('Server Error'),body:error.data.debug||this.env._t('The server encountered an error while receiving your order.'),});}else if(error.code===700){await this.showPopup('ErrorPopup',{title:this.env._t('Fiscal data module error'),body:error.data.error.status||this.env._t('The fiscal data module encountered an error while receiving your order.'),});}else if(error.code===701){let bodyMessage="";if(error.error.errorCode)
bodyMessage="'"+error.error.errorCode+"': "+error.error.errorMessage;else
bodyMessage="Fiscal data module is not on.";await this.showPopup('ErrorPopup',{title:this.env._t('Fiscal data module error'),body:bodyMessage});}else{await this.showPopup('ErrorPopup',{title:this.env._t('Unknown Error'),body:this.env._t('The order could not be sent to the server due to an unknown error'),});}};}
function useAutoFocusToLast(){const current=Component.current;let target=null;function autofocus(){const prevTarget=target;const allInputs=current.el.querySelectorAll('input');target=allInputs[allInputs.length-1];if(target&&target!==prevTarget){target.focus();target.selectionStart=target.selectionEnd=target.value.length;}}
onMounted(autofocus);onPatched(autofocus);}
function onChangeOrder(prevOrderCB,newOrderCB){const current=Component.current;prevOrderCB=prevOrderCB?prevOrderCB.bind(current):()=>{};newOrderCB=newOrderCB?newOrderCB.bind(current):()=>{};onMounted(()=>{current.env.pos.on('change:selectedOrder',async(pos,newOrder)=>{await prevOrderCB(pos.previous('selectedOrder'));await newOrderCB(newOrder);},current);newOrderCB(current.env.pos.get_order());});onWillUnmount(()=>{current.env.pos.off('change:selectedOrder',null,current);prevOrderCB(current.env.pos.get_order());});}
function useBarcodeReader(callbackMap,exclusive=false){const current=Component.current;const barcodeReader=current.env.pos.barcode_reader;for(let[key,callback]of Object.entries(callbackMap)){callbackMap[key]=callback.bind(current);}
onMounted(()=>{if(barcodeReader){for(let key in callbackMap){if(exclusive){barcodeReader.set_exclusive_callback(key,callbackMap[key]);}else{barcodeReader.set_action_callback(key,callbackMap[key]);}}}});onWillUnmount(()=>{if(barcodeReader){for(let key in callbackMap){if(exclusive){barcodeReader.remove_exclusive_callback(key,callbackMap[key]);}else{barcodeReader.remove_action_callback(key,callbackMap[key]);}}}});}
function useAsyncLockedMethod(method){const component=Component.current;let called=false;return async(...args)=>{if(called){return;}
try{called=true;await method.call(component,...args);}finally{called=false;}};}
return{useErrorHandlers,useAutoFocusToLast,onChangeOrder,useBarcodeReader,useAsyncLockedMethod};});;

/* /point_of_sale/static/src/js/Screens/ProductScreen/ProductScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ProductScreen',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const ControlButtonsMixin=require('point_of_sale.ControlButtonsMixin');const NumberBuffer=require('point_of_sale.NumberBuffer');const{useListener}=require('web.custom_hooks');const Registries=require('point_of_sale.Registries');const{onChangeOrder,useBarcodeReader}=require('point_of_sale.custom_hooks');const{useState}=owl.hooks;const{parse}=require('web.field_utils');class ProductScreen extends ControlButtonsMixin(PosComponent){constructor(){super(...arguments);useListener('update-selected-orderline',this._updateSelectedOrderline);useListener('new-orderline-selected',this._newOrderlineSelected);useListener('set-numpad-mode',this._setNumpadMode);useListener('click-product',this._clickProduct);useListener('click-customer',this._onClickCustomer);useListener('click-pay',this._onClickPay);useBarcodeReader({product:this._barcodeProductAction,weight:this._barcodeProductAction,price:this._barcodeProductAction,client:this._barcodeClientAction,discount:this._barcodeDiscountAction,error:this._barcodeErrorAction,})
onChangeOrder(null,(newOrder)=>newOrder&&this.render());NumberBuffer.use({nonKeyboardInputEvent:'numpad-click-input',triggerAtInput:'update-selected-orderline',useWithBarcode:true,});let status=this.showCashBoxOpening()
this.state=useState({cashControl:status,numpadMode:'quantity'});this.mobile_pane=this.props.mobile_pane||'right';}
mounted(){this.env.pos.on('change:selectedClient',this.render,this);}
willUnmount(){this.env.pos.off('change:selectedClient',null,this);}
get isScaleAvailable(){return true;}
get client(){return this.env.pos.get_client();}
get currentOrder(){return this.env.pos.get_order();}
showCashBoxOpening(){if(this.env.pos.config.cash_control&&this.env.pos.pos_session.state=='opening_control')
return true;return false;}
async _getAddProductOptions(product){let price_extra=0.0;let draftPackLotLines,weight,description,packLotLinesToEdit;if(this.env.pos.config.product_configurator&&_.some(product.attribute_line_ids,(id)=>id in this.env.pos.attributes_by_ptal_id)){let attributes=_.map(product.attribute_line_ids,(id)=>this.env.pos.attributes_by_ptal_id[id]).filter((attr)=>attr!==undefined);let{confirmed,payload}=await this.showPopup('ProductConfiguratorPopup',{product:product,attributes:attributes,});if(confirmed){description=payload.selected_attributes.join(', ');price_extra+=payload.price_extra;}else{return;}}
if(['serial','lot'].includes(product.tracking)&&(this.env.pos.picking_type.use_create_lots||this.env.pos.picking_type.use_existing_lots)){const isAllowOnlyOneLot=product.isAllowOnlyOneLot();if(isAllowOnlyOneLot){packLotLinesToEdit=[];}else{const orderline=this.currentOrder.get_orderlines().filter(line=>!line.get_discount()).find(line=>line.product.id===product.id);if(orderline){packLotLinesToEdit=orderline.getPackLotLinesToEdit();}else{packLotLinesToEdit=[];}}
const{confirmed,payload}=await this.showPopup('EditListPopup',{title:this.env._t('Lot/Serial Number(s) Required'),isSingleItem:isAllowOnlyOneLot,array:packLotLinesToEdit,});if(confirmed){const modifiedPackLotLines=Object.fromEntries(payload.newArray.filter(item=>item.id).map(item=>[item.id,item.text]));const newPackLotLines=payload.newArray.filter(item=>!item.id).map(item=>({lot_name:item.text}));draftPackLotLines={modifiedPackLotLines,newPackLotLines};}else{return;}}
if(product.to_weight&&this.env.pos.config.iface_electronic_scale){if(this.isScaleAvailable){const{confirmed,payload}=await this.showTempScreen('ScaleScreen',{product,});if(confirmed){weight=payload.weight;}else{return;}}else{await this._onScaleNotAvailable();}}
return{draftPackLotLines,quantity:weight,description,price_extra};}
async _clickProduct(event){if(!this.currentOrder){this.env.pos.add_new_order();}
const product=event.detail;const options=await this._getAddProductOptions(product);if(!options)return;this.currentOrder.add_product(product,options);NumberBuffer.reset();}
_setNumpadMode(event){const{mode}=event.detail;NumberBuffer.capture();NumberBuffer.reset();this.state.numpadMode=mode;}
async _updateSelectedOrderline(event){if(this.state.numpadMode==='quantity'&&this.env.pos.disallowLineQuantityChange()){let order=this.env.pos.get_order();let selectedLine=order.get_selected_orderline();let lastId=order.orderlines.last().cid;let currentQuantity=this.env.pos.get_order().get_selected_orderline().get_quantity();if(selectedLine.noDecrease){this.showPopup('ErrorPopup',{title:this.env._t('Invalid action'),body:this.env._t('You are not allowed to change this quantity'),});return;}
const parsedInput=event.detail.buffer&&parse.float(event.detail.buffer)||0;if(lastId!=selectedLine.cid)
this._showDecreaseQuantityPopup();else if(currentQuantity<parsedInput)
this._setValue(event.detail.buffer);else if(parsedInput<currentQuantity)
this._showDecreaseQuantityPopup();}else{let{buffer}=event.detail;let val=buffer===null?'remove':buffer;this._setValue(val);}}
async _newOrderlineSelected(){NumberBuffer.reset();}
_setValue(val){if(this.currentOrder.get_selected_orderline()){if(this.state.numpadMode==='quantity'){this.currentOrder.get_selected_orderline().set_quantity(val);}else if(this.state.numpadMode==='discount'){this.currentOrder.get_selected_orderline().set_discount(val);}else if(this.state.numpadMode==='price'){var selected_orderline=this.currentOrder.get_selected_orderline();selected_orderline.price_manually_set=true;selected_orderline.set_unit_price(val);}
if(this.env.pos.config.iface_customer_facing_display){this.env.pos.send_current_order_to_customer_facing_display();}}}
async _barcodeProductAction(code){const product=this.env.pos.db.get_product_by_barcode(code.base_code)
if(!product){return this._barcodeErrorAction(code);}
const options=await this._getAddProductOptions(product);if(!options)return;if(code.type==='price'){Object.assign(options,{price:code.value,extras:{price_manually_set:true,},});}else if(code.type==='weight'){Object.assign(options,{quantity:code.value,merge:false,});}else if(code.type==='discount'){Object.assign(options,{discount:code.value,merge:false,});}
this.currentOrder.add_product(product,options)}
_barcodeClientAction(code){const partner=this.env.pos.db.get_partner_by_barcode(code.code);if(partner){if(this.currentOrder.get_client()!==partner){this.currentOrder.set_client(partner);this.currentOrder.set_pricelist(_.findWhere(this.env.pos.pricelists,{id:partner.property_product_pricelist[0],})||this.env.pos.default_pricelist);}
return true;}
this._barcodeErrorAction(code);return false;}
_barcodeDiscountAction(code){var last_orderline=this.currentOrder.get_last_orderline();if(last_orderline){last_orderline.set_discount(code.value);}}
_barcodeErrorAction(code){this.showPopup('ErrorBarcodePopup',{code:this._codeRepr(code)});}
_codeRepr(code){if(code.code.length>32){return code.code.substring(0,29)+'...';}else{return code.code;}}
async _onScaleNotAvailable(){}
async _showDecreaseQuantityPopup(){const{confirmed,payload:inputNumber}=await this.showPopup('NumberPopup',{startingValue:0,title:this.env._t('Set the new quantity'),});if(!confirmed)
return;let newQuantity=parse.float(inputNumber);let order=this.env.pos.get_order();let selectedLine=this.env.pos.get_order().get_selected_orderline();let currentQuantity=selectedLine.get_quantity()
if(selectedLine.is_last_line()&&currentQuantity===1&&newQuantity<currentQuantity)
selectedLine.set_quantity(newQuantity);else if(newQuantity>=currentQuantity)
selectedLine.set_quantity(newQuantity);else{let newLine=selectedLine.clone();let decreasedQuantity=currentQuantity-newQuantity
newLine.order=order;newLine.set_quantity(-decreasedQuantity,true);order.add_orderline(newLine);}}
async _onClickCustomer(){const currentClient=this.currentOrder.get_client();const{confirmed,payload:newClient}=await this.showTempScreen('ClientListScreen',{client:currentClient});if(confirmed){this.currentOrder.set_client(newClient);this.currentOrder.updatePricelist(newClient);}}
async _onClickPay(){if(this.env.pos.get_order().orderlines.any(line=>line.get_product().tracking!=='none'&&!line.has_valid_product_lot()&&(this.env.pos.picking_type.use_create_lots||this.env.pos.picking_type.use_existing_lots))){const{confirmed}=await this.showPopup('ConfirmPopup',{title:this.env._t('Some Serial/Lot Numbers are missing'),body:this.env._t('You are trying to sell products with serial/lot numbers, but some of them are not set.\nWould you like to proceed anyway?'),confirmText:this.env._t('Yes'),cancelText:this.env._t('No')});if(confirmed){this.showScreen('PaymentScreen');}}else{this.showScreen('PaymentScreen');}}
switchPane(){if(this.mobile_pane==="left"){this.mobile_pane="right";this.render();}
else{this.mobile_pane="left";this.render();}}}
ProductScreen.template='ProductScreen';Registries.Component.add(ProductScreen);return ProductScreen;});;

/* /point_of_sale/static/src/js/Screens/ClientListScreen/ClientLine.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ClientLine',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class ClientLine extends PosComponent{get highlight(){return this.props.partner!==this.props.selectedClient?'':'highlight';}}
ClientLine.template='ClientLine';Registries.Component.add(ClientLine);return ClientLine;});;

/* /point_of_sale/static/src/js/Screens/ClientListScreen/ClientDetailsEdit.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ClientDetailsEdit',function(require){'use strict';const{_t}=require('web.core');const{getDataURLFromFile}=require('web.utils');const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class ClientDetailsEdit extends PosComponent{constructor(){super(...arguments);this.intFields=['country_id','state_id','property_product_pricelist'];const partner=this.props.partner;this.changes={'country_id':partner.country_id&&partner.country_id[0],'state_id':partner.state_id&&partner.state_id[0],};if(!partner.property_product_pricelist)
this.changes['property_product_pricelist']=this.env.pos.default_pricelist.id;}
mounted(){this.env.bus.on('save-customer',this,this.saveChanges);}
willUnmount(){this.env.bus.off('save-customer',this);}
get partnerImageUrl(){const partner=this.props.partner;if(this.changes.image_1920){return this.changes.image_1920;}else if(partner.id){return`/web/image?model=res.partner&id=${partner.id}&field=image_128&write_date=${partner.write_date}&unique=1`;}else{return false;}}
captureChange(event){this.changes[event.target.name]=event.target.value;}
saveChanges(){let processedChanges={};for(let[key,value]of Object.entries(this.changes)){if(this.intFields.includes(key)){processedChanges[key]=parseInt(value)||false;}else{processedChanges[key]=value;}}
if((!this.props.partner.name&&!processedChanges.name)||processedChanges.name===''){return this.showPopup('ErrorPopup',{title:_t('A Customer Name Is Required'),});}
processedChanges.id=this.props.partner.id||false;this.trigger('save-changes',{processedChanges});}
async uploadImage(event){const file=event.target.files[0];if(!file.type.match(/image.*/)){await this.showPopup('ErrorPopup',{title:this.env._t('Unsupported File Format'),body:this.env._t('Only web-compatible Image formats such as .png or .jpeg are supported.'),});}else{const imageUrl=await getDataURLFromFile(file);const loadedImage=await this._loadImage(imageUrl);if(loadedImage){const resizedImage=await this._resizeImage(loadedImage,800,600);this.changes.image_1920=resizedImage.toDataURL();this.render();}}}
_resizeImage(img,maxwidth,maxheight){var canvas=document.createElement('canvas');var ctx=canvas.getContext('2d');var ratio=1;if(img.width>maxwidth){ratio=maxwidth/img.width;}
if(img.height*ratio>maxheight){ratio=maxheight/img.height;}
var width=Math.floor(img.width*ratio);var height=Math.floor(img.height*ratio);canvas.width=width;canvas.height=height;ctx.drawImage(img,0,0,width,height);return canvas;}
_loadImage(url){return new Promise((resolve)=>{const img=new Image();img.addEventListener('load',()=>resolve(img));img.addEventListener('error',()=>{this.showPopup('ErrorPopup',{title:this.env._t('Loading Image Error'),body:this.env._t('Encountered error when loading image. Please try again.'),});resolve(false);});img.src=url;});}}
ClientDetailsEdit.template='ClientDetailsEdit';Registries.Component.add(ClientDetailsEdit);return ClientDetailsEdit;});;

/* /point_of_sale/static/src/js/Screens/ClientListScreen/ClientListScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ClientListScreen',function(require){'use strict';const{debounce}=owl.utils;const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');const{useListener}=require('web.custom_hooks');const{isRpcError}=require('point_of_sale.utils');const{useAsyncLockedMethod}=require('point_of_sale.custom_hooks');class ClientListScreen extends PosComponent{constructor(){super(...arguments);this.lockedSaveChanges=useAsyncLockedMethod(this.saveChanges);useListener('click-save',()=>this.env.bus.trigger('save-customer'));useListener('click-edit',()=>this.editClient());useListener('save-changes',this.lockedSaveChanges);this.state={query:null,selectedClient:this.props.client,detailIsShown:false,isEditMode:false,editModeProps:{partner:{country_id:this.env.pos.company.country_id,state_id:this.env.pos.company.state_id,}},};this.updateClientList=debounce(this.updateClientList,70);}
back(){if(this.state.detailIsShown){this.state.detailIsShown=false;this.render();}else{this.props.resolve({confirmed:false,payload:false});this.trigger('close-temp-screen');}}
confirm(){this.props.resolve({confirmed:true,payload:this.state.selectedClient});this.trigger('close-temp-screen');}
get currentOrder(){return this.env.pos.get_order();}
get clients(){if(this.state.query&&this.state.query.trim()!==''){return this.env.pos.db.search_partner(this.state.query.trim());}else{return this.env.pos.db.get_partners_sorted(1000);}}
get isNextButtonVisible(){return this.state.selectedClient?true:false;}
get nextButton(){if(!this.props.client){return{command:'set',text:this.env._t('Set Customer')};}else if(this.props.client&&this.props.client===this.state.selectedClient){return{command:'deselect',text:this.env._t('Deselect Customer')};}else{return{command:'set',text:this.env._t('Change Customer')};}}
updateClientList(event){this.state.query=event.target.value;const clients=this.clients;if(event.code==='Enter'&&clients.length===1){this.state.selectedClient=clients[0];this.clickNext();}else{this.render();}}
clickClient(event){let partner=event.detail.client;if(this.state.selectedClient===partner){this.state.selectedClient=null;}else{this.state.selectedClient=partner;}
this.render();}
editClient(){this.state.editModeProps={partner:this.state.selectedClient,};this.state.detailIsShown=true;this.render();}
clickNext(){this.state.selectedClient=this.nextButton.command==='set'?this.state.selectedClient:null;this.confirm();}
activateEditMode(event){const{isNewClient}=event.detail;this.state.isEditMode=true;this.state.detailIsShown=true;this.state.isNewClient=isNewClient;if(!isNewClient){this.state.editModeProps={partner:this.state.selectedClient,};}
this.render();}
deactivateEditMode(){this.state.isEditMode=false;this.state.editModeProps={partner:{country_id:this.env.pos.company.country_id,state_id:this.env.pos.company.state_id,},};this.render();}
async saveChanges(event){try{let partnerId=await this.rpc({model:'res.partner',method:'create_from_ui',args:[event.detail.processedChanges],});await this.env.pos.load_new_partners();this.state.selectedClient=this.env.pos.db.get_partner_by_id(partnerId);this.state.detailIsShown=false;this.render();}catch(error){if(isRpcError(error)&&error.message.code<0){await this.showPopup('OfflineErrorPopup',{title:this.env._t('Offline'),body:this.env._t('Unable to save changes.'),});}else{throw error;}}}
cancelEdit(){this.deactivateEditMode();}}
ClientListScreen.template='ClientListScreen';Registries.Component.add(ClientListScreen);return ClientListScreen;});;

/* /point_of_sale/static/src/js/Screens/OrderManagementScreen/ControlButtons/InvoiceButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.InvoiceButton',function(require){'use strict';const{useListener}=require('web.custom_hooks');const{useContext}=owl.hooks;const{isRpcError}=require('point_of_sale.utils');const PosComponent=require('point_of_sale.PosComponent');const OrderManagementScreen=require('point_of_sale.OrderManagementScreen');const OrderFetcher=require('point_of_sale.OrderFetcher');const Registries=require('point_of_sale.Registries');const contexts=require('point_of_sale.PosContext');class InvoiceButton extends PosComponent{constructor(){super(...arguments);useListener('click',this._onClick);this.orderManagementContext=useContext(contexts.orderManagement);}
get selectedOrder(){return this.orderManagementContext.selectedOrder;}
set selectedOrder(value){this.orderManagementContext.selectedOrder=value;}
get isAlreadyInvoiced(){if(!this.selectedOrder)return false;return Boolean(this.selectedOrder.account_move);}
get commandName(){if(!this.selectedOrder){return'Invoice';}else{return this.isAlreadyInvoiced?'Reprint Invoice':this.selectedOrder.isFromClosedSession?'Cannot Invoice':'Invoice';}}
get isHighlighted(){return this.selectedOrder&&!this.isAlreadyInvoiced&&!this.selectedOrder.isFromClosedSession;}
async _downloadInvoice(orderId){try{await this.env.pos.do_action('point_of_sale.pos_invoice_report',{additional_context:{active_ids:[orderId],},});}catch(error){if(error instanceof Error){throw error;}else{this.showPopup('ErrorPopup',{title:this.env._t('Network Error'),body:this.env._t('Unable to download invoice.'),});}}}
async _invoiceOrder(){const order=this.selectedOrder;if(!order)return;const orderId=order.backendId;if(this.isAlreadyInvoiced){await this._downloadInvoice(orderId);return;}
if(order.isFromClosedSession){this.showPopup('ErrorPopup',{title:this.env._t('Session is closed'),body:this.env._t('Cannot invoice order from closed session.'),});return;}
if(!order.get_client()){const{confirmed:confirmedPopup}=await this.showPopup('ConfirmPopup',{title:'Need customer to invoice',body:'Do you want to open the customer list to select customer?',});if(!confirmedPopup)return;const{confirmed:confirmedTempScreen,payload:newClient}=await this.showTempScreen('ClientListScreen');if(!confirmedTempScreen)return;await this.rpc({model:'pos.order',method:'write',args:[[orderId],{partner_id:newClient.id}],kwargs:{context:this.env.session.user_context},});}
await this.rpc({model:'pos.order',method:'action_pos_order_invoice',args:[orderId],kwargs:{context:this.env.session.user_context},},{timeout:30000,shadow:true,});await this._downloadInvoice(orderId);OrderFetcher.invalidateCache([orderId]);await OrderFetcher.fetch();this.selectedOrder=OrderFetcher.get(this.selectedOrder.backendId);}
async _onClick(){try{await this._invoiceOrder();}catch(error){if(isRpcError(error)&&error.message.code<0){this.showPopup('ErrorPopup',{title:this.env._t('Network Error'),body:this.env._t('Unable to invoice order.'),});}else{throw error;}}}}
InvoiceButton.template='InvoiceButton';OrderManagementScreen.addControlButton({component:InvoiceButton,condition:function(){return this.env.pos.config.module_account;},});Registries.Component.add(InvoiceButton);return InvoiceButton;});;

/* /point_of_sale/static/src/js/Screens/OrderManagementScreen/ControlButtons/ReprintReceiptButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ReprintReceiptButton',function(require){'use strict';const{useListener}=require('web.custom_hooks');const{useContext}=owl.hooks;const PosComponent=require('point_of_sale.PosComponent');const OrderManagementScreen=require('point_of_sale.OrderManagementScreen');const Registries=require('point_of_sale.Registries');const contexts=require('point_of_sale.PosContext');class ReprintReceiptButton extends PosComponent{constructor(){super(...arguments);useListener('click',this._onClick);this.orderManagementContext=useContext(contexts.orderManagement);}
async _onClick(){const order=this.orderManagementContext.selectedOrder;if(!order)return;this.showScreen('ReprintReceiptScreen',{order:order});}}
ReprintReceiptButton.template='ReprintReceiptButton';OrderManagementScreen.addControlButton({component:ReprintReceiptButton,condition:function(){return true;},});Registries.Component.add(ReprintReceiptButton);return ReprintReceiptButton;});;

/* /point_of_sale/static/src/js/Screens/OrderManagementScreen/OrderFetcher.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.OrderFetcher',function(require){'use strict';const{EventBus}=owl.core;const{Gui}=require('point_of_sale.Gui');const{isRpcError}=require('point_of_sale.utils');const models=require('point_of_sale.models');class OrderFetcher extends EventBus{constructor(){super();this.currentPage=1;this.ordersToShow=[];this.cache={};this.totalCount=0;}
get activeOrders(){const allActiveOrders=this.comp.env.pos.get('orders').models;return this.searchDomain?allActiveOrders.filter(this._predicateBasedOnSearchDomain.bind(this)):allActiveOrders;}
_predicateBasedOnSearchDomain(order){function check(order,field,searchWord){searchWord=searchWord.toLowerCase();switch(field){case'pos_reference':return order.name.toLowerCase().includes(searchWord);case'partner_id.display_name':const client=order.get_client();return client?client.name.toLowerCase().includes(searchWord):false;case'date_order':return moment(order.creation_date).format('YYYY-MM-DD hh:mm A').includes(searchWord);default:return false;}}
for(let[field,_,searchWord]of(this.searchDomain||[]).filter((item)=>item!=='|')){searchWord=searchWord.substring(1,searchWord.length-1);if(check(order,field,searchWord)){return true;}}
return false;}
get nActiveOrders(){return this.activeOrders.length;}
get lastPageFullOfActiveOrders(){return Math.trunc(this.nActiveOrders/this.nPerPage);}
get remainingActiveOrders(){return this.nActiveOrders%this.nPerPage;}
get lastPage(){const nItems=this.nActiveOrders+this.totalCount;return Math.trunc(nItems/(this.nPerPage+1))+1;}
async fetch(){try{let limit,offset;let start,end;if(this.currentPage<=this.lastPageFullOfActiveOrders){start=(this.currentPage-1)*this.nPerPage;end=this.currentPage*this.nPerPage;this.ordersToShow=this.activeOrders.slice(start,end);}else if(this.currentPage===this.lastPageFullOfActiveOrders+1){offset=0;limit=this.nPerPage-this.remainingActiveOrders;start=(this.currentPage-1)*this.nPerPage;end=this.nActiveOrders;this.ordersToShow=[...this.activeOrders.slice(start,end),...(await this._fetch(limit,offset)),];}else{offset=this.nPerPage-
this.remainingActiveOrders+
(this.currentPage-(this.lastPageFullOfActiveOrders+1)-1)*this.nPerPage;limit=this.nPerPage;this.ordersToShow=await this._fetch(limit,offset);}
this.trigger('update');}catch(error){if(isRpcError(error)&&error.message.code<0){Gui.showPopup('ErrorPopup',{title:this.comp.env._t('Network Error'),body:this.comp.env._t('Unable to fetch orders if offline.'),});Gui.setSyncStatus('error');}else{throw error;}}}
async _fetch(limit,offset){const{ids,totalCount}=await this._getOrderIdsForCurrentPage(limit,offset);const idsNotInCache=ids.filter((id)=>!(id in this.cache));if(idsNotInCache.length>0){const fetchedOrders=await this._fetchOrders(idsNotInCache);fetchedOrders.forEach((order)=>{this.cache[order.id]=new models.Order({},{pos:this.comp.env.pos,json:order});});}
this.totalCount=totalCount;return ids.map((id)=>this.cache[id]);}
async _getOrderIdsForCurrentPage(limit,offset){return await this.rpc({model:'pos.order',method:'search_paid_order_ids',kwargs:{config_id:this.configId,domain:this.searchDomain?this.searchDomain:[],limit,offset},context:this.comp.env.session.user_context,});}
async _fetchOrders(ids){return await this.rpc({model:'pos.order',method:'export_for_ui',args:[ids],context:this.comp.env.session.user_context,});}
nextPage(){if(this.currentPage<this.lastPage){this.currentPage+=1;this.fetch();}}
prevPage(){if(this.currentPage>1){this.currentPage-=1;this.fetch();}}
get(id){if(id)return this.cache[id];return this.ordersToShow;}
setSearchDomain(searchDomain){this.searchDomain=searchDomain;}
setComponent(comp){this.comp=comp;return this;}
setConfigId(configId){this.configId=configId;}
setNPerPage(val){this.nPerPage=val;}
setPage(page){this.currentPage=page;}
invalidateCache(ids){for(let id of ids){delete this.cache[id];}}
async rpc(){Gui.setSyncStatus('connecting');const result=await this.comp.rpc(...arguments);Gui.setSyncStatus('connected');return result;}}
return new OrderFetcher();});;

/* /point_of_sale/static/src/js/Screens/OrderManagementScreen/OrderManagementScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.OrderManagementScreen',function(require){'use strict';const{useContext}=owl.hooks;const{useListener}=require('web.custom_hooks');const ControlButtonsMixin=require('point_of_sale.ControlButtonsMixin');const NumberBuffer=require('point_of_sale.NumberBuffer');const Registries=require('point_of_sale.Registries');const OrderFetcher=require('point_of_sale.OrderFetcher');const IndependentToOrderScreen=require('point_of_sale.IndependentToOrderScreen');const contexts=require('point_of_sale.PosContext');class OrderManagementScreen extends ControlButtonsMixin(IndependentToOrderScreen){constructor(){super(...arguments);useListener('close-screen',this.close);useListener('set-numpad-mode',this._setNumpadMode);useListener('click-order',this._onClickOrder);useListener('next-page',this._onNextPage);useListener('prev-page',this._onPrevPage);useListener('search',this._onSearch);NumberBuffer.use({nonKeyboardInputEvent:'numpad-click-input',useWithBarcode:true,});this.numpadMode='quantity';OrderFetcher.setComponent(this);OrderFetcher.setConfigId(this.env.pos.config_id);this.orderManagementContext=useContext(contexts.orderManagement);}
mounted(){OrderFetcher.on('update',this,this.render);this.env.pos.get('orders').on('add remove',this.render,this);const flexContainer=this.el.querySelector('.flex-container');const cpEl=this.el.querySelector('.control-panel');const headerEl=this.el.querySelector('.order-row.header');const val=Math.trunc((flexContainer.offsetHeight-cpEl.offsetHeight-headerEl.offsetHeight)/headerEl.offsetHeight);OrderFetcher.setNPerPage(val);setTimeout(()=>OrderFetcher.fetch(),0);}
willUnmount(){OrderFetcher.off('update',this);this.env.pos.get('orders').off('add remove',null,this);}
get selectedClient(){const order=this.orderManagementContext.selectedOrder;return order?order.get_client():null;}
get orders(){return OrderFetcher.get();}
async _setNumpadMode(event){const{mode}=event.detail;this.numpadMode=mode;NumberBuffer.reset();}
_onNextPage(){OrderFetcher.nextPage();}
_onPrevPage(){OrderFetcher.prevPage();}
_onSearch({detail:domain}){OrderFetcher.setSearchDomain(domain);OrderFetcher.setPage(1);OrderFetcher.fetch();}
_onClickOrder({detail:clickedOrder}){if(!clickedOrder||clickedOrder.locked){this.orderManagementContext.selectedOrder=clickedOrder;}else{this._setOrder(clickedOrder);}}
_setOrder(order){this.env.pos.set_order(order);if(order===this.env.pos.get_order()){this.close();}}}
OrderManagementScreen.template='OrderManagementScreen';OrderManagementScreen.hideOrderSelector=true;Registries.Component.add(OrderManagementScreen);return OrderManagementScreen;});;

/* /point_of_sale/static/src/js/Screens/OrderManagementScreen/MobileOrderManagementScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.MobileOrderManagementScreen',function(require){const OrderManagementScreen=require('point_of_sale.OrderManagementScreen');const Registries=require('point_of_sale.Registries');const{useListener}=require('web.custom_hooks');const{useState}=owl.hooks;const MobileOrderManagementScreen=(OrderManagementScreen)=>{class MobileOrderManagementScreen extends OrderManagementScreen{constructor(){super(...arguments);useListener('click-order',this._onShowDetails)
this.mobileState=useState({showDetails:false});}
_onShowDetails(){this.mobileState.showDetails=true;}}
MobileOrderManagementScreen.template='MobileOrderManagementScreen';return MobileOrderManagementScreen;};Registries.Component.addByExtending(MobileOrderManagementScreen,OrderManagementScreen);return MobileOrderManagementScreen;});;

/* /point_of_sale/static/src/js/Screens/OrderManagementScreen/OrderManagementControlPanel.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.OrderManagementControlPanel',function(require){'use strict';const{useContext}=owl.hooks;const{useAutofocus,useListener}=require('web.custom_hooks');const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');const OrderFetcher=require('point_of_sale.OrderFetcher');const contexts=require('point_of_sale.PosContext');const VALID_SEARCH_TAGS=new Set(['date','customer','client','name','order']);const FIELD_MAP={date:'date_order',customer:'partner_id.display_name',client:'partner_id.display_name',name:'pos_reference',order:'pos_reference',};const SEARCH_FIELDS=['pos_reference','partner_id.display_name','date_order'];function getDomainForSingleCondition(fields,toSearch){const orSymbols=Array(fields.length-1).fill('|');return orSymbols.concat(fields.map((field)=>[field,'ilike',`%${toSearch}%`]));}
class OrderManagementControlPanel extends PosComponent{constructor(){super(...arguments);this.orderManagementContext=useContext(contexts.orderManagement);useListener('clear-search',this._onClearSearch);useAutofocus({selector:'input'});}
onInputKeydown(event){if(event.key==='Enter'){this.trigger('search',this._computeDomain());}}
get showPageControls(){return OrderFetcher.lastPage>1;}
get pageNumber(){const currentPage=OrderFetcher.currentPage;const lastPage=OrderFetcher.lastPage;return isNaN(lastPage)?'':`(${currentPage}/${lastPage})`;}
get validSearchTags(){return VALID_SEARCH_TAGS;}
get fieldMap(){return FIELD_MAP;}
get searchFields(){return SEARCH_FIELDS;}
_computeDomain(){const input=this.orderManagementContext.searchString.trim();if(!input)return;const searchConditions=this.orderManagementContext.searchString.split(/[,&]\s*/);if(searchConditions.length===1){let cond=searchConditions[0].split(/:\s*/);if(cond.length===1){return getDomainForSingleCondition(this.searchFields,cond[0]);}}
const domain=[];for(let cond of searchConditions){let[tag,value]=cond.split(/:\s*/);if(!this.validSearchTags.has(tag))continue;domain.push([this.fieldMap[tag],'ilike',`%${value}%`]);}
return domain;}
_onClearSearch(){this.orderManagementContext.searchString='';this.onInputKeydown({key:'Enter'});}}
OrderManagementControlPanel.template='OrderManagementControlPanel';Registries.Component.add(OrderManagementControlPanel);return OrderManagementControlPanel;});;

/* /point_of_sale/static/src/js/Screens/OrderManagementScreen/OrderList.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.OrderList',function(require){'use strict';const{useState}=owl.hooks;const{useListener}=require('web.custom_hooks');const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class OrderList extends PosComponent{constructor(){super(...arguments);useListener('click-order',this._onClickOrder);this.state=useState({highlightedOrder:this.props.initHighlightedOrder||null});}
get highlightedOrder(){return this.state.highlightedOrder;}
_onClickOrder({detail:order}){this.state.highlightedOrder=order;}}
OrderList.template='OrderList';Registries.Component.add(OrderList);return OrderList;});;

/* /point_of_sale/static/src/js/Screens/OrderManagementScreen/OrderRow.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.OrderRow',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class OrderRow extends PosComponent{get order(){return this.props.order;}
get highlighted(){const highlightedOrder=this.props.highlightedOrder;return!highlightedOrder?false:highlightedOrder.backendId===this.props.order.backendId;}
get name(){return this.order.get_name();}
get date(){return moment(this.order.validation_date).format('YYYY-MM-DD hh:mm A');}
get customer(){const customer=this.order.get('client');return customer?customer.name:null;}
get total(){return this.env.pos.format_currency(this.order.get_total_with_tax());}}
OrderRow.template='OrderRow';Registries.Component.add(OrderRow);return OrderRow;});;

/* /point_of_sale/static/src/js/Screens/OrderManagementScreen/OrderDetails.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.OrderDetails',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class OrderDetails extends PosComponent{get order(){return this.props.order;}
get orderlines(){return this.order?this.order.orderlines.models:[];}
get total(){return this.env.pos.format_currency(this.order?this.order.get_total_with_tax():0);}
get tax(){return this.env.pos.format_currency(this.order?this.order.get_total_tax():0)}}
OrderDetails.template='OrderDetails';Registries.Component.add(OrderDetails);return OrderDetails;});;

/* /point_of_sale/static/src/js/Screens/OrderManagementScreen/OrderlineDetails.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.OrderlineDetails',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');const{format}=require('web.field_utils');const{round_precision:round_pr}=require('web.utils');class OrderlineDetails extends PosComponent{get line(){const line=this.props.line;const formatQty=(line)=>{const quantity=line.get_quantity();const unit=line.get_unit();const decimals=this.env.pos.dp['Product Unit of Measure'];const rounding=Math.max(unit.rounding,Math.pow(10,-decimals));const roundedQuantity=round_pr(quantity,rounding);return format.float(roundedQuantity,{digits:[69,decimals]});};return{productName:line.get_full_product_name(),totalPrice:line.get_price_with_tax(),quantity:formatQty(line),unit:line.get_unit().name,unitPrice:line.get_unit_price(),};}
get productName(){return this.line.productName;}
get totalPrice(){return this.env.pos.format_currency(this.line.totalPrice);}
get quantity(){return this.line.quantity;}
get unitPrice(){return this.line.unitPrice;}
get unit(){return this.line.unit;}
get pricePerUnit(){return` ${this.unit} at ${this.unitPrice} / ${this.unit}`;}}
OrderlineDetails.template='OrderlineDetails';Registries.Component.add(OrderlineDetails);return OrderlineDetails;});;

/* /point_of_sale/static/src/js/Screens/OrderManagementScreen/ReprintReceiptScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ReprintReceiptScreen',function(require){'use strict';const AbstractReceiptScreen=require('point_of_sale.AbstractReceiptScreen');const Registries=require('point_of_sale.Registries');const ReprintReceiptScreen=(AbstractReceiptScreen)=>{class ReprintReceiptScreen extends AbstractReceiptScreen{mounted(){this.printReceipt();}
confirm(){this.showScreen('OrderManagementScreen');}
async printReceipt(){if(this.env.pos.proxy.printer&&this.env.pos.config.iface_print_skip_screen){let result=await this._printReceipt();if(result)
this.showScreen('OrderManagementScreen');}}
async tryReprint(){await this._printReceipt();}}
ReprintReceiptScreen.template='ReprintReceiptScreen';return ReprintReceiptScreen;};Registries.Component.addByExtending(ReprintReceiptScreen,AbstractReceiptScreen);return ReprintReceiptScreen;});;

/* /point_of_sale/static/src/js/Screens/TicketScreen/TicketScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.TicketScreen',function(require){'use strict';const Registries=require('point_of_sale.Registries');const IndependentToOrderScreen=require('point_of_sale.IndependentToOrderScreen');const{useListener}=require('web.custom_hooks');const{posbus}=require('point_of_sale.utils');class TicketScreen extends IndependentToOrderScreen{constructor(){super(...arguments);useListener('close-screen',this.close);useListener('filter-selected',this._onFilterSelected);useListener('search',this._onSearch);this.searchDetails={};this.filter=null;this._initializeSearchFieldConstants();}
mounted(){posbus.on('ticket-button-clicked',this,this.close);this.env.pos.get('orders').on('add remove change',()=>this.render(),this);this.env.pos.on('change:selectedOrder',()=>this.render(),this);}
willUnmount(){posbus.off('ticket-button-clicked',this);this.env.pos.get('orders').off('add remove change',null,this);this.env.pos.off('change:selectedOrder',null,this);}
_onFilterSelected(event){this.filter=event.detail.filter;this.render();}
_onSearch(event){const searchDetails=event.detail;Object.assign(this.searchDetails,searchDetails);this.render();}
get showNewTicketButton(){return true;}
get orderList(){return this.env.pos.get_order_list();}
get filteredOrderList(){const{AllTickets}=this.getOrderStates();const filterCheck=(order)=>{if(this.filter&&this.filter!==AllTickets){const screen=order.get_screen_data();return this.filter===this.constants.screenToStatusMap[screen.name];}
return true;};const{fieldValue,searchTerm}=this.searchDetails;const fieldAccessor=this._searchFields[fieldValue];const searchCheck=(order)=>{if(!fieldAccessor)return true;const fieldValue=fieldAccessor(order);if(fieldValue===null)return true;if(!searchTerm)return true;return fieldValue&&fieldValue.toString().toLowerCase().includes(searchTerm.toLowerCase());};const predicate=(order)=>{return filterCheck(order)&&searchCheck(order);};return this.orderList.filter(predicate);}
selectOrder(order){this._setOrder(order);if(order===this.env.pos.get_order()){this.close();}}
_setOrder(order){this.env.pos.set_order(order);}
createNewOrder(){this.env.pos.add_new_order();}
async deleteOrder(order){const screen=order.get_screen_data();if(['ProductScreen','PaymentScreen'].includes(screen.name)&&order.get_orderlines().length>0){const{confirmed}=await this.showPopup('ConfirmPopup',{title:this.env._t('Existing orderlines'),body:_.str.sprintf(this.env._t('%s has a total amount of %s, are you sure you want to delete this order ?'),order.name,this.getTotal(order)),});if(!confirmed)return;}
if(order){await this._canDeleteOrder(order);order.destroy({reason:'abandon'});}
posbus.trigger('order-deleted');}
getDate(order){return moment(order.creation_date).format('YYYY-MM-DD hh:mm A');}
getTotal(order){return this.env.pos.format_currency(order.get_total_with_tax());}
getCustomer(order){return order.get_client_name();}
getCardholderName(order){return order.get_cardholder_name();}
getEmployee(order){return order.employee?order.employee.name:'';}
getStatus(order){const screen=order.get_screen_data();return this.constants.screenToStatusMap[screen.name];}
hideDeleteButton(order){return order.get_paymentlines().some((payment)=>payment.is_electronic()&&payment.get_payment_status()==='done');}
showCardholderName(){return this.env.pos.payment_methods.some(method=>method.use_payment_terminal);}
get searchBarConfig(){return{searchFields:this.constants.searchFieldNames,filter:{show:true,options:this.filterOptions},};}
get filterOptions(){const{AllTickets,Ongoing,Payment,Receipt}=this.getOrderStates();return[AllTickets,Ongoing,Payment,Receipt];}
get _searchFields(){const{ReceiptNumber,Date,Customer,CardholderName}=this.getSearchFieldNames();var fields={[ReceiptNumber]:(order)=>order.name,[Date]:(order)=>moment(order.creation_date).format('YYYY-MM-DD hh:mm A'),[Customer]:(order)=>order.get_client_name(),};if(this.showCardholderName()){fields[CardholderName]=(order)=>order.get_cardholder_name();}
return fields;}
get _screenToStatusMap(){const{Ongoing,Payment,Receipt}=this.getOrderStates();return{ProductScreen:Ongoing,PaymentScreen:Payment,ReceiptScreen:Receipt,};}
_initializeSearchFieldConstants(){this.constants={};Object.assign(this.constants,{searchFieldNames:Object.keys(this._searchFields),screenToStatusMap:this._screenToStatusMap,});}
async _canDeleteOrder(order){return true;}
getOrderStates(){return{AllTickets:this.env._t('All Tickets'),Ongoing:this.env._t('Ongoing'),Payment:this.env._t('Payment'),Receipt:this.env._t('Receipt'),};}
getSearchFieldNames(){return{ReceiptNumber:this.env._t('Receipt Number'),Date:this.env._t('Date'),Customer:this.env._t('Customer'),CardholderName:this.env._t('Cardholder Name'),};}}
TicketScreen.template='TicketScreen';Registries.Component.add(TicketScreen);return TicketScreen;});;

/* /point_of_sale/static/src/js/Screens/PaymentScreen/PSNumpadInputButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.PSNumpadInputButton',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class PSNumpadInputButton extends PosComponent{get _class(){return this.props.changeClassTo||'input-button number-char';}}
PSNumpadInputButton.template='PSNumpadInputButton';Registries.Component.add(PSNumpadInputButton);return PSNumpadInputButton;});;

/* /point_of_sale/static/src/js/Screens/PaymentScreen/PaymentScreenNumpad.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.PaymentScreenNumpad',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class PaymentScreenNumpad extends PosComponent{constructor(){super(...arguments);this.decimalPoint=this.env._t.database.parameters.decimal_point;}}
PaymentScreenNumpad.template='PaymentScreenNumpad';Registries.Component.add(PaymentScreenNumpad);return PaymentScreenNumpad;});;

/* /point_of_sale/static/src/js/Screens/PaymentScreen/PaymentScreenElectronicPayment.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.PaymentScreenElectronicPayment',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class PaymentScreenElectronicPayment extends PosComponent{mounted(){this.props.line.on('change',this.render,this);}
willUnmount(){if(this.props.line){this.props.line.off('change',null,this);}}}
PaymentScreenElectronicPayment.template='PaymentScreenElectronicPayment';Registries.Component.add(PaymentScreenElectronicPayment);return PaymentScreenElectronicPayment;});;

/* /point_of_sale/static/src/js/Screens/PaymentScreen/PaymentScreenPaymentLines.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.PaymentScreenPaymentLines',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class PaymentScreenPaymentLines extends PosComponent{formatLineAmount(paymentline){return this.env.pos.format_currency_no_symbol(paymentline.get_amount());}
selectedLineClass(line){return{'payment-terminal':line.get_payment_status()};}
unselectedLineClass(line){return{};}}
PaymentScreenPaymentLines.template='PaymentScreenPaymentLines';Registries.Component.add(PaymentScreenPaymentLines);return PaymentScreenPaymentLines;});;

/* /point_of_sale/static/src/js/Screens/PaymentScreen/PaymentScreenStatus.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.PaymentScreenStatus',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class PaymentScreenStatus extends PosComponent{get changeText(){return this.env.pos.format_currency(this.currentOrder.get_change());}
get totalDueText(){return this.env.pos.format_currency(this.currentOrder.get_total_with_tax()+this.currentOrder.get_rounding_applied());}
get remainingText(){return this.env.pos.format_currency(this.currentOrder.get_due()>0?this.currentOrder.get_due():0);}
get currentOrder(){return this.env.pos.get_order();}}
PaymentScreenStatus.template='PaymentScreenStatus';Registries.Component.add(PaymentScreenStatus);return PaymentScreenStatus;});;

/* /point_of_sale/static/src/js/Screens/PaymentScreen/PaymentMethodButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.PaymentMethodButton',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class PaymentMethodButton extends PosComponent{}
PaymentMethodButton.template='PaymentMethodButton';Registries.Component.add(PaymentMethodButton);return PaymentMethodButton;});;

/* /point_of_sale/static/src/js/Screens/PaymentScreen/PaymentScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.PaymentScreen',function(require){'use strict';const{parse}=require('web.field_utils');const PosComponent=require('point_of_sale.PosComponent');const{useErrorHandlers,useAsyncLockedMethod}=require('point_of_sale.custom_hooks');const NumberBuffer=require('point_of_sale.NumberBuffer');const{useListener}=require('web.custom_hooks');const Registries=require('point_of_sale.Registries');const{onChangeOrder}=require('point_of_sale.custom_hooks');class PaymentScreen extends PosComponent{constructor(){super(...arguments);useListener('delete-payment-line',this.deletePaymentLine);useListener('select-payment-line',this.selectPaymentLine);useListener('new-payment-line',this.addNewPaymentLine);useListener('update-selected-paymentline',this._updateSelectedPaymentline);useListener('send-payment-request',this._sendPaymentRequest);useListener('send-payment-cancel',this._sendPaymentCancel);useListener('send-payment-reverse',this._sendPaymentReverse);useListener('send-force-done',this._sendForceDone);this.lockedValidateOrder=useAsyncLockedMethod(this.validateOrder);NumberBuffer.use(this._getNumberBufferConfig);onChangeOrder(this._onPrevOrder,this._onNewOrder);useErrorHandlers();this.payment_interface=null;this.error=false;this.payment_methods_from_config=this.env.pos.payment_methods.filter(method=>this.env.pos.config.payment_method_ids.includes(method.id));}
get _getNumberBufferConfig(){return{nonKeyboardInputEvent:'input-from-numpad',triggerAtInput:'update-selected-paymentline',}}
get currentOrder(){return this.env.pos.get_order();}
get paymentLines(){return this.currentOrder.get_paymentlines();}
get selectedPaymentLine(){return this.currentOrder.selected_paymentline;}
async selectClient(){const currentClient=this.currentOrder.get_client();const{confirmed,payload:newClient}=await this.showTempScreen('ClientListScreen',{client:currentClient});if(confirmed){this.currentOrder.set_client(newClient);this.currentOrder.updatePricelist(newClient);}}
addNewPaymentLine({detail:paymentMethod}){let result=this.currentOrder.add_paymentline(paymentMethod);if(result){NumberBuffer.reset();return true;}
else{this.showPopup('ErrorPopup',{title:this.env._t('Error'),body:this.env._t('There is already an electronic payment in progress.'),});return false;}}
_updateSelectedPaymentline(){if(this.paymentLines.every((line)=>line.paid)){this.currentOrder.add_paymentline(this.payment_methods_from_config[0]);}
if(!this.selectedPaymentLine)return;const payment_terminal=this.selectedPaymentLine.payment_method.payment_terminal;if(payment_terminal&&!['pending','retry'].includes(this.selectedPaymentLine.get_payment_status())){return;}
if(NumberBuffer.get()===null){this.deletePaymentLine({detail:{cid:this.selectedPaymentLine.cid}});}else{this.selectedPaymentLine.set_amount(NumberBuffer.getFloat());}}
toggleIsToInvoice(){this.currentOrder.set_to_invoice(!this.currentOrder.is_to_invoice());this.render();}
openCashbox(){this.env.pos.proxy.printer.open_cashbox();}
async addTip(){const tip=this.currentOrder.get_tip();const change=this.currentOrder.get_change();let value=tip.toFixed(this.env.pos.decimals);if(tip===0&&change>0){value=change;}
const{confirmed,payload}=await this.showPopup('NumberPopup',{title:tip?this.env._t('Change Tip'):this.env._t('Add Tip'),startingValue:value,});if(confirmed){this.currentOrder.set_tip(parse.float(payload));}}
deletePaymentLine(event){var self=this;const{cid}=event.detail;const line=this.paymentLines.find((line)=>line.cid===cid);if(['waiting','waitingCard','timeout'].includes(line.get_payment_status())){line.set_payment_status('waitingCancel');line.payment_method.payment_terminal.send_payment_cancel(this.currentOrder,cid).then(function(){self.currentOrder.remove_paymentline(line);NumberBuffer.reset();self.render();})}
else if(line.get_payment_status()!=='waitingCancel'){this.currentOrder.remove_paymentline(line);NumberBuffer.reset();this.render();}}
selectPaymentLine(event){const{cid}=event.detail;const line=this.paymentLines.find((line)=>line.cid===cid);this.currentOrder.select_paymentline(line);NumberBuffer.reset();this.render();}
async validateOrder(isForceValidate){if(this.env.pos.config.cash_rounding){if(!this.env.pos.get_order().check_paymentlines_rounding()){this.showPopup('ErrorPopup',{title:this.env._t('Rounding error in payment lines'),body:this.env._t("The amount of your payment lines must be rounded to validate the transaction."),});return;}}
if(await this._isOrderValid(isForceValidate)){for(let line of this.paymentLines){if(!line.is_done())this.currentOrder.remove_paymentline(line);}
await this._finalizeValidation();}}
async _finalizeValidation(){if((this.currentOrder.is_paid_with_cash()||this.currentOrder.get_change())&&this.env.pos.config.iface_cashdrawer){this.env.pos.proxy.printer.open_cashbox();}
this.currentOrder.initialize_validation_date();this.currentOrder.finalized=true;let syncedOrderBackendIds=[];try{if(this.currentOrder.is_to_invoice()){syncedOrderBackendIds=await this.env.pos.push_and_invoice_order(this.currentOrder);}else{syncedOrderBackendIds=await this.env.pos.push_single_order(this.currentOrder);}}catch(error){if(error.code==700||error.code==701)
this.error=true;if(error instanceof Error){throw error;}else{await this._handlePushOrderError(error);}}
if(syncedOrderBackendIds.length&&this.currentOrder.wait_for_push_order()){const result=await this._postPushOrderResolve(this.currentOrder,syncedOrderBackendIds);if(!result){await this.showPopup('ErrorPopup',{title:'Error: no internet connection.',body:error,});}}
this.showScreen(this.nextScreen);if(syncedOrderBackendIds.length&&this.env.pos.db.get_orders().length){const{confirmed}=await this.showPopup('ConfirmPopup',{title:this.env._t('Remaining unsynced orders'),body:this.env._t('There are unsynced orders. Do you want to sync these orders?'),});if(confirmed){this.env.pos.push_orders();}}}
get nextScreen(){return!this.error?'ReceiptScreen':'ProductScreen';}
async _isOrderValid(isForceValidate){if(this.currentOrder.get_orderlines().length===0){this.showPopup('ErrorPopup',{title:this.env._t('Empty Order'),body:this.env._t('There must be at least one product in your order before it can be validated'),});return false;}
if(this.currentOrder.is_to_invoice()&&!this.currentOrder.get_client()){const{confirmed}=await this.showPopup('ConfirmPopup',{title:this.env._t('Please select the Customer'),body:this.env._t('You need to select the customer before you can invoice an order.'),});if(confirmed){this.selectClient();}
return false;}
if(!this.currentOrder.is_paid()||this.invoicing){return false;}
if(this.currentOrder.has_not_valid_rounding()){var line=this.currentOrder.has_not_valid_rounding();this.showPopup('ErrorPopup',{title:this.env._t('Incorrect rounding'),body:this.env._t('You have to round your payments lines.'+line.amount+' is not rounded.'),});return false;}
if(Math.abs(this.currentOrder.get_total_with_tax()-this.currentOrder.get_total_paid()+this.currentOrder.get_rounding_applied())>0.00001){var cash=false;for(var i=0;i<this.env.pos.payment_methods.length;i++){cash=cash||this.env.pos.payment_methods[i].is_cash_count;}
if(!cash){this.showPopup('ErrorPopup',{title:this.env._t('Cannot return change without a cash payment method'),body:this.env._t('There is no cash payment method available in this point of sale to handle the change.\n\n Please pay the exact amount or add a cash payment method in the point of sale configuration'),});return false;}}
if(!isForceValidate&&this.currentOrder.get_total_with_tax()>0&&this.currentOrder.get_total_with_tax()*1000<this.currentOrder.get_total_paid()){this.showPopup('ConfirmPopup',{title:this.env._t('Please Confirm Large Amount'),body:this.env._t('Are you sure that the customer wants to  pay')+' '+
this.env.pos.format_currency(this.currentOrder.get_total_paid())+' '+
this.env._t('for an order of')+' '+
this.env.pos.format_currency(this.currentOrder.get_total_with_tax())+' '+
this.env._t('? Clicking "Confirm" will validate the payment.'),}).then(({confirmed})=>{if(confirmed)this.lockedValidateOrder(true);});return false;}
return true;}
async _postPushOrderResolve(order,order_server_ids){return true;}
async _sendPaymentRequest({detail:line}){this.paymentLines.forEach(function(line){line.can_be_reversed=false;});const payment_terminal=line.payment_method.payment_terminal;line.set_payment_status('waiting');const isPaymentSuccessful=await payment_terminal.send_payment_request(line.cid);if(isPaymentSuccessful){line.set_payment_status('done');line.can_be_reversed=payment_terminal.supports_reversals;}else{line.set_payment_status('retry');}}
async _sendPaymentCancel({detail:line}){const payment_terminal=line.payment_method.payment_terminal;line.set_payment_status('waitingCancel');const isCancelSuccessful=await payment_terminal.send_payment_cancel(this.currentOrder,line.cid);if(isCancelSuccessful){line.set_payment_status('retry');}else{line.set_payment_status('waitingCard');}}
async _sendPaymentReverse({detail:line}){const payment_terminal=line.payment_method.payment_terminal;line.set_payment_status('reversing');const isReversalSuccessful=await payment_terminal.send_payment_reversal(line.cid);if(isReversalSuccessful){line.set_amount(0);line.set_payment_status('reversed');}else{line.can_be_reversed=false;line.set_payment_status('done');}}
async _sendForceDone({detail:line}){line.set_payment_status('done');}
_onPrevOrder(prevOrder){prevOrder.off('change',null,this);prevOrder.paymentlines.off('change',null,this);if(prevOrder){prevOrder.stop_electronic_payment();}}
async _onNewOrder(newOrder){newOrder.on('change',this.render,this);newOrder.paymentlines.on('change',this.render,this);NumberBuffer.reset();await this.render();}}
PaymentScreen.template='PaymentScreen';Registries.Component.add(PaymentScreen);return PaymentScreen;});;

/* /point_of_sale/static/src/js/Screens/ProductScreen/Orderline.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.Orderline',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class Orderline extends PosComponent{selectLine(){this.trigger('select-line',{orderline:this.props.line});}
lotIconClicked(){this.trigger('edit-pack-lot-lines',{orderline:this.props.line});}
get addedClasses(){return{selected:this.props.line.selected,};}}
Orderline.template='Orderline';Registries.Component.add(Orderline);return Orderline;});;

/* /point_of_sale/static/src/js/Screens/ProductScreen/OrderSummary.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.OrderSummary',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class OrderSummary extends PosComponent{}
OrderSummary.template='OrderSummary';Registries.Component.add(OrderSummary);return OrderSummary;});;

/* /point_of_sale/static/src/js/Screens/ProductScreen/OrderWidget.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.OrderWidget',function(require){'use strict';const{useState,useRef,onPatched}=owl.hooks;const{useListener}=require('web.custom_hooks');const{onChangeOrder}=require('point_of_sale.custom_hooks');const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class OrderWidget extends PosComponent{constructor(){super(...arguments);useListener('select-line',this._selectLine);useListener('edit-pack-lot-lines',this._editPackLotLines);onChangeOrder(this._onPrevOrder,this._onNewOrder);this.scrollableRef=useRef('scrollable');this.scrollToBottom=false;onPatched(()=>{if(this.scrollToBottom){this.scrollableRef.el.scrollTop=this.scrollableRef.el.scrollHeight;this.scrollToBottom=false;}});this.state=useState({total:0,tax:0});this._updateSummary();}
get order(){return this.env.pos.get_order();}
get orderlinesArray(){return this.order?this.order.get_orderlines():[];}
_selectLine(event){this.order.select_orderline(event.detail.orderline);}
async _editPackLotLines(event){const orderline=event.detail.orderline;const isAllowOnlyOneLot=orderline.product.isAllowOnlyOneLot();const packLotLinesToEdit=orderline.getPackLotLinesToEdit(isAllowOnlyOneLot);const{confirmed,payload}=await this.showPopup('EditListPopup',{title:this.env._t('Lot/Serial Number(s) Required'),isSingleItem:isAllowOnlyOneLot,array:packLotLinesToEdit,});if(confirmed){const modifiedPackLotLines=Object.fromEntries(payload.newArray.filter(item=>item.id).map(item=>[item.id,item.text]));const newPackLotLines=payload.newArray.filter(item=>!item.id).map(item=>({lot_name:item.text}));orderline.setPackLotLines({modifiedPackLotLines,newPackLotLines});}
this.order.select_orderline(event.detail.orderline);}
_onNewOrder(order){if(order){order.orderlines.on('new-orderline-selected',()=>this.trigger('new-orderline-selected'),this);order.orderlines.on('change',this._updateSummary,this);order.orderlines.on('add remove',()=>{this.scrollToBottom=true;this._updateSummary();},this);order.on('change',this.render,this);}
this._updateSummary();this.trigger('new-orderline-selected');}
_onPrevOrder(order){if(order){order.orderlines.off('new-orderline-selected',null,this);order.orderlines.off('change',null,this);order.orderlines.off('add remove',null,this);order.off('change',null,this);}}
_updateSummary(){const total=this.order?this.order.get_total_with_tax():0;const tax=this.order?total-this.order.get_total_without_tax():0;this.state.total=this.env.pos.format_currency(total);this.state.tax=this.env.pos.format_currency(tax);this.render();}}
OrderWidget.template='OrderWidget';Registries.Component.add(OrderWidget);return OrderWidget;});;

/* /point_of_sale/static/src/js/Screens/ProductScreen/NumpadWidget.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.NumpadWidget',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class NumpadWidget extends PosComponent{mounted(){this.env.pos.on('change:cashier',()=>{if(!this.hasPriceControlRights&&this.props.activeMode==='price'){this.trigger('set-numpad-mode',{mode:'quantity'});}});}
willUnmount(){this.env.pos.on('change:cashier',null,this);}
get hasPriceControlRights(){const cashier=this.env.pos.get('cashier')||this.env.pos.get_cashier();return!this.env.pos.config.restrict_price_control||cashier.role=='manager';}
get hasManualDiscount(){return this.env.pos.config.manual_discount;}
changeMode(mode){if(!this.hasPriceControlRights&&mode==='price'){return;}
if(!this.hasManualDiscount&&mode==='discount'){return;}
this.trigger('set-numpad-mode',{mode});}
sendInput(key){this.trigger('numpad-click-input',{key});}
get decimalSeparator(){return this.env._t.database.parameters.decimal_point;}}
NumpadWidget.template='NumpadWidget';Registries.Component.add(NumpadWidget);return NumpadWidget;});;

/* /point_of_sale/static/src/js/Screens/ProductScreen/ActionpadWidget.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ActionpadWidget',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class ActionpadWidget extends PosComponent{get isLongName(){return this.client&&this.client.name.length>10;}
get client(){return this.props.client;}}
ActionpadWidget.template='ActionpadWidget';Registries.Component.add(ActionpadWidget);return ActionpadWidget;});;

/* /point_of_sale/static/src/js/Screens/ProductScreen/CategoryBreadcrumb.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.CategoryBreadcrumb',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class CategoryBreadcrumb extends PosComponent{}
CategoryBreadcrumb.template='CategoryBreadcrumb';Registries.Component.add(CategoryBreadcrumb);return CategoryBreadcrumb;});;

/* /point_of_sale/static/src/js/Screens/ProductScreen/CashBoxOpening.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.CashBoxOpening',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');const{Gui}=require('point_of_sale.Gui');const field_utils=require('web.field_utils');class CashBoxOpening extends PosComponent{constructor(){super(...arguments);this.changes={};this.defaultValue=this.env.pos.format_currency_no_symbol(this.env.pos.bank_statement.balance_start||0);this.symbol=this.env.pos.currency.symbol;}
captureChange(event){this.changes[event.target.name]=event.target.value;}
startSession(){let cashOpening=this.changes.cashBoxValue?this.changes.cashBoxValue:this.defaultValue;try{cashOpening=field_utils.parse.float(cashOpening);}catch(err){cashOpening=NaN;}
if(isNaN(cashOpening)){Gui.showPopup('ErrorPopup',{'title':'Wrong value','body':'Please insert a correct value.',});return;}
this.env.pos.bank_statement.balance_start=cashOpening;this.env.pos.pos_session.state='opened';this.props.cashControl.cashControl=false;this.rpc({model:'pos.session',method:'set_cashbox_pos',args:[this.env.pos.pos_session.id,cashOpening,this.changes.notes],});}}
CashBoxOpening.template='CashBoxOpening';Registries.Component.add(CashBoxOpening);return CashBoxOpening;});;

/* /point_of_sale/static/src/js/Screens/ProductScreen/CategoryButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.CategoryButton',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class CategoryButton extends PosComponent{get imageUrl(){const category=this.props.category
return`/web/image?model=pos.category&field=image_128&id=${category.id}&write_date=${category.write_date}&unique=1`;}}
CategoryButton.template='CategoryButton';Registries.Component.add(CategoryButton);return CategoryButton;});;

/* /point_of_sale/static/src/js/Screens/ProductScreen/CategorySimpleButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.CategorySimpleButton',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class CategorySimpleButton extends PosComponent{}
CategorySimpleButton.template='CategorySimpleButton';Registries.Component.add(CategorySimpleButton);return CategorySimpleButton;});;

/* /point_of_sale/static/src/js/Screens/ProductScreen/HomeCategoryBreadcrumb.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.HomeCategoryBreadcrumb',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');const{useListener}=require('web.custom_hooks');class HomeCategoryBreadcrumb extends PosComponent{constructor(){super(...arguments);useListener('categ-popup',this._categPopup);}
get selectedCategoryId(){return this.env.pos.get('selectedCategoryId');}
async _categPopup(){let selectionList=[{id:0,label:'All Items',isSelected:0===this.env.pos.get('selectedCategoryId'),item:{id:0,name:'All Items'},}];let subs=this.props.subcategories.map(category=>({id:category.id,label:category.name,isSelected:category.id===this.env.pos.get('selectedCategoryId'),item:category,}));selectionList=selectionList.concat(subs);const{confirmed,payload:selectedCategory}=await this.showPopup('SelectionPopup',{title:this.env._t('Select the category'),list:selectionList,});if(confirmed){this.trigger('switch-category',selectedCategory.id);}}}
HomeCategoryBreadcrumb.template='HomeCategoryBreadcrumb';Registries.Component.add(HomeCategoryBreadcrumb);return HomeCategoryBreadcrumb;});;

/* /point_of_sale/static/src/js/Screens/ProductScreen/ProductsWidgetControlPanel.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ProductsWidgetControlPanel',function(require){'use strict';const{useRef}=owl.hooks;const{debounce}=owl.utils;const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class ProductsWidgetControlPanel extends PosComponent{constructor(){super(...arguments);this.searchWordInput=useRef('search-word-input');this.updateSearch=debounce(this.updateSearch,100);}
clearSearch(){this.searchWordInput.el.value='';this.trigger('clear-search');}
updateSearch(event){this.trigger('update-search',event.target.value);if(event.key==='Enter'){this.trigger('try-add-product',{searchWordInput:this.searchWordInput});}}}
ProductsWidgetControlPanel.template='ProductsWidgetControlPanel';Registries.Component.add(ProductsWidgetControlPanel);return ProductsWidgetControlPanel;});;

/* /point_of_sale/static/src/js/Screens/ProductScreen/ProductItem.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ProductItem',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class ProductItem extends PosComponent{spaceClickProduct(event){if(event.which===32){this.trigger('click-product',this.props.product);}}
get imageUrl(){const product=this.props.product;return`/web/image?model=product.product&field=image_128&id=${product.id}&write_date=${product.write_date}&unique=1`;}
get pricelist(){const current_order=this.env.pos.get_order();if(current_order){return current_order.pricelist;}
return this.env.pos.default_pricelist;}
get price(){const formattedUnitPrice=this.env.pos.format_currency(this.props.product.get_display_price(this.pricelist,1),'Product Price');if(this.props.product.to_weight){return`${formattedUnitPrice}/${
                    this.env.pos.units_by_id[this.props.product.uom_id[0]].name
                }`;}else{return formattedUnitPrice;}}}
ProductItem.template='ProductItem';Registries.Component.add(ProductItem);return ProductItem;});;

/* /point_of_sale/static/src/js/Screens/ProductScreen/ProductList.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ProductList',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class ProductList extends PosComponent{}
ProductList.template='ProductList';Registries.Component.add(ProductList);return ProductList;});;

/* /point_of_sale/static/src/js/Screens/ProductScreen/ProductsWidget.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ProductsWidget',function(require){'use strict';const{useState}=owl.hooks;const PosComponent=require('point_of_sale.PosComponent');const{useListener}=require('web.custom_hooks');const Registries=require('point_of_sale.Registries');class ProductsWidget extends PosComponent{constructor(){super(...arguments);useListener('switch-category',this._switchCategory);useListener('update-search',this._updateSearch);useListener('try-add-product',this._tryAddProduct);useListener('clear-search',this._clearSearch);this.state=useState({searchWord:''});}
mounted(){this.env.pos.on('change:selectedCategoryId',this.render,this);}
willUnmount(){this.env.pos.off('change:selectedCategoryId',null,this);}
get selectedCategoryId(){return this.env.pos.get('selectedCategoryId');}
get searchWord(){return this.state.searchWord.trim();}
get productsToDisplay(){if(this.searchWord!==''){return this.env.pos.db.search_product_in_category(this.selectedCategoryId,this.searchWord);}else{return this.env.pos.db.get_product_by_category(this.selectedCategoryId);}}
get subcategories(){return this.env.pos.db.get_category_childs_ids(this.selectedCategoryId).map(id=>this.env.pos.db.get_category_by_id(id));}
get breadcrumbs(){if(this.selectedCategoryId===this.env.pos.db.root_category_id)return[];return[...this.env.pos.db.get_category_ancestors_ids(this.selectedCategoryId).slice(1),this.selectedCategoryId,].map(id=>this.env.pos.db.get_category_by_id(id));}
get hasNoCategories(){return this.env.pos.db.get_category_childs_ids(0).length===0;}
_switchCategory(event){this.env.pos.set('selectedCategoryId',event.detail);}
_updateSearch(event){this.state.searchWord=event.detail;}
_tryAddProduct(event){const searchResults=this.productsToDisplay;if(searchResults.length===1){const{searchWordInput}=event.detail;this.trigger('click-product',searchResults[0]);searchWordInput.el.value='';this._clearSearch();}}
_clearSearch(){this.state.searchWord='';}}
ProductsWidget.template='ProductsWidget';Registries.Component.add(ProductsWidget);return ProductsWidget;});;

/* /point_of_sale/static/src/js/Screens/ReceiptScreen/WrappedProductNameLines.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.WrappedProductNameLines',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class WrappedProductNameLines extends PosComponent{constructor(){super(...arguments);this.line=this.props.line;}}
WrappedProductNameLines.template='WrappedProductNameLines';Registries.Component.add(WrappedProductNameLines);return WrappedProductNameLines;});;

/* /point_of_sale/static/src/js/Screens/ReceiptScreen/OrderReceipt.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.OrderReceipt',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class OrderReceipt extends PosComponent{constructor(){super(...arguments);this._receiptEnv=this.props.order.getOrderReceiptEnv();}
willUpdateProps(nextProps){this._receiptEnv=nextProps.order.getOrderReceiptEnv();}
get receipt(){return this.receiptEnv.receipt;}
get orderlines(){return this.receiptEnv.orderlines;}
get paymentlines(){return this.receiptEnv.paymentlines;}
get isTaxIncluded(){return Math.abs(this.receipt.subtotal-this.receipt.total_with_tax)<=0.000001;}
get receiptEnv(){return this._receiptEnv;}
isSimple(line){return(line.discount===0&&line.is_in_unit&&line.quantity===1&&!(line.display_discount_policy=='without_discount'&&line.price<line.price_lst));}}
OrderReceipt.template='OrderReceipt';Registries.Component.add(OrderReceipt);return OrderReceipt;});;

/* /point_of_sale/static/src/js/Screens/ReceiptScreen/ReceiptScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ReceiptScreen',function(require){'use strict';const{Printer}=require('point_of_sale.Printer');const{is_email}=require('web.utils');const{useRef,useContext}=owl.hooks;const{useErrorHandlers,onChangeOrder}=require('point_of_sale.custom_hooks');const Registries=require('point_of_sale.Registries');const AbstractReceiptScreen=require('point_of_sale.AbstractReceiptScreen');const ReceiptScreen=(AbstractReceiptScreen)=>{class ReceiptScreen extends AbstractReceiptScreen{constructor(){super(...arguments);useErrorHandlers();onChangeOrder(null,(newOrder)=>newOrder&&this.render());this.orderReceipt=useRef('order-receipt');const order=this.currentOrder;const client=order.get_client();this.orderUiState=useContext(order.uiState.ReceiptScreen);this.orderUiState.inputEmail=this.orderUiState.inputEmail||(client&&client.email)||'';this.is_email=is_email;}
mounted(){setTimeout(async()=>await this.handleAutoPrint(),0);}
async onSendEmail(){if(!is_email(this.orderUiState.inputEmail)){this.orderUiState.emailSuccessful=false;this.orderUiState.emailNotice=this.env._t('Invalid email.');return;}
try{await this._sendReceiptToCustomer();this.orderUiState.emailSuccessful=true;this.orderUiState.emailNotice=this.env._t('Email sent.');}catch(error){this.orderUiState.emailSuccessful=false;this.orderUiState.emailNotice=this.env._t('Sending email failed. Please try again.');}}
get orderAmountPlusTip(){const order=this.currentOrder;const orderTotalAmount=order.get_total_with_tax();const tip_product_id=this.env.pos.config.tip_product_id&&this.env.pos.config.tip_product_id[0];const tipLine=order.get_orderlines().find((line)=>tip_product_id&&line.product.id===tip_product_id);const tipAmount=tipLine?tipLine.get_all_prices().priceWithTax:0;const orderAmountStr=this.env.pos.format_currency(orderTotalAmount-tipAmount);if(!tipAmount)return orderAmountStr;const tipAmountStr=this.env.pos.format_currency(tipAmount);return`${orderAmountStr} + ${tipAmountStr} tip`;}
get currentOrder(){return this.env.pos.get_order();}
get nextScreen(){return{name:'ProductScreen'};}
whenClosing(){this.orderDone();}
async handleAutoPrint(){if(this._shouldAutoPrint()){await this.printReceipt();if(this.currentOrder._printed&&this._shouldCloseImmediately()){this.whenClosing();}}}
orderDone(){this.currentOrder.finalize();const{name,props}=this.nextScreen;this.showScreen(name,props);}
async printReceipt(){const isPrinted=await this._printReceipt();if(isPrinted){this.currentOrder._printed=true;}}
_shouldAutoPrint(){return this.env.pos.config.iface_print_auto&&!this.currentOrder._printed;}
_shouldCloseImmediately(){var invoiced_finalized=this.currentOrder.is_to_invoice()?this.currentOrder.finalized:true;return this.env.pos.proxy.printer&&this.env.pos.config.iface_print_skip_screen&&invoiced_finalized;}
async _sendReceiptToCustomer(){const printer=new Printer(null,this.env.pos);const receiptString=this.orderReceipt.comp.el.outerHTML;const ticketImage=await printer.htmlToImg(receiptString);const order=this.currentOrder;const client=order.get_client();const orderName=order.get_name();const orderClient={email:this.orderUiState.inputEmail,name:client?client.name:this.orderUiState.inputEmail};const order_server_id=this.env.pos.validated_orders_name_server_id_map[orderName];await this.rpc({model:'pos.order',method:'action_receipt_to_customer',args:[[order_server_id],orderName,orderClient,ticketImage],});}}
ReceiptScreen.template='ReceiptScreen';return ReceiptScreen;};Registries.Component.addByExtending(ReceiptScreen,AbstractReceiptScreen);return ReceiptScreen;});;

/* /point_of_sale/static/src/js/Screens/ScaleScreen/ScaleScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ScaleScreen',function(require){'use strict';const{useState,useExternalListener}=owl.hooks;const PosComponent=require('point_of_sale.PosComponent');const{round_precision:round_pr}=require('web.utils');const Registries=require('point_of_sale.Registries');class ScaleScreen extends PosComponent{constructor(){super(...arguments);useExternalListener(document,'keyup',this._onHotkeys);this.state=useState({weight:0});}
mounted(){this._readScale();}
willUnmount(){this.env.pos.proxy_queue.clear();}
back(){this.props.resolve({confirmed:false,payload:null});this.trigger('close-temp-screen');}
confirm(){this.props.resolve({confirmed:true,payload:{weight:this.state.weight},});this.trigger('close-temp-screen');}
_onHotkeys(event){if(event.key==='Escape'){this.back();}else if(event.key==='Enter'){this.confirm();}}
_readScale(){this.env.pos.proxy_queue.schedule(this._setWeight.bind(this),{duration:500,repeat:true,});}
async _setWeight(){const reading=await this.env.pos.proxy.scale_read();this.state.weight=reading.weight;}
get _activePricelist(){const current_order=this.env.pos.get_order();let current_pricelist=this.env.pos.default_pricelist;if(current_order){current_pricelist=current_order.pricelist;}
return current_pricelist;}
get productWeightString(){const defaultstr=(this.state.weight||0).toFixed(3)+' Kg';if(!this.props.product||!this.env.pos){return defaultstr;}
const unit_id=this.props.product.uom_id;if(!unit_id){return defaultstr;}
const unit=this.env.pos.units_by_id[unit_id[0]];const weight=round_pr(this.state.weight||0,unit.rounding);let weightstr=weight.toFixed(Math.ceil(Math.log(1.0/unit.rounding)/Math.log(10)));weightstr+=' '+unit.name;return weightstr;}
get computedPriceString(){return this.env.pos.format_currency(this.productPrice*this.state.weight);}
get productPrice(){const product=this.props.product;return(product?product.get_price(this._activePricelist,this.state.weight):0)||0;}
get productName(){return((this.props.product?this.props.product.display_name:undefined)||'Unnamed Product');}
get productUom(){return this.props.product?this.env.pos.units_by_id[this.props.product.uom_id[0]].name:'';}}
ScaleScreen.template='ScaleScreen';Registries.Component.add(ScaleScreen);return ScaleScreen;});;

/* /point_of_sale/static/src/js/ChromeWidgets/CashierName.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.CashierName',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class CashierName extends PosComponent{get username(){const cashier=this.env.pos.get_cashier();if(cashier){return cashier.name;}else{return'';}}}
CashierName.template='CashierName';Registries.Component.add(CashierName);return CashierName;});;

/* /point_of_sale/static/src/js/ChromeWidgets/ProxyStatus.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ProxyStatus',function(require){'use strict';const{useState}=owl;const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class ProxyStatus extends PosComponent{constructor(){super(...arguments);const initialProxyStatus=this.env.pos.proxy.get('status');this.state=useState({status:initialProxyStatus.status,msg:initialProxyStatus.msg,});this.statuses=['connected','connecting','disconnected','warning'];this.index=0;}
mounted(){this.env.pos.proxy.on('change:status',this,this._onChangeStatus);}
willUnmount(){this.env.pos.proxy.off('change:status',this,this._onChangeStatus);}
async onClick(){try{await this.env.pos.connect_to_proxy();}catch(error){if(error instanceof Error){throw error;}else{this.showPopup('ErrorPopup',error);}}}
_onChangeStatus(posProxy,statusChange){this._setStatus(statusChange.newValue);}
_setStatus(newStatus){if(newStatus.status==='connected'){var warning=false;var msg='';if(this.env.pos.config.iface_scan_via_proxy){var scannerStatus=newStatus.drivers.scanner?newStatus.drivers.scanner.status:false;if(scannerStatus!='connected'&&scannerStatus!='connecting'){warning=true;msg+=this.env._t('Scanner');}}
if(this.env.pos.config.iface_print_via_proxy||this.env.pos.config.iface_cashdrawer){var printerStatus=newStatus.drivers.printer?newStatus.drivers.printer.status:false;if(printerStatus!='connected'&&printerStatus!='connecting'){warning=true;msg=msg?msg+' & ':msg;msg+=this.env._t('Printer');}}
if(this.env.pos.config.iface_electronic_scale){var scaleStatus=newStatus.drivers.scale?newStatus.drivers.scale.status:false;if(scaleStatus!='connected'&&scaleStatus!='connecting'){warning=true;msg=msg?msg+' & ':msg;msg+=this.env._t('Scale');}}
msg=msg?msg+' '+this.env._t('Offline'):msg;this.state.status=warning?'warning':'connected';this.state.msg=msg;}else{this.state.status=newStatus.status;this.state.msg=newStatus.msg||'';}}}
ProxyStatus.template='ProxyStatus';Registries.Component.add(ProxyStatus);return ProxyStatus;});;

/* /point_of_sale/static/src/js/ChromeWidgets/SyncNotification.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.SyncNotification',function(require){'use strict';const{useState}=owl;const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class SyncNotification extends PosComponent{constructor(){super(...arguments);const synch=this.env.pos.get('synch');this.state=useState({status:synch.status,msg:synch.pending});}
mounted(){this.env.pos.on('change:synch',(pos,synch)=>{this.state.status=synch.status;this.state.msg=synch.pending;},this);}
willUnmount(){this.env.pos.on('change:synch',null,this);}
onClick(){this.env.pos.push_orders(null,{show_error:true});}}
SyncNotification.template='SyncNotification';Registries.Component.add(SyncNotification);return SyncNotification;});;

/* /point_of_sale/static/src/js/ChromeWidgets/OrderManagementButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.OrderManagementButton',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');const{isRpcError}=require('point_of_sale.utils');class OrderManagementButton extends PosComponent{async onClick(){try{await this.rpc({model:'pos.order',method:'browse',args:[[]],kwargs:{context:this.env.session.user_context},});this.showScreen('OrderManagementScreen');}catch(error){if(isRpcError(error)&&error.message.code<0){this.showPopup('ErrorPopup',{title:this.env._t('Network Error'),body:this.env._t('Cannot access order management screen if offline.'),});}else{throw error;}}}}
OrderManagementButton.template='OrderManagementButton';Registries.Component.add(OrderManagementButton);return OrderManagementButton;});;

/* /point_of_sale/static/src/js/ChromeWidgets/HeaderButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.HeaderButton',function(require){'use strict';const{useState}=owl;const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class HeaderButton extends PosComponent{constructor(){super(...arguments);this.state=useState({label:'Close'});this.confirmed=null;}
get translatedLabel(){return this.env._t(this.state.label);}
onClick(){if(!this.confirmed){this.state.label='Confirm';this.confirmed=setTimeout(()=>{this.state.label='Close';this.confirmed=null;},2000);}else{this.trigger('close-pos');}}}
HeaderButton.template='HeaderButton';Registries.Component.add(HeaderButton);return HeaderButton;});;

/* /point_of_sale/static/src/js/ChromeWidgets/SaleDetailsButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.SaleDetailsButton',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class SaleDetailsButton extends PosComponent{async onClick(){const saleDetails=await this.rpc({model:'report.point_of_sale.report_saledetails',method:'get_sale_details',args:[false,false,false,[this.env.pos.pos_session.id]],});const report=this.env.qweb.renderToString('SaleDetailsReport',Object.assign({},saleDetails,{date:new Date().toLocaleString(),pos:this.env.pos,}));const printResult=await this.env.pos.proxy.printer.print_receipt(report);if(!printResult.successful){await this.showPopup('ErrorPopup',{title:printResult.message.title,body:printResult.message.body,});}}}
SaleDetailsButton.template='SaleDetailsButton';Registries.Component.add(SaleDetailsButton);return SaleDetailsButton;});;

/* /point_of_sale/static/src/js/ChromeWidgets/TicketButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.TicketButton',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');const{posbus}=require('point_of_sale.utils');class TicketButton extends PosComponent{onClick(){if(this.props.isTicketScreenShown){posbus.trigger('ticket-button-clicked');}else{this.showScreen('TicketScreen');}}
willPatch(){posbus.off('order-deleted',this);}
patched(){posbus.on('order-deleted',this,this.render);}
mounted(){posbus.on('order-deleted',this,this.render);}
willUnmount(){posbus.off('order-deleted',this);}
get count(){if(this.env.pos){return this.env.pos.get_order_list().length;}else{return 0;}}}
TicketButton.template='TicketButton';Registries.Component.add(TicketButton);return TicketButton;});;

/* /point_of_sale/static/src/js/Misc/Draggable.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.Draggable',function(require){'use strict';const{useExternalListener}=owl.hooks;const{useListener}=require('web.custom_hooks');const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class Draggable extends PosComponent{constructor(){super(...arguments);this.isDragging=false;this.dx=0;this.dy=0;useExternalListener(document,'mousemove',this.move);useExternalListener(document,'mouseup',this.endDrag);useExternalListener(document,'touchmove',this.move);useExternalListener(document,'touchend',this.endDrag);useListener('mousedown','.drag-handle',this.startDrag);useListener('touchstart','.drag-handle',this.startDrag);}
mounted(){this.limitArea=this.props.limitArea?document.querySelector(this.props.limitArea):this.el.offsetParent;this.limitAreaBoundingRect=this.limitArea.getBoundingClientRect();if(this.limitArea===this.el.offsetParent){this.limitLeft=0;this.limitTop=0;this.limitRight=this.limitAreaBoundingRect.width;this.limitBottom=this.limitAreaBoundingRect.height;}else{this.limitLeft=-this.el.offsetParent.offsetLeft;this.limitTop=-this.el.offsetParent.offsetTop;this.limitRight=this.limitAreaBoundingRect.width-this.el.offsetParent.offsetLeft;this.limitBottom=this.limitAreaBoundingRect.height-this.el.offsetParent.offsetTop;}
this.limitAreaWidth=this.limitAreaBoundingRect.width;this.limitAreaHeight=this.limitAreaBoundingRect.height;const elBoundingRect=this.el.getBoundingClientRect();this.el.style.top=`${elBoundingRect.top}px`;this.el.style.left=`${elBoundingRect.left}px`;this.el.style.transform='none';}
startDrag(event){let realEvent;if(event instanceof CustomEvent){realEvent=event.detail;}else{realEvent=event;}
const{x,y}=this._getEventLoc(realEvent);this.isDragging=true;this.dx=this.el.offsetLeft-x;this.dy=this.el.offsetTop-y;event.stopPropagation();}
move(event){if(this.isDragging){const{x:pointerX,y:pointerY}=this._getEventLoc(event);const posLeft=this._getPosLeft(pointerX,this.dx);const posTop=this._getPosTop(pointerY,this.dy);this.el.style.left=`${posLeft}px`;this.el.style.top=`${posTop}px`;}}
endDrag(){if(this.isDragging){this.isDragging=false;this.trigger('drag-end',{loc:{top:this.el.offsetTop,left:this.el.offsetLeft},});}}
_getEventLoc(event){let coordX,coordY;if(event.touches&&event.touches[0]){coordX=event.touches[0].clientX;coordY=event.touches[0].clientY;}else{coordX=event.clientX;coordY=event.clientY;}
return{x:coordX,y:coordY,};}
_getPosLeft(pointerX,dx){const posLeft=pointerX+dx;if(posLeft<this.limitLeft){return this.limitLeft;}else if(posLeft>this.limitRight-this.el.offsetWidth){return this.limitRight-this.el.offsetWidth;}
return posLeft;}
_getPosTop(pointerY,dy){const posTop=pointerY+dy;if(posTop<this.limitTop){return this.limitTop;}else if(posTop>this.limitBottom-this.el.offsetHeight){return this.limitBottom-this.el.offsetHeight;}
return posTop;}}
Draggable.template='Draggable';Registries.Component.add(Draggable);return Draggable;});;

/* /point_of_sale/static/src/js/Misc/NotificationSound.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.NotificationSound',function(require){'use strict';const{useListener}=require('web.custom_hooks');const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class NotificationSound extends PosComponent{constructor(){super(...arguments);useListener('ended',()=>(this.props.sound.src=null));}}
NotificationSound.template='NotificationSound';Registries.Component.add(NotificationSound);return NotificationSound;});;

/* /point_of_sale/static/src/js/Misc/IndependentToOrderScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.IndependentToOrderScreen',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');class IndependentToOrderScreen extends PosComponent{close(){this.forceTriggerSelectedOrder();}
forceTriggerSelectedOrder(){this.env.pos.trigger('change:selectedOrder',this.env.pos,this.env.pos.get_order());}}
return IndependentToOrderScreen;});;

/* /point_of_sale/static/src/js/Misc/AbstractReceiptScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.AbstractReceiptScreen',function(require){'use strict';const{useRef}=owl.hooks;const{nextFrame}=require('point_of_sale.utils');const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class AbstractReceiptScreen extends PosComponent{constructor(){super(...arguments);this.orderReceipt=useRef('order-receipt');}
async _printReceipt(){if(this.env.pos.proxy.printer){const printResult=await this.env.pos.proxy.printer.print_receipt(this.orderReceipt.el.outerHTML);if(printResult.successful){return true;}else{const{confirmed}=await this.showPopup('ConfirmPopup',{title:printResult.message.title,body:'Do you want to print using the web printer?',});if(confirmed){await nextFrame();return await this._printWeb();}
return false;}}else{return await this._printWeb();}}
async _printWeb(){try{window.print();return true;}catch(err){await this.showPopup('ErrorPopup',{title:this.env._t('Printing is not supported on some browsers'),body:this.env._t('Printing is not supported on some browsers due to no default printing protocol '+'is available. It is possible to print your tickets by making use of an IoT Box.'),});return false;}}}
Registries.Component.add(AbstractReceiptScreen);return AbstractReceiptScreen;});;

/* /point_of_sale/static/src/js/Misc/SearchBar.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.SearchBar',function(require){'use strict';const{useState,useExternalListener}=owl.hooks;const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class SearchBar extends PosComponent{constructor(){super(...arguments);this.config=this.props.config;this.state=useState({searchInput:'',selectedFieldId:this.config.searchFields.length?0:null,showSearchFields:false,showFilterOptions:false,selectedFilter:this.config.filter.options[0]||this.env._t('Select'),});useExternalListener(window,'click',this._hideOptions);}
selectFilter(option){this.state.selectedFilter=option;this.trigger('filter-selected',{filter:this.state.selectedFilter});}
get placeholder(){return this.props.placeholder;}
onKeydown(event){if(['ArrowUp','ArrowDown'].includes(event.key)){event.preventDefault();this.state.selectedFieldId=this._fieldIdToSelect(event.key);}else if(event.key==='Enter'){this.trigger('search',{fieldValue:this.config.searchFields[this.state.selectedFieldId],searchTerm:this.state.searchInput,});this.state.showSearchFields=false;}else{if(this.state.selectedFieldId===null&&this.config.searchFields.length){this.state.selectedFieldId=0;}
this.state.showSearchFields=true;}}
onClickSearchField(id){this.state.showSearchFields=false;this.trigger('search',{fieldValue:this.config.searchFields[id],searchTerm:this.state.searchInput,});}
_fieldIdToSelect(key){const length=this.config.searchFields.length;if(!length)return null;if(this.state.selectedFieldId===null)return 0;const current=this.state.selectedFieldId||length;return(current+(key==='ArrowDown'?1:-1))%length;}
_hideOptions(){this.state.showFilterOptions=false;this.state.showSearchFields=false;}}
SearchBar.template='point_of_sale.SearchBar';SearchBar.defaultProps={config:{searchFields:[],filter:{show:false,options:[],},},placeholder:'Search ...',};Registries.Component.add(SearchBar);return SearchBar;});;

/* /point_of_sale/static/src/js/ChromeWidgets/DebugWidget.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.DebugWidget',function(require){'use strict';const{useState}=owl;const{useRef}=owl.hooks;const{getFileAsText}=require('point_of_sale.utils');const{parse}=require('web.field_utils');const NumberBuffer=require('point_of_sale.NumberBuffer');const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class DebugWidget extends PosComponent{constructor(){super(...arguments);this.state=useState({barcodeInput:'',weightInput:'',isPaidOrdersReady:false,isUnpaidOrdersReady:false,buffer:NumberBuffer.get(),});this.eventElementsRef={};this.animations={};for(let eventName of['open_cashbox','print_receipt','scale_read']){this.eventElementsRef[eventName]=useRef(eventName);this.env.pos.proxy.add_notification(eventName,(()=>{if(this.animations[eventName]){this.animations[eventName].cancel();}
const eventElement=this.eventElementsRef[eventName].el;eventElement.style.backgroundColor='#6CD11D';this.animations[eventName]=eventElement.animate({backgroundColor:['#6CD11D','#1E1E1E']},2000);}).bind(this));}}
mounted(){NumberBuffer.on('buffer-update',this,this._onBufferUpdate);}
willUnmount(){NumberBuffer.off('buffer-update',this,this._onBufferUpdate);}
toggleWidget(){this.state.isShown=!this.state.isShown;}
setWeight(){var weightInKg=parse.float(this.state.weightInput);if(!isNaN(weightInKg)){this.env.pos.proxy.debug_set_weight(weightInKg);}}
resetWeight(){this.state.weightInput='';this.env.pos.proxy.debug_reset_weight();}
barcodeScan(){this.env.pos.barcode_reader.scan(this.state.barcodeInput);}
barcodeScanEAN(){const ean=this.env.pos.barcode_reader.barcode_parser.sanitize_ean(this.state.barcodeInput||'0');this.state.barcodeInput=ean;this.env.pos.barcode_reader.scan(ean);}
async deleteOrders(){const{confirmed}=await this.showPopup('ConfirmPopup',{title:this.env._t('Delete Paid Orders ?'),body:this.env._t('This operation will permanently destroy all paid orders from the local storage. You will lose all the data. This operation cannot be undone.'),});if(confirmed){this.env.pos.db.remove_all_orders();this.env.pos.set_synch('connected',0);}}
async deleteUnpaidOrders(){const{confirmed}=await this.showPopup('ConfirmPopup',{title:this.env._t('Delete Unpaid Orders ?'),body:this.env._t('This operation will destroy all unpaid orders in the browser. You will lose all the unsaved data and exit the point of sale. This operation cannot be undone.'),});if(confirmed){this.env.pos.db.remove_all_unpaid_orders();window.location='/';}}
_createBlob(contents){if(typeof contents!=='string'){contents=JSON.stringify(contents,null,2);}
return new Blob([contents]);}
preparePaidOrders(){try{this.paidOrdersBlob=this._createBlob(this.env.pos.export_paid_orders());this.state.isPaidOrdersReady=true;}catch(error){console.warn(error);}}
get paidOrdersFilename(){return`${this.env._t('paid orders')} ${moment().format('YYYY-MM-DD-HH-mm-ss')}.json`;}
get paidOrdersURL(){var URL=window.URL||window.webkitURL;return URL.createObjectURL(this.paidOrdersBlob);}
prepareUnpaidOrders(){try{this.unpaidOrdersBlob=this._createBlob(this.env.pos.export_unpaid_orders());this.state.isUnpaidOrdersReady=true;}catch(error){console.warn(error);}}
get unpaidOrdersFilename(){return`${this.env._t('unpaid orders')} ${moment().format('YYYY-MM-DD-HH-mm-ss')}.json`;}
get unpaidOrdersURL(){var URL=window.URL||window.webkitURL;return URL.createObjectURL(this.unpaidOrdersBlob);}
async importOrders(event){const file=event.target.files[0];if(file){const report=this.env.pos.import_orders(await getFileAsText(file));await this.showPopup('OrderImportPopup',{report});}}
refreshDisplay(){this.env.pos.proxy.message('display_refresh',{});}
_onBufferUpdate(buffer){this.state.buffer=buffer;}
get bufferRepr(){return`"${this.state.buffer}"`;}}
DebugWidget.template='DebugWidget';Registries.Component.add(DebugWidget);return DebugWidget;});;

/* /point_of_sale/static/src/js/Popups/AbstractAwaitablePopup.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.AbstractAwaitablePopup',function(require){'use strict';const{useExternalListener}=owl.hooks;const PosComponent=require('point_of_sale.PosComponent');class AbstractAwaitablePopup extends PosComponent{constructor(){super(...arguments);useExternalListener(window,'keyup',this._cancelAtEscape);}
async confirm(){this.props.resolve({confirmed:true,payload:await this.getPayload()});this.trigger('close-popup');}
cancel(){this.props.resolve({confirmed:false,payload:null});this.trigger('close-popup');}
_cancelAtEscape(event){if(event.key==='Escape'){this.cancel();}}
async getPayload(){return null;}}
return AbstractAwaitablePopup;});;

/* /point_of_sale/static/src/js/Popups/ErrorPopup.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ErrorPopup',function(require){'use strict';const AbstractAwaitablePopup=require('point_of_sale.AbstractAwaitablePopup');const Registries=require('point_of_sale.Registries');class ErrorPopup extends AbstractAwaitablePopup{mounted(){this.playSound('error');}}
ErrorPopup.template='ErrorPopup';ErrorPopup.defaultProps={confirmText:'Ok',cancelText:'Cancel',title:'Error',body:'',};Registries.Component.add(ErrorPopup);return ErrorPopup;});;

/* /point_of_sale/static/src/js/Popups/ErrorBarcodePopup.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ErrorBarcodePopup',function(require){'use strict';const ErrorPopup=require('point_of_sale.ErrorPopup');const Registries=require('point_of_sale.Registries');class ErrorBarcodePopup extends ErrorPopup{get translatedMessage(){return this.env._t(this.props.message);}}
ErrorBarcodePopup.template='ErrorBarcodePopup';ErrorBarcodePopup.defaultProps={confirmText:'Ok',cancelText:'Cancel',title:'Error',body:'',message:'The Point of Sale could not find any product, client, employee or action associated with the scanned barcode.',};Registries.Component.add(ErrorBarcodePopup);return ErrorBarcodePopup;});;

/* /point_of_sale/static/src/js/Popups/ConfirmPopup.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ConfirmPopup',function(require){'use strict';const AbstractAwaitablePopup=require('point_of_sale.AbstractAwaitablePopup');const Registries=require('point_of_sale.Registries');class ConfirmPopup extends AbstractAwaitablePopup{}
ConfirmPopup.template='ConfirmPopup';ConfirmPopup.defaultProps={confirmText:'Ok',cancelText:'Cancel',title:'Confirm ?',body:'',};Registries.Component.add(ConfirmPopup);return ConfirmPopup;});;

/* /point_of_sale/static/src/js/Popups/TextInputPopup.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.TextInputPopup',function(require){'use strict';const{useState,useRef}=owl.hooks;const AbstractAwaitablePopup=require('point_of_sale.AbstractAwaitablePopup');const Registries=require('point_of_sale.Registries');class TextInputPopup extends AbstractAwaitablePopup{constructor(){super(...arguments);this.state=useState({inputValue:this.props.startingValue});this.inputRef=useRef('input');}
mounted(){this.inputRef.el.focus();}
getPayload(){return this.state.inputValue;}}
TextInputPopup.template='TextInputPopup';TextInputPopup.defaultProps={confirmText:'Ok',cancelText:'Cancel',title:'',body:'',startingValue:'',};Registries.Component.add(TextInputPopup);return TextInputPopup;});;

/* /point_of_sale/static/src/js/Popups/TextAreaPopup.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.TextAreaPopup',function(require){'use strict';const{useState,useRef}=owl.hooks;const AbstractAwaitablePopup=require('point_of_sale.AbstractAwaitablePopup');const Registries=require('point_of_sale.Registries');class TextAreaPopup extends AbstractAwaitablePopup{constructor(){super(...arguments);this.state=useState({inputValue:this.props.startingValue});this.inputRef=useRef('input');}
mounted(){this.inputRef.el.focus();}
getPayload(){return this.state.inputValue;}}
TextAreaPopup.template='TextAreaPopup';TextAreaPopup.defaultProps={confirmText:'Ok',cancelText:'Cancel',title:'',body:'',};Registries.Component.add(TextAreaPopup);return TextAreaPopup;});;

/* /point_of_sale/static/src/js/Popups/ErrorTracebackPopup.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ErrorTracebackPopup',function(require){'use strict';const ErrorPopup=require('point_of_sale.ErrorPopup');const Registries=require('point_of_sale.Registries');class ErrorTracebackPopup extends ErrorPopup{get tracebackUrl(){const blob=new Blob([this.props.body]);const URL=window.URL||window.webkitURL;return URL.createObjectURL(blob);}
get tracebackFilename(){return`${this.env._t('error')} ${moment().format('YYYY-MM-DD-HH-mm-ss')}.txt`;}
emailTraceback(){const address=this.env.pos.company.email;const subject=this.env._t('IMPORTANT: Bug Report From Odoo Point Of Sale');window.open('mailto:'+
address+'?subject='+
(subject?window.encodeURIComponent(subject):'')+'&body='+
(this.props.body?window.encodeURIComponent(this.props.body):''));}}
ErrorTracebackPopup.template='ErrorTracebackPopup';ErrorTracebackPopup.defaultProps={confirmText:'Ok',cancelText:'Cancel',title:'Error with Traceback',body:'',exitButtonIsShown:false,exitButtonText:'Exit Pos',exitButtonTrigger:'close-pos'};Registries.Component.add(ErrorTracebackPopup);return ErrorTracebackPopup;});;

/* /point_of_sale/static/src/js/Popups/SelectionPopup.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.SelectionPopup',function(require){'use strict';const{useState}=owl.hooks;const AbstractAwaitablePopup=require('point_of_sale.AbstractAwaitablePopup');const Registries=require('point_of_sale.Registries');class SelectionPopup extends AbstractAwaitablePopup{constructor(){super(...arguments);this.state=useState({selectedId:this.props.list.find((item)=>item.isSelected)});}
selectItem(itemId){this.state.selectedId=itemId;this.confirm();}
getPayload(){const selected=this.props.list.find((item)=>this.state.selectedId===item.id);return selected&&selected.item;}}
SelectionPopup.template='SelectionPopup';SelectionPopup.defaultProps={confirmText:'Confirm',cancelText:'Cancel',title:'Select',body:'',list:[],};Registries.Component.add(SelectionPopup);return SelectionPopup;});;

/* /point_of_sale/static/src/js/Popups/EditListInput.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.EditListInput',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class EditListInput extends PosComponent{onKeyup(event){if(event.key==="Enter"&&event.target.value.trim()!==''){this.trigger('create-new-item');}}}
EditListInput.template='EditListInput';Registries.Component.add(EditListInput);return EditListInput;});;

/* /point_of_sale/static/src/js/Popups/EditListPopup.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.EditListPopup',function(require){'use strict';const{useState}=owl.hooks;const AbstractAwaitablePopup=require('point_of_sale.AbstractAwaitablePopup');const Registries=require('point_of_sale.Registries');const{useAutoFocusToLast}=require('point_of_sale.custom_hooks');class EditListPopup extends AbstractAwaitablePopup{constructor(){super(...arguments);this._id=0;this.state=useState({array:this._initialize(this.props.array)});useAutoFocusToLast();}
_nextId(){return this._id++;}
_emptyItem(){return{text:'',_id:this._nextId(),};}
_initialize(array){if(array.length===0)return[this._emptyItem()];return array.map((item)=>Object.assign({},{_id:this._nextId()},typeof item==='object'?item:{'text':item}));}
removeItem(event){const itemToRemove=event.detail;this.state.array.splice(this.state.array.findIndex(item=>item._id==itemToRemove._id),1);if(this.state.array.length===0){this.state.array.push(this._emptyItem());}}
createNewItem(){if(this.props.isSingleItem)return;this.state.array.push(this._emptyItem());}
getPayload(){return{newArray:this.state.array.filter((item)=>item.text.trim()!=='').map((item)=>Object.assign({},item)),};}}
EditListPopup.template='EditListPopup';EditListPopup.defaultProps={confirmText:'Ok',cancelText:'Cancel',array:[],isSingleItem:false,};Registries.Component.add(EditListPopup);return EditListPopup;});;

/* /point_of_sale/static/src/js/Popups/NumberPopup.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.NumberPopup',function(require){'use strict';var core=require('web.core');var _t=core._t;const{useState}=owl;const AbstractAwaitablePopup=require('point_of_sale.AbstractAwaitablePopup');const NumberBuffer=require('point_of_sale.NumberBuffer');const{useListener}=require('web.custom_hooks');const Registries=require('point_of_sale.Registries');class NumberPopup extends AbstractAwaitablePopup{constructor(){super(...arguments);useListener('accept-input',this.confirm);useListener('close-this-popup',this.cancel);let startingBuffer='';if(typeof this.props.startingValue==='number'&&this.props.startingValue>0){startingBuffer=this.props.startingValue.toString().replace('.',this.decimalSeparator);}
this.state=useState({buffer:startingBuffer});NumberBuffer.use({nonKeyboardInputEvent:'numpad-click-input',triggerAtEnter:'accept-input',triggerAtEscape:'close-this-popup',state:this.state,});}
get decimalSeparator(){return this.env._t.database.parameters.decimal_point;}
get inputBuffer(){if(this.state.buffer===null){return'';}
if(this.props.isPassword){return this.state.buffer.replace(/./g,'•');}else{return this.state.buffer;}}
confirm(event){const bufferState=event.detail;if(bufferState.buffer!==''){super.confirm();}}
sendInput(key){this.trigger('numpad-click-input',{key});}
getPayload(){return NumberBuffer.get();}}
NumberPopup.template='NumberPopup';NumberPopup.defaultProps={confirmText:_t('Ok'),cancelText:_t('Cancel'),title:_t('Confirm ?'),body:'',cheap:false,startingValue:null,isPassword:false,};Registries.Component.add(NumberPopup);return NumberPopup;});;

/* /point_of_sale/static/src/js/Popups/OfflineErrorPopup.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.OfflineErrorPopup',function(require){'use strict';const ErrorPopup=require('point_of_sale.ErrorPopup');const Registries=require('point_of_sale.Registries');class OfflineErrorPopup extends ErrorPopup{dontShowAgain(){this.constructor.dontShow=true;this.cancel();}}
OfflineErrorPopup.template='OfflineErrorPopup';OfflineErrorPopup.dontShow=false;OfflineErrorPopup.defaultProps={confirmText:'Ok',cancelText:'Cancel',title:'Offline Error',body:'Either the server is inaccessible or browser is not connected online.',};Registries.Component.add(OfflineErrorPopup);return OfflineErrorPopup;});;

/* /point_of_sale/static/src/js/Popups/OrderImportPopup.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.OrderImportPopup',function(require){'use strict';const AbstractAwaitablePopup=require('point_of_sale.AbstractAwaitablePopup');const Registries=require('point_of_sale.Registries');class OrderImportPopup extends AbstractAwaitablePopup{get unpaidSkipped(){return((this.props.report.unpaid_skipped_existing||0)+
(this.props.report.unpaid_skipped_session||0));}
getPayload(){}}
OrderImportPopup.template='OrderImportPopup';OrderImportPopup.defaultProps={confirmText:'Ok',cancelText:'Cancel',body:'',};Registries.Component.add(OrderImportPopup);return OrderImportPopup;});;

/* /point_of_sale/static/src/js/Popups/ProductConfiguratorPopup.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ProductConfiguratorPopup',function(require){'use strict';const{useState,useSubEnv}=owl.hooks;const PosComponent=require('point_of_sale.PosComponent');const AbstractAwaitablePopup=require('point_of_sale.AbstractAwaitablePopup');const Registries=require('point_of_sale.Registries');class ProductConfiguratorPopup extends AbstractAwaitablePopup{constructor(){super(...arguments);useSubEnv({attribute_components:[]});}
getPayload(){var selected_attributes=[];var price_extra=0.0;this.env.attribute_components.forEach((attribute_component)=>{let{value,extra}=attribute_component.getValue();selected_attributes.push(value);price_extra+=extra;});return{selected_attributes,price_extra,};}}
ProductConfiguratorPopup.template='ProductConfiguratorPopup';Registries.Component.add(ProductConfiguratorPopup);class BaseProductAttribute extends PosComponent{constructor(){super(...arguments);this.env.attribute_components.push(this);this.attribute=this.props.attribute;this.values=this.attribute.values;this.state=useState({selected_value:parseFloat(this.values[0].id),custom_value:'',});}
getValue(){let selected_value=this.values.find((val)=>val.id===parseFloat(this.state.selected_value));let value=selected_value.name;if(selected_value.is_custom&&this.state.custom_value){value+=`: ${this.state.custom_value}`;}
return{value,extra:selected_value.price_extra};}}
class RadioProductAttribute extends BaseProductAttribute{mounted(){$(this.el).find('input[type="radio"]:first').prop('checked',true);}}
RadioProductAttribute.template='RadioProductAttribute';Registries.Component.add(RadioProductAttribute);class SelectProductAttribute extends BaseProductAttribute{}
SelectProductAttribute.template='SelectProductAttribute';Registries.Component.add(SelectProductAttribute);class ColorProductAttribute extends BaseProductAttribute{}
ColorProductAttribute.template='ColorProductAttribute';Registries.Component.add(ColorProductAttribute);return{ProductConfiguratorPopup,BaseProductAttribute,RadioProductAttribute,SelectProductAttribute,ColorProductAttribute,};});;

/* /point_of_sale/static/src/js/Screens/ProductScreen/ControlButtons/SetPricelistButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.SetPricelistButton',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const ProductScreen=require('point_of_sale.ProductScreen');const{useListener}=require('web.custom_hooks');const Registries=require('point_of_sale.Registries');class SetPricelistButton extends PosComponent{constructor(){super(...arguments);useListener('click',this.onClick);}
mounted(){this.env.pos.get('orders').on('add remove change',()=>this.render(),this);this.env.pos.on('change:selectedOrder',()=>this.render(),this);}
willUnmount(){this.env.pos.get('orders').off('add remove change',null,this);this.env.pos.off('change:selectedOrder',null,this);}
get currentOrder(){return this.env.pos.get_order();}
get currentPricelistName(){const order=this.currentOrder;return order&&order.pricelist?order.pricelist.display_name:this.env._t('Pricelist');}
async onClick(){const selectionList=this.env.pos.pricelists.map(pricelist=>({id:pricelist.id,label:pricelist.name,isSelected:pricelist.id===this.currentOrder.pricelist.id,item:pricelist,}));const{confirmed,payload:selectedPricelist}=await this.showPopup('SelectionPopup',{title:this.env._t('Select the pricelist'),list:selectionList,});if(confirmed){this.currentOrder.set_pricelist(selectedPricelist);}}}
SetPricelistButton.template='SetPricelistButton';ProductScreen.addControlButton({component:SetPricelistButton,condition:function(){return this.env.pos.config.use_pricelist&&this.env.pos.pricelists.length>1;},});Registries.Component.add(SetPricelistButton);return SetPricelistButton;});;

/* /point_of_sale/static/src/js/Screens/ProductScreen/ControlButtons/SetFiscalPositionButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.SetFiscalPositionButton',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const ProductScreen=require('point_of_sale.ProductScreen');const{useListener}=require('web.custom_hooks');const Registries=require('point_of_sale.Registries');class SetFiscalPositionButton extends PosComponent{constructor(){super(...arguments);useListener('click',this.onClick);}
mounted(){this.env.pos.get('orders').on('add remove change',()=>this.render(),this);this.env.pos.on('change:selectedOrder',()=>this.render(),this);}
willUnmount(){this.env.pos.get('orders').off('add remove change',null,this);this.env.pos.off('change:selectedOrder',null,this);}
get currentOrder(){return this.env.pos.get_order();}
get currentFiscalPositionName(){return this.currentOrder&&this.currentOrder.fiscal_position?this.currentOrder.fiscal_position.display_name:this.env._t('Tax');}
async onClick(){const currentFiscalPosition=this.currentOrder.fiscal_position;const fiscalPosList=[{id:-1,label:this.env._t('None'),isSelected:!currentFiscalPosition,},];for(let fiscalPos of this.env.pos.fiscal_positions){fiscalPosList.push({id:fiscalPos.id,label:fiscalPos.name,isSelected:currentFiscalPosition?fiscalPos.id===currentFiscalPosition.id:false,item:fiscalPos,});}
const{confirmed,payload:selectedFiscalPosition}=await this.showPopup('SelectionPopup',{title:this.env._t('Select Fiscal Position'),list:fiscalPosList,});if(confirmed){this.currentOrder.fiscal_position=selectedFiscalPosition;for(let line of this.currentOrder.orderlines.models){line.set_quantity(line.quantity);}
this.currentOrder.trigger('change');}}}
SetFiscalPositionButton.template='SetFiscalPositionButton';ProductScreen.addControlButton({component:SetFiscalPositionButton,condition:function(){return this.env.pos.fiscal_positions.length>0;},position:['before','SetPricelistButton'],});Registries.Component.add(SetFiscalPositionButton);return SetFiscalPositionButton;});;

/* /point_of_sale/static/src/js/ChromeWidgets/ClientScreenButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.ClientScreenButton',function(require){'use strict';const{useState}=owl;const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class ClientScreenButton extends PosComponent{constructor(){super(...arguments);this.state=useState({status:'failure'});this._start();}
get message(){return{success:'',warning:this.env._t('Connected, Not Owned'),failure:this.env._t('Disconnected'),not_found:this.env._t('Client Screen Unsupported. Please upgrade the IoT Box'),}[this.state.status];}
async onClick(){try{const renderedHtml=await this.env.pos.render_html_for_customer_facing_display();const ownership=await this.env.pos.proxy.take_ownership_over_client_screen(renderedHtml);if(typeof ownership==='string'){ownership=JSON.parse(ownership);}
if(ownership.status==='success'){this.state.status='success';}else{this.state.status='warning';}
if(!this.env.pos.proxy.posbox_supports_display){this.env.pos.proxy.posbox_supports_display=true;this._start();}}catch(error){if(typeof error=='undefined'){this.state.status='failure';}else{this.state.status='not_found';}}}
_start(){const self=this;async function loop(){if(self.env.pos.proxy.posbox_supports_display){try{const ownership=await self.env.pos.proxy.test_ownership_of_client_screen();if(typeof ownership==='string'){ownership=JSON.parse(ownership);}
if(ownership.status==='OWNER'){self.state.status='success';}else{self.state.status='warning';}
setTimeout(loop,3000);}catch(error){if(error.abort){return;}
if(typeof error=='undefined'){self.state.status='failure';}else{self.state.status='not_found';self.env.pos.proxy.posbox_supports_display=false;}
setTimeout(loop,3000);}}}
loop();}}
ClientScreenButton.template='ClientScreenButton';Registries.Component.add(ClientScreenButton);return ClientScreenButton;});;

/* /point_of_sale/static/src/js/Misc/NumberBuffer.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.NumberBuffer',function(require){'use strict';const{Component}=owl;const{EventBus}=owl.core;const{onMounted,onWillUnmount,useExternalListener}=owl.hooks;const{useListener}=require('web.custom_hooks');const{parse}=require('web.field_utils');const{BarcodeEvents}=require('barcodes.BarcodeEvents');const{_t}=require('web.core');const{Gui}=require('point_of_sale.Gui');const INPUT_KEYS=new Set(['Delete','Backspace','+1','+2','+5','+10','+20','+50'].concat('0123456789+-.,'.split('')));const CONTROL_KEYS=new Set(['Enter','Esc']);const ALLOWED_KEYS=new Set([...INPUT_KEYS,...CONTROL_KEYS]);const getDefaultConfig=()=>({decimalPoint:false,triggerAtEnter:false,triggerAtEsc:false,triggerAtInput:false,nonKeyboardInputEvent:false,useWithBarcode:false,});class NumberBuffer extends EventBus{constructor(){super();this.isReset=false;this.bufferHolderStack=[];}
get(){return this.state?this.state.buffer:null;}
set(val){this.state.buffer=!isNaN(parseFloat(val))?val:'';this.trigger('buffer-update',this.state.buffer);}
reset(){this.isReset=true;this.state.buffer='';this.trigger('buffer-update',this.state.buffer);}
capture(){if(this.handler){clearTimeout(this._timeout);this.handler();delete this.handler;}}
getFloat(){return parse.float(this.get());}
activate(){this.defaultDecimalPoint=_t.database.parameters.decimal_point;useExternalListener(window,'keyup',this._onKeyboardInput.bind(this));}
use(config){this.eventsBuffer=[];const currentComponent=Component.current;config=Object.assign(getDefaultConfig(),config);onMounted(()=>{this.bufferHolderStack.push({component:currentComponent,state:config.state?config.state:{buffer:''},config,});this._setUp();});onWillUnmount(()=>{this.bufferHolderStack.pop();this._setUp();});if(typeof config.nonKeyboardInputEvent==='string'){useListener(config.nonKeyboardInputEvent,this._onNonKeyboardInput.bind(this));}}
get _currentBufferHolder(){return this.bufferHolderStack[this.bufferHolderStack.length-1];}
_setUp(){if(!this._currentBufferHolder)return;const{component,state,config}=this._currentBufferHolder;this.component=component;this.state=state;this.config=config;this.decimalPoint=config.decimalPoint||this.defaultDecimalPoint;this.maxTimeBetweenKeys=this.config.useWithBarcode?BarcodeEvents.max_time_between_keys_in_ms:0;}
_onKeyboardInput(event){return this._bufferEvents(this._onInput(event=>event.key))(event);}
_onNonKeyboardInput(event){return this._bufferEvents(this._onInput(event=>event.detail.key))(event);}
_bufferEvents(handler){return event=>{if(['INPUT','TEXTAREA'].includes(event.target.tagName)||!this.eventsBuffer)return;clearTimeout(this._timeout);this.eventsBuffer.push(event);this._timeout=setTimeout(handler,this.maxTimeBetweenKeys);this.handler=handler};}
_onInput(keyAccessor){return()=>{if(this.eventsBuffer.length<=2){for(let event of this.eventsBuffer){if(!ALLOWED_KEYS.has(keyAccessor(event))){this.eventsBuffer=[];return;}}
for(let event of this.eventsBuffer){this._handleInput(keyAccessor(event));event.preventDefault();event.stopPropagation();}}
this.eventsBuffer=[];};}
_handleInput(key){if(key==='Enter'&&this.config.triggerAtEnter){this.component.trigger(this.config.triggerAtEnter,this.state);}else if(key==='Esc'&&this.config.triggerAtEsc){this.component.trigger(this.config.triggerAtEsc,this.state);}else if(INPUT_KEYS.has(key)){this._updateBuffer(key);if(this.config.triggerAtInput)
this.component.trigger(this.config.triggerAtInput,{buffer:this.state.buffer,key});}}
_updateBuffer(input){const isEmpty=val=>{return val===''||val===null;};if(input===undefined||input===null)return;let isFirstInput=isEmpty(this.state.buffer);if(input===','||input==='.'){if(isFirstInput){this.state.buffer='0'+this.decimalPoint;}else if(!this.state.buffer.length||this.state.buffer==='-'){this.state.buffer+='0'+this.decimalPoint;}else if(this.state.buffer.indexOf(this.decimalPoint)<0){this.state.buffer=this.state.buffer+this.decimalPoint;}}else if(input==='Delete'){if(this.isReset){this.state.buffer='';this.isReset=false;return;}
this.state.buffer=isEmpty(this.state.buffer)?null:'';}else if(input==='Backspace'){if(this.isReset){this.state.buffer='';this.isReset=false;return;}
const buffer=this.state.buffer;if(isEmpty(buffer)){this.state.buffer=null;}else{const nCharToRemove=buffer[buffer.length-1]===this.decimalPoint?2:1;this.state.buffer=buffer.substring(0,buffer.length-nCharToRemove);}}else if(input==='+'){if(this.state.buffer[0]==='-'){this.state.buffer=this.state.buffer.substring(1,this.state.buffer.length);}}else if(input==='-'){if(isFirstInput){this.state.buffer='-0';}else if(this.state.buffer[0]==='-'){this.state.buffer=this.state.buffer.substring(1,this.state.buffer.length);}else{this.state.buffer='-'+this.state.buffer;}}else if(input[0]==='+'&&!isNaN(parseFloat(input))){const inputValue=parse.float(input.slice(1));const currentBufferValue=this.state.buffer?parse.float(this.state.buffer):0;this.state.buffer=this.component.env.pos.formatFixed(inputValue+currentBufferValue);}else if(!isNaN(parseInt(input,10))){if(isFirstInput){this.state.buffer=''+input;}else if(this.state.buffer.length>12){Gui.playSound('bell');}else{this.state.buffer+=input;}}
if(this.state.buffer==='-'){this.state.buffer='';}
this.isReset=false;this.trigger('buffer-update',this.state.buffer);}}
return new NumberBuffer();});;

/* /point_of_sale/static/src/js/Misc/MobileOrderWidget.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.MobileOrderWidget',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class MobileOrderWidget extends PosComponent{constructor(){super(...arguments);this.pane=this.props.pane;this.update();}
get order(){return this.env.pos.get_order();}
mounted(){this.order.on('change',()=>{this.update();this.render();});this.order.orderlines.on('change',()=>{this.update();this.render();});}
update(){const total=this.order?this.order.get_total_with_tax():0;const tax=this.order?total-this.order.get_total_without_tax():0;this.total=this.env.pos.format_currency(total);this.items_number=this.order?this.order.orderlines.reduce((items_number,line)=>items_number+line.quantity,0):0;}}
MobileOrderWidget.template='MobileOrderWidget';Registries.Component.add(MobileOrderWidget);return MobileOrderWidget;});;

/* /pos_epson_printer/static/src/js/pos_epson_printer.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_epson_printer.pos_epson_printer',function(require){"use strict";var models=require('point_of_sale.models');var EpsonPrinter=require('pos_epson_printer.Printer');var posmodel_super=models.PosModel.prototype;models.PosModel=models.PosModel.extend({after_load_server_data:function(){var self=this;return posmodel_super.after_load_server_data.apply(this,arguments).then(function(){if(self.config.other_devices&&self.config.epson_printer_ip){self.proxy.printer=new EpsonPrinter(self.config.epson_printer_ip,self);}});},});});;

/* /pos_epson_printer/static/src/js/printers.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_epson_printer.Printer',function(require){"use strict";const{Gui}=require('point_of_sale.Gui');var core=require('web.core');var PrinterMixin=require('point_of_sale.Printer').PrinterMixin;var _t=core._t;var EpsonPrinter=core.Class.extend(PrinterMixin,{init:function(ip,pos){PrinterMixin.init.call(this,pos);this.ePOSDevice=new epson.ePOSDevice();var port=window.location.protocol==='http:'?'8008':'8043';this.ePOSDevice.connect(ip,port,this.callback_connect.bind(this),{eposprint:true});},callback_connect:function(resultConnect){var deviceId='local_printer';var options={'crypto':false,'buffer':false};if((resultConnect=='OK')||(resultConnect=='SSL_CONNECT_OK')){this.ePOSDevice.createDevice(deviceId,this.ePOSDevice.DEVICE_TYPE_PRINTER,options,this.callback_createDevice.bind(this));}else{Gui.showPopup('ErrorPopup',{'title':_t('Connection to the printer failed'),'body':_t('Please check if the printer is still connected, if the configured IP address is correct and if your printer supports the ePOS protocol. \n'+'Some browsers don\'t allow HTTP calls from websites to devices in the network (for security reasons). '+'If it is the case, you will need to follow Odoo\'s documentation for '+'\'Self-signed certificate for ePOS printers\' and \'Secure connection (HTTPS)\' to solve the issue'),});}},callback_createDevice:function(deviceObj,errorCode){if(deviceObj===null){Gui.showPopup('ErrorPopup',{'title':_t('Connection to the printer failed'),'body':_t('Please check if the printer is still connected. Error code: ')+errorCode,});return;}
this.printer=deviceObj;this.printer.onreceive=function(response){if(!response.success){Gui.showPopup('ErrorPopup',{'title':_t('Epson ePOS Error'),'body':_t('An error happened while sending data to the printer. Error code: ')+response.code,});}};},process_canvas:function(canvas){if(this.printer){this.printer.addTextAlign(this.printer.ALIGN_CENTER);this.printer.addImage(canvas.getContext('2d'),0,0,canvas.width,canvas.height);this.printer.addCut();}},open_cashbox:function(){if(this.printer){this.printer.addPulse();this.printer.send();}},send_printing_job:function(){if(this.printer){this.printer.send();return{result:true};}},_onIoTActionFail:function(){},_onIoTActionResult:function(){},});return EpsonPrinter;});;

/* /pos_epson_printer/static/lib/epos-2.12.0.js defined in bundle 'point_of_sale.assets' */
(function(window,undefined){function callbackInfo(){this.callbackInfoList=new Object()}callbackInfo.prototype={addCallback:function(callback,sq){this.callbackInfoList[sq]=callback},removeCallback:function(sq){for(var i in this.callbackInfoList){if(i==sq){delete this.callbackInfoList[i];return}}},getCallback:function(sq){if(this.callbackInfoList[sq]!=null){return this.callbackInfoList[sq]}return null}};function CommBox(boxID,commBoxManager,callbackInfo){this.ERROR_OK="OK";this.ERROR_NOT_OPENED="NOT_OPENED";this.ERROR_MEMBER_NOT_FOUND="MEMBER_NOT_FOUND";this.ERROR_SYSTEM_ERROR="SYSTEM_ERROR";this.boxID=boxID;this.commBoxManager=commBoxManager;this.callbackInfo=callbackInfo;this.onreceive=null;this.connectionObj=this.commBoxManager.connectionObj}CommBox.prototype={getCommHistory:function(option,callback){var _option=(typeof(option)=="function")?null:option;var _callback=(typeof(option)=="function")?option:callback;var allHistory=((_option==null)||(_option.allHistory==null))?false:option.allHistory;var data={type:"getcommhistory",box_id:this.boxID,all_history:allHistory};var eposmsg=MessageFactory.getCommBoxDataMessage(data);if(!this.commBoxManager.isOpened(this.getBoxId())){if(_callback!=null){_callback(this.ERROR_NOT_OPENED,null,eposmsg.sequence)}return eposmsg.sequence}this.callbackInfo.addCallback(_callback,eposmsg.sequence);this.connectionObj.emit(eposmsg);return eposmsg.sequence},send:function(message,memberID,callback){var data={type:"send",box_id:this.boxID,message:message,member_id:memberID};var eposmsg=MessageFactory.getCommBoxDataMessage(data);if(!this.commBoxManager.isOpened(this.getBoxId())){if(callback!=null){callback(this.ERROR_NOT_OPENED,0,eposmsg.sequence)}return eposmsg.sequence}this.callbackInfo.addCallback(callback,eposmsg.sequence);this.connectionObj.emit(eposmsg);return eposmsg.sequence},client_getcommhistory:function(data,sq){var code=data.code;var historyList=data.history_list;var getCommHistoryCB=this.callbackInfo.getCallback(sq);this.callbackInfo.removeCallback(sq);if(getCommHistoryCB!=null){getCommHistoryCB(code,historyList,sq)}return},client_send:function(data,sq){var code=data.code;var count=data.count;var sendCB=this.callbackInfo.getCallback(sq);this.callbackInfo.removeCallback(sq);if(sendCB!=null){sendCB(code,count,sq)}return},client_onreceive:function(data,sq){var rcvData=new Object();rcvData.senderId=data.sender_id;rcvData.receiverId=data.receiver_id;rcvData.message=data.message;if(this.onreceive!=null){this.onreceive(rcvData)}return},getBoxId:function(){return this.boxID}};function CommBoxManager(){this.ERROR_OK="OK";this.ERROR_BOX_COUNT_OVER="BOX_COUNT_OVER";this.ERROR_BOX_CLIENT_OVER="BOX_CLIENT_OVER";this.ERROR_MEMBERID_ALREADY_USED="MEMBERID_ALREADY_USED";this.ERROR_ALREADY_OPENED="ALREADY_OPENED";this.ERROR_NOT_OPENED="NOT_OPENED";this.ERROR_PARAMETER_ERROR="PARAMETER_ERROR";this.ERROR_SYSTEM_ERROR="SYSTEM_ERROR";this.callbackInfo=new callbackInfo();this.commBoxList=new Array();this.connectionObj=null}CommBoxManager.prototype={setConnectionObject:function(connectionObj){this.connectionObj=connectionObj},openCommBox:function(boxID,option,callback){var memberID="";if(option!=null&&option.memberID!=null){memberID=option.memberID}var data={box_id:boxID,member_id:memberID};var eposmsg=MessageFactory.getOpenCommBoxMessage(data);if(!this.connectionObj.isUsableDeviceIF()){callback(null,this.ERROR_SYSTEM_ERROR,eposmsg.sequence);return eposmsg.sequence}this.connectionObj.emit(eposmsg);this.callbackInfo.addCallback(callback,eposmsg.sequence);return eposmsg.sequence},closeCommBox:function(boxObj,callback){var data={box_id:boxID};var eposmsg=MessageFactory.getCloseCommBoxMessage(data);try{var boxID=boxObj.getBoxId();data.box_id=boxID;eposmsg=MessageFactory.getCloseCommBoxMessage(data);if(!this.isOpened(boxID)){if(callback!=null){callback(this.ERROR_NOT_OPENED,eposmsg.sequence)}return eposmsg.sequence}this.connectionObj.emit(eposmsg)}catch(e){if(callback!=null){callback(this.ERROR_PARAMETER_ERROR,eposmsg.sequence)}}this.callbackInfo.addCallback(callback,eposmsg.sequence);return eposmsg.sequence},client_opencommbox:function(data,sq){var boxID=data.box_id;var code=data.code;var commBoxObj=null;if(code==this.ERROR_OK&&this.getCommBox(boxID)==null){commBoxObj=new CommBox(boxID,this,this.callbackInfo)}if(commBoxObj!=null){this.commBoxList.push(commBoxObj)}var openCommBoxCB=this.callbackInfo.getCallback(sq);this.callbackInfo.removeCallback(sq);if(openCommBoxCB!=null){openCommBoxCB(commBoxObj,code,sq)}return},client_closecommbox:function(data,sq){var boxID=data.box_id;var code=data.code;this.removeCommBox(boxID);var closeCommBoxCB=this.callbackInfo.getCallback(sq);this.callbackInfo.removeCallback(sq);if(closeCommBoxCB!=null){closeCommBoxCB(code,sq)}return},executeCommDataCallback:function(data,sq){var boxID=data.box_id;var commBoxObj=this.getCommBox(boxID);var method="client_"+data.type;try{eval("commBoxObj."+method+"(data, sq)")}catch(e){throw new Error("")}return},getCommBox:function(boxID){var commBoxObj=null;for(var i=0;i<this.commBoxList.length;i++){if(this.commBoxList[i].getBoxId()==boxID){commBoxObj=this.commBoxList[i];break}}return commBoxObj},removeCommBox:function(boxID){var result=false;for(var i=0;i<this.commBoxList.length;i++){if(this.commBoxList[i].getBoxId()==boxID){this.commBoxList.splice(i,1);result=true;break}}return result},isOpened:function(boxID){var result=false;for(var i=0;i<this.commBoxList.length;i++){if(this.commBoxList[i].getBoxId()==boxID){result=true;break}}return result}};function DeviceObjectSelector(){this.type2objectMap={type_scanner:"Scanner",type_keyboard:"Keyboard",type_poskeyboard:"POSKeyboard",type_msr:"MSR",type_cat:"CAT",type_cash_changer:"CashChanger",type_printer:"Printer",type_display:"Display",type_simple_serial:"SimpleSerial",type_hybrid_printer:"HybridPrinter",type_hybrid_printer2:"HybridPrinter2",type_dt:"DeviceTerminal",type_other_peripheral:"OtherPeripheral"};this.connectionObj=null}DeviceObjectSelector.prototype={setConnectionObject:function(connectionObj){this.connectionObj=connectionObj},isSelectable:function(deviceType){if(this.connectionObj.isUsableDeviceIF()){return true}else{if(deviceType=="type_printer"&&this.connectionObj.isUsablePrintIF()){return true}else{if(deviceType=="type_display"&&this.connectionObj.isUsableDisplayIF()){return true}}}return false},select:function(deviceId,deviceType,specificDevice,isCrypto,ePOSDeviceContext){var deviceObjectName="";if(typeof(specificDevice)=="string"){deviceObjectName=specificDevice}else{deviceObjectName=this.type2objectMap[deviceType]}var templateObject=null;try{templateObject=eval(deviceObjectName)}catch(e){throw new Error("ERROR_PARAMETER")}if(typeof(templateObject)!="function"){throw new Error("ERROR_PARAMETER")}if((deviceObjectName=="Printer")||(deviceObjectName=="Display")||(deviceObjectName=="HybridPrinter")||(deviceObjectName=="HybridPrinter2")){return new templateObject(deviceId,isCrypto,ePOSDeviceContext)}else{return new templateObject(deviceId,isCrypto)}}};function CashChanger(deviceID,isCrypto){this.CONFIG_LEFT_CASH="CONFIG_LEFT_CASH";this.CONFIG_COUNT_MODE="CONFIG_COUNT_MODE";this.MODE_MANUAL_INPUT="MODE_MANUAL_INPUT";this.MODE_AUTOCOUNT="MODE_AUTO_COUNT";this.DEPOSIT_CHANGE="DEPOSIT_CHANGE";this.DEPOSIT_NOCHANGE="DEPOSIT_NOCHANGE";this.DEPOSIT_REPAY="DEPOSIT_REPAY";this.COLLECT_ALL_CASH="ALL_CASH";this.COLLECT_PART_OF_CASH="PART_OF_CASH";this.SUE_POWER_ONLINE=2001;this.SUE_POWER_OFF=2002;this.SUE_POWER_OFFLINE=2003;this.SUE_POWER_OFF_OFFLINE=2004;this.SUE_STATUS_EMPTY=11;this.SUE_STATUS_NEAREMPTY=12;this.SUE_STATUS_EMPTYOK=13;this.SUE_STATUS_FULL=21;this.SUE_STATUS_NEARFULL=22;this.SUE_STATUS_FULLOK=23;this.SUE_STATUS_JAM=31;this.SUE_STATUS_JAMOK=32;this.deviceID=deviceID;this.isCrypto=isCrypto;this.connectionObj=null}CashChanger.prototype={setConnectionObject:function(connectionObj){this.connectionObj=connectionObj},client_oncashcounts:function(data){try{if(this.oncashcounts==null){return}this.oncashcounts(data)}catch(e){}return},client_onstatuschange:function(data){try{if(this.onstatuschange==null){return}this.onstatuschange(data)}catch(e){}return},client_ondeposit:function(data){try{if(this.ondeposit==null){return}this.ondeposit(data)}catch(e){}return},client_ondispense:function(data){try{if(this.ondispense==null){return}this.ondispense(data)}catch(e){}return},client_oncollect:function(data){try{if(this.oncollect==null){return}this.oncollect(data)}catch(e){}return},client_onconfigchange:function(data){try{if(this.onconfigchange==null){return}this.onconfigchange(data)}catch(e){}return},client_oncommandreply:function(data){try{if(this.oncommandreply==null){return}if(typeof data.command!=""){}else{var hexData=data.data;hexData=hexData.replace(/[0-9a-fA-F]{2}/g,function(c){var hexNum=parseInt(c,16);return String.fromCharCode(hexNum)});data.data=hexData}this.oncommandreply(data)}catch(e){}return},client_ondirectio:function(data){try{if(this.ondirectio==null){return}this.ondirectio(data)}catch(e){}return},client_onstatusupdate:function(data){try{if(this.onstatusupdate==null){return}this.onstatusupdate(data)}catch(e){}return},readCashCounts:function(){var data={type:"readcashcounts"};return this.send(data)},beginDeposit:function(){var data={type:"begindeposit"};return this.send(data)},pauseDeposit:function(){var data={type:"pausedeposit"};return this.send(data)},restartDeposit:function(){var data={type:"restartdeposit"};return this.send(data)},endDeposit:function(cmd){var data={type:"enddeposit",cmd:cmd};return this.send(data)},dispenseCash:function(data){var data_;if(typeof data=="object"){data_=data;data_.type="dispensecash"}else{data_={type:"dispensecash",cash:data}}return this.send(data_)},dispenseChange:function(cash){var data_;if(typeof cash=="object"){data_=cash;data_.type="dispensechange"}else{data_={type:"dispensechange",cash:cash}}return this.send(data_)},openDrawer:function(){var data={type:"opendrawer"};return this.send(data)},collectCash:function(collectMode){var data={type:"collectcash",collectmode:collectMode};return this.send(data)},setConfig:function(config,value){var data=null;switch(config){case this.CONFIG_COUNT_MODE:data={type:"setconfig",config:config,mode:value.mode};break;case this.CONFIG_LEFT_CASH:if((value.bills==null)||(value.bills=="")){value.bills="0"}if((value.coins==null)||(value.coins=="")){value.coins="0"}data={type:"setconfig",config:config,bills:value.bills,coins:value.coins};break;default:break}var sq=-1;if(data!=null){sq=this.send(data)}return sq},sendCommand:function(command){var data;if(typeof command=="object"){data=command;data.type="sendcommand"}else{data={type:"sendcommand",command:toHexBinary(command)}}return this.send(data)},callEvent:function(eventName,data){var eventReq=data;eventReq.type=eventName;return this.send(eventReq)},send:function(data){var eposmsg=MessageFactory.getDeviceDataMessage(this.deviceID,data,this.isCrypto);var sequence=-1;try{this.connectionObj.emit(eposmsg);sequence=eposmsg.sequence}catch(e){}return sequence}};function CAT(deviceID,isCrypto){this.SUE_LOGSTATUS_OK=0;this.SUE_LOGSTATUS_NEARFULL=1;this.SUE_LOGSTATUS_FULL=2;this.SUE_POWER_ONLINE=2001;this.SUE_POWER_OFF_OFFLINE=2004;this.deviceID=deviceID;this.isCrypto=isCrypto;this.timeout=0;this.trainingMode=false;this.connectionObj=null}CAT.prototype={setConnectionObject:function(connectionObj){this.connectionObj=connectionObj},authorizeSales:function(data){var _data={service:data.service,total_amount:data.totalAmount,sequence:data.sequence};_data.type="authorizesales";_data.training=this.trainingMode;_data.timeout=this.timeout;return this.send(_data)},authorizeVoid:function(data){var _data={service:data.service,total_amount:data.totalAmount,sequence:data.sequence};_data.type="authorizevoid";_data.training=this.trainingMode;_data.timeout=this.timeout;return this.send(_data)},authorizeRefund:function(data){var _data={service:data.service,total_amount:data.totalAmount,sequence:data.sequence};_data.type="authorizerefund";_data.training=this.trainingMode;_data.timeout=this.timeout;return this.send(_data)},authorizeCompletion:function(data){var _data={service:data.service,total_amount:data.totalAmount,sequence:data.sequence};_data.type="authorizecompletion";_data.training=this.trainingMode;_data.timeout=this.timeout;return this.send(_data)},accessDailyLog:function(data){var _data={service:data.service,total_amount:data.totalAmount,sequence:data.sequence};_data.type="accessdailylog";_data.training=this.trainingMode;_data.timeout=this.timeout;return this.send(_data)},sendCommand:function(data){var _data={service:data.service,command:data.command,data:data.data,string:data.string};_data.type="sendcommand";_data.training=this.trainingMode;return this.send(_data)},send:function(data){var tmp=this.deviceID;var eposmsg=MessageFactory.getDeviceDataMessage(this.deviceID,data,this.isCrypto);var sequence=-1;try{this.connectionObj.emit(eposmsg);sequence=eposmsg.sequence}catch(e){}return sequence},client_onauthorizesales:function(data){try{if(this.onauthorizesales==null){return}this.onauthorizesales(this.getResultObject(data))}catch(e){}return},client_onauthorizevoid:function(data){try{if(this.onauthorizevoid==null){return}this.onauthorizevoid(this.getResultObject(data))}catch(e){}return},client_onauthorizerefund:function(data){try{if(this.onauthorizerefund==null){return}this.onauthorizerefund(this.getResultObject(data))}catch(e){}return},client_onauthorizecompletion:function(data){try{if(this.onauthorizecompletion==null){return}this.onauthorizecompletion(this.getResultObject(data))}catch(e){}return},client_onaccessdailylog:function(data){try{if(this.onaccessdailylog==null){return}this.onaccessdailylog(this.getDailyLogObject(data))}catch(e){}return},client_oncommandreply:function(data){try{if(this.oncommandreply==null){return}this.oncommandreply(this.getCommandReplyObject(data))}catch(e){}return},client_onstatusupdate:function(data){try{if(this.onstatusupdate==null){return}this.onstatusupdate(data)}catch(e){}return},getResultObject:function(data){return({status:data.status,sequence:data.sequence,service:data.service,accountNumber:data.account_number,settledAmount:data.settled_amount,slipNumber:data.slip_number,kid:data.kid,approvalCode:data.approval_code,transactionNumber:data.transaction_number,paymentCondition:data.payment_condition,voidSlipNumber:data.void_slip_number,balance:data.balance})},getDailyLogObject:function(data){var dailylogData={};dailylogData.status=data.status;dailylogData.service=data.service;dailylogData.sequence=data.sequence;var logList=[];try{data.daily_log.forEach(function(log){var logData={};if(log===0){throw logList}logData.kid=log.kid;logData.salesCount=log.sales_count;logData.salesAmount=log.sales_amount;logData.voidCount=log.void_count;logData.voidAmount=log.void_amount;logList.push(logData)})}catch(e){}dailylogData.dailyLog=logList;return dailylogData},getCommandReplyObject:function(data){return({status:data.status,command:data.command,data:data.data,string:data.string,service:data.service,sequence:data.sequence,accountNumber:data.account_number,settledAmount:data.settled_amount,slipNumber:data.slip_number,transactionNumber:data.transaction_number,paymentCondition:data.payment_condition,balance:data.balance,additionalSecurityInformation:data.additional_security_information,})},callEvent:function(eventName,data){var eventReq=data;eventReq.type=eventName;return this.send(eventReq)}};function DeviceTerminal(deviceID,isCrypto){this.deviceID=deviceID;this.isCrypto=isCrypto;this.onshutdown=null;this.onrestart=null;this.connectionObj=null}DeviceTerminal.prototype={setConnectionObject:function(connectionObj){this.connectionObj=connectionObj},shutdown:function(password,callback){this.onshutdown=callback;var data={type:"shutdown",password:password};return this.send(data)},client_onshutdown:function(data){try{if(typeof(this.onshutdown)!="function"){return}this.onshutdown(data)}catch(e){}return},restart:function(password,callback){this.onrestart=callback;var data={type:"restart",password:password};return this.send(data)},client_onrestart:function(data){try{if(typeof(this.onrestart)!="function"){return}this.onrestart(data)}catch(e){}return},send:function(data){var eposmsg=MessageFactory.getDeviceDataMessage(this.deviceID,data,this.isCrypto);var sequence=-1;try{this.connectionObj.emit(eposmsg);sequence=eposmsg.sequence}catch(e){}return sequence}};function Display(deviceID,isCrypto,ePOSDeviceContext){this.message="";this.deviceID=deviceID;this.isCrypto=isCrypto;this.ePosDev=ePOSDeviceContext;this.timeout=10000;this.onreceive=null;this.onerror=null;this.ASB_NO_RESPONSE=1;this.ASB_DISPLAY_SUCCESS=2;this.SCROLL_OVERWRITE="overwrite";this.SCROLL_VERTICAL="v_scroll";this.SCROLL_HORIZONTAL="h_scroll";this.MOVE_TOP_LEFT="top_left";this.MOVE_TOP_RIGHT="top_right";this.MOVE_BOTTOM_LEFT="bottom_left";this.MOVE_BOTTOM_RIGHT="bottom_right";this.CURSOR_NONE="none";this.CURSOR_UNDERLINE="underline";this.BRIGHTNESS_20=20;this.BRIGHTNESS_40=40;this.BRIGHTNESS_60=60;this.BRIGHTNESS_100=100;this.MARQUEE_WALK="walk";this.MARQUEE_PLACE="place";this.connectionObj=null}Display.prototype.setConnectionObject=function(connectionObj){this.connectionObj=connectionObj};Display.prototype.reset=function(){try{this.message+="<reset />"}catch(e){throw e}return this};Display.prototype.createWindow=function(number,x,y,width,hight,scrollMode){try{var s="";s+=getIntAttr("number",number,1,4);s+=getIntAttr("x",x,1,20);s+=getIntAttr("y",y,1,2);s+=getIntAttr("width",width,1,(21-x));s+=getIntAttr("height",hight,1,(3-y));s+=getEnumAttr("scrollmode",scrollMode,regexScrollMode);this.message+="<window"+s+"/>"}catch(e){throw e}return this};Display.prototype.destroyWindow=function(number){try{var s="";s+=getIntAttr("number",number,1,4);this.message+="<window"+s+' destroy="true"/>'}catch(e){throw e}return this};Display.prototype.setCurrentWindow=function(number){try{var s="";s+=getIntAttr("number",number,1,4);this.message+="<window"+s+"/>"}catch(e){throw e}return this};Display.prototype.setCursorPosition=function(){try{var s="";s+=getIntAttr("x",arguments[0],1,20);s+=getIntAttr("y",arguments[1],1,2);this.message+="<cursor"+s+"/>"}catch(e){throw e}return this};Display.prototype.moveCursorPosition=function(){try{var s="";s+=getEnumAttr("moveto",arguments[0],regexMoveto);this.message+="<cursor"+s+"/>"}catch(e){throw e}return this};Display.prototype.setCursorType=function(underline){try{var s="";s+=getEnumAttr("type",underline,regexUnderline);this.message+="<cursor"+s+"/>"}catch(e){throw e}return this};Display.prototype.addText=function(){try{var s="";switch(arguments.length){case 1:break;case 2:s+=' lang="'+arguments[1]+'"';break;case 3:s+=getIntAttr("x",arguments[1],1,20);s+=getIntAttr("y",arguments[2],1,2);break;case 4:s+=getIntAttr("x",arguments[1],1,20);s+=getIntAttr("y",arguments[2],1,2);s+=' lang="'+arguments[3]+'"';break;default:throw new Error("Parameters are invalid");break}this.message+="<text"+s+">"+escapeMarkup(arguments[0])+"</text>"}catch(e){throw e}return this};Display.prototype.addReverseText=function(){try{var s="";switch(arguments.length){case 1:s+=getBoolAttr("reverse",true);break;case 2:s+=' lang="'+arguments[1]+'"';s+=getBoolAttr("reverse",true);break;case 3:s+=getIntAttr("x",arguments[1],1,20);s+=getIntAttr("y",arguments[2],1,2);s+=getBoolAttr("reverse",true);break;case 4:s+=getIntAttr("x",arguments[1],1,20);s+=getIntAttr("y",arguments[2],1,2);s+=' lang="'+arguments[3]+'"';s+=getBoolAttr("reverse",true);break;default:throw new Error("Parameters are invalid");break}this.message+="<text"+s+">"+escapeMarkup(arguments[0])+"</text>"}catch(e){throw e}return this};Display.prototype.clearWindow=function(){try{this.message+="<clear/>"}catch(e){throw e}return this};Display.prototype.setBlink=function(interval){try{var s="";s+=getUShortAttr("interval",interval);this.message+="<blink"+s+"/>"}catch(e){throw e}return this};Display.prototype.setBrightness=function(value){try{var s="";s+=getEnumAttr("value",value,regexBrightness);this.message+="<brightness"+s+"/>"}catch(e){throw e}return this};Display.prototype.addMarquee=function(text,format,uwait,rwait,repeat,lang){try{var s="";s+=getEnumAttr("format",format,regexMarquee);s+=getIntAttr("uwait",uwait,0,2000);s+=getIntAttr("rwait",rwait,100,2000);s+=getIntAttr("repeat",repeat,0,127);if((typeof lang)!=="undefined"){s+=' lang="'+lang+'"'}this.message+="<marquee"+s+">"+escapeMarkup(text)+"</marquee>"}catch(e){throw e}return this};Display.prototype.showClock=function(){try{this.message+="<clock/>"}catch(e){throw e}return this};Display.prototype.addCommand=function(text){try{this.message+="<command>"+toHexBinary(text)+"</command>"}catch(e){throw e}return this};Display.prototype.send=function(){var sq=-1;if((!this.ePosDev.eposprint)&&(this.connectionObj.isUsableDeviceIF())){try{var xml=this.toString();var data={type:"display",timeout:this.timeout,displaydata:xml};var eposmsg=MessageFactory.getDeviceDataMessage(this.deviceID,data,this.isCrypto);this.connectionObj.emit(eposmsg);sq=eposmsg.sequence;this.message=""}catch(e){sq=-1}}else{var self=this,address=this.connectionObj.getAddressWithProtocol()+"/cgi-bin/eposDisp/service.cgi?devid="+this.deviceID+"&timeout="+this.timeout,soap,xhr,tid,res,success,code,status;res={};soap='<?xml version="1.0" encoding="utf-8"?><s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">';soap+="<s:Body>"+this.toString()+"</s:Body></s:Envelope>";if(window.XMLHttpRequest){xhr=new XMLHttpRequest();if(!("withCredentials"in xhr)&&window.XDomainRequest){xhr=new XDomainRequest();xhr.open("POST",address,true);xhr.onload=function(){res=xhr.responseText;if(/response/.test(res)){success=/success\s*=\s*"\s*(1|true)\s*"/.test(res);code=res.match(/code\s*=\s*"\s*(\S*)\s*"/)?RegExp.$1:"";status=res.match(/status\s*=\s*"\s*(\d+)\s*"/)?parseInt(RegExp.$1):0;self.fireReceiveEvent(success,code,status,0)}else{self.fireErrorEvent(0,xhr.responseText,0)}};xhr.onerror=function(){self.fireErrorEvent(0,xhr.responseText,0)};xhr.onprogress=function(){};xhr.ontimeout=xhr.onerror;xhr.timeout=self.timeout;xhr.send(soap)}else{xhr.open("POST",address,true);xhr.setRequestHeader("Content-Type","text/xml; charset=utf-8");xhr.setRequestHeader("If-Modified-Since","Thu, 01 Jan 1970 00:00:00 GMT");xhr.setRequestHeader("SOAPAction",'""');xhr.onreadystatechange=function(){if(xhr.readyState==4){clearTimeout(tid);if(xhr.status==200&&xhr.responseXML){res=xhr.responseXML.getElementsByTagName("response");if(res.length>0){success=/^(1|true)$/.test(res[0].getAttribute("success"));code=res[0].hasAttribute("code")?res[0].getAttribute("code"):"";status=res[0].hasAttribute("status")?parseInt(res[0].getAttribute("status")):0;self.fireReceiveEvent(success,code,status,0)}else{self.fireErrorEvent(xhr.status,xhr.responseText,0)}}else{self.fireErrorEvent(xhr.status,xhr.responseText,0)}}};tid=setTimeout(function(){xhr.abort()},this.timeout);xhr.send(soap)}this.message=""}else{throw new Error("XMLHttpRequest is not supported")}sq=0}return sq};Display.prototype.fireReceiveEvent=function(success,code,status,sq){if(code=="EX_ENPC_TIMEOUT"){code="ERROR_DEVICE_BUSY"}if(this.onreceive){this.onreceive({success:success,code:code,status:status},sq)}};Display.prototype.fireErrorEvent=function(status,responseText,sq){if(this.onerror){this.onerror({status:0,responseText:this.ASB_NO_RESPONSE},sq)}this.ePosDev.cleanup()};Display.prototype.client_onxmlresult=function(res,sq){if(res){var xml=res.resultdata;var success=/success\s*=\s*"\s*(1|true)\s*"/.test(xml);xml.match(/code\s*=\s*"\s*(\S*)\s*"/);var code=RegExp.$1;xml.match(/status\s*=\s*"\s*(\d+)\s*"/);var status=parseInt(RegExp.$1);if(this.onreceive){this.onreceive({success:success,code:code,status:status},sq)}}else{if(this.onerror){this.onerror({status:0,responseText:this.ASB_NO_RESPONSE},sq)}this.ePosDev.cleanup()}};Display.prototype.toString=function(){var epos='<epos-display xmlns="http://www.epson-pos.com/schemas/2012/09/epos-display">'+this.message+"</epos-display>";return epos};Display.prototype.setXmlString=function(xml){this.message=xml};Display.prototype.getXmlString=function(){return this.message};Display.prototype.callEvent=function(eventName,data){var eventReq={type:eventName,data:data};var eposmsg=MessageFactory.getDeviceDataMessage(this.deviceID,data,this.isCrypto);var sequence=-1;try{this.connectionObj.emit(eposmsg);sequence=eposmsg.sequence}catch(e){}return sequence};var regexBrightness=/^(20|40|60|100)$/;var regexScrollMode=/^(overwrite|v_scroll|h_scroll)$/;var regexMoveto=/^(top_left|top_right|bottom_left|bottom_right)$/;var regexUnderline=/^(none|underline)$/;var regexMarquee=/^(walk|place)$/;function OtherPeripheral(deviceID,isCrypto){this.deviceID=deviceID;this.isCrypto=isCrypto;this.connectionObj=null}OtherPeripheral.prototype={setConnectionObject:function(connectionObj){this.connectionObj=connectionObj},send:function(methodName,data){var _data={};for(var key in data){_data[key]=data[key]}_data.type=methodName;var eposmsg=MessageFactory.getDeviceDataMessage(this.deviceID,_data,this.isCrypto);var sequence=-1;try{this.connectionObj.emit(eposmsg);sequence=eposmsg.sequence}catch(e){}return sequence},client_onreceive:function(data){try{var eventData=data;delete eventData.type;this.onreceive(data.type,eventData)}catch(e){}return},callEvent:function(eventName,data){var eventReq={type:eventName,data:data};var eposmsg=MessageFactory.getDeviceDataMessage(this.deviceID,data,this.isCrypto);var sequence=-1;try{this.connectionObj.emit(eposmsg);sequence=eposmsg.sequence}catch(e){}return sequence}};function Keyboard(deviceID,isCrypto){this.VK_CANCEL=3;this.VK_BACK=8;this.VK_TAB=9;this.VK_RETURN=13;this.VK_SHIFT=16;this.VK_CONTROL=17;this.VK_MENU=18;this.VK_PAUSE=19;this.VK_CAPITAL=20;this.VK_KANA=21;this.VK_ESCAPE=27;this.VK_CONVERT=28;this.VK_NONCONVERT=29;this.VK_SPACE=32;this.VK_PRIOR=33;this.VK_NEXT=34;this.VK_END=35;this.VK_HOME=36;this.VK_LEFT=37;this.VK_UP=38;this.VK_RIGHT=39;this.VK_DOWN=40;this.VK_INSERT=45;this.VK_DELETE=46;this.VK_0=48;this.VK_1=49;this.VK_2=50;this.VK_3=51;this.VK_4=52;this.VK_5=53;this.VK_6=54;this.VK_7=55;this.VK_8=56;this.VK_9=57;this.VK_A=65;this.VK_B=66;this.VK_C=67;this.VK_D=68;this.VK_E=69;this.VK_F=70;this.VK_G=71;this.VK_H=72;this.VK_I=73;this.VK_J=74;this.VK_K=75;this.VK_L=76;this.VK_M=77;this.VK_N=78;this.VK_O=79;this.VK_P=80;this.VK_Q=81;this.VK_R=82;this.VK_S=83;this.VK_T=84;this.VK_U=85;this.VK_V=86;this.VK_W=87;this.VK_X=88;this.VK_Y=89;this.VK_Z=90;this.VK_LWIN=91;this.VK_RWIN=92;this.VK_APPS=93;this.VK_NUMPAD0=96;this.VK_NUMPAD1=97;this.VK_NUMPAD2=98;this.VK_NUMPAD3=99;this.VK_NUMPAD4=100;this.VK_NUMPAD5=101;this.VK_NUMPAD6=102;this.VK_NUMPAD7=103;this.VK_NUMPAD8=104;this.VK_NUMPAD9=105;this.VK_MULTIPLY=106;this.VK_ADD=107;this.VK_SEPARATOR=108;this.VK_SUBTRACT=109;this.VK_DECIMAL=110;this.VK_DIVIDE=111;this.VK_F1=112;this.VK_F2=113;this.VK_F3=114;this.VK_F4=115;this.VK_F5=116;this.VK_F6=117;this.VK_F7=118;this.VK_F8=119;this.VK_F9=120;this.VK_F10=121;this.VK_F11=122;this.VK_F12=123;this.VK_NUMLOCK=144;this.VK_SCROLL=145;this.VK_LSHIFT=160;this.VK_RSHIFT=161;this.VK_LCONTROL=162;this.VK_RCONTROL=163;this.VK_LMENU=164;this.VK_RMENU=165;this.VK_OEM_1=186;this.VK_OEM_PLUS=187;this.VK_OEM_COMMA=188;this.VK_OEM_MINUS=189;this.VK_OEM_PERIOD=190;this.VK_OEM_2=191;this.VK_OEM_3=192;this.VK_OEM_4=219;this.VK_OEM_5=220;this.VK_OEM_6=221;this.VK_OEM_7=222;this.VK_OEM_102=226;this.VK_OEM_ATTN=240;this.deviceID=deviceID;this.isCrypto=isCrypto;this.connectionObj=null}Keyboard.prototype={setConnectionObject:function(connectionObj){this.connectionObj=connectionObj},client_onkeypress:function(data){try{if(this.onkeypress==null){return}this.onkeypress(data)}catch(e){}return},client_onstring:function(data){try{if(this.onstring==null){return}this.onstring(data)}catch(e){}return},setPrefix:function(keycodes){var data={type:"setprefix"};if(typeof keycodes=="object"){if((keycodes.length==0)){return-1}data.keycodes=keycodes}else{if((keycodes==null)||(keycodes=="")){return-1}data.keycodes=[keycodes]}var eposmsg=MessageFactory.getDeviceDataMessage(this.deviceID,data,this.isCrypto);var sequence=-1;try{this.connectionObj.emit(eposmsg);sequence=eposmsg.sequence}catch(e){}return sequence},callEvent:function(eventName,data){var eventReq=data;eventReq.type=eventName;var eposmsg=MessageFactory.getDeviceDataMessage(this.deviceID,eventReq,this.isCrypto);var sequence=-1;try{this.connectionObj.emit(eposmsg);sequence=eposmsg.sequence}catch(e){}return sequence}};function MSR(deviceID,isCrypto){this.deviceID=deviceID;this.isCrypto=isCrypto;this.connectionObj=null}MSR.prototype={setConnectionObject:function(connectionObj){this.connectionObj=connectionObj},client_ondata:function(data){try{if(this.ondata==null){return}this.ondata(data)}catch(e){}return},callEvent:function(eventName,data){var eventReq=data;eventReq.type=eventName;var eposmsg=MessageFactory.getDeviceDataMessage(this.deviceID,eventReq,this.isCrypto);var sequence=-1;try{this.connectionObj.emit(eposmsg);sequence=eposmsg.sequence}catch(e){}return sequence}};function ePOSBuilder(){this.message="";this.halftone=0;this.brightness=1;this.force=false;this.FONT_A="font_a";this.FONT_B="font_b";this.FONT_C="font_c";this.FONT_D="font_d";this.FONT_E="font_e";this.FONT_SPECIAL_A="special_a";this.FONT_SPECIAL_B="special_b";this.ALIGN_LEFT="left";this.ALIGN_CENTER="center";this.ALIGN_RIGHT="right";this.COLOR_NONE="none";this.COLOR_1="color_1";this.COLOR_2="color_2";this.COLOR_3="color_3";this.COLOR_4="color_4";this.FEED_PEELING="peeling";this.FEED_CUTTING="cutting";this.FEED_CURRENT_TOF="current_tof";this.FEED_NEXT_TOF="next_tof";this.MODE_MONO="mono";this.MODE_GRAY16="gray16";this.BARCODE_UPC_A="upc_a";this.BARCODE_UPC_E="upc_e";this.BARCODE_EAN13="ean13";this.BARCODE_JAN13="jan13";this.BARCODE_EAN8="ean8";this.BARCODE_JAN8="jan8";this.BARCODE_CODE39="code39";this.BARCODE_ITF="itf";this.BARCODE_CODABAR="codabar";this.BARCODE_CODE93="code93";this.BARCODE_CODE128="code128";this.BARCODE_GS1_128="gs1_128";this.BARCODE_GS1_DATABAR_OMNIDIRECTIONAL="gs1_databar_omnidirectional";this.BARCODE_GS1_DATABAR_TRUNCATED="gs1_databar_truncated";this.BARCODE_GS1_DATABAR_LIMITED="gs1_databar_limited";this.BARCODE_GS1_DATABAR_EXPANDED="gs1_databar_expanded";this.HRI_NONE="none";this.HRI_ABOVE="above";this.HRI_BELOW="below";this.HRI_BOTH="both";this.SYMBOL_PDF417_STANDARD="pdf417_standard";this.SYMBOL_PDF417_TRUNCATED="pdf417_truncated";this.SYMBOL_QRCODE_MODEL_1="qrcode_model_1";this.SYMBOL_QRCODE_MODEL_2="qrcode_model_2";this.SYMBOL_QRCODE_MICRO="qrcode_micro";this.SYMBOL_MAXICODE_MODE_2="maxicode_mode_2";this.SYMBOL_MAXICODE_MODE_3="maxicode_mode_3";this.SYMBOL_MAXICODE_MODE_4="maxicode_mode_4";this.SYMBOL_MAXICODE_MODE_5="maxicode_mode_5";this.SYMBOL_MAXICODE_MODE_6="maxicode_mode_6";this.SYMBOL_GS1_DATABAR_STACKED="gs1_databar_stacked";this.SYMBOL_GS1_DATABAR_STACKED_OMNIDIRECTIONAL="gs1_databar_stacked_omnidirectional";this.SYMBOL_GS1_DATABAR_EXPANDED_STACKED="gs1_databar_expanded_stacked";this.SYMBOL_AZTECCODE_FULLRANGE="azteccode_fullrange";this.SYMBOL_AZTECCODE_COMPACT="azteccode_compact";this.SYMBOL_DATAMATRIX_SQUARE="datamatrix_square";this.SYMBOL_DATAMATRIX_RECTANGLE_8="datamatrix_rectangle_8";this.SYMBOL_DATAMATRIX_RECTANGLE_12="datamatrix_rectangle_12";this.SYMBOL_DATAMATRIX_RECTANGLE_16="datamatrix_rectangle_16";this.LEVEL_0="level_0";this.LEVEL_1="level_1";this.LEVEL_2="level_2";this.LEVEL_3="level_3";this.LEVEL_4="level_4";this.LEVEL_5="level_5";this.LEVEL_6="level_6";this.LEVEL_7="level_7";this.LEVEL_8="level_8";this.LEVEL_L="level_l";this.LEVEL_M="level_m";this.LEVEL_Q="level_q";this.LEVEL_H="level_h";this.LEVEL_DEFAULT="default";this.LINE_THIN="thin";this.LINE_MEDIUM="medium";this.LINE_THICK="thick";this.LINE_THIN_DOUBLE="thin_double";this.LINE_MEDIUM_DOUBLE="medium_double";this.LINE_THICK_DOUBLE="thick_double";this.DIRECTION_LEFT_TO_RIGHT="left_to_right";this.DIRECTION_BOTTOM_TO_TOP="bottom_to_top";this.DIRECTION_RIGHT_TO_LEFT="right_to_left";this.DIRECTION_TOP_TO_BOTTOM="top_to_bottom";this.CUT_NO_FEED="no_feed";this.CUT_FEED="feed";this.CUT_RESERVE="reserve";this.DRAWER_1="drawer_1";this.DRAWER_2="drawer_2";this.PULSE_100="pulse_100";this.PULSE_200="pulse_200";this.PULSE_300="pulse_300";this.PULSE_400="pulse_400";this.PULSE_500="pulse_500";this.PATTERN_NONE="none";this.PATTERN_0="pattern_0";this.PATTERN_1="pattern_1";this.PATTERN_2="pattern_2";this.PATTERN_3="pattern_3";this.PATTERN_4="pattern_4";this.PATTERN_5="pattern_5";this.PATTERN_6="pattern_6";this.PATTERN_7="pattern_7";this.PATTERN_8="pattern_8";this.PATTERN_9="pattern_9";this.PATTERN_10="pattern_10";this.PATTERN_A="pattern_a";this.PATTERN_B="pattern_b";this.PATTERN_C="pattern_c";this.PATTERN_D="pattern_d";this.PATTERN_E="pattern_e";this.PATTERN_ERROR="error";this.PATTERN_PAPER_END="paper_end";this.LAYOUT_RECEIPT="receipt";this.LAYOUT_RECEIPT_BM="receipt_bm";this.LAYOUT_LABEL="label";this.LAYOUT_LABEL_BM="label_bm";this.HALFTONE_DITHER=0;this.HALFTONE_ERROR_DIFFUSION=1;this.HALFTONE_THRESHOLD=2}ePOSBuilder.prototype.addText=function(data){this.message+="<text>"+escapeMarkup(data)+"</text>";return this};ePOSBuilder.prototype.addTextLang=function(lang){this.message+='<text lang="'+lang+'"/>';return this};ePOSBuilder.prototype.addTextAlign=function(align){var s="";s+=getEnumAttr("align",align,regexAlign);this.message+="<text"+s+"/>";return this};ePOSBuilder.prototype.addTextRotate=function(rotate){var s="";s+=getBoolAttr("rotate",rotate);this.message+="<text"+s+"/>";return this};ePOSBuilder.prototype.addTextLineSpace=function(linespc){var s="";s+=getUByteAttr("linespc",linespc);this.message+="<text"+s+"/>";return this};ePOSBuilder.prototype.addTextFont=function(font){var s="";s+=getEnumAttr("font",font,regexFont);this.message+="<text"+s+"/>";return this};ePOSBuilder.prototype.addTextSmooth=function(smooth){var s="";s+=getBoolAttr("smooth",smooth);this.message+="<text"+s+"/>";return this};ePOSBuilder.prototype.addTextDouble=function(dw,dh){var s="";if(dw!==undefined){s+=getBoolAttr("dw",dw)}if(dh!==undefined){s+=getBoolAttr("dh",dh)}this.message+="<text"+s+"/>";return this};ePOSBuilder.prototype.addTextSize=function(width,height){var s="";if(width!==undefined){s+=getIntAttr("width",width,1,8)}if(height!==undefined){s+=getIntAttr("height",height,1,8)}this.message+="<text"+s+"/>";return this};ePOSBuilder.prototype.addTextStyle=function(reverse,ul,em,color){var s="";if(reverse!==undefined){s+=getBoolAttr("reverse",reverse)}if(ul!==undefined){s+=getBoolAttr("ul",ul)}if(em!==undefined){s+=getBoolAttr("em",em)}if(color!==undefined){s+=getEnumAttr("color",color,regexColor)}this.message+="<text"+s+"/>";return this};ePOSBuilder.prototype.addTextPosition=function(x){var s="";s+=getUShortAttr("x",x);this.message+="<text"+s+"/>";return this};ePOSBuilder.prototype.addTextVPosition=function(y){var s="";s+=getUShortAttr("y",y);this.message+="<text"+s+"/>";return this};ePOSBuilder.prototype.addFeedUnit=function(unit){var s="";s+=getUByteAttr("unit",unit);this.message+="<feed"+s+"/>";return this};ePOSBuilder.prototype.addFeedLine=function(line){var s="";s+=getUByteAttr("line",line);this.message+="<feed"+s+"/>";return this};ePOSBuilder.prototype.addFeed=function(){this.message+="<feed/>";return this};ePOSBuilder.prototype.addFeedPosition=function(pos){var s="";s+=getEnumAttr("pos",pos,regexFeed);this.message+="<feed"+s+"/>";return this};ePOSBuilder.prototype.addImage=function(context,x,y,width,height,color,mode){var s="",ht=this.halftone,br=this.brightness,imgdata,raster;getUShortAttr("x",x);getUShortAttr("y",y);s+=getUShortAttr("width",width);s+=getUShortAttr("height",height);if(color!==undefined){s+=getEnumAttr("color",color,regexColor)}if(mode!==undefined){s+=getEnumAttr("mode",mode,regexMode)}if(isNaN(ht)||ht<0||ht>2){throw new Error('Property "halftone" is invalid')}if(isNaN(br)||br<0.1||br>10){throw new Error('Property "brightness" is invalid')}imgdata=context.getImageData(x,y,width,height);raster=(mode==this.MODE_GRAY16)?toGrayImage(imgdata,br):toMonoImage(imgdata,ht,br);this.message+="<image"+s+">"+toBase64Binary(raster)+"</image>";return this};ePOSBuilder.prototype.addLogo=function(key1,key2){var s="";s+=getUByteAttr("key1",key1);s+=getUByteAttr("key2",key2);this.message+="<logo"+s+"/>";return this};ePOSBuilder.prototype.addBarcode=function(data,type,hri,font,width,height){var s="";s+=getEnumAttr("type",type,regexBarcode);if(hri!==undefined){s+=getEnumAttr("hri",hri,regexHri)}if(font!==undefined){s+=getEnumAttr("font",font,regexFont)}if(width!==undefined){s+=getUByteAttr("width",width)}if(height!==undefined){s+=getUByteAttr("height",height)}this.message+="<barcode"+s+">"+escapeControl(escapeMarkup(data))+"</barcode>";return this};ePOSBuilder.prototype.addSymbol=function(data,type,level,width,height,size){var s="";s+=getEnumAttr("type",type,regexSymbol);if(level!==undefined){s+=getEnumIntAttr("level",level,regexLevel,0,255)}if(width!==undefined){s+=getUByteAttr("width",width)}if(height!==undefined){s+=getUByteAttr("height",height)}if(size!==undefined){s+=getUShortAttr("size",size)}this.message+="<symbol"+s+">"+escapeControl(escapeMarkup(data))+"</symbol>";return this};ePOSBuilder.prototype.addHLine=function(x1,x2,style){var s="";s+=getUShortAttr("x1",x1);s+=getUShortAttr("x2",x2);if(style!==undefined){s+=getEnumAttr("style",style,regexLine)}this.message+="<hline"+s+"/>";return this};ePOSBuilder.prototype.addVLineBegin=function(x,style){var s="";s+=getUShortAttr("x",x);if(style!==undefined){s+=getEnumAttr("style",style,regexLine)}this.message+="<vline-begin"+s+"/>";return this};ePOSBuilder.prototype.addVLineEnd=function(x,style){var s="";s+=getUShortAttr("x",x);if(style!==undefined){s+=getEnumAttr("style",style,regexLine)}this.message+="<vline-end"+s+"/>";return this};ePOSBuilder.prototype.addPageBegin=function(){this.message+="<page>";return this};ePOSBuilder.prototype.addPageEnd=function(){this.message+="</page>";return this};ePOSBuilder.prototype.addPageArea=function(x,y,width,height){var s="";s+=getUShortAttr("x",x);s+=getUShortAttr("y",y);s+=getUShortAttr("width",width);s+=getUShortAttr("height",height);this.message+="<area"+s+"/>";return this};ePOSBuilder.prototype.addPageDirection=function(dir){var s="";s+=getEnumAttr("dir",dir,regexDirection);this.message+="<direction"+s+"/>";return this};ePOSBuilder.prototype.addPagePosition=function(x,y){var s="";s+=getUShortAttr("x",x);s+=getUShortAttr("y",y);this.message+="<position"+s+"/>";return this};ePOSBuilder.prototype.addPageLine=function(x1,y1,x2,y2,style){var s="";s+=getUShortAttr("x1",x1);s+=getUShortAttr("y1",y1);s+=getUShortAttr("x2",x2);s+=getUShortAttr("y2",y2);if(style!==undefined){s+=getEnumAttr("style",style,regexLine)}this.message+="<line"+s+"/>";return this};ePOSBuilder.prototype.addPageRectangle=function(x1,y1,x2,y2,style){var s="";s+=getUShortAttr("x1",x1);s+=getUShortAttr("y1",y1);s+=getUShortAttr("x2",x2);s+=getUShortAttr("y2",y2);if(style!==undefined){s+=getEnumAttr("style",style,regexLine)}this.message+="<rectangle"+s+"/>";return this};ePOSBuilder.prototype.addCut=function(type){var s="";if(type!==undefined){s+=getEnumAttr("type",type,regexCut)}this.message+="<cut"+s+"/>";return this};ePOSBuilder.prototype.addPulse=function(drawer,time){var s="";if(drawer!==undefined){s+=getEnumAttr("drawer",drawer,regexDrawer)}if(time!==undefined){s+=getEnumAttr("time",time,regexPulse)}this.message+="<pulse"+s+"/>";return this};ePOSBuilder.prototype.addSound=function(pattern,repeat,cycle){var s="";if(pattern!==undefined){s+=getEnumAttr("pattern",pattern,regexPattern)}if(repeat!==undefined){s+=getUByteAttr("repeat",repeat)}if(cycle!==undefined){s+=getUShortAttr("cycle",cycle)}this.message+="<sound"+s+"/>";return this};ePOSBuilder.prototype.addLayout=function(type,width,height,margin_top,margin_bottom,offset_cut,offset_label){var s="";s+=getEnumAttr("type",type,regexLayout);if(width!==undefined){s+=getUShortAttr("width",width)}if(height!==undefined){s+=getUShortAttr("height",height)}if(margin_top!==undefined){s+=getShortAttr("margin-top",margin_top)}if(margin_bottom!==undefined){s+=getShortAttr("margin-bottom",margin_bottom)}if(offset_cut!==undefined){s+=getShortAttr("offset-cut",offset_cut)}if(offset_label!==undefined){s+=getShortAttr("offset-label",offset_label)}this.message+="<layout"+s+"/>";return this};ePOSBuilder.prototype.addRecovery=function(){this.message+="<recovery/>";return this};ePOSBuilder.prototype.addReset=function(){this.message+="<reset/>";return this};ePOSBuilder.prototype.addCommand=function(data){this.message+="<command>"+toHexBinary(data)+"</command>";return this};ePOSBuilder.prototype.toString=function(){var s="";if(this.force){s+=getBoolAttr("force",true)}return'<epos-print xmlns="http://www.epson-pos.com/schemas/2011/03/epos-print"'+s+">"+this.message+"</epos-print>"};function toHexBinary(s){var l=s.length,r=new Array(l),i;for(i=0;i<l;i++){r[i]=("0"+s.charCodeAt(i).toString(16)).slice(-2)}return r.join("")}function toBase64Binary(s){var l=s.length,r=new Array((l+2)/3<<2),t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",p=(3-l%3)%3,j=0,i=0,n;s+="\x00\x00";while(i<l){n=s.charCodeAt(i++)<<16|s.charCodeAt(i++)<<8|s.charCodeAt(i++);r[j++]=t.charAt(n>>18&63);r[j++]=t.charAt(n>>12&63);r[j++]=t.charAt(n>>6&63);r[j++]=t.charAt(n&63)}while(p--){r[--j]="="}return r.join("")}function toMonoImage(imgdata,s,g){var x=String.fromCharCode,m8=[[2,130,34,162,10,138,42,170],[194,66,226,98,202,74,234,106],[50,178,18,146,58,186,26,154],[242,114,210,82,250,122,218,90],[14,142,46,174,6,134,38,166],[206,78,238,110,198,70,230,102],[62,190,30,158,54,182,22,150],[254,126,222,94,246,118,214,86]],d=imgdata.data,w=imgdata.width,h=imgdata.height,r=new Array((w+7>>3)*h),n=0,p=0,q=0,t=128,e=new Array(),e1,e2,b,v,f,i,j;if(s==1){i=w;while(i--){e.push(0)}}for(j=0;j<h;j++){e1=0;e2=0;i=0;while(i<w){b=i&7;if(s==0){t=m8[j&7][b]}v=Math.pow(((d[p++]*0.29891+d[p++]*0.58661+d[p++]*0.11448)*d[p]/255+255-d[p++])/255,1/g)*255|0;if(s==1){v+=e[i]+e1>>4;f=v-(v<t?0:255);if(i>0){e[i-1]+=f}e[i]=f*7+e2;e1=f*5;e2=f*3}if(v<t){n|=128>>b}i++;if(b==7||i==w){r[q++]=x(n==16?32:n);n=0}}}return r.join("")}function toGrayImage(imgdata,g){var x=String.fromCharCode,m4=[[0,9,2,11],[13,4,15,6],[3,12,1,10],[16,7,14,5]],thermal=[0,7,13,19,23,27,31,35,40,44,49,52,54,55,57,59,61,62,64,66,67,69,70,70,71,72,73,74,75,76,77,78,79,80,81,82,83,83,84,85,86,86,87,88,88,89,90,90,91,91,92,93,93,94,94,95,96,96,97,98,98,99,99,100,101,101,102,102,103,103,104,104,105,105,106,106,107,107,108,108,109,109,110,110,111,111,112,112,112,113,113,114,114,115,115,116,116,117,117,118,118,119,119,120,120,120,121,121,122,122,123,123,123,124,124,125,125,125,126,126,127,127,127,128,128,129,129,130,130,130,131,131,132,132,132,133,133,134,134,135,135,135,136,136,137,137,137,138,138,139,139,139,140,140,141,141,141,142,142,143,143,143,144,144,145,145,146,146,146,147,147,148,148,148,149,149,150,150,150,151,151,152,152,152,153,153,154,154,155,155,155,156,156,157,157,158,158,159,159,160,160,161,161,161,162,162,163,163,164,164,165,165,166,166,166,167,167,168,168,169,169,170,170,171,171,172,173,173,174,175,175,176,177,178,178,179,180,180,181,182,182,183,184,184,185,186,186,187,189,191,193,195,198,200,202,255],d=imgdata.data,w=imgdata.width,h=imgdata.height,r=new Array((w+1>>1)*h),n=0,p=0,q=0,b,v,v1,i,j;for(j=0;j<h;j++){i=0;while(i<w){b=i&1;v=thermal[Math.pow(((d[p++]*0.29891+d[p++]*0.58661+d[p++]*0.11448)*d[p]/255+255-d[p++])/255,1/g)*255|0];v1=v/17|0;if(m4[j&3][i&3]<v%17){v1++}n|=v1<<((1-b)<<2);i++;if(b==1||i==w){r[q++]=x(n);n=0}}}return r.join("")}function escapeMarkup(s){var markup=/[<>&'"\t\n\r]/g;if(markup.test(s)){s=s.replace(markup,function(c){var r="";switch(c){case"<":r="&lt;";break;case">":r="&gt;";break;case"&":r="&amp;";break;case"'":r="&apos;";break;case'"':r="&quot;";break;case"\t":r="&#9;";break;case"\n":r="&#10;";break;case"\r":r="&#13;";break;default:break}return r})}return s}function escapeControl(s){var control=/[\\\x00-\x1f\x7f-\xff]/g;if(control.test(s)){s=s.replace(control,function(c){return(c=="\\")?"\\\\":"\\x"+("0"+c.charCodeAt(0).toString(16)).slice(-2)})}return s}var regexFont=/^(font_[a-e]|special_[ab])$/,regexAlign=/^(left|center|right)$/,regexColor=/^(none|color_[1-4])$/,regexFeed=/^(peeling|cutting|current_tof|next_tof)$/,regexMode=/^(mono|gray16)$/,regexBarcode=/^(upc_[ae]|[ej]an13|[ej]an8|code(39|93|128)|itf|codabar|gs1_128|gs1_databar_(omnidirectional|truncated|limited|expanded))$/,regexHri=/^(none|above|below|both)$/,regexSymbol=/^(pdf417_(standard|truncated)|qrcode_(model_[12]|micro)|maxicode_mode_[2-6]|gs1_databar_(stacked(_omnidirectional)?|expanded_stacked)|azteccode_(fullrange|compact)|datamatrix_(square|rectangle_(8|12|16)))$/,regexLevel=/^(level_[0-8lmqh]|default)$/,regexLine=/^(thin|medium|thick)(_double)?$/,regexDirection=/^(left_to_right|bottom_to_top|right_to_left|top_to_bottom)$/,regexCut=/^(no_feed|feed|reserve)$/,regexDrawer=/^drawer_[12]$/,regexPulse=/^pulse_[1-5]00$/,regexPattern=/^(none|pattern_(10|[0-9a-e])|error|paper_end)$/,regexLayout=/^(receipt|label)(_bm)?$/;function getEnumAttr(name,value,regex){if(!regex.test(value)){throw new Error('Parameter "'+name+'" is invalid')}return" "+name+'="'+value+'"'}function getBoolAttr(name,value){return" "+name+'="'+!!value+'"'}function getIntAttr(name,value,min,max){if(isNaN(value)||value<min||value>max){throw new Error('Parameter "'+name+'" is invalid')}return" "+name+'="'+value+'"'}function getUByteAttr(name,value){return getIntAttr(name,value,0,255)}function getUShortAttr(name,value){return getIntAttr(name,value,0,65535)}function getShortAttr(name,value){return getIntAttr(name,value,-32768,32767)}function getEnumIntAttr(name,value,regex,min,max){if(!regex.test(value)){if(isNaN(value)||value<min||value>max){throw new Error('Parameter "'+name+'" is invalid')}}return" "+name+'="'+value+'"'}function ePOSPrint(address){this.address=address;this.enabled=false;this.interval=3000;this.timeout=300000;this.status=0;this.battery=0;this.drawerOpenLevel=0;this.onreceive=null;this.onerror=null;this.onstatuschange=null;this.ononline=null;this.onoffline=null;this.onpoweroff=null;this.oncoverok=null;this.oncoveropen=null;this.onpaperok=null;this.onpaperend=null;this.onpapernearend=null;this.ondrawerclosed=null;this.ondraweropen=null;this.onbatterylow=null;this.onbatteryok=null;this.onbatterystatuschange=null;this.ASB_NO_RESPONSE=1;this.ASB_PRINT_SUCCESS=2;this.ASB_DRAWER_KICK=4;this.ASB_BATTERY_OFFLINE=4;this.ASB_OFF_LINE=8;this.ASB_COVER_OPEN=32;this.ASB_PAPER_FEED=64;this.ASB_WAIT_ON_LINE=256;this.ASB_PANEL_SWITCH=512;this.ASB_MECHANICAL_ERR=1024;this.ASB_AUTOCUTTER_ERR=2048;this.ASB_UNRECOVER_ERR=8192;this.ASB_AUTORECOVER_ERR=16384;this.ASB_RECEIPT_NEAR_END=131072;this.ASB_RECEIPT_END=524288;this.ASB_BUZZER=16777216;this.ASB_WAIT_REMOVE_LABEL=16777216;this.ASB_NO_LABEL=67108864;this.ASB_SPOOLER_IS_STOPPED=2147483648;this.DRAWER_OPEN_LEVEL_LOW=0;this.DRAWER_OPEN_LEVEL_HIGH=1}ePOSPrint.prototype=new ePOSBuilder();ePOSPrint.prototype.constructor=ePOSPrint;ePOSPrint.prototype.open=function(){if(!this.enabled){this.enabled=true;this.status=0;this.battery=0;this.send()}};ePOSPrint.prototype.close=function(){this.enabled=false;if(this.intervalid){clearTimeout(this.intervalid);delete this.intervalid}if(this.intervalxhr){this.intervalxhr.abort();delete this.intervalxhr}};ePOSPrint.prototype.getPrintJobStatus=function(printjobid){this.send(printjobid)};ePOSPrint.prototype.send=function(request,printjobid){var args=arguments.length,epos=this,address=epos.address,soap,xhr,tid,res,success,code,status,battery;if(!/^<epos/.test(request)){if(args<2){printjobid=request;request=new ePOSBuilder().toString()}else{address=request;request=printjobid;printjobid=arguments[2]}}soap='<?xml version="1.0" encoding="utf-8"?><s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">';if(printjobid){soap+='<s:Header><parameter xmlns="http://www.epson-pos.com/schemas/2011/03/epos-print"><printjobid>'+printjobid+"</printjobid></parameter></s:Header>"}soap+="<s:Body>"+request+"</s:Body></s:Envelope>";if(window.XMLHttpRequest){xhr=new XMLHttpRequest();if(!("withCredentials"in xhr)&&window.XDomainRequest){xhr=new XDomainRequest();xhr.open("POST",address,true);xhr.onload=function(){res=xhr.responseText;if(/response/.test(res)){success=/success\s*=\s*"\s*(1|true)\s*"/.test(res);code=res.match(/code\s*=\s*"\s*(\S*)\s*"/)?RegExp.$1:"";status=res.match(/status\s*=\s*"\s*(\d+)\s*"/)?parseInt(RegExp.$1):0;battery=res.match(/battery\s*=\s*"\s*(\d+)\s*"/)?parseInt(RegExp.$1):0;printjobid=res.match(/<printjobid>\s*(\S*)\s*<\/printjobid>/)?RegExp.$1:"";if(args>0){fireReceiveEvent(epos,success,code,status,battery,printjobid)}else{fireStatusEvent(epos,status,battery)}}else{if(args>0){fireErrorEvent(epos,0,xhr.responseText)}else{fireStatusEvent(epos,epos.ASB_NO_RESPONSE,0)}}if(args<1){updateStatus(epos)}};xhr.onerror=function(){if(args>0){fireErrorEvent(epos,0,xhr.responseText)}else{fireStatusEvent(epos,epos.ASB_NO_RESPONSE,0);updateStatus(epos)}};xhr.onprogress=function(){};xhr.ontimeout=xhr.onerror;xhr.timeout=epos.timeout;xhr.send(soap)}else{xhr.open("POST",address,true);xhr.setRequestHeader("Content-Type","text/xml; charset=utf-8");xhr.setRequestHeader("If-Modified-Since","Thu, 01 Jan 1970 00:00:00 GMT");xhr.setRequestHeader("SOAPAction",'""');xhr.onreadystatechange=function(){if(xhr.readyState==4){clearTimeout(tid);if(xhr.status==200&&xhr.responseXML){res=xhr.responseXML.getElementsByTagName("response");if(res.length>0){success=/^(1|true)$/.test(res[0].getAttribute("success"));code=res[0].hasAttribute("code")?res[0].getAttribute("code"):"";status=res[0].hasAttribute("status")?parseInt(res[0].getAttribute("status")):0;battery=res[0].hasAttribute("battery")?parseInt(res[0].getAttribute("battery")):0;res=xhr.responseXML.getElementsByTagName("printjobid");printjobid=res.length>0?res[0].textContent:"";if(args>0){fireReceiveEvent(epos,success,code,status,battery,printjobid)}else{fireStatusEvent(epos,status,battery)}}else{if(args>0){fireErrorEvent(epos,xhr.status,xhr.responseText)}else{fireStatusEvent(epos,epos.ASB_NO_RESPONSE,0)}}}else{if(args>0){fireErrorEvent(epos,xhr.status,xhr.responseText)}else{fireStatusEvent(epos,epos.ASB_NO_RESPONSE,0)}}if(args<1){updateStatus(epos)}}};tid=setTimeout(function(){xhr.abort()},epos.timeout);xhr.send(soap)}if(args<1){epos.intervalxhr=xhr}}else{throw new Error("XMLHttpRequest is not supported")}};function fireReceiveEvent(epos,success,code,status,battery,printjobid){if(code=="EX_ENPC_TIMEOUT"){code="ERROR_DEVICE_BUSY"}if(epos.onreceive){epos.onreceive({success:success,code:code,status:status,battery:battery,printjobid:printjobid})}}function fireStatusEvent(epos,status,battery){var diff,difb;if(status==0||status==epos.ASB_NO_RESPONSE){status=epos.status|epos.ASB_NO_RESPONSE}diff=epos.status==0?~0:epos.status^status;difb=epos.status==0?~0:epos.battery^battery;epos.status=status;epos.battery=battery;if(diff&&epos.onstatuschange){epos.onstatuschange(status)}if(difb&&epos.onbatterystatuschange){epos.onbatterystatuschange(battery)}if(diff&(epos.ASB_NO_RESPONSE|epos.ASB_OFF_LINE)){if(status&epos.ASB_NO_RESPONSE){if(epos.onpoweroff){epos.onpoweroff()}}else{if(status&epos.ASB_OFF_LINE){if(epos.onoffline){epos.onoffline()}}else{if(epos.ononline){epos.ononline()}}}}if(diff&epos.ASB_COVER_OPEN){if(status&epos.ASB_NO_RESPONSE){}else{if(status&epos.ASB_COVER_OPEN){if(epos.oncoveropen){epos.oncoveropen()}}else{if(epos.oncoverok){epos.oncoverok()}}}}if(diff&(epos.ASB_RECEIPT_END|epos.ASB_RECEIPT_NEAR_END)){if(status&epos.ASB_NO_RESPONSE){}else{if(status&epos.ASB_RECEIPT_END){if(epos.onpaperend){epos.onpaperend()}}else{if(status&epos.ASB_RECEIPT_NEAR_END){if(epos.onpapernearend){epos.onpapernearend()}}else{if(epos.onpaperok){epos.onpaperok()}}}}}if(diff&epos.ASB_DRAWER_KICK){if(status&epos.ASB_NO_RESPONSE){}else{if(status&epos.ASB_DRAWER_KICK){if(epos.drawerOpenLevel==epos.DRAWER_OPEN_LEVEL_HIGH){if(epos.ondraweropen){epos.ondraweropen()}}else{if(epos.ondrawerclosed){epos.ondrawerclosed()}}if(epos.onbatterylow){epos.onbatterylow()}}else{if(epos.drawerOpenLevel==epos.DRAWER_OPEN_LEVEL_HIGH){if(epos.ondrawerclosed){epos.ondrawerclosed()}}else{if(epos.ondraweropen){epos.ondraweropen()}}if(epos.onbatteryok){epos.onbatteryok()}}}}}function fireErrorEvent(epos,status,responseText){if(epos.onerror){epos.onerror({status:status,responseText:responseText})}}function updateStatus(epos){var delay=epos.interval;if(epos.enabled){if(isNaN(delay)||delay<1000){delay=3000}epos.intervalid=setTimeout(function(){delete epos.intervalid;if(epos.enabled){epos.send()}},delay)}delete epos.intervalxhr}function CanvasPrint(address){this.address=address;this.mode="mono";this.halftone=0;this.brightness=1;this.align="left";this.color="color_1";this.paper="receipt";this.feed="current_tof";this.cut=false;this.layout=null;this.ALIGN_LEFT="left";this.ALIGN_CENTER="center";this.ALIGN_RIGHT="right";this.COLOR_NONE="none";this.COLOR_1="color_1";this.COLOR_2="color_2";this.COLOR_3="color_3";this.COLOR_4="color_4";this.FEED_PEELING="peeling";this.FEED_CUTTING="cutting";this.FEED_CURRENT_TOF="current_tof";this.FEED_NEXT_TOF="next_tof";this.HALFTONE_DITHER=0;this.HALFTONE_ERROR_DIFFUSION=1;this.HALFTONE_THRESHOLD=2;this.MODE_MONO="mono";this.MODE_GRAY16="gray16";this.PAPER_RECEIPT="receipt";this.PAPER_RECEIPT_BM="receipt_bm";this.PAPER_LABEL="label";this.PAPER_LABEL_BM="label_bm";this.connectionObj=null}CanvasPrint.prototype=new ePOSPrint();CanvasPrint.prototype.constructor=CanvasPrint;CanvasPrint.prototype.setConnectionObject=function(connectionObj){this.connectionObj=connectionObj};CanvasPrint.prototype.print=function(){var args=arguments.length;var address=this.address,layout=this.layout,paper=this.paper;var canvas=arguments[0],cut=this.cut,mode=this.mode,printjobid=undefined;switch(args){case 2:printjobid=arguments[1];break;case 4:printjobid=arguments[3];case 3:cut=arguments[1];mode=arguments[2];break}if((typeof(canvas)=="undefined")||(canvas==null)){throw new Error("Canvas is not supported")}if(!canvas.getContext){throw new Error("Canvas is not supported")}if(layout){this.addLayout(paper,layout.width,layout.height,layout.margin_top,layout.margin_bottom,layout.offset_cut,layout.offset_label)}if(paper!=this.PAPER_RECEIPT){this.addFeedPosition(this.FEED_CURRENT_TOF);if(layout){this.addFeedPosition(this.FEED_NEXT_TOF)}}this.addTextAlign(this.align);this.addImage(canvas.getContext("2d"),0,0,canvas.width,canvas.height,this.color,mode);if(paper!=this.PAPER_RECEIPT){this.addFeedPosition(this.feed);if(cut){this.addCut(this.CUT_NO_FEED)}}else{if(cut){this.addCut(this.CUT_FEED)}}this.send(address,this.toString(),printjobid)};CanvasPrint.prototype.recover=function(){this.force=true;this.addRecovery();this.send(this.address,this.toString())};CanvasPrint.prototype.reset=function(){this.addReset();this.send(this.address,this.toString())};if(!window.epson){window.epson={}}window.epson.ePOSBuilder=ePOSBuilder;window.epson.ePOSPrint=ePOSPrint;window.epson.CanvasPrint=CanvasPrint;function POSKeyboard(deviceID,isCrypto){this.deviceID=deviceID;this.isCrypto=isCrypto;this.connectionObj=null}POSKeyboard.prototype={setConnectionObject:function(connectionObj){this.connectionObj=connectionObj},client_onkeypress:function(data){try{if(this.onkeypress==null){return}this.onkeypress(data)}catch(e){}return},callEvent:function(eventName,data){var eventReq=data;eventReq.type=eventName;var eposmsg=MessageFactory.getDeviceDataMessage(this.deviceID,eventReq,this.isCrypto);var sequence=-1;try{this.connectionObj.emit(eposmsg);sequence=eposmsg.sequence}catch(e){}return sequence}};function Printer(deviceID,isCrypto,ePOSDeviceContext){this.deviceID=deviceID;this.isCrypto=isCrypto;this.ePosDev=ePOSDeviceContext;this.timeout=10000}Printer.prototype=new CanvasPrint();Printer.prototype.finalize=function(){this.stopMonitor()};Printer.prototype.toString=function(){var str=ePOSBuilder.prototype.toString.apply(this);return str};Printer.prototype.addFeedUnit=function(unit){try{ePOSBuilder.prototype.addFeedUnit.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addFeedLine=function(line){try{ePOSBuilder.prototype.addFeedLine.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addFeed=function(unit){try{ePOSBuilder.prototype.addFeed.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addFeedPosition=function(line){try{ePOSBuilder.prototype.addFeedPosition.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addText=function(text){try{ePOSBuilder.prototype.addText.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addTextLang=function(lang){try{ePOSBuilder.prototype.addTextLang.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addTextAlign=function(align){try{ePOSBuilder.prototype.addTextAlign.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addTextRotate=function(rotate){try{ePOSBuilder.prototype.addTextRotate.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addTextLineSpace=function(linespc){try{ePOSBuilder.prototype.addTextLineSpace.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addTextFont=function(font){try{ePOSBuilder.prototype.addTextFont.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addTextSmooth=function(smooth){try{ePOSBuilder.prototype.addTextSmooth.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addTextDouble=function(dw,dh){try{ePOSBuilder.prototype.addTextDouble.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addTextSize=function(width,height){try{ePOSBuilder.prototype.addTextSize.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addTextStyle=function(reverse,ul,em,color){try{ePOSBuilder.prototype.addTextStyle.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addTextPosition=function(x){try{ePOSBuilder.prototype.addTextPosition.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addTextVPosition=function(y){try{ePOSBuilder.prototype.addTextVPosition.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addImage=function(context,x,y,width,height,color,mode){try{ePOSBuilder.prototype.addImage.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addLogo=function(key1,key2){try{ePOSBuilder.prototype.addLogo.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addBarcode=function(barCodeData,type,hri,font,width,height){try{ePOSBuilder.prototype.addBarcode.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addSymbol=function(symbolData,type,level,width,height,size){try{ePOSBuilder.prototype.addSymbol.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addCommand=function(data){try{ePOSBuilder.prototype.addCommand.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addHLine=function(x1,x2,style){try{ePOSBuilder.prototype.addHLine.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addVLineBegin=function(x,style){try{ePOSBuilder.prototype.addVLineBegin.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addVLineEnd=function(x,style){try{ePOSBuilder.prototype.addVLineEnd.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addPageBegin=function(){try{ePOSBuilder.prototype.addPageBegin.apply(this)}catch(e){throw e}return this};Printer.prototype.addPageEnd=function(){try{ePOSBuilder.prototype.addPageEnd.apply(this)}catch(e){throw e}return this};Printer.prototype.addPageArea=function(x,y,width,height){try{ePOSBuilder.prototype.addPageArea.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addPageDirection=function(dir){try{ePOSBuilder.prototype.addPageDirection.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addPagePosition=function(x,y){try{ePOSBuilder.prototype.addPagePosition.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addPageLine=function(x1,y1,x2,y2,style){try{ePOSBuilder.prototype.addPageLine.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addPageRectangle=function(x1,y1,x2,y2,style){try{ePOSBuilder.prototype.addPageRectangle.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addCut=function(type){try{ePOSBuilder.prototype.addCut.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addPulse=function(drawer,time){try{ePOSBuilder.prototype.addPulse.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addSound=function(pattern,repeat,cycle){try{ePOSBuilder.prototype.addSound.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.addLayout=function(type,width,height,margin_top,margin_bottom,offset_cut,offset_label){try{ePOSBuilder.prototype.addLayout.apply(this,arguments)}catch(e){throw e}return this};Printer.prototype.setXmlString=function(xml){this.message=xml};Printer.prototype.getXmlString=function(){return this.message};Printer.prototype.getPrintJobStatus=function(printjobid){this.setXmlString("");this.send(printjobid)};Printer.prototype.send=function(printjobid){var sq=-1;if((!this.ePosDev.eposprint)&&(this.connectionObj.isUsableDeviceIF())){try{var data={type:"print",timeout:this.timeout,printdata:this.toString()};switch(arguments.length){case 0:data.printdata=this.toString();break;case 1:data.printdata=this.toString();data.printjobid=printjobid;break;case 2:case 3:data.printdata=arguments[1];data.printjobid=arguments[2]}var eposmsg=MessageFactory.getDeviceDataMessage(this.deviceID,data,this.isCrypto);var sequence=-1;try{this.connectionObj.emit(eposmsg);sequence=eposmsg.sequence}catch(e){}this.force=false;this.setXmlString("")}catch(e){sq=-1}}else{var self=this,address=this.connectionObj.getAddressWithProtocol()+"/cgi-bin/epos/service.cgi?devid="+this.deviceID+"&timeout="+this.timeout,soap,xhr,tid,res,success,code,status,battery;soap='<?xml version="1.0" encoding="utf-8"?><s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/">';if(printjobid){soap+='<s:Header><parameter xmlns="http://www.epson-pos.com/schemas/2011/03/epos-print"><printjobid>'+printjobid+"</printjobid></parameter></s:Header>"}soap+="<s:Body>"+this.toString()+"</s:Body></s:Envelope>";if(window.XMLHttpRequest){xhr=new XMLHttpRequest();if(!("withCredentials"in xhr)&&window.XDomainRequest){xhr=new XDomainRequest();xhr.open("POST",address,true);xhr.onload=function(){res=xhr.responseText;if(/response/.test(res)){success=/success\s*=\s*"\s*(1|true)\s*"/.test(res);code=res.match(/code\s*=\s*"\s*(\S*)\s*"/)?RegExp.$1:"";status=res.match(/status\s*=\s*"\s*(\d+)\s*"/)?parseInt(RegExp.$1):0;battery=res.match(/battery\s*=\s*"\s*(\d+)\s*"/)?parseInt(RegExp.$1):0;printjobid=res.match(/<printjobid>\s*(\S*)\s*<\/printjobid>/)?RegExp.$1:"";self.fireReceiveEvent(success,code,status,battery,printjobid,0)}else{self.fireErrorEvent(0,xhr.responseText,0)}};xhr.onerror=function(){self.fireErrorEvent(0,xhr.responseText,0)};xhr.onprogress=function(){};xhr.ontimeout=xhr.onerror;xhr.timeout=self.timeout;xhr.send(soap)}else{xhr.open("POST",address,true);xhr.setRequestHeader("Content-Type","text/xml; charset=utf-8");xhr.setRequestHeader("If-Modified-Since","Thu, 01 Jan 1970 00:00:00 GMT");xhr.setRequestHeader("SOAPAction",'""');xhr.onreadystatechange=function(){if(xhr.readyState==4){clearTimeout(tid);if(xhr.status==200&&xhr.responseXML){res=xhr.responseXML.getElementsByTagName("response");if(res.length>0){success=/^(1|true)$/.test(res[0].getAttribute("success"));code=res[0].hasAttribute("code")?res[0].getAttribute("code"):"";status=res[0].hasAttribute("status")?parseInt(res[0].getAttribute("status")):0;battery=res[0].hasAttribute("battery")?parseInt(res[0].getAttribute("battery")):0;res=xhr.responseXML.getElementsByTagName("printjobid");printjobid=res.length>0?res[0].textContent:"";self.fireReceiveEvent(success,code,status,battery,printjobid,0)}else{self.fireErrorEvent(xhr.status,xhr.responseText,0)}}else{self.fireErrorEvent(xhr.status,xhr.responseText,0)}}};tid=setTimeout(function(){xhr.abort()},this.timeout);xhr.send(soap)}this.setXmlString("")}else{throw new Error("XMLHttpRequest is not supported")}sq=0}return sq};Printer.prototype.client_onxmlresult=function(res,sq){if(res){var xml=res.resultdata;var success=/success\s*=\s*"\s*(1|true)\s*"/.test(xml);xml.match(/code\s*=\s*"\s*(\S*)\s*"/);var code=RegExp.$1;xml.match(/status\s*=\s*"\s*(\d+)\s*"/);var status=parseInt(RegExp.$1);xml.match(/battery\s*=\s*"\s*(\d+)\s*"/);var battery=parseInt(RegExp.$1);this.fireReceiveEvent(success,code,status,battery,res.printjobid,sq)}else{this.fireErrorEvent(0,this.ASB_NO_RESPONSE,sq)}};Printer.prototype.startMonitor=function(){var result=false;var address=this.connectionObj.getAddressWithProtocol()+"/cgi-bin/epos/service.cgi?devid="+this.deviceID+"&timeout=10000";try{if(!this.enabled){this.address=address;this.enabled=true;this.status=this.ASB_DRAWER_KICK;this.sendStartMonitorCommand()}result=true}catch(e){throw e}return result};Printer.prototype.sendStartMonitorCommand=function(){var self=this;var address=this.address;var request=new ePOSBuilder().toString();var soap='<?xml version="1.0" encoding="utf-8"?><s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body>'+request+"</s:Body></s:Envelope>";var epos=this;if(window.XDomainRequest){var xdr=new XDomainRequest();xdr.open("POST",address,true);xdr.onload=function(){var res=xdr.responseText;if(/response/.test(res)){var success=/success\s*=\s*"\s*(1|true)\s*"/.test(res);res.match(/code\s*=\s*"\s*(\S*)\s*"/);var code=RegExp.$1;res.match(/status\s*=\s*"\s*(\d+)\s*"/);var status=parseInt(RegExp.$1);res.match(/battery\s*=\s*"\s*(\d+)\s*"/);var battery=parseInt(RegExp.$1);self.fireStatusEvent(epos,status,battery)}else{self.fireStatusEvent(epos,epos.ASB_NO_RESPONSE,0)}self.updateStatus(epos)};xdr.onerror=function(){self.fireStatusEvent(epos,epos.ASB_NO_RESPONSE);self.updateStatus(epos)};xdr.onprogress=function(){};xdr.ontimeout=xdr.onerror;xdr.send(soap)}else{if(window.XMLHttpRequest){var xhr=new XMLHttpRequest();xhr.open("POST",address,true);xhr.setRequestHeader("Content-Type","text/xml; charset=utf-8");xhr.setRequestHeader("If-Modified-Since","Thu, 01 Jan 1970 00:00:00 GMT");xhr.setRequestHeader("SOAPAction",'""');xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status==200&&xhr.responseXML){var res=xhr.responseXML.getElementsByTagName("response");if(res.length>0){var success=/^(1|true)$/.test(res[0].getAttribute("success"));var code=res[0].getAttribute("code");var status=parseInt(res[0].getAttribute("status"));var battery=res[0].hasAttribute("battery")?parseInt(res[0].getAttribute("battery")):0;self.fireStatusEvent(epos,status,battery)}else{self.fireStatusEvent(epos,epos.ASB_NO_RESPONSE,0)}}else{self.fireStatusEvent(epos,epos.ASB_NO_RESPONSE,0)}self.updateStatus(epos)}};xhr.send(soap)}else{throw new Error("XMLHttpRequest is not supported")}}};Printer.prototype.stopMonitor=function(){var result=false;try{this.enabled=false;if(this.timeoutid){clearTimeout(this.timeoutid);delete this.timeoutid}result=true}catch(e){throw e}return result};Printer.prototype.fireReceiveEvent=function(success,code,status,battery,printjobid,sq){delete this.isPrint;if(code=="EX_ENPC_TIMEOUT"){code="ERROR_DEVICE_BUSY"}if(this.onreceive){this.onreceive({success:success,code:code,status:status,battery:battery,printjobid:printjobid},sq)}};Printer.prototype.fireErrorEvent=function(status,responseText,sq){if(this.onerror){this.onerror({status:status,responseText:responseText},sq)}this.ePosDev.cleanup()};Printer.prototype.fireStatusEvent=function(epos,status,battery){if(status==0||status==this.ASB_NO_RESPONSE){status=this.status|this.ASB_NO_RESPONSE}var diff=this.status==this.ASB_DRAWER_KICK?~0:this.status^status;var difb=this.status==0?~0:this.battery^battery;this.status=status;this.battery=battery;if(diff&&this.onstatuschange){this.onstatuschange(status)}if(difb&&this.onbatterystatuschange){this.onbatterystatuschange(battery)}if(diff&(this.ASB_NO_RESPONSE|this.ASB_OFF_LINE)){if(status&this.ASB_NO_RESPONSE){if(this.onpoweroff){this.onpoweroff()}}else{if(status&this.ASB_OFF_LINE){if(this.onoffline){this.onoffline()}}else{if(this.ononline){this.ononline()}}}}if(diff&this.ASB_COVER_OPEN){if(status&this.ASB_NO_RESPONSE){}else{if(status&this.ASB_COVER_OPEN){if(this.oncoveropen){this.oncoveropen()}}else{if(this.oncoverok){this.oncoverok()}}}}if(diff&(this.ASB_RECEIPT_END|this.ASB_RECEIPT_NEAR_END)){if(status&this.ASB_NO_RESPONSE){}else{if(status&this.ASB_RECEIPT_END){if(this.onpaperend){this.onpaperend()}}else{if(status&this.ASB_RECEIPT_NEAR_END){if(this.onpapernearend){this.onpapernearend()}}else{if(this.onpaperok){this.onpaperok()}}}}}if(diff&this.ASB_DRAWER_KICK){if(status&this.ASB_NO_RESPONSE){}else{if(status&this.ASB_DRAWER_KICK){if(this.drawerOpenLevel==this.DRAWER_OPEN_LEVEL_HIGH){if(this.ondraweropen){this.ondraweropen()}}else{if(this.ondrawerclosed){this.ondrawerclosed()}}if(this.onbatterylow){this.onbatterylow()}}else{if(this.drawerOpenLevel==this.DRAWER_OPEN_LEVEL_HIGH){if(this.ondrawerclosed){this.ondrawerclosed()}}else{if(this.ondraweropen){this.ondraweropen()}}if(this.onbatteryok){this.onbatteryok()}}}}};Printer.prototype.updateStatus=function(){var self=this;if(this.enabled){var delay=this.interval;if(isNaN(delay)||delay<1000){delay=3000}this.timeoutid=setTimeout(function(){delete self.timeoutid;if(self.enabled){self.sendStartMonitorCommand()}},delay)}};Printer.prototype.print=function(canvas,cut,mode,printjobid){try{CanvasPrint.prototype.print.apply(this,arguments)}catch(e){throw e}};Printer.prototype.reset=function(){try{CanvasPrint.prototype.reset.apply(this,arguments)}catch(e){throw e}};Printer.prototype.recover=function(){try{CanvasPrint.prototype.recover.apply(this,arguments)}catch(e){throw e}};function HybridPrinter(deviceID,isCrypto,ePOSDeviceContext){this.deviceID=deviceID;this.isCrypto=isCrypto;this.ePosDev=ePOSDeviceContext;this.connectionObj=null;this.ReceiptPrinter;this.SlipPrinter;this.EndorsePrinter;this.MICRReader;this.force=false;this.onstatuschange;this.ononline;this.onoffline;this.onpoweroff;this.oncoveropen;this.onpaperok;this.onpapernearend;this.onpaperend;this.ondrawerclosed;this.ondraweropen;this.ASB_NO_RESPONSE=1;this.ASB_PRINT_SUCCESS=2;this.ASB_DRAWER_KICK=4;this.ASB_OFF_LINE=8;this.ASB_COVER_OPEN=32;this.ASB_PAPER_FEED=64;this.ASB_WAIT_ON_LINE=256;this.ASB_PANEL_SWITCH=512;this.ASB_MECHANICAL_ERR=1024;this.ASB_AUTOCUTTER_ERR=2048;this.ASB_UNRECOVER_ERR=8192;this.ASB_AUTORECOVER_ERR=16384;this.ASB_RECEIPT_NEAR_END=131072;this.ASB_RECEIPT_END=524288;this.ASB_TOF_NOPAPER=2097152;this.ASB_BOF_NOPAPER=4194304;this.ASB_SLIP_NO_SELECT=16777216;this.ASB_SLIP_IMPOSSIBLE_PRINT=33554432;this.ASB_SPOOLER_IS_STOPPED=2147483648;this.SUCCESS="SUCCESS";this.CANCEL="CANCEL";this.ERROR_PARAMMETER="ERROR_PARAMMETER";this.ERROR_COMMAND="ERROR_COMMAND";this.ERROR_DEVICE_NOT_FOUND="ERROR_DEVICE_NOT_FOUND";this.ERROR_DEVICE_BUSY="ERROR_DEVICE_BUSY";this.ERROR_NOT_SUPPORTED="ERROR_NOT_SUPPORTED";this.ERROR_COVER_OPEN="ERROR_COVER_OPEN";this.ERROR_TIMEOUT="ERROR_TIMEOUT";this.ERROR_AUTOMATICAL="ERROR_AUTOMATICAL";this.ERROR_UNRECOVERABLE="ERROR_UNRECOVERABLE";this.ERROR_BADPORT="ERROR_BADPORT";this.SYSTEM_ERROR="SYSTEM_ERROR";this.init(deviceID)}HybridPrinter.prototype={init:function(deviceID){var obj=this;obj.deviceID=deviceID;obj.ReceiptPrinter=new ReceiptPrinter(this);obj.SlipPrinter=new SlipPrinter(this);obj.EndorsePrinter=new EndorsePrinter(this);obj.MICRReader=new MICRReader(this);obj.ReceiptPrinter.onstatuschange=function(status){if(obj.onstatuschange!=null){obj.onstatuschange(status)}};obj.ReceiptPrinter.ononline=function(){if(obj.ononline!=null){obj.ononline()}};obj.ReceiptPrinter.onoffline=function(){if(obj.onoffline!=null){obj.onoffline()}};obj.ReceiptPrinter.onpoweroff=function(){if(obj.onpoweroff!=null){obj.onpoweroff()}};obj.ReceiptPrinter.oncoveropen=function(){if(obj.oncoveropen!=null){obj.oncoveropen()}};obj.ReceiptPrinter.onpaperok=function(){if(obj.onpaperok!=null){obj.onpaperok()}};obj.ReceiptPrinter.onpapernearend=function(){if(obj.onpapernearend!=null){obj.onpapernearend()}};obj.ReceiptPrinter.onpaperend=function(){if(obj.onpaperend!=null){obj.onpaperend()}};obj.ReceiptPrinter.ondrawerclosed=function(){if(obj.ondrawerclosed!=null){obj.ondrawerclosed()}};obj.ReceiptPrinter.ondraweropen=function(){if(obj.ondraweropen!=null){obj.ondraweropen()}}},setConnectionObject:function(connectionObj){this.connectionObj=connectionObj;this.ReceiptPrinter.setConnectionObject(this.connectionObj)},lock:function(){var data={type:"lock"};return this.send(data)},unlock:function(){var data={type:"unlock"};return this.send(data)},eject:function(){var data={type:"eject"};return this.send(data)},recover:function(){return this.ReceiptPrinter.recover()},reset:function(){this.ReceiptPrinter.force=this.force;var ret=this.ReceiptPrinter.reset();this.force=false;return ret},startMonitor:function(){return this.ReceiptPrinter.startMonitor()},stopMonitor:function(){return this.ReceiptPrinter.stopMonitor()},client_onreceive:function(res,sq){switch(res.eventtype){case"slipprint":case"slipcancel":this.SlipPrinter.fireOnReceive(res,sq);break;case"endorseprint":case"endorsecancel":this.EndorsePrinter.fireOnReceive(res,sq);break;case"micrread":case"micrcleaning":case"micrcancel":this.MICRReader.fireOnReceive(res,sq);break;case"print":var tmp=res;tmp.eventtype=this.ReceiptPrinter.methodName;this.fireOnReceive(tmp,sq);break;default:this.fireOnReceive(res,sq);break}},client_onxmlresult:function(res,sq){this.ReceiptPrinter.fireOnReceive(res,sq)},fireOnReceive:function(res,sq){if(this.onreceive==null){return}if(res==null){return}this.onreceive({eventtype:res.eventtype,success:res.success,code:res.code,status:res.status},sq)},callEvent:function(eventName,data){var eventReq=data;eventReq.type=eventName;return this.send(eventReq)},send:function(data){var eposmsg=MessageFactory.getDeviceDataMessage(this.deviceID,data,this.isCrypto);var sequence=-1;try{this.connectionObj.emit(eposmsg);sequence=eposmsg.sequence}catch(e){}return sequence}};function ReceiptPrinter(parent){this.parent=parent;this.methodName="";this.deviceID=this.parent.deviceID;this.ePosDev=this.parent.ePosDev;this.connectionObj=null;this.SUCCESS="SUCCESS";this.CANCEL="CANCEL";this.ERROR_PARAMMETER="ERROR_PARAMMETER";this.ERROR_COMMAND="ERROR_COMMAND";this.ERROR_DEVICE_NOT_FOUND="DeviceNotFound";this.ERROR_DEVICE_BUSY="ERROR_DEVICE_BUSY";this.ERROR_NOT_SUPPORTED="ERROR_NOT_SUPPORTED";this.ERROR_COVER_OPEN="EPTR_COVER_OPEN";this.ERROR_TIMEOUT="EX_TIMEOUT";this.ERROR_AUTOMATICAL="EPTR_AUTOMATICAL";this.ERROR_UNRECOVERABLE="EPTR_UNRECOVERABLE";this.ERROR_BADPORT="EX_BADPORT";this.SYSTEM_ERROR="SYSTEM_ERROR";this.EPTR_CUTTER="EPTR_CUTTER";this.EPTR_MECHANICAL="EPTR_MECHANICAL";this.EPTR_REC_EMPTY="EPTR_REC_EMPTY";this.EPTR_SCHEMAERROR="SchemaError";this.EPTR_PRINT_SYSTEM_ERROR="PrintSystemError"}ReceiptPrinter.prototype.setConnectionObject=function(connectionObj){this.connectionObj=connectionObj};ReceiptPrinter.prototype=new Printer();ReceiptPrinter.prototype.send=function(){if(this.methodName==""){this.methodName="send"}return Printer.prototype.send.apply(this,arguments)};ReceiptPrinter.prototype.print=function(canvas,cut,mode){this.methodName="print";return Printer.prototype.print.apply(this,arguments)};ReceiptPrinter.prototype.recover=function(){this.methodName="recover";return Printer.prototype.recover.apply(this,arguments)};ReceiptPrinter.prototype.reset=function(){this.methodName="reset";return Printer.prototype.reset.apply(this,arguments)};ReceiptPrinter.prototype.fireOnReceive=function(res,sq){if(this.onreceive==null){return}var eventtype=this.methodName;var success="false";var code="";var status=this.ASB_NO_RESPONSE;if(res){var xml=res.resultdata;success=/success\s*=\s*"\s*(1|true)\s*"/.test(xml);xml.match(/code\s*=\s*"\s*(\S*)\s*"/);code=RegExp.$1;if(code==""){code=(success)?"SUCCESS":"ERROR_DEVICE_NOT_FOUND"}xml.match(/status\s*=\s*"\s*(\d+)\s*"/);status=parseInt(RegExp.$1)}if(code=="EX_ENPC_TIMEOUT"){code="ERROR_DEVICE_BUSY"}this.onreceive({eventtype:eventtype,success:success,code:code,status:status},sq);this.methodName=""};function SlipPrinter(parent){this.parent=parent;this.SUCCESS="SUCCESS";this.CANCEL="CANCEL";this.ERROR_PARAMMETER="ERROR_PARAMMETER";this.ERROR_COMMAND="ERROR_COMMAND";this.ERROR_DEVICE_NOT_FOUND="ERROR_DEVICE_NOT_FOUND";this.ERROR_DEVICE_BUSY="ERROR_DEVICE_BUSY";this.ERROR_NOT_SUPPORTED="ERROR_NOT_SUPPORTED";this.ERROR_COVER_OPEN="ERROR_COVER_OPEN";this.ERROR_TIMEOUT="ERROR_TIMEOUT";this.ERROR_AUTOMATICAL="ERROR_AUTOMATICAL";this.ERROR_UNRECOVERABLE="ERROR_UNRECOVERABLE";this.ERROR_BADPORT="ERROR_BADPORT";this.SYSTEM_ERROR="SYSTEM_ERROR";this.EPTR_CUTTER="EPTR_CUTTER";this.EPTR_MECHANICAL="EPTR_MECHANICAL";this.EPTR_REC_EMPTY="EPTR_REC_EMPTY";this.EPTR_SCHEMAERROR="EPTR_SCHEMAERROR";this.EPTR_PRINT_SYSTEM_ERROR="EPTR_PRINT_SYSTEM_ERROR"}SlipPrinter.prototype=new ePOSBuilder();SlipPrinter.prototype.timeout=60000;SlipPrinter.prototype.send=function(){var xml=(arguments.length<1)?this.toString():arguments[1];var data={type:"slipprint",timeout:this.timeout,printdata:xml};var sequence=this.parent.send(data);this.setXmlString("");return sequence};SlipPrinter.prototype.setXmlString=function(xml){this.message=xml};SlipPrinter.prototype.getXmlString=function(){return this.message};SlipPrinter.prototype.cancel=function(){var data={type:"slipcancel"};return this.parent.send(data)};SlipPrinter.prototype.fireOnReceive=function(res,sq){if(this.onreceive==null){return}if(res==null){return}var eventtype="";switch(res.eventtype){case"slipprint":eventtype="send";break;case"slipcancel":eventtype="cancel";break;default:break}var code=res.code;if(code=="EX_ENPC_TIMEOUT"){code="ERROR_DEVICE_BUSY"}this.onreceive({eventtype:eventtype,success:res.success,code:code,status:res.status},sq)};function EndorsePrinter(parent){this.parent=parent;this.mode40cpl=false;this.SUCCESS="SUCCESS";this.CANCEL="CANCEL";this.ERROR_PARAMMETER="ERROR_PARAMMETER";this.ERROR_COMMAND="ERROR_COMMAND";this.ERROR_DEVICE_NOT_FOUND="ERROR_DEVICE_NOT_FOUND";this.ERROR_DEVICE_BUSY="ERROR_DEVICE_BUSY";this.ERROR_NOT_SUPPORTED="ERROR_NOT_SUPPORTED";this.ERROR_COVER_OPEN="ERROR_COVER_OPEN";this.ERROR_TIMEOUT="ERROR_TIMEOUT";this.ERROR_AUTOMATICAL="ERROR_AUTOMATICAL";this.ERROR_UNRECOVERABLE="ERROR_UNRECOVERABLE";this.ERROR_BADPORT="ERROR_BADPORT";this.SYSTEM_ERROR="SYSTEM_ERROR";this.EPTR_CUTTER="EPTR_CUTTER";this.EPTR_MECHANICAL="EPTR_MECHANICAL";this.EPTR_REC_EMPTY="EPTR_REC_EMPTY";this.EPTR_SCHEMAERROR="EPTR_SCHEMAERROR";this.EPTR_PRINT_SYSTEM_ERROR="EPTR_PRINT_SYSTEM_ERROR"}EndorsePrinter.prototype=new ePOSBuilder();EndorsePrinter.prototype.timeout=60000;EndorsePrinter.prototype.send=function(){var xml=(arguments.length<1)?this.toString():arguments[1];var data={type:"endorseprint",is40cplmode:this.mode40cpl,timeout:this.timeout,printdata:xml};var sequence=this.parent.send(data);this.setXmlString("");return sequence};EndorsePrinter.prototype.setXmlString=function(xml){this.message=xml};EndorsePrinter.prototype.getXmlString=function(){return this.message};EndorsePrinter.prototype.cancel=function(){var data={type:"endorsecancel"};return this.parent.send(data)};EndorsePrinter.prototype.enable40cplmode=function(flag){this.mode40cpl=flag};EndorsePrinter.prototype.fireOnReceive=function(res,sq){if(this.onreceive==null){return}if(res==null){return}var eventtype="";switch(res.eventtype){case"endorseprint":eventtype="send";break;case"endorsecancel":eventtype="cancel";break;default:break}var code=res.code;if(code=="EX_ENPC_TIMEOUT"){code="ERROR_DEVICE_BUSY"}this.onreceive({eventtype:eventtype,success:res.success,code:code,status:res.status},sq)};function MICRReader(parent){this.parent=parent;this.timeout=60000;this.FONT_E13B="MICR_E13B";this.FONT_CMC7="MICR_CMC7";this.SUCCESS="SUCCESS";this.CANCEL="CANCEL";this.ERROR_PARAMMETER="ERROR_PARAMMETER";this.ERROR_COMMAND="ERROR_COMMAND";this.ERROR_DEVICE_NOT_FOUND="ERROR_DEVICE_NOT_FOUND";this.ERROR_DEVICE_BUSY="ERROR_DEVICE_BUSY";this.ERROR_NOT_SUPPORTED="ERROR_NOT_SUPPORTED";this.ERROR_COVER_OPEN="ERROR_COVER_OPEN";this.ERROR_TIMEOUT="ERROR_TIMEOUT";this.ERROR_AUTOMATICAL="ERROR_AUTOMATICAL";this.ERROR_UNRECOVERABLE="ERROR_UNRECOVERABLE";this.ERROR_BADPORT="ERROR_BADPORT";this.SYSTEM_ERROR="SYSTEM_ERROR";this.EMICR_ILLEGAL_LENGTH="EMICR_ILLEGAL_LENGTH";this.EMICR_NO_MICR="EMICR_NO_MICR";this.EMICR_RECOGNITION="EMICR_RECOGNITION";this.EMICR_READ="EMICR_READ";this.EMICR_NOISE_DETECTED="EMICR_NOISE_DETECTED";this.EMICR_COVER_OPENED="EMICR_COVER_OPENED";this.EMICR_PAPER_JAM="EMICR_PAPER_JAM"}MICRReader.prototype.read=function(ignoreerror,font){var data={type:"micrread",ignoreerror:ignoreerror,font:font,timeout:this.timeout};return this.parent.send(data)};MICRReader.prototype.cleaning=function(){var data={type:"micrcleaning",timeout:this.timeout};return this.parent.send(data)};MICRReader.prototype.cancel=function(){var data={type:"micrcancel"};return this.parent.send(data)};MICRReader.prototype.fireOnReceive=function(res,sq){if(this.onreceive==null){return}if(res==null){return}var eventtype="";switch(res.eventtype){case"micrread":eventtype="read";break;case"micrcleaning":eventtype="cleaning";break;case"micrcancel":eventtype="cancel";break;default:break}var code=res.code;if(code=="EX_ENPC_TIMEOUT"){code="ERROR_DEVICE_BUSY"}this.onreceive({eventtype:eventtype,success:res.success,code:code,status:res.status,data:res.data},sq)};function HybridPrinter2(deviceID,isCrypto,ePOSDeviceContext){this.deviceID=deviceID;this.isCrypto=isCrypto;this.ePosDev=ePOSDeviceContext;this.connectionObj=null;this.ReceiptPrinter=null;this.SlipPrinter2=null;this.ValidationPrinter=null;this.EndorsePrinter2=null;this.MICRReader2=null;this.currentPrinter=null;this.isMicrMode=false;this.FONT_A="font_a";this.FONT_B="font_b";this.FONT_C="font_c";this.FONT_D="font_d";this.FONT_E="font_e";this.FONT_SPECIAL_A="special_a";this.FONT_SPECIAL_B="special_b";this.ALIGN_LEFT="left";this.ALIGN_CENTER="center";this.ALIGN_RIGHT="right";this.COLOR_NONE="none";this.COLOR_1="color_1";this.COLOR_2="color_2";this.COLOR_3="color_3";this.COLOR_4="color_4";this.FEED_PEELING="peeling";this.FEED_CUTTING="cutting";this.FEED_CURRENT_TOF="current_tof";this.FEED_NEXT_TOF="next_tof";this.MODE_MONO="mono";this.MODE_GRAY16="gray16";this.BARCODE_UPC_A="upc_a";this.BARCODE_UPC_E="upc_e";this.BARCODE_EAN13="ean13";this.BARCODE_JAN13="jan13";this.BARCODE_EAN8="ean8";this.BARCODE_JAN8="jan8";this.BARCODE_CODE39="code39";this.BARCODE_ITF="itf";this.BARCODE_CODABAR="codabar";this.BARCODE_CODE93="code93";this.BARCODE_CODE128="code128";this.BARCODE_GS1_128="gs1_128";this.BARCODE_GS1_DATABAR_OMNIDIRECTIONAL="gs1_databar_omnidirectional";this.BARCODE_GS1_DATABAR_TRUNCATED="gs1_databar_truncated";this.BARCODE_GS1_DATABAR_LIMITED="gs1_databar_limited";this.BARCODE_GS1_DATABAR_EXPANDED="gs1_databar_expanded";this.HRI_NONE="none";this.HRI_ABOVE="above";this.HRI_BELOW="below";this.HRI_BOTH="both";this.SYMBOL_PDF417_STANDARD="pdf417_standard";this.SYMBOL_PDF417_TRUNCATED="pdf417_truncated";this.SYMBOL_QRCODE_MODEL_1="qrcode_model_1";this.SYMBOL_QRCODE_MODEL_2="qrcode_model_2";this.SYMBOL_QRCODE_MICRO="qrcode_micro";this.SYMBOL_MAXICODE_MODE_2="maxicode_mode_2";this.SYMBOL_MAXICODE_MODE_3="maxicode_mode_3";this.SYMBOL_MAXICODE_MODE_4="maxicode_mode_4";this.SYMBOL_MAXICODE_MODE_5="maxicode_mode_5";this.SYMBOL_MAXICODE_MODE_6="maxicode_mode_6";this.SYMBOL_GS1_DATABAR_STACKED="gs1_databar_stacked";this.SYMBOL_GS1_DATABAR_STACKED_OMNIDIRECTIONAL="gs1_databar_stacked_omnidirectional";this.SYMBOL_GS1_DATABAR_EXPANDED_STACKED="gs1_databar_expanded_stacked";this.SYMBOL_AZTECCODE_FULLRANGE="azteccode_fullrange";this.SYMBOL_AZTECCODE_COMPACT="azteccode_compact";this.SYMBOL_DATAMATRIX_SQUARE="datamatrix_square";this.SYMBOL_DATAMATRIX_RECTANGLE_8="datamatrix_rectangle_8";this.SYMBOL_DATAMATRIX_RECTANGLE_12="datamatrix_rectangle_12";this.SYMBOL_DATAMATRIX_RECTANGLE_16="datamatrix_rectangle_16";this.LEVEL_0="level_0";this.LEVEL_1="level_1";this.LEVEL_2="level_2";this.LEVEL_3="level_3";this.LEVEL_4="level_4";this.LEVEL_5="level_5";this.LEVEL_6="level_6";this.LEVEL_7="level_7";this.LEVEL_8="level_8";this.LEVEL_L="level_l";this.LEVEL_M="level_m";this.LEVEL_Q="level_q";this.LEVEL_H="level_h";this.LEVEL_DEFAULT="default";this.LINE_THIN="thin";this.LINE_MEDIUM="medium";this.LINE_THICK="thick";this.LINE_THIN_DOUBLE="thin_double";this.LINE_MEDIUM_DOUBLE="medium_double";this.LINE_THICK_DOUBLE="thick_double";this.DIRECTION_LEFT_TO_RIGHT="left_to_right";this.DIRECTION_BOTTOM_TO_TOP="bottom_to_top";this.DIRECTION_RIGHT_TO_LEFT="right_to_left";this.DIRECTION_TOP_TO_BOTTOM="top_to_bottom";this.CUT_NO_FEED="no_feed";this.CUT_FEED="feed";this.CUT_RESERVE="reserve";this.DRAWER_1="drawer_1";this.DRAWER_2="drawer_2";this.PULSE_100="pulse_100";this.PULSE_200="pulse_200";this.PULSE_300="pulse_300";this.PULSE_400="pulse_400";this.PULSE_500="pulse_500";this.PATTERN_NONE="none";this.PATTERN_0="pattern_0";this.PATTERN_1="pattern_1";this.PATTERN_2="pattern_2";this.PATTERN_3="pattern_3";this.PATTERN_4="pattern_4";this.PATTERN_5="pattern_5";this.PATTERN_6="pattern_6";this.PATTERN_7="pattern_7";this.PATTERN_8="pattern_8";this.PATTERN_9="pattern_9";this.PATTERN_10="pattern_10";this.PATTERN_A="pattern_a";this.PATTERN_B="pattern_b";this.PATTERN_C="pattern_c";this.PATTERN_D="pattern_d";this.PATTERN_E="pattern_e";this.PATTERN_ERROR="error";this.PATTERN_PAPER_END="paper_end";this.LAYOUT_RECEIPT="receipt";this.LAYOUT_RECEIPT_BM="receipt_bm";this.LAYOUT_LABEL="label";this.LAYOUT_LABEL_BM="label_bm";this.HALFTONE_DITHER=0;this.HALFTONE_ERROR_DIFFUSION=1;this.HALFTONE_THRESHOLD=2;this.ASB_NO_RESPONSE=1;this.ASB_PRINT_SUCCESS=2;this.ASB_DRAWER_KICK=4;this.ASB_OFF_LINE=8;this.ASB_COVER_OPEN=32;this.ASB_PAPER_FEED=64;this.ASB_WAIT_ON_LINE=256;this.ASB_PANEL_SWITCH=512;this.ASB_MECHANICAL_ERR=1024;this.ASB_AUTOCUTTER_ERR=2048;this.ASB_UNRECOVER_ERR=8192;this.ASB_AUTORECOVER_ERR=16384;this.ASB_INSERTION_WAIT_PAPER=65536;this.ASB_RECEIPT_NEAR_END=131072;this.ASB_REMOVAL_WAIT_PAPER=262144;this.ASB_RECEIPT_END=524288;this.ASB_TOF_NOPAPER=2097152;this.ASB_BOF_NOPAPER=4194304;this.ASB_SLIP_NO_SELECT=16777216;this.ASB_SLIP_IMPOSSIBLE_PRINT=33554432;this.ASB_EJD_NOPAPER=1073741824;this.ASB_VALIDATION_NO_SELECT=67108864;this.ASB_VALIDATION_IMPOSSIBLE_PRINT=134217728;this.ASB_SPOOLER_IS_STOPPED=2147483648;this.DRAWER_OPEN_LEVEL_LOW=0;this.DRAWER_OPEN_LEVEL_HIGH=1;this.SUCCESS="SUCCESS";this.CANCEL="CANCEL";this.ERROR_CANCEL_FAILED="ERROR_CANCEL_FAILED";this.ERROR_PARAMMETER="ERROR_PARAMMETER";this.ERROR_COMMAND="ERROR_COMMAND";this.ERROR_DEVICE_NOT_FOUND="ERROR_DEVICE_NOT_FOUND";this.ERROR_DEVICE_BUSY="ERROR_DEVICE_BUSY";this.ERROR_NOT_SUPPORTED="ERROR_NOT_SUPPORTED";this.ERROR_COVER_OPEN="ERROR_COVER_OPEN";this.ERROR_TIMEOUT="ERROR_TIMEOUT";this.ERROR_AUTOMATICAL="ERROR_AUTOMATICAL";this.ERROR_UNRECOVERABLE="ERROR_UNRECOVERABLE";this.ERROR_BADPORT="ERROR_BADPORT";this.SYSTEM_ERROR="SYSTEM_ERROR";this.EPTR_AUTOMATICAL="EPTR_AUTOMATICAL";this.EPTR_COVER_OPEN="EPTR_COVER_OPEN";this.EPTR_CUTTER="EPTR_CUTTER";this.EPTR_MECHANICAL="EPTR_MECHANICAL";this.EPTR_REC_EMPTY="EPTR_REC_EMPTY";this.EPTR_UNRECOVERABLE="EPTR_UNRECOVERABLE";this.EPTR_SCHEMAERROR="EPTR_SCHEMAERROR";this.EPTR_PRINT_SYSTEM_ERROR="EPTR_PRINT_SYSTEM_ERROR";this.EPTR_PAPER_PULLED_OUT="EPTR_PAPER_PULLED_OUT";this.EMICR_ILLEGAL_LENGTH="EMICR_ILLEGAL_LENGTH";this.EMICR_NO_MICR="EMICR_NO_MICR";this.EMICR_RECOGNITION="EMICR_RECOGNITION";this.EMICR_READ="EMICR_READ";this.EMICR_NOISE_DETECTED="EMICR_NOISE_DETECTED";this.EMICR_COVER_OPENED="EMICR_COVER_OPENED";this.EMICR_PAPER_JAM="EMICR_PAPER_JAM";this.EMICR_PAPER_PULLED_OUT="EMICR_PAPER_PULLED_OUT";this.DeviceNotFound="DeviceNotFound";this.EX_TIMEOUT="EX_TIMEOUT";this.EX_BADPORT="EX_BADPORT";this.SchemaError="SchemaError";this.PrintSystemError="PrintSystemError";this.PAPERTYPE_RECEIPT=0;this.PAPERTYPE_SLIP=1;this.PAPERTYPE_ENDORSE=2;this.PAPERTYPE_VALIDATION=3;this.FONT_E13B="MICR_E13B";this.FONT_CMC7="MICR_CMC7";this.halftone=this.HALFTONE_DITHER;this.brightness=1;this.force=false;this.drawerOpenLevel=this.DRAWER_OPEN_LEVEL_LOW;this.paperType=this.PAPERTYPE_RECEIPT;this.interval=3000;this.waitTime=500;this.enable40cplMode=true;this.onstatuschange=null;this.ononline=null;this.onoffline=null;this.onpoweroff=null;this.oncoveropen=null;this.onpaperok=null;this.onpapernearend=null;this.onpaperend=null;this.ondrawerclosed=null;this.ondraweropen=null;this.init(deviceID)}HybridPrinter2.prototype.init=function(deviceID){this.deviceID=deviceID;this.ReceiptPrinter=new ReceiptPrinter(this);this.SlipPrinter2=new SlipPrinter2(this);this.ValidationPrinter=new ValidationPrinter(this);this.EndorsePrinter2=new EndorsePrinter2(this);this.MICRReader2=new MICRReader2(this);this.currentPrinter=this.ReceiptPrinter;this.ReceiptPrinter.onstatuschange=function(status){if(this.parent.onstatuschange!=null){this.parent.onstatuschange(status)}};this.ReceiptPrinter.ononline=function(){if(this.parent.ononline!=null){this.parent.ononline()}};this.ReceiptPrinter.onoffline=function(){if(this.parent.onoffline!=null){this.parent.onoffline()}};this.ReceiptPrinter.onpoweroff=function(){if(this.parent.onpoweroff!=null){this.parent.onpoweroff()}};this.ReceiptPrinter.oncoveropen=function(){if(this.parent.oncoveropen!=null){this.parent.oncoveropen()}};this.ReceiptPrinter.oncoverok=function(){if(this.parent.oncoverok!=null){this.parent.oncoverok()}};this.ReceiptPrinter.onpaperok=function(){if(this.parent.onpaperok!=null){this.parent.onpaperok()}};this.ReceiptPrinter.onpapernearend=function(){if(this.parent.onpapernearend!=null){this.parent.onpapernearend()}};this.ReceiptPrinter.onpaperend=function(){if(this.parent.onpaperend!=null){this.parent.onpaperend()}};this.ReceiptPrinter.ondrawerclosed=function(){if(this.parent.ondrawerclosed!=null){this.parent.ondrawerclosed()}};this.ReceiptPrinter.ondraweropen=function(){if(this.parent.ondraweropen!=undefined){this.parent.ondraweropen()}};this.ReceiptPrinter.onreceive=function(res,sq){this.parent.fireOnReceive(res,sq)};this.SlipPrinter2.onreceive=function(res,sq){this.parent.fireOnReceive(res,sq)};this.EndorsePrinter2.onreceive=function(res,sq){this.parent.fireOnReceive(res,sq)};this.ValidationPrinter.onreceive=function(res,sq){this.parent.fireOnReceive(res,sq)};this.MICRReader2.onreceive=function(res,sq){this.parent.fireOnReceive(res,sq)}};HybridPrinter2.prototype.setConnectionObject=function(connectionObj){this.connectionObj=connectionObj;this.ReceiptPrinter.setConnectionObject(this.connectionObj)};HybridPrinter2.prototype.isValidFunction=function(paperType,supportPaperTypes){var isValid=false;var index=0;if(supportPaperTypes.length!=0){for(index=0;index<supportPaperTypes.length;index++){if(paperType==supportPaperTypes[index]){isValid=true;break}}}return isValid};HybridPrinter2.prototype.addText=function(data){this.currentPrinter.addText.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addTextLang=function(lang){this.currentPrinter.addTextLang.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addTextAlign=function(align){this.currentPrinter.addTextAlign.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addTextRotate=function(rotate){this.currentPrinter.addTextRotate.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addTextLineSpace=function(linespc){this.currentPrinter.addTextLineSpace.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addTextFont=function(font){this.currentPrinter.addTextFont.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addTextSmooth=function(smooth){this.currentPrinter.addTextSmooth.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addTextDouble=function(dw,dh){this.currentPrinter.addTextDouble.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addTextSize=function(width,height){this.currentPrinter.addTextSize.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addTextStyle=function(reverse,ul,em,color){this.currentPrinter.addTextStyle.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addTextPosition=function(x){this.currentPrinter.addTextPosition.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addTextVPosition=function(y){this.currentPrinter.addTextVPosition.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addFeedUnit=function(unit){this.currentPrinter.addFeedUnit.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addFeedLine=function(line){this.currentPrinter.addFeedLine.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addFeed=function(){this.currentPrinter.addFeed.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addFeedPosition=function(pos){this.currentPrinter.addFeedPosition.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addImage=function(context,x,y,width,height,color,mode){this.currentPrinter.halftone=this.halftone;this.currentPrinter.brightness=this.brightness;this.currentPrinter.addImage.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addLogo=function(key1,key2){this.currentPrinter.addLogo.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addBarcode=function(data,type,hri,font,width,height){this.currentPrinter.addBarcode.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addSymbol=function(data,type,level,width,height,size){this.currentPrinter.addSymbol.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addHLine=function(x1,x2,style){this.currentPrinter.addHLine.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addVLineBegin=function(x,style){this.currentPrinter.addVLineBegin.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addVLineEnd=function(x,style){this.currentPrinter.addVLineEnd.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addPageBegin=function(){this.currentPrinter.addPageBegin.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addPageEnd=function(){this.currentPrinter.addPageEnd.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addPageArea=function(x,y,width,height){this.currentPrinter.addPageArea.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addPageDirection=function(dir){this.currentPrinter.addPageDirection.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addPagePosition=function(x,y){this.currentPrinter.addPagePosition.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addPageLine=function(x1,y1,x2,y2,style){this.currentPrinter.addPageLine.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addPageRectangle=function(x1,y1,x2,y2,style){this.currentPrinter.addPageRectangle.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addCut=function(type){this.ReceiptPrinter.addCut.apply(this.ReceiptPrinter,arguments);return this};HybridPrinter2.prototype.addPulse=function(drawer,time){this.currentPrinter.addPulse.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addSound=function(pattern,repeat,cycle){this.currentPrinter.addSound.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.addLayout=function(type,width,height,margin_top,margin_bottom,offset_cut,offset_label){this.ReceiptPrinter.addLayout.apply(this.ReceiptPrinter,arguments);return this};HybridPrinter2.prototype.addRecovery=function(){this.ReceiptPrinter.addRecovery.apply(this.ReceiptPrinter,arguments);return this};HybridPrinter2.prototype.addReset=function(){this.ReceiptPrinter.addReset.apply(this.ReceiptPrinter,arguments);return this};HybridPrinter2.prototype.addCommand=function(data){this.currentPrinter.addCommand.apply(this.currentPrinter,arguments);return this};HybridPrinter2.prototype.recover=function(){this.ReceiptPrinter.recover.apply(this.ReceiptPrinter,arguments);return this};HybridPrinter2.prototype.reset=function(){this.ReceiptPrinter.force=this.force;var ret=this.ReceiptPrinter.reset.apply(this.ReceiptPrinter,arguments);this.force=false;return ret};HybridPrinter2.prototype.setMessage=function(message){this.currentPrinter.message=message};HybridPrinter2.prototype.getMessage=function(){return this.currentPrinter.message};HybridPrinter2.prototype.startMonitor=function(){var delay=this.interval;if((typeof(this.interval)!="number")||delay<1000||6000<delay){delay=3000}this.ReceiptPrinter.interval=delay;return this.ReceiptPrinter.startMonitor()};HybridPrinter2.prototype.stopMonitor=function(){return this.ReceiptPrinter.stopMonitor()};HybridPrinter2.prototype.lock=function(){var data={type:"lock"};return this.send(data)};HybridPrinter2.prototype.unlock=function(){var data={type:"unlock"};return this.send(data)};HybridPrinter2.prototype.selectPaperType=function(paperType){if(this.isValidFunction(paperType,[this.PAPERTYPE_RECEIPT,this.PAPERTYPE_SLIP,this.PAPERTYPE_ENDORSE,this.PAPERTYPE_VALIDATION])!=true){throw new Error('Property "paperType" is invalid')}switch(paperType){case this.PAPERTYPE_RECEIPT:this.currentPrinter=this.ReceiptPrinter;break;case this.PAPERTYPE_SLIP:this.currentPrinter=this.SlipPrinter2;break;case this.PAPERTYPE_ENDORSE:this.currentPrinter=this.EndorsePrinter2;break;case this.PAPERTYPE_VALIDATION:this.currentPrinter=this.ValidationPrinter;break;default:this.currentPrinter=this.ReceiptPrinter;break}this.paperType=paperType;return this};HybridPrinter2.prototype.waitInsertion=function(timeout){if(this.isValidFunction(this.paperType,[this.PAPERTYPE_SLIP,this.PAPERTYPE_ENDORSE,this.PAPERTYPE_VALIDATION])!=true){throw new Error('Property "paperType" is invalid')}this.currentPrinter.waitTime=this.waitTime;var ret=this.currentPrinter.waitInsertion.apply(this.currentPrinter,arguments);return ret};HybridPrinter2.prototype.cancelInsertion=function(){var ret=null;if(this.isMicrMode){ret=this.MICRReader2.cancel.apply(this.MICRReader2,arguments)}else{if(this.isValidFunction(this.paperType,[this.PAPERTYPE_SLIP,this.PAPERTYPE_ENDORSE,this.PAPERTYPE_VALIDATION])!=true){throw new Error('Property "paperType" is invalid')}ret=this.currentPrinter.cancel.apply(this.currentPrinter,arguments)}return ret};HybridPrinter2.prototype.ejectPaper=function(){var data={type:"eject"};return this.send(data)};HybridPrinter2.prototype.sendData=function(timeout){this.currentPrinter.isCrypto=this.isCrypto;if((typeof(timeout)!="number")||(timeout<1)||(timeout>1000000)){this.currentPrinter.timeout=0}else{this.currentPrinter.timeout=timeout}this.EndorsePrinter2.enable40cplmode(this.enable40cplMode);this.currentPrinter.force=this.force;var ret=this.currentPrinter.send();this.force=false;return ret};HybridPrinter2.prototype.print=function(canvas,cut,mode,timeout){if((typeof(timeout)!="number")||(timeout<1)||(timeout>1000000)){this.ReceiptPrinter.timeout=0}else{this.ReceiptPrinter.timeout=timeout}this.ReceiptPrinter.print.apply(this.ReceiptPrinter,[canvas,cut,mode]);return this};HybridPrinter2.prototype.readMicrData=function(ignoreerror,micrFont,timeout){var ignoreerrorMicr=ignoreerror;var micrFontMicr=micrFont;if(typeof(ignoreerror)=="undefined"){ignoreerrorMicr=true}if(typeof(micrFont)=="undefined"){micrFontMicr=this.FONT_E13B}this.MICRReader2.timeout=timeout;this.MICRReader2.waitTime=this.waitTime;this.MICRReader2.read.apply(this.MICRReader2,[ignoreerrorMicr,micrFontMicr]);this.isMicrMode=true;return this};HybridPrinter2.prototype.cleanMicrReader=function(timeout){this.MICRReader2.timeout=timeout;this.MICRReader2.cleaning.apply(this.MICRReader2,[]);this.isMicrMode=true;return this};HybridPrinter2.prototype.client_onreceive=function(res,sq){switch(res.eventtype){case"slipprint2":case"slipcancel":case"slipwaitinsertion":this.SlipPrinter2.fireOnReceive(res,sq);break;case"endorseprint2":case"endorsecancel":case"endorsewaitinsertion":this.EndorsePrinter2.fireOnReceive(res,sq);break;case"validationprint2":case"validationcancel":case"validationwaitinsertion":this.ValidationPrinter.fireOnReceive(res,sq);break;case"micrread":case"micrcleaning":case"micrcancel":this.MICRReader2.fireOnReceive(res,sq);break;case"print":var tmp=res;tmp.eventtype=this.ReceiptPrinter.methodName;this.fireOnReceive(tmp,sq);break;default:this.fireOnReceive(res,sq);break}};HybridPrinter2.prototype.client_onxmlresult=function(res,sq){this.ReceiptPrinter.fireOnReceive(res,sq)};HybridPrinter2.prototype.fireOnReceive=function(res,sq){if(typeof(this.onreceive)==undefined){return}if(res==null){return}var eventtype=res.eventtype;var success=res.success;var code=res.code;var status=res.status;var data=res.data;switch(res.eventtype){case"send":eventtype="sendData";if(code==this.SUCCESS){this.isMicrMode=false}break;case"waitinsertion":eventtype="waitInsertion";if(code==this.SUCCESS){this.isMicrMode=false}break;case"read":eventtype="readMicrData";if(code==this.SUCCESS){this.isMicrMode=true}break;case"cleaning":eventtype="cleanMicrReader";if(code==this.SUCCESS){this.isMicrMode=true}break;case"cancel":eventtype="cancelInsertion";break;case"eject":eventtype="ejectPaper";if(code==this.SUCCESS){this.isMicrMode=false}break;default:break}switch(code){case"EX_ENPC_TIMEOUT":code="ERROR_DEVICE_BUSY";break;case"CANCEL":this.isMicrMode=false;break;default:break}this.onreceive({method:eventtype,success:success,code:code,status:status,data:data},sq)};HybridPrinter2.prototype.callEvent=function(eventName,data){var eventReq=data;eventReq.type=eventName;return this.send(eventReq)};HybridPrinter2.prototype.send=function(data){var eposmsg=MessageFactory.getDeviceDataMessage(this.deviceID,data,this.isCrypto);var sequence=-1;try{this.connectionObj.emit(eposmsg);sequence=eposmsg.sequence}catch(e){}return sequence};function SlipPrinter2(parent){this.parent=parent}SlipPrinter2.prototype=new SlipPrinter();SlipPrinter2.prototype.timeout=60000;SlipPrinter2.prototype.waitTime=500;SlipPrinter2.prototype.send=function(){var xml=null;if(arguments.length<1){xml=this.toString()}else{xml=arguments[1]}if((typeof(this.timeout)!="number")||(this.timeout<5000)||(this.timeout>1000000)){this.timeout=10000}var data={type:"slipprint2",timeout:this.timeout,printdata:xml};var sequence=this.parent.send(data);this.setXmlString("");return sequence};SlipPrinter2.prototype.setXmlString=function(xml){this.message=xml};SlipPrinter2.prototype.getXmlString=function(){return this.message};SlipPrinter2.prototype.waitInsertion=function(timeout){if((typeof(timeout)!="number")||(timeout<5000)||(timeout>900000)){this.timeout=60000}else{this.timeout=timeout}var slipWaitTime=this.waitTime;if((typeof(this.waitTime)!="number")||(this.waitTime<0)||(this.waitTime>6400)){slipWaitTime=500}var data={type:"slipwaitinsertion",timeout:this.timeout,waittime:slipWaitTime};return this.parent.send(data)};SlipPrinter2.prototype.cancel=function(){var data={type:"slipcancel"};return this.parent.send(data)};SlipPrinter2.prototype.fireOnReceive=function(res,sq){if(this.onreceive==null){return}if(res==null){return}var eventtype="";switch(res.eventtype){case"slipprint2":eventtype="send";break;case"slipcancel":eventtype="cancel";break;case"slipwaitinsertion":eventtype="waitinsertion";break;default:break}this.onreceive({eventtype:eventtype,success:res.success,code:res.code,status:res.status},sq)};function EndorsePrinter2(parent){this.parent=parent;this.mode40cpl=false}EndorsePrinter2.prototype=new EndorsePrinter();EndorsePrinter2.prototype.timeout=60000;EndorsePrinter2.prototype.waitTime=500;EndorsePrinter2.prototype.send=function(){var xml=null;if(arguments.length<1){xml=this.toString()}else{xml=arguments[1]}if((typeof(this.timeout)!="number")||(this.timeout<60000)||(this.timeout>900000)){this.timeout=60000}var data={type:"endorseprint2",is40cplmode:this.mode40cpl,timeout:this.timeout,printdata:xml};var sequence=this.parent.send(data);this.setXmlString("");return sequence};EndorsePrinter2.prototype.setXmlString=function(xml){this.message=xml};EndorsePrinter2.prototype.getXmlString=function(){return this.message};EndorsePrinter2.prototype.waitInsertion=function(timeout){if((typeof(timeout)!="number")||(timeout<5000)||(timeout>900000)){this.timeout=60000}else{this.timeout=timeout}var endorseWaitTime=this.waitTime;if((typeof(this.waitTime)!="number")||(this.waitTime<0)||(this.waitTime>6400)){endorseWaitTime=500}var data={type:"endorsewaitinsertion",timeout:this.timeout,waittime:endorseWaitTime};return this.parent.send(data)};EndorsePrinter2.prototype.cancel=function(){var data={type:"endorsecancel"};return this.parent.send(data)};EndorsePrinter2.prototype.enable40cplmode=function(flag){this.mode40cpl=flag};EndorsePrinter2.prototype.fireOnReceive=function(res,sq){if(this.onreceive==null){return}if(res==null){return}var eventtype="";switch(res.eventtype){case"endorseprint2":eventtype="send";break;case"endorsecancel":eventtype="cancel";break;case"endorsewaitinsertion":eventtype="waitinsertion";break;default:break}this.onreceive({eventtype:eventtype,success:res.success,code:res.code,status:res.status},sq)};function MICRReader2(parent){this.parent=parent}MICRReader2.prototype=new MICRReader();MICRReader2.prototype.waitTime=500;MICRReader2.prototype.read=function(ignoreerror,font){if((typeof(this.timeout)!="number")||(this.timeout<5000)||(this.timeout>900000)){this.timeout=60000}var micrWaitTime=this.waitTime;if((typeof(this.waitTime)!="number")||(this.waitTime<0)||(this.waitTime>6400)){micrWaitTime=500}var data={type:"micrread",ignoreerror:ignoreerror,font:font,timeout:this.timeout,waittime:micrWaitTime};return this.parent.send(data)};MICRReader2.prototype.cleaning=function(){var micrWaitTime=this.waitTime;this.timeout=60000;if((typeof(this.waitTime)!="number")||(this.waitTime<0)||(this.waitTime>6400)){micrWaitTime=500}var data={type:"micrcleaning",timeout:this.timeout,waittime:micrWaitTime};return this.parent.send(data)};function ValidationPrinter(parent){this.parent=parent}ValidationPrinter.prototype=new ePOSBuilder();ValidationPrinter.prototype.timeout=10000;ValidationPrinter.prototype.waitTime=500;ValidationPrinter.prototype.send=function(){var xml=null;if(arguments.length<1){xml=this.toString()}else{xml=arguments[1]}if((typeof(this.timeout)!="number")||(this.timeout<5000)||(this.timeout>1000000)){this.timeout=10000}var data={type:"validationprint2",timeout:this.timeout,printdata:xml};var sequence=this.parent.send(data);this.setXmlString("");return sequence};ValidationPrinter.prototype.setXmlString=function(xml){this.message=xml};ValidationPrinter.prototype.getXmlString=function(){return this.message};ValidationPrinter.prototype.waitInsertion=function(timeout){if((typeof(timeout)!="number")||(timeout<5000)||(timeout>900000)){this.timeout=60000}else{this.timeout=timeout}var validationWaitTime=this.waitTime;if((typeof(this.waitTime)!="number")||(this.waitTime<0)||(this.waitTime>6400)){validationWaitTime=500}var data={type:"validationwaitinsertion",timeout:this.timeout,waittime:validationWaitTime};return this.parent.send(data)};ValidationPrinter.prototype.cancel=function(){var data={type:"validationcancel"};return this.parent.send(data)};ValidationPrinter.prototype.fireOnReceive=function(res,sq){if(this.onreceive==null){return}if(res==null){return}var eventtype="";switch(res.eventtype){case"validationprint2":eventtype="send";break;case"validationcancel":eventtype="cancel";break;case"validationwaitinsertion":eventtype="waitinsertion";break;default:break}this.onreceive({eventtype:eventtype,success:res.success,code:res.code,status:res.status},sq)};function Scanner(deviceID,isCrypto){this.deviceID=deviceID;this.isCrypto=isCrypto;this.connectionObj=null}Scanner.prototype={setConnectionObject:function(connectionObj){this.connectionObj=connectionObj},client_ondata:function(data){try{if(this.ondata==null){return}this.ondata(data)}catch(e){}return},client_onbinarydata:function(data){try{if(this.onbinarydata==null){return}this.onbinarydata(data)}catch(e){}return},client_setbinarymode:function(data){try{if(this.onbinarymode==null){return}this.onbinarymode(data)}catch(e){}return},setBinaryMode:function(enable){var str="";if(enable==true){str="true"}else{str="false"}var data={type:"setbinarymode",binarymode:str};var eposmsg=MessageFactory.getDeviceDataMessage(this.deviceID,data,this.isCrypto);var sequence=-1;try{this.connectionObj.emit(eposmsg);sequence=eposmsg.sequence}catch(e){}return sequence},callEvent:function(eventName,data){var eventReq=data;eventReq.type=eventName;var eposmsg=MessageFactory.getDeviceDataMessage(this.deviceID,eventReq,this.isCrypto);var sequence=-1;try{this.connectionObj.emit(eposmsg);sequence=eposmsg.sequence}catch(e){}return sequence}};function SimpleSerial(deviceID,isCrypto){this.deviceID=deviceID;this.isCrypto=isCrypto;this.connectionObj=null}SimpleSerial.prototype={setConnectionObject:function(connectionObj){this.connectionObj=connectionObj},sendCommand:function(command){var data={type:"sendcommand",command:toHexBinary(command)};var eposmsg=MessageFactory.getDeviceDataMessage(this.deviceID,data,this.isCrypto);var sequence=-1;try{this.connectionObj.emit(eposmsg);sequence=eposmsg.sequence}catch(e){}return sequence},client_oncommandreply:function(data){try{if(this.oncommandreply==null){return}var hexData=data.data;hexData=hexData.replace(/[0-9a-fA-F]{2}/g,function(c){var hexNum=parseInt(c,16);return String.fromCharCode(hexNum)});data.data=hexData;this.oncommandreply(data)}catch(e){}return}};function Ofsc(){this.SERVICE_ID="OFSC";this.callback=null;this.connectionObj=null}Ofsc.prototype={setConnectionObject:function(connectionObj){this.connectionObj=connectionObj},send:function(xml,timeout,crypto,callback){this.callback=callback;try{if(this.connectionObj.isUsableDeviceIF()){var data={type:"print",timeout:timeout,printdata:xml};var eposmsg=MessageFactory.getServiceMessage(this.SERVICE_ID,crypto,data);this.connectionObj.emit(eposmsg)}}catch(e){return}},notify:function(eposmsg){var data=null;if(eposmsg.isCrypto=="1"){data=MessageFactory.decrypt(eposmsg.data)}else{data=eposmsg.data}if(this.callback!=null){this.callback(data.resultdata)}},onxmlresult:function(xml){if(this.callback!=null){this.callback(xml)}}};function CookieIO(){this.KEY="EPSON_EPOSDEVICE_CLIENTID";this.EXPIRES_MINUTES=5}CookieIO.prototype={writeId:function(value){var path=location.pathname;if(path.slice(-1)=="/"){path=path+"index.html"}var hostname=location.hostname;var expired=this.getExpiredDate();document.cookie=this.KEY+"_"+hostname+path+"="+escape(value)+"; expires="+expired},readId:function(){var id="";var strCookie=document.cookie+";";var path=location.pathname;if(path.slice(-1)=="/"){path=path+"index.html"}var hostname=location.hostname;var searchKey=this.KEY+"_"+hostname+path+"=";var keyValueFrom=strCookie.indexOf(searchKey);if(keyValueFrom!=-1){keyValueFrom+=searchKey.length;var keyValueTo=strCookie.indexOf(";",keyValueFrom);id=unescape(strCookie.substring(keyValueFrom,keyValueTo))}return id},getExpiredDate:function(){var expire=new Date();var nTime=expire.getTime();expire.setTime(nTime+(1000*60*this.EXPIRE_MINUTES));return expire.toUTCString()}};function DeviceObjElement(deviceId,isCrypto,deviceObject,callback){this.deviceId=deviceId;this.isCrypto=isCrypto;this.deviceObject=deviceObject;this.callback=callback}function DeviceObjElementMap(){this.elementList=new Array()}DeviceObjElementMap.prototype={add:function(element){this.elementList.push(element)},get:function(deviceId){var element=null;for(var i=0;i<this.elementList.length;i++){if(this.elementList[i].deviceId==deviceId){element=this.elementList[i];break}}return element},getByObj:function(deviceObject){var element=null;for(var i=0;i<this.elementList.length;i++){if(this.elementList[i].deviceObject==deviceObject){element=this.elementList[i];break}}return element},remove:function(deviceId){for(var i=0;i<this.elementList.length;i++){if(this.elementList[i].deviceId==deviceId){this.elementList.splice(i,1);break}}},removeAll:function(){this.elementList=[]},getElementList:function(){return this.elementList},};function ePOSDevice(){this.DEVICE_TYPE_SCANNER="type_scanner";this.DEVICE_TYPE_KEYBOARD="type_keyboard";this.DEVICE_TYPE_POSKEYBOARD="type_poskeyboard";this.DEVICE_TYPE_MSR="type_msr";this.DEVICE_TYPE_CAT="type_cat";this.DEVICE_TYPE_CASH_CHANGER="type_cash_changer";this.DEVICE_TYPE_PRINTER="type_printer";this.DEVICE_TYPE_DISPLAY="type_display";this.DEVICE_TYPE_SIMPLE_SERIAL="type_simple_serial";this.DEVICE_TYPE_HYBRID_PRINTER="type_hybrid_printer";this.DEVICE_TYPE_HYBRID_PRINTER2="type_hybrid_printer2";this.DEVICE_TYPE_DT="type_dt";this.DEVICE_TYPE_OTHER_PERIPHERAL="type_other_peripheral";this.RESULT_OK="OK";this.ERROR_SYSTEM="SYSTEM_ERROR";this.ERROR_DEVICE_IN_USE="DEVICE_IN_USE";this.ERROR_DEVICE_OPEN="DEVICE_OPEN_ERROR";this.ERROR_DEVICE_CLOSE="DEVICE_CLOSE_ERROR";this.ERROR_DEVICE_NOT_OPEN="DEVICE_NOT_OPEN";this.ERROR_DEVICE_NOT_FOUND="DEVICE_NOT_FOUND";this.ERROR_PARAMETER="ERROR_PARAMETER";this.IFPORT_EPOSDEVICE=8008;this.IFPORT_EPOSDEVICE_S=8043;this.CONNECT_TIMEOUT=15000;this.RECONNECT_TIMEOUT=3000;this.MAX_RECONNECT_RETRY=5;this.socket=null;this.connectionId=null;this.reconnectTimerId=null;this.reconnectTryCount=0;this.admin="";this.location="";this.recievedDataId=0;this.connectStartTime=0;this.waitRetryConnectId=0;this.conectionObj=new Connection();this.commBoxManager=new CommBoxManager();this.commBoxManager.setConnectionObject(this.conectionObj);this.devObjSelector=new DeviceObjectSelector();this.devObjSelector.setConnectionObject(this.conectionObj);this.devObjElmMap=new DeviceObjElementMap();this.ofsc=new Ofsc();this.ofsc.setConnectionObject(this.conectionObj);this.cookieIo=new CookieIO();this.gbox=new SocketGarbageBox();this.eposprint=false;var self=this;window.onbeforeunload=function(){self.disconnect()};window.onpagehide=function(){self.disconnect()}}ePOSDevice.prototype={connect:function(address,port,callback,options){if((this.conectionObj.status(this.conectionObj.IF_EPOSDEVICE)!=this.conectionObj.DISCONNECT)||(this.conectionObj.status(this.conectionObj.IF_EPOSPRINT)!=this.conectionObj.DISCONNECT)){this.disconnect()}this.connectStartTime=new Date().getTime();var protocol=(port==this.IFPORT_EPOSDEVICE)?"http":"https";this.conectionObj.setAddress(protocol,address,port);this.conectionObj.registCallback(callback);if(arguments.length>=4){this.eposprint=options.eposprint}else{this.eposprint=false}var self=this;if(this.eposprint){var selfofProb=this.conectionObj;this.conectionObj.probeWebServiceIF(function(accessTime){var result=self.ERROR_PARAMETER;if(selfofProb.isUsablePrintIF()){result=self.RESULT_OK}callback(result)})}else{this.connectBySocketIo(this.CONNECT_TIMEOUT,protocol)}},isConnected:function(){var devIsConnect=false;var wsIsConnect=false;switch(this.conectionObj.status(this.conectionObj.IF_EPOSDEVICE)){case this.conectionObj.CONNECT:case this.conectionObj.RECONNECTING:devIsConnect=true;break;case this.conectionObj.DISCONNECT:break}if(this.conectionObj.status(this.conectionObj.IF_EPOSPRINT)==this.conectionObj.CONNECT){wsIsConnect=true}return devIsConnect|wsIsConnect},disconnect:function(){var eposmsg=MessageFactory.getDisconnectMessage(this.connectionId);this.conectionObj.emit(eposmsg);this.cleanup()},createDevice:function(deviceId,deviceType,options,callback){try{if(!this.isConnected()){throw new Error(this.ERROR_SYSTEM)}if(this.devObjElmMap.get(deviceId)!=null){throw new Error(this.ERROR_DEVICE_IN_USE)}if(!this.devObjSelector.isSelectable(deviceType)){throw new Error(this.ERROR_DEVICE_NOT_FOUND)}var isCrypto=false;var isBufferEnable=false;if(typeof(options)=="boolean"){isCrypto=options}else{if(typeof(options.crypto)=="boolean"){isCrypto=options.crypto}if(typeof(options.buffer)=="boolean"){isBufferEnable=options.buffer}}if(deviceType==this.DEVICE_TYPE_DT){isCrypto=true;deviceId="local_dt"}var deviceObject=this.devObjSelector.select(deviceId,deviceType,options.driver,isCrypto,this);deviceObject.setConnectionObject(this.conectionObj);var element=new DeviceObjElement(deviceId,isCrypto,deviceObject,callback);this.devObjElmMap.add(element);if(this.conectionObj.isUsableDeviceIF()){var eposmsg=MessageFactory.getOpenDeviceMessage(deviceId,deviceType,isCrypto,isBufferEnable);this.conectionObj.emit(eposmsg)}else{var self=this;this.checkEposPrintService(deviceId,deviceType,function(result){if(result==self.RESULT_OK){callback(deviceObject,self.RESULT_OK)}else{callback(null,self.ERROR_DEVICE_NOT_FOUND)}})}}catch(e){var message=e.message;if((message==null)||(message=="")){message=this.ERROR_DEVICE_OPEN}if(callback!=null){callback(null,message)}}},deleteDevice:function(deviceObject,callback){try{var element=this.devObjElmMap.getByObj(deviceObject);if(element==null){throw new Error(this.ERROR_DEVICE_NOT_OPEN)}if(this.conectionObj.isUsableDeviceIF()){element.callback=callback;var eposmsg=MessageFactory.getCloseDeviceMessage(element.deviceId);this.conectionObj.emit(eposmsg)}else{try{deviceObject.finalize()}catch(e){}this.devObjElmMap.remove(element.deviceId);callback(this.RESULT_OK)}}catch(e){var message=e.message;if((message==null)||(message=="")){message=this.ERROR_DEVICE_CLOSE}if(callback!=null){callback(message)}}},getAdmin:function(){return this.admin},getLocation:function(){return this.location},sendOfscXml:function(xml,timeout,crypto,callback){this.ofsc.send(xml,timeout,crypto,callback)},getCommBoxManager:function(){if(this.conectionObj.status(this.conectionObj.IF_EPOSDEVICE)!=this.conectionObj.CONNECT){return null}return this.commBoxManager},cleanup:function(){if(this.waitRetryConnectId!=0){clearTimeout(this.waitRetryConnectId);this.waitRetryConnectId=0}this.connectStartTime=0;this.gbox.stock(this.socket);this.gbox.dispose();var devObjList=this.devObjElmMap.getElementList();devObjList.forEach(function(obj){try{obj.deviceObject.finalize()}catch(e){}});devObjList=null;this.devObjElmMap.removeAll();if((this.ondisconnect!=null)&&(this.conectionObj.status(this.conectionObj.IF_EPOSDEVICE)!=this.conectionObj.DISCONNECT||this.conectionObj.status(this.conectionObj.IF_EPOSPRINT)!=this.conectionObj.DISCONNECT)){this.ondisconnect()}this.cookieIo.writeId("");this.conectionObj.changeStatus(this.conectionObj.IF_ALL,this.conectionObj.DISCONNECT);this.socket=null;this.conectionObj.setSocket(null);this.connectionId=null;this.conectionObj.setAddress("","","");if(this.reconnectTimerId!=null){clearInterval(this.reconnectTimerId)}this.reconnectTimerId=null;this.reconnectTryCount=0;this.admin="";this.location="";this.recievedDataId=0;this.eposprint=false},connectBySocketIo:function(timeout){var selfofProb=this.conectionObj;var url=selfofProb.getSocketIoURL();this.socket=io.connect(url,{reconnect:false,"connect timeout":timeout,"force new connection":true});this.conectionObj.setSocket(this.socket);var self=this;this.socket.on("connect",function(data){try{self.gbox.dispose()}catch(e){}});this.socket.on("close",function(){selfofProb.changeStatus(selfofProb.IF_EPOSDEVICE,tselfofProb.DISCONNECT)});this.socket.on("disconnect",function(data){try{if(selfofProb.status(selfofProb.IF_EPOSDEVICE)==selfofProb.RECONNECTING){return}else{if(self.cookieIo.readId()==""&&self.connectionId==null){self.cleanup()}else{self.startReconnectAction()}}}catch(e){}});this.socket.on("error",function(){try{selfofProb.probeWebServiceIF(function(accessTime){if(selfofProb.isUsablePrintIF()){self.eposprint=true;selfofProb.registIFAccessResult(selfofProb.IF_EPOSDEVICE,selfofProb.ACCESS_NONE)}else{selfofProb.changeStatus(selfofProb.IF_EPOSDEVICE,selfofProb.DISCONNECT);selfofProb.registIFAccessResult(selfofProb.IF_EPOSDEVICE,selfofProb.ACCESS_TIMEOUT)}})}catch(e){}});this.socket.on("connect_failed",function(){try{var selfofProb=this.conectionObj;this.conectionObj.probeWebServiceIF(function(accessTime){if(selfofProb.isUsablePrintIF()){self.eposprint=true;selfofProb.registIFAccessResult(selfofProb.IF_EPOSDEVICE,selfofProb.ACCESS_NONE)}else{selfofProb.changeStatus(selfofProb.IF_EPOSDEVICE,selfofProb.DISCONNECT);selfofProb.registIFAccessResult(selfofProb.IF_EPOSDEVICE,selfofProb.ACCESS_TIMEOUT)}})}catch(e){}});this.socket.on("message",function(data){try{var eposmsg=MessageFactory.parseRequestMessage(data);if(eposmsg.data_id!=""){self.recievedDataId=eposmsg.data_id}switch(eposmsg.request){case eposmsg.REQUEST.CONNECT:self.procConnect(eposmsg);break;case eposmsg.REQUEST.PUBKEY:self.procPubkey(eposmsg);break;case eposmsg.REQUEST.ADMININFO:self.procAdminInfo(eposmsg);break;case eposmsg.REQUEST.RECONNECT:self.procReconnect(eposmsg);break;case eposmsg.REQUEST.DISCONNECT:self.procDisconnect(eposmsg);break;case eposmsg.REQUEST.OPENDEVICE:self.procOpenDevice(eposmsg);break;case eposmsg.REQUEST.CLOSEDEVICE:self.procCloseDevice(eposmsg);break;case eposmsg.REQUEST.DEVICEDATA:self.procDeviceData(eposmsg);break;case eposmsg.REQUEST.SERVICEDATA:self.procServiceData(eposmsg);break;case eposmsg.REQUEST.OPENCOMMBOX:self.procOpenCommBox(eposmsg);break;case eposmsg.REQUEST.CLOSECOMMBOX:self.procCloseCommBox(eposmsg);break;case eposmsg.REQUEST.COMMDATA:self.procCommBoxData(eposmsg);break;case eposmsg.REQUEST.ERROR:self.procError(eposmsg);break;default:return}}catch(e){}})},procConnect:function(eposmsg){try{if(this.reconnectTimerId!=null){clearInterval(this.reconnectTimerId);this.reconnectTimerId=null}var response=null;var prevConnectionId=this.cookieIo.readId();if(eposmsg.data.protocol_version<2){response=MessageFactory.getPubkeyMessage(eposmsg.data.prime,eposmsg.data.key);this.conectionObj.emit(response)}else{if(this.connectionId!=null){response=MessageFactory.getReconnectMessage(this.connectionId,eposmsg.data.client_id,this.recievedDataId);this.conectionObj.emit(response)}else{if(prevConnectionId!=""){response=MessageFactory.getDisconnectMessage(prevConnectionId);this.conectionObj.emit(response);response=MessageFactory.getPubkeyMessage(eposmsg.data.prime,eposmsg.data.key);this.conectionObj.emit(response)}else{response=MessageFactory.getPubkeyMessage(eposmsg.data.prime,eposmsg.data.key);this.conectionObj.emit(response)}}}this.cookieIo.writeId(eposmsg.data.client_id);this.connectionId=eposmsg.data.client_id}catch(e){this.conectionObj.registIFAccessResult(this.conectionObj.IF_EPOSDEVICE,this.conectionObj.ACCESS_ERROR);this.cleanup()}},procPubkey:function(eposmsg){try{if(eposmsg.code=="SHARED_KEY_MISMATCH_ERROR"){var mismatchErrTime=new Date().getTime();var mismatchTimeout=0;if(this.connectStartTime!=0){mismatchTimeout=mismatchErrTime-this.connectStartTime;if(mismatchTimeout<this.CONNECT_TIMEOUT){var self=this;this.gbox.stock(this.socket);this.connectionId=null;this.waitRetryConnectId=setTimeout(function(){self.connectBySocketIo(self.CONNECT_TIMEOUT-mismatchTimeout)},100)}else{this.conectionObj.registIFAccessResult(this.conectionObj.IF_EPOSDEVICE,this.conectionObj.ACCESS_TIMEOUT);this.cleanup()}}else{this.conectionObj.registIFAccessResult(this.conectionObj.IF_EPOSDEVICE,this.conectionObj.ACCESS_TIMEOUT);this.cleanup()}}else{if(eposmsg.code=="PARAM_ERROR"){this.conectionObj.registIFAccessResult(this.conectionObj.IF_EPOSDEVICE,this.conectionObj.ACCESS_ERROR);this.cleanup()}else{var response=MessageFactory.getAdminInfoMessage();this.conectionObj.emit(response)}}}catch(e){this.conectionObj.registIFAccessResult(this.conectionObj.IF_EPOSDEVICE,this.conectionObj.ACCESS_ERROR);this.cleanup()}},procAdminInfo:function(eposmsg){if(this.eposprint){return}if(eposmsg.code!=this.RESULT_OK){this.conectionObj.registIFAccessResult(this.conectionObj.IF_EPOSDEVICE,this.conectionObj.ACCESS_ERROR);return}this.admin=eposmsg.data.admin_name;this.location=eposmsg.data.location;this.conectionObj.registIFAccessResult(this.conectionObj.IF_EPOSDEVICE,this.conectionObj.ACCESS_OK)},procReconnect:function(eposmsg){if(this.conectionObj.status(this.conectionObj.IF_EPOSDEVICE)!=this.conectionObj.RECONNECTING){return}if(eposmsg.code==this.RESULT_OK){this.conectionObj.changeStatus(this.conectionObj.IF_EPOSDEVICE,this.conectionObj.CONNECT);if(this.onreconnect!=null){this.onreconnect()}}else{this.cleanup()}},procDisconnect:function(eposmsg){},procOpenDevice:function(eposmsg){var deviceId=eposmsg.deviceId;try{var element=this.devObjElmMap.get(deviceId);if(eposmsg.code==this.RESULT_OK){if(element.callback!=null){element.callback(element.deviceObject,eposmsg.code)}}else{if(element.callback!=null){element.callback(null,eposmsg.code)}this.devObjElmMap.remove(deviceId)}}catch(e){if(this.onerror!=null){this.onerror("0",deviceId,this.ERROR_SYSTEM,null)}}},procCloseDevice:function(eposmsg){var deviceId=eposmsg.deviceId;try{if(eposmsg.code==this.RESULT_OK){var element=this.devObjElmMap.get(deviceId);if(element.callback!=null){element.callback(eposmsg.code)}try{element.deviceObject.finalize()}catch(e){}this.devObjElmMap.remove(deviceId)}}catch(e){if(this.onerror!=null){this.onerror("0",deviceId,this.ERROR_SYSTEM,null)}}},procDeviceData:function(eposmsg){var deviceId=eposmsg.deviceId;var sequence=eposmsg.sequence;var data=eposmsg.data;try{var devObjElm=this.devObjElmMap.get(deviceId);if(devObjElm.isCrypto){data=MessageFactory.decrypt(data)}var deviceObject=devObjElm.deviceObject;var method="client_"+data.type;try{if(deviceObject instanceof OtherPeripheral){deviceObject.client_onreceive(data,sequence)}else{eval("deviceObject."+method+"(data, sequence)")}}catch(e){eval("deviceObject."+data.type+"(data, sequence)")}}catch(e){if(this.onerror!=null){this.onerror(sequence,deviceId,this.ERROR_SYSTEM,null)}}},procServiceData:function(eposmsg){try{switch(eposmsg.serviceId){case"OFSC":this.ofsc.notify(eposmsg);break;default:break}}catch(e){if(this.onerror!=null){this.onerror(eposmsg.sequence,eposmsg.serviceId,this.ERROR_SYSTEM,null)}}},procOpenCommBox:function(eposmsg){var sequence=eposmsg.sequence;try{this.commBoxManager.client_opencommbox(eposmsg.data,sequence)}catch(e){if(this.onerror!=null){this.onerror(sequence,"",this.ERROR_SYSTEM,null)}}},procCloseCommBox:function(eposmsg){var sequence=eposmsg.sequence;try{this.commBoxManager.client_closecommbox(eposmsg.data,sequence)}catch(e){if(this.onerror!=null){this.onerror(sequence,"",this.ERROR_SYSTEM,null)}}},procCommBoxData:function(eposmsg){var sequence=eposmsg.sequence;try{this.commBoxManager.executeCommDataCallback(eposmsg.data,sequence)}catch(e){if(this.onerror!=null){this.onerror(sequence,"",this.ERROR_SYSTEM,null)}}},procError:function(eposmsg){try{if(this.onerror!=null){this.onerror(eposmsg.sequence,eposmsg.deviceId,eposmsg.code,eposmsg.data)}}catch(e){}},startReconnectAction:function(){if(this.conectionObj.status(this.conectionObj.IF_EPOSDEVICE)==this.conectionObj.RECONNECTING){return}this.conectionObj.changeStatus(this.conectionObj.IF_EPOSDEVICE,this.conectionObj.RECONNECTING);this.reconnectTryCount=0;var self=this;this.reconnectTimerId=setInterval(function(){if(self.socket!=null){self.gbox.stock(self.socket)}if(self.reconnectTryCount==self.MAX_RECONNECT_RETRY){clearInterval(self.reconnectTimerId);self.cleanup();return}if(this.conectionObj.status(this.conectionObj.IF_EPOSDEVICE)==this.conectionObj.RECONNECTING){self.connectBySocketIo(self.RECONNECT_TIMEOUT)}self.reconnectTryCount++},this.RECONNECT_TIMEOUT);if(this.reconnectTryCount==0&&this.onreconnecting!=null){this.onreconnecting()}},checkEposPrintService:function(deviceId,deviceType,callback){var OK="OK";var SSL_CONNECT_OK="SSL_CONNECT_OK";var ERROR_TIMEOUT="ERROR_TIMEOUT";var ERROR_PARAMETER="ERROR_PARAMETER";var ERROR_SYSTEM="SYSTEM_ERROR";var postUrl=null;var printUrl=this.conectionObj.getAddressWithProtocol()+"/cgi-bin/epos/service.cgi?devid="+deviceId+"&timeout=10000";var displayUrl=this.conectionObj.getAddressWithProtocol()+"/cgi-bin/eposDisp/service.cgi?devid="+deviceId+"&timeout=10000";var postData=null;var printData='<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body><epos-print xmlns="http://www.epson-pos.com/schemas/2011/03/epos-print"></epos-print></s:Body></s:Envelope>';var displayData='<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body><epos-display xmlns="http://www.epson-pos.com/schemas/2012/09/epos-display"></epos-display></s:Body></s:Envelope>';var xhr=null;var tid;var success;if(deviceType==this.DEVICE_TYPE_DISPLAY){postUrl=displayUrl;postData=displayData}else{postUrl=printUrl;postData=printData}if(window.XDomainRequest){try{xhr=new XDomainRequest();xhr.open("POST",postUrl);xhr.onload=function(){if(/response/.test(xhr.responseText)){success=/success\s*=\s*"\s*(1|true)\s*"/.test(xhr.responseText);if(success){callback(OK)}else{callback(ERROR_PARAMETER)}}else{callback(ERROR_PARAMETER)}};xhr.onerror=function(){callback(ERROR_PARAMETER)};xhr.ontimeout=function(){callback(ERROR_TIMEOUT)};xhr.onprogress=function(){};xhr.send(postData)}catch(e){callback(ERROR_PARAMETER)}}else{try{xhr=new XMLHttpRequest();xhr.open("POST",postUrl,true);xhr.setRequestHeader("Content-Type","text/xml; charset=utf-8");xhr.setRequestHeader("If-Modified-Since","Thu, 01 Jun 1970 00:00:00 GMT");xhr.setRequestHeader("SOAPAction",'""');xhr.onreadystatechange=function(){if(xhr.readyState==4){clearTimeout(tid);if((xhr.status==200)&&(xhr.responseXML)){var res=xhr.responseXML.getElementsByTagName("response");if(res.length<=0){success=false}else{success=/^(1|true)$/.test(res[0].getAttribute("success"))}if(success){callback(OK)}else{callback(ERROR_PARAMETER)}}else{callback(ERROR_PARAMETER)}}};tid=setTimeout(function(){xhr.abort();callback(ERROR_TIMEOUT)},5000);xhr.timeout=10000;xhr.send(postData)}catch(e){callback(ERROR_PARAMETER)}}}};function SocketGarbageBox(){this.box=new Array()}SocketGarbageBox.prototype={stock:function(socket){if(socket==null){return}socket.removeAllListeners("connect");socket.removeAllListeners("close");socket.removeAllListeners("disconnect");socket.removeAllListeners("error");socket.removeAllListeners("connect_failed");socket.removeAllListeners("message");var clone=function(){};clone.prototype=socket;this.box.push(clone)},dispose:function(){while(0<this.box.length){var socket=this.box.pop();try{socket.disconnect();delete socket}catch(e){}}}};function Connection(){this.OK="OK";this.SSL_CONNECT_OK="SSL_CONNECT_OK";this.ERROR_TIMEOUT="ERROR_TIMEOUT";this.ERROR_PARAMETER="ERROR_PARAMETER";this.ERROR_SYSTEM="SYSTEM_ERROR";this.socket_p=null;this.address_p="";this.protocol_p="";this.port_p="";this.callback_p=null;this.usableIF_p=0;this.ws_status_p=2;this.dev_status_p=2;this.IF_EPOSDEVICE=1;this.IF_EPOSPRINT=2;this.IF_EPOSDISPLAY=4;this.IF_ALL=7;this.ACCESS_OK="OK";this.ACCESS_ERROR="ERROR";this.ACCESS_TIMEOUT="TIMEOUT";this.ACCESS_NONE="NONE";this.CONNECT=1;this.DISCONNECT=2;this.RECONNECTING=4}Connection.prototype.probe=function(url,postdata,callback){var probeSelf=this;var xhr=null;var tid;if(window.XDomainRequest){try{xhr=new XDomainRequest();xhr.open("POST",url);xhr.onload=function(){callback(probeSelf.OK)};xhr.onerror=function(){callback(probeSelf.ERROR_PARAMETER)};xhr.ontimeout=function(){callback(probeSelf.ERROR_TIMEOUT)};xhr.onprogress=function(){};xhr.send(postdata)}catch(e){callback(this.ERROR_PARAMETER)}}else{try{xhr=new XMLHttpRequest();xhr.open("POST",url,true);xhr.setRequestHeader("Content-Type","text/xml; charset=utf-8");xhr.setRequestHeader("If-Modified-Since","Thu, 01 Jun 1970 00:00:00 GMT");xhr.setRequestHeader("SOAPAction",'""');xhr.onreadystatechange=function(){if(xhr.readyState==4){clearTimeout(tid);if(xhr.status==200){callback(probeSelf.OK)}else{callback(probeSelf.ERROR_PARAMETER)}}};tid=setTimeout(function(){xhr.abort();callback(probeSelf.ERROR_TIMEOUT)},5000);xhr.timeout=10000;xhr.send(postdata)}catch(e){callback(this.ERROR_PARAMETER)}}};Connection.prototype.probeWebServiceIF=function(callback){var startTime=(new Date()).getTime();var notify=false;var probeSelf=this;var printUrl=this.getAddressWithProtocol()+"/cgi-bin/epos/service.cgi?devid=local_printer&timeout=10000";var printData='<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body><epos-print xmlns="http://www.epson-pos.com/schemas/2011/03/epos-print"></epos-print></s:Body></s:Envelope>';this.probe(printUrl,printData,function(code){var result=probeSelf.ACCESS_ERROR;if(code==probeSelf.OK){result=probeSelf.ACCESS_OK}probeSelf.registIFAccessResult(probeSelf.IF_EPOSPRINT,result);if(notify){callback((new Date()).getTime()-startTime)}notify=!notify});var displayUrl=this.getAddressWithProtocol()+"/cgi-bin/eposDisp/service.cgi?devid=local_display&timeout=10000";var displayData='<s:Envelope xmlns:s="http://schemas.xmlsoap.org/soap/envelope/"><s:Body><epos-display xmlns="http://www.epson-pos.com/schemas/2012/09/epos-display"></epos-display></s:Body></s:Envelope>';this.probe(displayUrl,displayData,function(code){var result=probeSelf.ACCESS_ERROR;if(code==probeSelf.OK){result=probeSelf.ACCESS_OK}probeSelf.registIFAccessResult(probeSelf.IF_EPOSDISPLAY,result);if(notify){callback((new Date()).getTime()-startTime)}notify=!notify})};Connection.prototype.setSocket=function(socket){this.socket_p=socket};Connection.prototype.emit=function(eposmsg){try{if(this.socket_p==null){return}this.socket_p.emit("message",eposmsg.toTransmissionForm())}catch(e){throw new Error(this.ERROR_SYSTEM)}};Connection.prototype.setAddress=function(protocol,address,port){this.protocol_p=protocol;this.address_p=address;this.port_p=port;this.usableIF_p=0};Connection.prototype.getAddressWithProtocol=function(){return this.protocol_p+"://"+this.address_p};Connection.prototype.getSocketIoURL=function(){return this.getAddressWithProtocol()+":"+this.port_p};Connection.prototype.registCallback=function(callback){if(typeof(callback)=="function"){this.callback_p=callback}};Connection.prototype.changeStatus=function(target,status){switch(target){case this.IF_ALL:this.dev_status_p=status;this.ws_status_p=status;break;case this.IF_EPOSDEVICE:this.dev_status_p=status;break;default:this.ws_status_p=status;break}};Connection.prototype.status=function(target){if(target==this.IF_EPOSDEVICE){return this.dev_status_p}else{return this.ws_status_p}};Connection.prototype.isUsableDeviceIF=function(){return((this.usableIF_p&this.IF_EPOSDEVICE)==this.IF_EPOSDEVICE)};Connection.prototype.isUsablePrintIF=function(){if(this.isUsableDeviceIF()){return true}return((this.usableIF_p&this.IF_EPOSPRINT)==this.IF_EPOSPRINT)};Connection.prototype.isUsableDisplayIF=function(){if(this.isUsableDeviceIF()){return true}return((this.usableIF_p&this.IF_EPOSDISPLAY)==this.IF_EPOSDISPLAY)};Connection.prototype.registIFAccessResult=function(type,code){if(code==this.ACCESS_OK){this.changeStatus(type,this.CONNECT);this.usableIF_p|=type}if(type==this.IF_EPOSDEVICE){var result=this.ERROR_PARAMETER;if(this.usableIF_p&this.IF_ALL){if(this.protocol_p=="http"){result=this.OK}else{result=this.SSL_CONNECT_OK}}if(code==this.ACCESS_TIMEOUT){result=this.ERROR_TIMEOUT}if(this.callback_p!=null){try{this.callback_p(result)}catch(e){}this.callback_p=null}}};function ePosCrypto(){this.pubkey_c="";this.secretKey=""}ePosCrypto.prototype={genClientKeys:function(arg_prime_s,arg_pubkey_s){var g=str2bigInt("2",10);var prime_c=str2bigInt(arg_prime_s,16);var privkey_c=randBigInt(64,0);this.pubkey_c=powMod(g,privkey_c,prime_c);var intPubkey=str2bigInt(arg_pubkey_s,16);var modNum=powMod(intPubkey,privkey_c,prime_c);var strModNum=bigInt2str(modNum,16);var strSecretKey=strModNum.toLowerCase();while(strSecretKey.length<192){strSecretKey="0"+strSecretKey}this.secretKey=md5.bin(strSecretKey)},bfEncrypt:function(data){try{var enc_req={data:data,key:this.secretKey,mode:"cbc",round:16,iv:blowfish.mkIV()};var enc_data=blowfish.encrypt(enc_req);var cdata=base64.encode(enc_data)}catch(e){return""}return cdata},bfDecrypt:function(data){try{var dec_req={data:base64.decode(data),key:this.secretKey,mode:"cbc"};var ddata=blowfish.decrypt(dec_req)}catch(e){return""}return ddata}};function ePosDeviceMessage(){this.REQUEST={CONNECT:"connect",PUBKEY:"pubkey",ADMININFO:"admin_info",RECONNECT:"reconnect",DISCONNECT:"disconnect",OPENDEVICE:"open_device",CLOSEDEVICE:"close_device",DEVICEDATA:"device_data",SERVICEDATA:"service_data",ERROR:"error",OPENCOMMBOX:"open_commbox",CLOSECOMMBOX:"close_commbox",COMMDATA:"commbox_data"};this.request=null;this.sequence=0;this.deviceId="";this.serviceId="";this.data={};this.isCrypto="0";this.code="";this.data_id=0}ePosDeviceMessage.prototype={toTransmissionForm:function(){var message=null;switch(this.request){case this.REQUEST.PUBKEY:case this.REQUEST.ADMININFO:case this.REQUEST.RECONNECT:case this.REQUEST.DISCONNECT:message=[this.request,this.data];break;case this.REQUEST.OPENDEVICE:case this.REQUEST.CLOSEDEVICE:message=[this.request,this.deviceId,this.data,this.data_id];break;case this.REQUEST.DEVICEDATA:message=[this.request,this.sequence,this.deviceId,this.data,this.data_id];break;case this.REQUEST.SERVICEDATA:message=[this.request,this.sequence,this.serviceId,this.isCrypto,this.data,this.data_id];break;case this.REQUEST.OPENCOMMBOX:case this.REQUEST.CLOSECOMMBOX:case this.REQUEST.COMMDATA:message=[this.request,this.sequence,this.data,this.data_id];break;default:message=null}return message},};var MessageFactory=(function(){var PUBKEY_TEST_TEXT="hello";var sequence=0;var cipher=new ePosCrypto();getNextSequence=function(){sequence++;if(Number.MAX_VALUE==sequence){sequence=1}return String(sequence)};return{parseRequestMessage:function(message){var eposmsg=new ePosDeviceMessage();eposmsg.request=message[0];switch(eposmsg.request){case eposmsg.REQUEST.CONNECT:eposmsg.data=message[1];break;case eposmsg.REQUEST.PUBKEY:case eposmsg.REQUEST.ADMININFO:case eposmsg.REQUEST.RECONNECT:case eposmsg.REQUEST.DISCONNECT:eposmsg.code=message[1];eposmsg.data=message[2];break;case eposmsg.REQUEST.OPENDEVICE:case eposmsg.REQUEST.CLOSEDEVICE:eposmsg.deviceId=message[1];eposmsg.code=message[2];eposmsg.data=message[3];eposmsg.data_id=message[4];break;case eposmsg.REQUEST.DEVICEDATA:eposmsg.sequence=message[1];eposmsg.deviceId=message[2];eposmsg.data=message[3];eposmsg.data_id=message[4];break;case eposmsg.REQUEST.SERVICEDATA:eposmsg.sequence=message[1];eposmsg.serviceId=message[2];eposmsg.isCrypto=message[3];eposmsg.data=message[4];eposmsg.data_id=message[5];break;case eposmsg.REQUEST.OPENCOMMBOX:case eposmsg.REQUEST.CLOSECOMMBOX:case eposmsg.REQUEST.COMMDATA:eposmsg.sequence=message[1];eposmsg.data=message[2];eposmsg.data_id=message[3];break;case eposmsg.REQUEST.ERROR:eposmsg.sequence=message[1];eposmsg.deviceId=message[2];eposmsg.code=message[3];eposmsg.data=message[4];eposmsg.data_id=message[5];break;default:eposmsg=null}return eposmsg},getPubkeyMessage:function(prime,key){var eposmsg=new ePosDeviceMessage();eposmsg.request=eposmsg.REQUEST.PUBKEY;cipher.genClientKeys(prime,key);var testData=cipher.bfEncrypt(PUBKEY_TEST_TEXT);var pubkey=bigInt2str(cipher.pubkey_c,16);while(pubkey.length<192){pubkey="0"+pubkey}eposmsg.data={key:pubkey,testData:testData};return eposmsg},getAdminInfoMessage:function(){var eposmsg=new ePosDeviceMessage();eposmsg.request=eposmsg.REQUEST.ADMININFO;eposmsg.data={};return eposmsg},getReconnectMessage:function(prevId,curId,dataId){var eposmsg=new ePosDeviceMessage();eposmsg.request=eposmsg.REQUEST.RECONNECT;eposmsg.data={old_client_id:prevId,new_client_id:curId,received_id:dataId};return eposmsg},getDisconnectMessage:function(connectionId){var eposmsg=new ePosDeviceMessage();eposmsg.request=eposmsg.REQUEST.DISCONNECT;eposmsg.data={client_id:connectionId};return eposmsg},getOpenDeviceMessage:function(deviceId,deviceType,isCrypto,isBufferEnable){var eposmsg=new ePosDeviceMessage();var deviceTypeName=deviceType;if(deviceTypeName=="type_hybrid_printer2"){deviceTypeName="type_hybrid_printer"}eposmsg.request=eposmsg.REQUEST.OPENDEVICE;eposmsg.deviceId=deviceId;eposmsg.data={type:deviceTypeName,crypto:isCrypto,buffer:isBufferEnable};return eposmsg},getCloseDeviceMessage:function(deviceId){var eposmsg=new ePosDeviceMessage();eposmsg.request=eposmsg.REQUEST.CLOSEDEVICE;eposmsg.deviceId=deviceId;eposmsg.data={};return eposmsg},getDeviceDataMessage:function(deviceId,data,crypto){var eposmsg=new ePosDeviceMessage();eposmsg.request=eposmsg.REQUEST.DEVICEDATA;eposmsg.sequence=getNextSequence();eposmsg.deviceId=deviceId;if(crypto){eposmsg.data=cipher.bfEncrypt(JSON.stringify(data))}else{eposmsg.data=data}return eposmsg},getServiceMessage:function(serviceId,isCrypt,data){var eposmsg=new ePosDeviceMessage();eposmsg.request=eposmsg.REQUEST.SERVICEDATA;eposmsg.sequence=getNextSequence();eposmsg.serviceId=serviceId;eposmsg.isCrypto=isCrypt;if(isCrypt){eposmsg.data=cipher.bfEncrypt(JSON.stringify(data))}else{eposmsg.data=data}return eposmsg},getOpenCommBoxMessage:function(data){var eposmsg=new ePosDeviceMessage();eposmsg.request=eposmsg.REQUEST.OPENCOMMBOX;eposmsg.sequence=getNextSequence();eposmsg.data=data;return eposmsg},getCloseCommBoxMessage:function(data){var eposmsg=new ePosDeviceMessage();eposmsg.request=eposmsg.REQUEST.CLOSECOMMBOX;eposmsg.sequence=getNextSequence();eposmsg.data=data;return eposmsg},getCommBoxDataMessage:function(data){var eposmsg=new ePosDeviceMessage();eposmsg.request=eposmsg.REQUEST.COMMDATA;eposmsg.sequence=getNextSequence();eposmsg.data=data;return eposmsg},decrypt:function(data){var decryptoData=cipher.bfDecrypt(data);return JSON.parse(decryptoData)},}}());function ePOSDeviceConfiguration(address){this.DEVICE_GROUP_ALL="group_all";this.DEVICE_GROUP_PRINTER="group_printer";this.DEVICE_GROUP_DISPLAY="group_display";this.DEVICE_GROUP_HID="group_hid";this.DEVICE_GROUP_SERIAL="group_serial";this.DEVICE_GROUP_OTHER="group_other";this.DEVICE_TYPE_PRINTER="type_printer";this.DEVICE_TYPE_HYBRID_PRINTER="type_hybrid_printer";this.DEVICE_TYPE_DISPLAY="type_display";this.DEVICE_TYPE_KEYBOARD="type_keyboard";this.DEVICE_TYPE_SCANNER="type_scanner";this.DEVICE_TYPE_MSR="type_msr";this.DEVICE_TYPE_CASH_CHANGER="type_cash_changer";this.DEVICE_TYPE_SIMPLE_SERIAL="type_simple_serial";this.DEVICE_TYPE_CASH_DRAWER="type_cash_drawer";this.DEVICE_TYPE_PIN_PAD="type_pin_pad";this.DEVICE_TYPE_CAT="type_cat";this.DEVICE_TYPE_SMARTCARD_RW="type_smartcard_rw";this.CGI_PATH="/epson_eposdevice/getDeviceList.cgi";this.RESULT_OK="OK";this.UNKNOWN="unknown";this.ONLINE="online";this.OFFLINE="offline";this.INTERVAL=500;this.TIMEOUT=60*1000;this.address=address;this.cb=null;this.message=null;this.WEBSOCKET_PORT=8008;this.SSLWEBSOCKET_PORT=8043}ePOSDeviceConfiguration.prototype.getRegisterdDevices=function(type,callback){this.cb=callback;var self=this;var xhr=null;var protocol=window.location.protocol+"//";var param="?group="+type;var url=protocol+this.address+this.CGI_PATH+param;if(window.XDomainRequest){xhr=new XDomainRequest();xhr.open("GET",url);xhr.onload=function(){self.message=self.RESULT_OK;var jsonObj=JSON.parse(xhr.responseText);self.checkDevice(jsonObj,function(resultList){for(var key in resultList){for(var i=0;i<jsonObj.length;i++){if(jsonObj[i].deviceId!=key){continue}jsonObj[i].status=resultList[key]}}if(self.cb!=null){self.cb(self,jsonObj);self.cb=null}})};xhr.onerror=function(){self.message="Failed to get device list.";if(self.cb!=null){self.cb(self,null);self.cb=null}}}else{xhr=new XMLHttpRequest();xhr.open("GET",url,true);xhr.setRequestHeader("Pragma","no-cache");xhr.setRequestHeader("Cache-Control","no-cache");xhr.setRequestHeader("If-Modified-Since","Thu, 01 Jun 1970 00:00:00 GMT");xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status==200){self.message=self.RESULT_OK;var jsonObj=JSON.parse(xhr.responseText);self.checkDevice(jsonObj,function(resultList){for(var key in resultList){for(var i=0;i<jsonObj.length;i++){if(jsonObj[i].deviceId!=key){continue}jsonObj[i].status=resultList[key]}}if(self.cb!=null){self.cb(self,jsonObj);self.cb=null}})}else{self.message="Failed to get device list.";if(self.cb!=null){self.cb(self,null);self.cb=null}}}}}xhr.send(null)};ePOSDeviceConfiguration.prototype.checkDevice=function(obj,callback){var self=this;var protocol=window.location.protocol;var port=(protocol.match(/^(https:)/))?this.SSLWEBSOCKET_PORT:this.WEBSOCKET_PORT;var ePosDev=new epson.ePOSDevice();var resultList=new Array();for(var i=0;i<obj.length;i++){resultList[obj[i].deviceId]=self.UNKNOWN}ePosDev.onerror=function(sq,deviceId,result){if(deviceId!=""){resultList[deviceId]=self.OFFLINE}};ePosDev.connect(this.address,port,function(data){if((data=="OK")||(data=="SSL_CONNECT_OK")){for(var i=0;i<obj.length;i++){ePosDev.createDevice(obj[i].deviceId,obj[i].deviceType,{},function(data,code){resultList[data.deviceID]=(code=="OK")?self.ONLINE:self.OFFLINE;ePosDev.deleteDevice(data,null)})}}});var timer;timer=window.setInterval(function(){for(var key in resultList){if(resultList[key]==self.UNKNOWN){return}}clearInterval(timer);if(callback!=null){callback(resultList)}},self.INTERVAL);window.setTimeout(function(){clearInterval(timer);if(callback!=null){callback(resultList)}},self.TIMEOUT)};if(typeof JSON!=="object"){JSON={}}(function(){function f(n){return n<10?"0"+n:n}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf()}}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){if(typeof rep[i]==="string"){k=rep[i];v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}if(typeof JSON.stringify!=="function"){JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})}}if(typeof JSON.parse!=="function"){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}}());(function(exports,global){var io=exports;io.version="0.8.7";io.protocol=1;io.transports=[];io.j=[];io.sockets={};io.connect=function(host,details){var uri=io.util.parseUri(host),uuri,socket;if(global&&global.location){uri.protocol=uri.protocol||global.location.protocol.slice(0,-1);uri.host=uri.host||(global.document?global.document.domain:global.location.hostname);uri.port=uri.port||global.location.port}uuri=io.util.uniqueUri(uri);var options={host:uri.host,secure:"https"==uri.protocol,port:uri.port||("https"==uri.protocol?443:80),query:uri.query||""};io.util.merge(options,details);if(options["force new connection"]||!io.sockets[uuri]){socket=new io.Socket(options)}if(!options["force new connection"]&&socket){io.sockets[uuri]=socket}socket=socket||io.sockets[uuri];return socket.of(uri.path.length>1?uri.path:"")}})("object"===typeof module?module.exports:(this.io={}),this);(function(exports,global){var util=exports.util={};var re=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;var parts=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];util.parseUri=function(str){var m=re.exec(str||""),uri={},i=14;while(i--){uri[parts[i]]=m[i]||""}return uri};util.uniqueUri=function(uri){var protocol=uri.protocol,host=uri.host,port=uri.port;if("document"in global){host=host||document.domain;port=port||(protocol=="https"&&document.location.protocol!=="https:"?443:document.location.port)}else{host=host||"localhost";if(!port&&protocol=="https"){port=443}}return(protocol||"http")+"://"+host+":"+(port||80)};util.query=function(base,addition){var query=util.chunkQuery(base||""),components=[];util.merge(query,util.chunkQuery(addition||""));for(var part in query){if(query.hasOwnProperty(part)){components.push(part+"="+query[part])}}return components.length?"?"+components.join("&"):""};util.chunkQuery=function(qs){var query={},params=qs.split("&"),i=0,l=params.length,kv;for(;i<l;++i){kv=params[i].split("=");if(kv[0]){query[kv[0]]=decodeURIComponent(kv[1])}}return query};var pageLoaded=false;util.load=function(fn){if("document"in global&&document.readyState==="complete"||pageLoaded){return fn()}util.on(global,"load",fn,false)};util.on=function(element,event,fn,capture){if(element.attachEvent){element.attachEvent("on"+event,fn)}else{if(element.addEventListener){element.addEventListener(event,fn,capture)}}};util.request=function(xdomain){if(xdomain&&"undefined"!=typeof XDomainRequest){return new XDomainRequest()}if("undefined"!=typeof XMLHttpRequest&&(!xdomain||util.ua.hasCORS)){return new XMLHttpRequest()}if(!xdomain){try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}return null};if("undefined"!=typeof window){util.load(function(){pageLoaded=true})}util.defer=function(fn){if(!util.ua.webkit||"undefined"!=typeof importScripts){return fn()}util.load(function(){setTimeout(fn,100)})};util.merge=function merge(target,additional,deep,lastseen){var seen=lastseen||[],depth=typeof deep=="undefined"?2:deep,prop;for(prop in additional){if(additional.hasOwnProperty(prop)&&util.indexOf(seen,prop)<0){if(typeof target[prop]!=="object"||!depth){target[prop]=additional[prop];seen.push(additional[prop])}else{util.merge(target[prop],additional[prop],depth-1,seen)}}}return target};util.mixin=function(ctor,ctor2){util.merge(ctor.prototype,ctor2.prototype)};util.inherit=function(ctor,ctor2){function f(){}f.prototype=ctor2.prototype;ctor.prototype=new f};util.isArray=Array.isArray||function(obj){return Object.prototype.toString.call(obj)==="[object Array]"};util.intersect=function(arr,arr2){var ret=[],longest=arr.length>arr2.length?arr:arr2,shortest=arr.length>arr2.length?arr2:arr;for(var i=0,l=shortest.length;i<l;i++){if(~util.indexOf(longest,shortest[i])){ret.push(shortest[i])}}return ret};util.indexOf=function(arr,o,i){if(Array.prototype.indexOf){return Array.prototype.indexOf.call(arr,o,i)}for(var j=arr.length,i=i<0?i+j<0?0:i+j:i||0;i<j&&arr[i]!==o;i++){}return j<=i?-1:i};util.toArray=function(enu){var arr=[];for(var i=0,l=enu.length;i<l;i++){arr.push(enu[i])}return arr};util.ua={};util.ua.hasCORS="undefined"!=typeof XMLHttpRequest&&(function(){try{var a=new XMLHttpRequest()}catch(e){return false}return a.withCredentials!=undefined})();util.ua.webkit="undefined"!=typeof navigator&&/webkit/i.test(navigator.userAgent)})("undefined"!=typeof io?io:module.exports,this);(function(exports,io){exports.EventEmitter=EventEmitter;function EventEmitter(){}EventEmitter.prototype.on=function(name,fn){if(!this.$events){this.$events={}}if(!this.$events[name]){this.$events[name]=fn}else{if(io.util.isArray(this.$events[name])){this.$events[name].push(fn)}else{this.$events[name]=[this.$events[name],fn]}}return this};EventEmitter.prototype.addListener=EventEmitter.prototype.on;EventEmitter.prototype.once=function(name,fn){var self=this;function on(){self.removeListener(name,on);fn.apply(this,arguments)}on.listener=fn;this.on(name,on);return this};EventEmitter.prototype.removeListener=function(name,fn){if(this.$events&&this.$events[name]){var list=this.$events[name];if(io.util.isArray(list)){var pos=-1;for(var i=0,l=list.length;i<l;i++){if(list[i]===fn||(list[i].listener&&list[i].listener===fn)){pos=i;break}}if(pos<0){return this}list.splice(pos,1);if(!list.length){delete this.$events[name]}}else{if(list===fn||(list.listener&&list.listener===fn)){delete this.$events[name]}}}return this};EventEmitter.prototype.removeAllListeners=function(name){if(this.$events&&this.$events[name]){this.$events[name]=null}return this};EventEmitter.prototype.listeners=function(name){if(!this.$events){this.$events={}}if(!this.$events[name]){this.$events[name]=[]}if(!io.util.isArray(this.$events[name])){this.$events[name]=[this.$events[name]]}return this.$events[name]};EventEmitter.prototype.emit=function(name){if(!this.$events){return false}var handler=this.$events[name];if(!handler){return false}var args=Array.prototype.slice.call(arguments,1);if("function"==typeof handler){handler.apply(this,args)}else{if(io.util.isArray(handler)){var listeners=handler.slice();for(var i=0,l=listeners.length;i<l;i++){listeners[i].apply(this,args)}}else{return false}}return true}})("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports);(function(exports,nativeJSON){if(nativeJSON&&nativeJSON.parse){return exports.JSON={parse:nativeJSON.parse,stringify:nativeJSON.stringify}}var JSON=exports.JSON={};function f(n){return n<10?"0"+n:n}function date(d,key){return isFinite(d.valueOf())?d.getUTCFullYear()+"-"+f(d.getUTCMonth()+1)+"-"+f(d.getUTCDate())+"T"+f(d.getUTCHours())+":"+f(d.getUTCMinutes())+":"+f(d.getUTCSeconds())+"Z":null}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value instanceof Date){value=date(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){if(typeof rep[i]==="string"){k=rep[i];v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})};JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}})("undefined"!=typeof io?io:module.exports,typeof JSON!=="undefined"?JSON:undefined);(function(exports,io){var parser=exports.parser={};var packets=parser.packets=["disconnect","connect","heartbeat","message","json","event","ack","error","noop"];var reasons=parser.reasons=["transport not supported","client not handshaken","unauthorized"];var advice=parser.advice=["reconnect"];var JSON=io.JSON,indexOf=io.util.indexOf;parser.encodePacket=function(packet){var type=indexOf(packets,packet.type),id=packet.id||"",endpoint=packet.endpoint||"",ack=packet.ack,data=null;switch(packet.type){case"error":var reason=packet.reason?indexOf(reasons,packet.reason):"",adv=packet.advice?indexOf(advice,packet.advice):"";if(reason!==""||adv!==""){data=reason+(adv!==""?("+"+adv):"")}break;case"message":if(packet.data!==""){data=packet.data}break;case"event":var ev={name:packet.name};if(packet.args&&packet.args.length){ev.args=packet.args}data=JSON.stringify(ev);break;case"json":data=JSON.stringify(packet.data);break;case"connect":if(packet.qs){data=packet.qs}break;case"ack":data=packet.ackId+(packet.args&&packet.args.length?"+"+JSON.stringify(packet.args):"");break}var encoded=[type,id+(ack=="data"?"+":""),endpoint];if(data!==null&&data!==undefined){encoded.push(data)}return encoded.join(":")};parser.encodePayload=function(packets){var decoded="";if(packets.length==1){return packets[0]}for(var i=0,l=packets.length;i<l;i++){var packet=packets[i];decoded+="\ufffd"+packet.length+"\ufffd"+packets[i]}return decoded};var regexp=/([^:]+):([0-9]+)?(\+)?:([^:]+)?:?([\s\S]*)?/;parser.decodePacket=function(data){var pieces=data.match(regexp);if(!pieces){return{}}var id=pieces[2]||"",data=pieces[5]||"",packet={type:packets[pieces[1]],endpoint:pieces[4]||""};if(id){packet.id=id;if(pieces[3]){packet.ack="data"}else{packet.ack=true}}switch(packet.type){case"error":var pieces=data.split("+");packet.reason=reasons[pieces[0]]||"";packet.advice=advice[pieces[1]]||"";break;case"message":packet.data=data||"";break;case"event":try{var opts=JSON.parse(data);packet.name=opts.name;packet.args=opts.args}catch(e){}packet.args=packet.args||[];break;case"json":try{packet.data=JSON.parse(data)}catch(e){}break;case"connect":packet.qs=data||"";break;case"ack":var pieces=data.match(/^([0-9]+)(\+)?(.*)/);if(pieces){packet.ackId=pieces[1];packet.args=[];if(pieces[3]){try{packet.args=pieces[3]?JSON.parse(pieces[3]):[]}catch(e){}}}break;case"disconnect":case"heartbeat":break}return packet};parser.decodePayload=function(data){if(data.charAt(0)=="\ufffd"){var ret=[];for(var i=1,length="";i<data.length;i++){if(data.charAt(i)=="\ufffd"){ret.push(parser.decodePacket(data.substr(i+1).substr(0,length)));i+=Number(length)+1;length=""}else{length+=data.charAt(i)}}return ret}else{return[parser.decodePacket(data)]}}})("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports);(function(exports,io){exports.Transport=Transport;function Transport(socket,sessid){this.socket=socket;this.sessid=sessid}io.util.mixin(Transport,io.EventEmitter);Transport.prototype.onData=function(data){this.clearCloseTimeout();if(this.socket.connected||this.socket.connecting||this.socket.reconnecting){this.setCloseTimeout()}if(data!==""){var msgs=io.parser.decodePayload(data);if(msgs&&msgs.length){for(var i=0,l=msgs.length;i<l;i++){this.onPacket(msgs[i])}}}return this};Transport.prototype.onPacket=function(packet){if(packet.type=="heartbeat"){return this.onHeartbeat()}if(packet.type=="connect"&&packet.endpoint==""){this.onConnect()}this.socket.onPacket(packet);return this};Transport.prototype.setCloseTimeout=function(){if(!this.closeTimeout){var self=this;this.closeTimeout=setTimeout(function(){self.onDisconnect()},this.socket.closeTimeout)}};Transport.prototype.onDisconnect=function(){if(this.close&&this.open){this.close()}this.clearTimeouts();this.socket.onDisconnect();return this};Transport.prototype.onConnect=function(){this.socket.onConnect();return this};Transport.prototype.clearCloseTimeout=function(){if(this.closeTimeout){clearTimeout(this.closeTimeout);this.closeTimeout=null}};Transport.prototype.clearTimeouts=function(){this.clearCloseTimeout();if(this.reopenTimeout){clearTimeout(this.reopenTimeout)}};Transport.prototype.packet=function(packet){this.send(io.parser.encodePacket(packet))};Transport.prototype.onHeartbeat=function(heartbeat){this.packet({type:"heartbeat"})};Transport.prototype.onOpen=function(){this.open=true;this.clearCloseTimeout();this.socket.onOpen()};Transport.prototype.onClose=function(){var self=this;this.open=false;this.socket.onClose();this.onDisconnect()};Transport.prototype.prepareUrl=function(){var options=this.socket.options;return this.scheme()+"://"+options.host+":"+options.port+"/"+options.resource+"/"+io.protocol+"/"+this.name+"/"+this.sessid};Transport.prototype.ready=function(socket,fn){fn.call(this)}})("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports);(function(exports,io,global){exports.Socket=Socket;function Socket(options){this.options={port:80,secure:false,document:"document"in global?document:false,resource:"socket.io",transports:io.transports,"connect timeout":10000,"try multiple transports":true,reconnect:true,"reconnection delay":500,"reconnection limit":Infinity,"reopen delay":3000,"max reconnection attempts":10,"sync disconnect on unload":true,"auto connect":true,"flash policy port":10843};io.util.merge(this.options,options);this.connected=false;this.open=false;this.connecting=false;this.reconnecting=false;this.namespaces={};this.buffer=[];this.doBuffer=false;if(this.options["sync disconnect on unload"]&&(!this.isXDomain()||io.util.ua.hasCORS)){var self=this;io.util.on(global,"beforeunload",function(){self.disconnectSync()},false)}if(this.options["auto connect"]){this.connect()}}io.util.mixin(Socket,io.EventEmitter);Socket.prototype.of=function(name){if(!this.namespaces[name]){this.namespaces[name]=new io.SocketNamespace(this,name);if(name!==""){this.namespaces[name].packet({type:"connect"})}}return this.namespaces[name]};Socket.prototype.publish=function(){this.emit.apply(this,arguments);var nsp;for(var i in this.namespaces){if(this.namespaces.hasOwnProperty(i)){nsp=this.of(i);nsp.$emit.apply(nsp,arguments)}}};function empty(){}Socket.prototype.handshake=function(fn){var self=this,options=this.options;function complete(data){if(data instanceof Error){self.onError(data.message)}else{fn.apply(null,data.split(":"))}}var url=["http"+(options.secure?"s":"")+":/",options.host+":"+options.port,options.resource,io.protocol,io.util.query(this.options.query,"t="+ +new Date)].join("/");var loadTimeout=setTimeout(function(){if(typeof script!=="undefined"){try{var srcIndex=script.src.lastIndexOf("=")+1;var arrayIndex=script.src.substring(srcIndex);io.j[arrayIndex]=function(data){script.parentNode.removeChild(script)}}catch(e){}}self.publish("connect_failed")},this.options["connect timeout"]);if(this.isXDomain()&&!io.util.ua.hasCORS){var insertAt=document.getElementsByTagName("script")[0],script=document.createElement("script");script.src=url+"&jsonp="+io.j.length;insertAt.parentNode.insertBefore(script,insertAt);io.j.push(function(data){clearTimeout(loadTimeout);complete(data);script.parentNode.removeChild(script)})}else{var xhr=io.util.request();xhr.open("GET",url,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){xhr.onreadystatechange=empty;clearTimeout(loadTimeout);if(xhr.status==200){complete(xhr.responseText)}else{!self.reconnecting&&self.onError(xhr.responseText)}}};xhr.timeout=this.options["connect timeout"];xhr.send(null)}};Socket.prototype.getTransport=function(override){var transports=override||this.transports,match;for(var i=0,transport;transport=transports[i];i++){if(io.Transport[transport]&&io.Transport[transport].check(this)&&(!this.isXDomain()||io.Transport[transport].xdomainCheck())){return new io.Transport[transport](this,this.sessionid)}}return null};Socket.prototype.connect=function(fn){if(this.connecting){return this}var self=this;this.handshake(function(sid,heartbeat,close,transports){self.sessionid=sid;self.closeTimeout=close*1000;self.heartbeatTimeout=heartbeat*1000;self.transports=io.util.intersect(transports.split(","),self.options.transports);function connect(transports){if(self.transport){self.transport.clearTimeouts()}self.transport=self.getTransport(transports);if(!self.transport){return self.publish("connect_failed")}self.transport.ready(self,function(){self.connecting=true;self.publish("connecting",self.transport.name);self.transport.open();if(self.options["connect timeout"]){self.connectTimeoutTimer=setTimeout(function(){if(!self.connected){self.connecting=false;if(self.options["try multiple transports"]){if(!self.remainingTransports){self.remainingTransports=self.transports.slice(0)}var remaining=self.remainingTransports;while(remaining.length>0&&remaining.splice(0,1)[0]!=self.transport.name){}if(remaining.length){connect(remaining)}else{self.publish("connect_failed")}}}},self.options["connect timeout"])}})}connect();self.once("connect",function(){clearTimeout(self.connectTimeoutTimer);fn&&typeof fn=="function"&&fn()})});return this};Socket.prototype.packet=function(data){if(this.connected&&!this.doBuffer){this.transport.packet(data)}else{this.buffer.push(data)}return this};Socket.prototype.setBuffer=function(v){this.doBuffer=v;if(!v&&this.connected&&this.buffer.length){this.transport.payload(this.buffer);this.buffer=[]}};Socket.prototype.disconnect=function(){if(this.connected){if(this.open){this.of("").packet({type:"disconnect"})}this.onDisconnect("booted")}return this};Socket.prototype.disconnectSync=function(){var xhr=io.util.request(),uri=this.resource+"/"+io.protocol+"/"+this.sessionid;xhr.open("GET",uri,true);this.onDisconnect("booted")};Socket.prototype.isXDomain=function(){var port=global.location.port||("https:"==global.location.protocol?443:80);return this.options.host!==global.location.hostname||this.options.port!=port};Socket.prototype.onConnect=function(){if(!this.connected){this.connected=true;this.connecting=false;if(!this.doBuffer){this.setBuffer(false)}this.emit("connect")}};Socket.prototype.onOpen=function(){this.open=true};Socket.prototype.onClose=function(){this.open=false};Socket.prototype.onPacket=function(packet){this.of(packet.endpoint).onPacket(packet)};Socket.prototype.onError=function(err){if(err&&err.advice){if(err.advice==="reconnect"&&this.connected){this.disconnect();this.reconnect()}}this.publish("error",err&&err.reason?err.reason:err)};Socket.prototype.onDisconnect=function(reason){var wasConnected=this.connected;this.connected=false;this.connecting=false;this.open=false;if(wasConnected){this.transport.close();this.transport.clearTimeouts();this.publish("disconnect",reason);if("booted"!=reason&&this.options.reconnect&&!this.reconnecting){this.reconnect()}}};Socket.prototype.reconnect=function(){this.reconnecting=true;this.reconnectionAttempts=0;this.reconnectionDelay=this.options["reconnection delay"];var self=this,maxAttempts=this.options["max reconnection attempts"],tryMultiple=this.options["try multiple transports"],limit=this.options["reconnection limit"];function reset(){if(self.connected){for(var i in self.namespaces){if(self.namespaces.hasOwnProperty(i)&&""!==i){self.namespaces[i].packet({type:"connect"})}}self.publish("reconnect",self.transport.name,self.reconnectionAttempts)}self.removeListener("connect_failed",maybeReconnect);self.removeListener("connect",maybeReconnect);self.reconnecting=false;delete self.reconnectionAttempts;delete self.reconnectionDelay;delete self.reconnectionTimer;delete self.redoTransports;self.options["try multiple transports"]=tryMultiple}function maybeReconnect(){if(!self.reconnecting){return}if(self.connected){return reset()}if(self.connecting&&self.reconnecting){return self.reconnectionTimer=setTimeout(maybeReconnect,1000)}if(self.reconnectionAttempts++>=maxAttempts){if(!self.redoTransports){self.on("connect_failed",maybeReconnect);self.options["try multiple transports"]=true;self.transport=self.getTransport();self.redoTransports=true;self.connect()}else{self.publish("reconnect_failed");reset()}}else{if(self.reconnectionDelay<limit){self.reconnectionDelay*=2}self.connect();self.publish("reconnecting",self.reconnectionDelay,self.reconnectionAttempts);self.reconnectionTimer=setTimeout(maybeReconnect,self.reconnectionDelay)}}this.options["try multiple transports"]=false;this.reconnectionTimer=setTimeout(maybeReconnect,this.reconnectionDelay);this.on("connect",maybeReconnect)}})("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports,this);(function(exports,io){exports.SocketNamespace=SocketNamespace;function SocketNamespace(socket,name){this.socket=socket;this.name=name||"";this.flags={};this.json=new Flag(this,"json");this.ackPackets=0;this.acks={}}io.util.mixin(SocketNamespace,io.EventEmitter);SocketNamespace.prototype.$emit=io.EventEmitter.prototype.emit;SocketNamespace.prototype.of=function(){return this.socket.of.apply(this.socket,arguments)};SocketNamespace.prototype.packet=function(packet){packet.endpoint=this.name;this.socket.packet(packet);this.flags={};return this};SocketNamespace.prototype.send=function(data,fn){var packet={type:this.flags.json?"json":"message",data:data};if("function"==typeof fn){packet.id=++this.ackPackets;packet.ack=true;this.acks[packet.id]=fn}return this.packet(packet)};SocketNamespace.prototype.emit=function(name){var args=Array.prototype.slice.call(arguments,1),lastArg=args[args.length-1],packet={type:"event",name:name};if("function"==typeof lastArg){packet.id=++this.ackPackets;packet.ack="data";this.acks[packet.id]=lastArg;args=args.slice(0,args.length-1)}packet.args=args;return this.packet(packet)};SocketNamespace.prototype.disconnect=function(){if(this.name===""){this.socket.disconnect()}else{this.packet({type:"disconnect"});this.$emit("disconnect")}return this};SocketNamespace.prototype.onPacket=function(packet){var self=this;function ack(){self.packet({type:"ack",args:io.util.toArray(arguments),ackId:packet.id})}switch(packet.type){case"connect":this.$emit("connect");break;case"disconnect":if(this.name===""){this.socket.onDisconnect(packet.reason||"booted")}else{this.$emit("disconnect",packet.reason)}break;case"message":case"json":var params=["message",packet.data];if(packet.ack=="data"){params.push(ack)}else{if(packet.ack){this.packet({type:"ack",ackId:packet.id})}}this.$emit.apply(this,params);break;case"event":var params=[packet.name].concat(packet.args);if(packet.ack=="data"){params.push(ack)}this.$emit.apply(this,params);break;case"ack":if(this.acks[packet.ackId]){this.acks[packet.ackId].apply(this,packet.args);delete this.acks[packet.ackId]}break;case"error":if(packet.advice){this.socket.onError(packet)}else{if(packet.reason=="unauthorized"){this.$emit("connect_failed",packet.reason)}else{this.$emit("error",packet.reason)}}break}};function Flag(nsp,name){this.namespace=nsp;this.name=name}Flag.prototype.send=function(){this.namespace.flags[this.name]=true;this.namespace.send.apply(this.namespace,arguments)};Flag.prototype.emit=function(){this.namespace.flags[this.name]=true;this.namespace.emit.apply(this.namespace,arguments)}})("undefined"!=typeof io?io:module.exports,"undefined"!=typeof io?io:module.parent.exports);(function(exports,io,global){exports.websocket=WS;function WS(socket){io.Transport.apply(this,arguments)}io.util.inherit(WS,io.Transport);WS.prototype.name="websocket";WS.prototype.open=function(){var query=io.util.query(this.socket.options.query),self=this,Socket;if(!Socket){Socket=global.MozWebSocket||global.WebSocket}this.websocket=new Socket(this.prepareUrl()+query);this.websocket.onopen=function(){self.onOpen();self.socket.setBuffer(false)};this.websocket.onmessage=function(ev){self.onData(ev.data)};this.websocket.onclose=function(){self.onClose();self.socket.setBuffer(true)};this.websocket.onerror=function(e){self.onError(e)};return this};WS.prototype.send=function(data){this.websocket.send(data);return this};WS.prototype.payload=function(arr){for(var i=0,l=arr.length;i<l;i++){this.packet(arr[i])}return this};WS.prototype.close=function(){this.websocket.close();return this};WS.prototype.onError=function(e){this.socket.onError(e)};WS.prototype.scheme=function(){return this.socket.options.secure?"wss":"ws"};WS.check=function(){return("WebSocket"in global&&!("__addTask"in WebSocket))||"MozWebSocket"in global};WS.xdomainCheck=function(){return true};io.transports.push("websocket")})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this);(function(exports,io){exports.flashsocket=Flashsocket;function Flashsocket(){io.Transport.websocket.apply(this,arguments)}io.util.inherit(Flashsocket,io.Transport.websocket);Flashsocket.prototype.name="flashsocket";Flashsocket.prototype.open=function(){var self=this,args=arguments;WebSocket.__addTask(function(){io.Transport.websocket.prototype.open.apply(self,args)});return this};Flashsocket.prototype.send=function(){var self=this,args=arguments;WebSocket.__addTask(function(){io.Transport.websocket.prototype.send.apply(self,args)});return this};Flashsocket.prototype.close=function(){WebSocket.__tasks.length=0;io.Transport.websocket.prototype.close.call(this);return this};Flashsocket.prototype.ready=function(socket,fn){function init(){var options=socket.options,port=options["flash policy port"],path=["http"+(options.secure?"s":"")+":/",options.host+":"+options.port,options.resource,"static/flashsocket","WebSocketMain"+(socket.isXDomain()?"Insecure":"")+".swf"];if(!Flashsocket.loaded){if(typeof WEB_SOCKET_SWF_LOCATION==="undefined"){WEB_SOCKET_SWF_LOCATION=path.join("/")}if(port!==843){WebSocket.loadFlashPolicyFile("xmlsocket://"+options.host+":"+port)}WebSocket.__initialize();Flashsocket.loaded=true}fn.call(self)}var self=this;if(document.body){return init()}io.util.load(init)};Flashsocket.check=function(){if(typeof WebSocket=="undefined"||!("__initialize"in WebSocket)||!swfobject){return false}return swfobject.getFlashPlayerVersion().major>=10};Flashsocket.xdomainCheck=function(){return true};if(typeof window!="undefined"){WEB_SOCKET_DISABLE_AUTO_INITIALIZATION=true}io.transports.push("flashsocket")})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports);if("undefined"!=typeof window){var swfobject=function(){var D="undefined",r="object",S="Shockwave Flash",W="ShockwaveFlash.ShockwaveFlash",q="application/x-shockwave-flash",R="SWFObjectExprInst",x="onreadystatechange",O=window,j=document,t=navigator,T=false,U=[h],o=[],N=[],I=[],l,Q,E,B,J=false,a=false,n,G,m=true,M=function(){var aa=typeof j.getElementById!=D&&typeof j.getElementsByTagName!=D&&typeof j.createElement!=D,ah=t.userAgent.toLowerCase(),Y=t.platform.toLowerCase(),ae=Y?/win/.test(Y):/win/.test(ah),ac=Y?/mac/.test(Y):/mac/.test(ah),af=/webkit/.test(ah)?parseFloat(ah.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")):false,X=!+"\v1",ag=[0,0,0],ab=null;if(typeof t.plugins!=D&&typeof t.plugins[S]==r){ab=t.plugins[S].description;if(ab&&!(typeof t.mimeTypes!=D&&t.mimeTypes[q]&&!t.mimeTypes[q].enabledPlugin)){T=true;X=false;ab=ab.replace(/^.*\s+(\S+\s+\S+$)/,"$1");ag[0]=parseInt(ab.replace(/^(.*)\..*$/,"$1"),10);ag[1]=parseInt(ab.replace(/^.*\.(.*)\s.*$/,"$1"),10);ag[2]=/[a-zA-Z]/.test(ab)?parseInt(ab.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0}}else{if(typeof O.ActiveXObject!=D){try{var ad=new ActiveXObject(W);if(ad){ab=ad.GetVariable("$version");if(ab){X=true;ab=ab.split(" ")[1].split(",");ag=[parseInt(ab[0],10),parseInt(ab[1],10),parseInt(ab[2],10)]}}}catch(Z){}}}return{w3:aa,pv:ag,wk:af,ie:X,win:ae,mac:ac}}(),k=function(){if(!M.w3){return}if((typeof j.readyState!=D&&j.readyState=="complete")||(typeof j.readyState==D&&(j.getElementsByTagName("body")[0]||j.body))){f()}if(!J){if(typeof j.addEventListener!=D){j.addEventListener("DOMContentLoaded",f,false)}if(M.ie&&M.win){j.attachEvent(x,function(){if(j.readyState=="complete"){j.detachEvent(x,arguments.callee);f()}});if(O==top){(function(){if(J){return}try{j.documentElement.doScroll("left")}catch(X){setTimeout(arguments.callee,0);return}f()})()}}if(M.wk){(function(){if(J){return}if(!/loaded|complete/.test(j.readyState)){setTimeout(arguments.callee,0);return}f()})()}s(f)}}();function f(){if(J){return}try{var Z=j.getElementsByTagName("body")[0].appendChild(C("span"));Z.parentNode.removeChild(Z)}catch(aa){return}J=true;var X=U.length;for(var Y=0;Y<X;Y++){U[Y]()}}function K(X){if(J){X()}else{U[U.length]=X}}function s(Y){if(typeof O.addEventListener!=D){O.addEventListener("load",Y,false)}else{if(typeof j.addEventListener!=D){j.addEventListener("load",Y,false)}else{if(typeof O.attachEvent!=D){i(O,"onload",Y)}else{if(typeof O.onload=="function"){var X=O.onload;O.onload=function(){X();Y()}}else{O.onload=Y}}}}}function h(){if(T){V()}else{H()}}function V(){var X=j.getElementsByTagName("body")[0];var aa=C(r);aa.setAttribute("type",q);var Z=X.appendChild(aa);if(Z){var Y=0;(function(){if(typeof Z.GetVariable!=D){var ab=Z.GetVariable("$version");if(ab){ab=ab.split(" ")[1].split(",");M.pv=[parseInt(ab[0],10),parseInt(ab[1],10),parseInt(ab[2],10)]}}else{if(Y<10){Y++;setTimeout(arguments.callee,10);return}}X.removeChild(aa);Z=null;H()})()}else{H()}}function H(){var ag=o.length;if(ag>0){for(var af=0;af<ag;af++){var Y=o[af].id;var ab=o[af].callbackFn;var aa={success:false,id:Y};if(M.pv[0]>0){var ae=c(Y);if(ae){if(F(o[af].swfVersion)&&!(M.wk&&M.wk<312)){w(Y,true);if(ab){aa.success=true;aa.ref=z(Y);ab(aa)}}else{if(o[af].expressInstall&&A()){var ai={};ai.data=o[af].expressInstall;ai.width=ae.getAttribute("width")||"0";ai.height=ae.getAttribute("height")||"0";if(ae.getAttribute("class")){ai.styleclass=ae.getAttribute("class")}if(ae.getAttribute("align")){ai.align=ae.getAttribute("align")}var ah={};var X=ae.getElementsByTagName("param");var ac=X.length;for(var ad=0;ad<ac;ad++){if(X[ad].getAttribute("name").toLowerCase()!="movie"){ah[X[ad].getAttribute("name")]=X[ad].getAttribute("value")}}P(ai,ah,Y,ab)}else{p(ae);if(ab){ab(aa)}}}}}else{w(Y,true);if(ab){var Z=z(Y);if(Z&&typeof Z.SetVariable!=D){aa.success=true;aa.ref=Z}ab(aa)}}}}}function z(aa){var X=null;var Y=c(aa);if(Y&&Y.nodeName=="OBJECT"){if(typeof Y.SetVariable!=D){X=Y}else{var Z=Y.getElementsByTagName(r)[0];if(Z){X=Z}}}return X}function A(){return!a&&F("6.0.65")&&(M.win||M.mac)&&!(M.wk&&M.wk<312)}function P(aa,ab,X,Z){a=true;E=Z||null;B={success:false,id:X};var ae=c(X);if(ae){if(ae.nodeName=="OBJECT"){l=g(ae);Q=null}else{l=ae;Q=X}aa.id=R;if(typeof aa.width==D||(!/%$/.test(aa.width)&&parseInt(aa.width,10)<310)){aa.width="310"}if(typeof aa.height==D||(!/%$/.test(aa.height)&&parseInt(aa.height,10)<137)){aa.height="137"}j.title=j.title.slice(0,47)+" - Flash Player Installation";var ad=M.ie&&M.win?"ActiveX":"PlugIn",ac="MMredirectURL="+O.location.toString().replace(/&/g,"%26")+"&MMplayerType="+ad+"&MMdoctitle="+j.title;if(typeof ab.flashvars!=D){ab.flashvars+="&"+ac}else{ab.flashvars=ac}if(M.ie&&M.win&&ae.readyState!=4){var Y=C("div");X+="SWFObjectNew";Y.setAttribute("id",X);ae.parentNode.insertBefore(Y,ae);ae.style.display="none";(function(){if(ae.readyState==4){ae.parentNode.removeChild(ae)}else{setTimeout(arguments.callee,10)}})()}u(aa,ab,X)}}function p(Y){if(M.ie&&M.win&&Y.readyState!=4){var X=C("div");Y.parentNode.insertBefore(X,Y);X.parentNode.replaceChild(g(Y),X);Y.style.display="none";(function(){if(Y.readyState==4){Y.parentNode.removeChild(Y)}else{setTimeout(arguments.callee,10)}})()}else{Y.parentNode.replaceChild(g(Y),Y)}}function g(ab){var aa=C("div");if(M.win&&M.ie){aa.innerHTML=ab.innerHTML}else{var Y=ab.getElementsByTagName(r)[0];if(Y){var ad=Y.childNodes;if(ad){var X=ad.length;for(var Z=0;Z<X;Z++){if(!(ad[Z].nodeType==1&&ad[Z].nodeName=="PARAM")&&!(ad[Z].nodeType==8)){aa.appendChild(ad[Z].cloneNode(true))}}}}}return aa}function u(ai,ag,Y){var X,aa=c(Y);if(M.wk&&M.wk<312){return X}if(aa){if(typeof ai.id==D){ai.id=Y}if(M.ie&&M.win){var ah="";for(var ae in ai){if(ai[ae]!=Object.prototype[ae]){if(ae.toLowerCase()=="data"){ag.movie=ai[ae]}else{if(ae.toLowerCase()=="styleclass"){ah+=' class="'+ai[ae]+'"'}else{if(ae.toLowerCase()!="classid"){ah+=" "+ae+'="'+ai[ae]+'"'}}}}}var af="";for(var ad in ag){if(ag[ad]!=Object.prototype[ad]){af+='<param name="'+ad+'" value="'+ag[ad]+'" />'}}aa.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+ah+">"+af+"</object>";N[N.length]=ai.id;X=c(ai.id)}else{var Z=C(r);Z.setAttribute("type",q);for(var ac in ai){if(ai[ac]!=Object.prototype[ac]){if(ac.toLowerCase()=="styleclass"){Z.setAttribute("class",ai[ac])}else{if(ac.toLowerCase()!="classid"){Z.setAttribute(ac,ai[ac])}}}}for(var ab in ag){if(ag[ab]!=Object.prototype[ab]&&ab.toLowerCase()!="movie"){e(Z,ab,ag[ab])}}aa.parentNode.replaceChild(Z,aa);X=Z}}return X}function e(Z,X,Y){var aa=C("param");aa.setAttribute("name",X);aa.setAttribute("value",Y);Z.appendChild(aa)}function y(Y){var X=c(Y);if(X&&X.nodeName=="OBJECT"){if(M.ie&&M.win){X.style.display="none";(function(){if(X.readyState==4){b(Y)}else{setTimeout(arguments.callee,10)}})()}else{X.parentNode.removeChild(X)}}}function b(Z){var Y=c(Z);if(Y){for(var X in Y){if(typeof Y[X]=="function"){Y[X]=null}}Y.parentNode.removeChild(Y)}}function c(Z){var X=null;try{X=j.getElementById(Z)}catch(Y){}return X}function C(X){return j.createElement(X)}function i(Z,X,Y){Z.attachEvent(X,Y);I[I.length]=[Z,X,Y]}function F(Z){var Y=M.pv,X=Z.split(".");X[0]=parseInt(X[0],10);X[1]=parseInt(X[1],10)||0;X[2]=parseInt(X[2],10)||0;return(Y[0]>X[0]||(Y[0]==X[0]&&Y[1]>X[1])||(Y[0]==X[0]&&Y[1]==X[1]&&Y[2]>=X[2]))?true:false}function v(ac,Y,ad,ab){if(M.ie&&M.mac){return}var aa=j.getElementsByTagName("head")[0];if(!aa){return}var X=(ad&&typeof ad=="string")?ad:"screen";if(ab){n=null;G=null}if(!n||G!=X){var Z=C("style");Z.setAttribute("type","text/css");Z.setAttribute("media",X);n=aa.appendChild(Z);if(M.ie&&M.win&&typeof j.styleSheets!=D&&j.styleSheets.length>0){n=j.styleSheets[j.styleSheets.length-1]}G=X}if(M.ie&&M.win){if(n&&typeof n.addRule==r){n.addRule(ac,Y)}}else{if(n&&typeof j.createTextNode!=D){n.appendChild(j.createTextNode(ac+" {"+Y+"}"))}}}function w(Z,X){if(!m){return}var Y=X?"visible":"hidden";if(J&&c(Z)){c(Z).style.visibility=Y}else{v("#"+Z,"visibility:"+Y)}}function L(Y){var Z=/[\\\"<>\.;]/;var X=Z.exec(Y)!=null;return X&&typeof encodeURIComponent!=D?encodeURIComponent(Y):Y}var d=function(){if(M.ie&&M.win){window.attachEvent("onunload",function(){var ac=I.length;for(var ab=0;ab<ac;ab++){I[ab][0].detachEvent(I[ab][1],I[ab][2])}var Z=N.length;for(var aa=0;aa<Z;aa++){y(N[aa])}for(var Y in M){M[Y]=null}M=null;for(var X in swfobject){swfobject[X]=null}swfobject=null})}}();return{registerObject:function(ab,X,aa,Z){if(M.w3&&ab&&X){var Y={};Y.id=ab;Y.swfVersion=X;Y.expressInstall=aa;Y.callbackFn=Z;o[o.length]=Y;w(ab,false)}else{if(Z){Z({success:false,id:ab})}}},getObjectById:function(X){if(M.w3){return z(X)}},embedSWF:function(ab,ah,ae,ag,Y,aa,Z,ad,af,ac){var X={success:false,id:ah};if(M.w3&&!(M.wk&&M.wk<312)&&ab&&ah&&ae&&ag&&Y){w(ah,false);K(function(){ae+="";ag+="";var aj={};if(af&&typeof af===r){for(var al in af){aj[al]=af[al]}}aj.data=ab;aj.width=ae;aj.height=ag;var am={};if(ad&&typeof ad===r){for(var ak in ad){am[ak]=ad[ak]}}if(Z&&typeof Z===r){for(var ai in Z){if(typeof am.flashvars!=D){am.flashvars+="&"+ai+"="+Z[ai]}else{am.flashvars=ai+"="+Z[ai]}}}if(F(Y)){var an=u(aj,am,ah);if(aj.id==ah){w(ah,true)}X.success=true;X.ref=an}else{if(aa&&A()){aj.data=aa;P(aj,am,ah,ac);return}else{w(ah,true)}}if(ac){ac(X)}})}else{if(ac){ac(X)}}},switchOffAutoHideShow:function(){m=false},ua:M,getFlashPlayerVersion:function(){return{major:M.pv[0],minor:M.pv[1],release:M.pv[2]}},hasFlashPlayerVersion:F,createSWF:function(Z,Y,X){if(M.w3){return u(Z,Y,X)}else{return undefined}},showExpressInstall:function(Z,aa,X,Y){if(M.w3&&A()){P(Z,aa,X,Y)}},removeSWF:function(X){if(M.w3){y(X)}},createCSS:function(aa,Z,Y,X){if(M.w3){v(aa,Z,Y,X)}},addDomLoadEvent:K,addLoadEvent:s,getQueryParamValue:function(aa){var Z=j.location.search||j.location.hash;if(Z){if(/\?/.test(Z)){Z=Z.split("?")[1]}if(aa==null){return L(Z)}var Y=Z.split("&");for(var X=0;X<Y.length;X++){if(Y[X].substring(0,Y[X].indexOf("="))==aa){return L(Y[X].substring((Y[X].indexOf("=")+1)))}}}return""},expressInstallCallback:function(){if(a){var X=c(R);if(X&&l){X.parentNode.replaceChild(l,X);if(Q){w(Q,true);if(M.ie&&M.win){l.style.display="block"}}if(E){E(B)}}a=false}}}}()}(function(){if("undefined"==typeof window||window.WebSocket){return}var console=window.console;if(!console||!console.log||!console.error){console={log:function(){},error:function(){}}}if(!swfobject.hasFlashPlayerVersion("10.0.0")){console.error("Flash Player >= 10.0.0 is required.");return}if(location.protocol=="file:"){console.error("WARNING: web-socket-js doesn't work in file:///... URL unless you set Flash Security Settings properly. Open the page via Web server i.e. http://...")}WebSocket=function(url,protocols,proxyHost,proxyPort,headers){var self=this;self.__id=WebSocket.__nextId++;WebSocket.__instances[self.__id]=self;self.readyState=WebSocket.CONNECTING;self.bufferedAmount=0;self.__events={};if(!protocols){protocols=[]}else{if(typeof protocols=="string"){protocols=[protocols]}}setTimeout(function(){WebSocket.__addTask(function(){WebSocket.__flash.create(self.__id,url,protocols,proxyHost||null,proxyPort||0,headers||null)})},0)};WebSocket.prototype.send=function(data){if(this.readyState==WebSocket.CONNECTING){throw"INVALID_STATE_ERR: Web Socket connection has not been established"}var result=WebSocket.__flash.send(this.__id,encodeURIComponent(data));if(result<0){return true}else{this.bufferedAmount+=result;return false}};WebSocket.prototype.close=function(){if(this.readyState==WebSocket.CLOSED||this.readyState==WebSocket.CLOSING){return}this.readyState=WebSocket.CLOSING;WebSocket.__flash.close(this.__id)};WebSocket.prototype.addEventListener=function(type,listener,useCapture){if(!(type in this.__events)){this.__events[type]=[]}this.__events[type].push(listener)};WebSocket.prototype.removeEventListener=function(type,listener,useCapture){if(!(type in this.__events)){return}var events=this.__events[type];for(var i=events.length-1;i>=0;--i){if(events[i]===listener){events.splice(i,1);break}}};WebSocket.prototype.dispatchEvent=function(event){var events=this.__events[event.type]||[];for(var i=0;i<events.length;++i){events[i](event)}var handler=this["on"+event.type];if(handler){handler(event)}};WebSocket.prototype.__handleEvent=function(flashEvent){if("readyState"in flashEvent){this.readyState=flashEvent.readyState}if("protocol"in flashEvent){this.protocol=flashEvent.protocol}var jsEvent;if(flashEvent.type=="open"||flashEvent.type=="error"){jsEvent=this.__createSimpleEvent(flashEvent.type)}else{if(flashEvent.type=="close"){jsEvent=this.__createSimpleEvent("close")}else{if(flashEvent.type=="message"){var data=decodeURIComponent(flashEvent.message);jsEvent=this.__createMessageEvent("message",data)}else{throw"unknown event type: "+flashEvent.type}}}this.dispatchEvent(jsEvent)};WebSocket.prototype.__createSimpleEvent=function(type){if(document.createEvent&&window.Event){var event=document.createEvent("Event");event.initEvent(type,false,false);return event}else{return{type:type,bubbles:false,cancelable:false}}};WebSocket.prototype.__createMessageEvent=function(type,data){if(document.createEvent&&window.MessageEvent&&!window.opera){var event=document.createEvent("MessageEvent");event.initMessageEvent("message",false,false,data,null,null,window,null);return event}else{return{type:type,data:data,bubbles:false,cancelable:false}}};WebSocket.CONNECTING=0;WebSocket.OPEN=1;WebSocket.CLOSING=2;WebSocket.CLOSED=3;WebSocket.__flash=null;WebSocket.__instances={};WebSocket.__tasks=[];WebSocket.__nextId=0;WebSocket.loadFlashPolicyFile=function(url){WebSocket.__addTask(function(){WebSocket.__flash.loadManualPolicyFile(url)})};WebSocket.__initialize=function(){if(WebSocket.__flash){return}if(WebSocket.__swfLocation){window.WEB_SOCKET_SWF_LOCATION=WebSocket.__swfLocation}if(!window.WEB_SOCKET_SWF_LOCATION){console.error("[WebSocket] set WEB_SOCKET_SWF_LOCATION to location of WebSocketMain.swf");return}var container=document.createElement("div");container.id="webSocketContainer";container.style.position="absolute";if(WebSocket.__isFlashLite()){container.style.left="0px";container.style.top="0px"}else{container.style.left="-100px";container.style.top="-100px"}var holder=document.createElement("div");holder.id="webSocketFlash";container.appendChild(holder);document.body.appendChild(container);swfobject.embedSWF(WEB_SOCKET_SWF_LOCATION,"webSocketFlash","1","1","10.0.0",null,null,{hasPriority:true,swliveconnect:true,allowScriptAccess:"always"},null,function(e){if(!e.success){console.error("[WebSocket] swfobject.embedSWF failed")}})};WebSocket.__onFlashInitialized=function(){setTimeout(function(){WebSocket.__flash=document.getElementById("webSocketFlash");WebSocket.__flash.setCallerUrl(location.href);WebSocket.__flash.setDebug(!!window.WEB_SOCKET_DEBUG);for(var i=0;i<WebSocket.__tasks.length;++i){WebSocket.__tasks[i]()}WebSocket.__tasks=[]},0)};WebSocket.__onFlashEvent=function(){setTimeout(function(){try{var events=WebSocket.__flash.receiveEvents();for(var i=0;i<events.length;++i){WebSocket.__instances[events[i].webSocketId].__handleEvent(events[i])}}catch(e){console.error(e)}},0);return true};WebSocket.__log=function(message){console.log(decodeURIComponent(message))};WebSocket.__error=function(message){console.error(decodeURIComponent(message))};WebSocket.__addTask=function(task){if(WebSocket.__flash){task()}else{WebSocket.__tasks.push(task)}};WebSocket.__isFlashLite=function(){if(!window.navigator||!window.navigator.mimeTypes){return false}var mimeType=window.navigator.mimeTypes["application/x-shockwave-flash"];if(!mimeType||!mimeType.enabledPlugin||!mimeType.enabledPlugin.filename){return false}return mimeType.enabledPlugin.filename.match(/flashlite/i)?true:false};if(!window.WEB_SOCKET_DISABLE_AUTO_INITIALIZATION){if(window.addEventListener){window.addEventListener("load",function(){WebSocket.__initialize()},false)}else{window.attachEvent("onload",function(){WebSocket.__initialize()})}}})();(function(exports,io,global){exports.XHR=XHR;function XHR(socket){if(!socket){return}io.Transport.apply(this,arguments);this.sendBuffer=[]}io.util.inherit(XHR,io.Transport);XHR.prototype.open=function(){this.socket.setBuffer(false);this.onOpen();this.get();this.setCloseTimeout();return this};XHR.prototype.payload=function(payload){var msgs=[];for(var i=0,l=payload.length;i<l;i++){msgs.push(io.parser.encodePacket(payload[i]))}this.send(io.parser.encodePayload(msgs))};XHR.prototype.send=function(data){this.post(data);return this};function empty(){}XHR.prototype.post=function(data){var self=this;this.socket.setBuffer(true);function stateChange(){if(this.readyState==4){this.onreadystatechange=empty;self.posting=false;if(this.status==200){self.socket.setBuffer(false)}else{self.onClose()}}}function onload(){this.onload=empty;self.socket.setBuffer(false)}this.sendXHR=this.request("POST");if(global.XDomainRequest&&this.sendXHR instanceof XDomainRequest){this.sendXHR.onload=this.sendXHR.onerror=onload}else{this.sendXHR.onreadystatechange=stateChange}this.sendXHR.send(data)};XHR.prototype.close=function(){this.onClose();return this};XHR.prototype.request=function(method){var req=io.util.request(this.socket.isXDomain()),query=io.util.query(this.socket.options.query,"t="+ +new Date);req.open(method||"GET",this.prepareUrl()+query,true);if(method=="POST"){try{if(req.setRequestHeader){req.setRequestHeader("Content-type","text/plain;charset=UTF-8")}else{req.contentType="text/plain"}}catch(e){}}return req};XHR.prototype.scheme=function(){return this.socket.options.secure?"https":"http"};XHR.check=function(socket,xdomain){try{if(io.util.request(xdomain)){return true}}catch(e){}return false};XHR.xdomainCheck=function(){return XHR.check(null,true)}})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this);(function(exports,io){exports.htmlfile=HTMLFile;function HTMLFile(socket){io.Transport.XHR.apply(this,arguments)}io.util.inherit(HTMLFile,io.Transport.XHR);HTMLFile.prototype.name="htmlfile";HTMLFile.prototype.get=function(){this.doc=new ActiveXObject("htmlfile");this.doc.open();this.doc.write("<html></html>");this.doc.close();this.doc.parentWindow.s=this;var iframeC=this.doc.createElement("div");iframeC.className="socketio";this.doc.body.appendChild(iframeC);this.iframe=this.doc.createElement("iframe");iframeC.appendChild(this.iframe);var self=this,query=io.util.query(this.socket.options.query,"t="+ +new Date);this.iframe.src=this.prepareUrl()+query;io.util.on(window,"unload",function(){self.destroy()})};HTMLFile.prototype._=function(data,doc){this.onData(data);try{var script=doc.getElementsByTagName("script")[0];script.parentNode.removeChild(script)}catch(e){}};HTMLFile.prototype.destroy=function(){if(this.iframe){try{this.iframe.src="about:blank"}catch(e){}this.doc=null;this.iframe.parentNode.removeChild(this.iframe);this.iframe=null;CollectGarbage()}};HTMLFile.prototype.close=function(){this.destroy();return io.Transport.XHR.prototype.close.call(this)};HTMLFile.check=function(){if("ActiveXObject"in window){try{var a=new ActiveXObject("htmlfile");return a&&io.Transport.XHR.check()}catch(e){}}return false};HTMLFile.xdomainCheck=function(){return false};io.transports.push("htmlfile")})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports);(function(exports,io,global){exports["xhr-polling"]=XHRPolling;function XHRPolling(){io.Transport.XHR.apply(this,arguments)}io.util.inherit(XHRPolling,io.Transport.XHR);io.util.merge(XHRPolling,io.Transport.XHR);XHRPolling.prototype.name="xhr-polling";XHRPolling.prototype.open=function(){var self=this;io.Transport.XHR.prototype.open.call(self);return false};function empty(){}XHRPolling.prototype.get=function(){if(!this.open){return}var self=this;function stateChange(){if(this.readyState==4){this.onreadystatechange=empty;if(this.status==200){self.onData(this.responseText);self.get()}else{self.onClose()}}}function onload(){this.onload=empty;self.onData(this.responseText);self.get()}this.xhr=this.request();if(global.XDomainRequest&&this.xhr instanceof XDomainRequest){this.xhr.onload=this.xhr.onerror=onload}else{this.xhr.onreadystatechange=stateChange}this.xhr.send(null)};XHRPolling.prototype.onClose=function(){io.Transport.XHR.prototype.onClose.call(this);if(this.xhr){this.xhr.onreadystatechange=this.xhr.onload=empty;try{this.xhr.abort()}catch(e){}this.xhr=null}};XHRPolling.prototype.ready=function(socket,fn){var self=this;io.util.defer(function(){fn.call(self)})};io.transports.push("xhr-polling")})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this);(function(exports,io,global){var indicator=global.document&&"MozAppearance"in global.document.documentElement.style;exports["jsonp-polling"]=JSONPPolling;function JSONPPolling(socket){io.Transport["xhr-polling"].apply(this,arguments);this.index=io.j.length;var self=this;io.j.push(function(msg){self._(msg)})}io.util.inherit(JSONPPolling,io.Transport["xhr-polling"]);JSONPPolling.prototype.name="jsonp-polling";JSONPPolling.prototype.post=function(data){var self=this,query=io.util.query(this.socket.options.query,"t="+(+new Date)+"&i="+this.index);if(!this.form){var form=document.createElement("form"),area=document.createElement("textarea"),id=this.iframeId="socketio_iframe_"+this.index,iframe;form.className="socketio";form.style.position="absolute";form.style.top="-1000px";form.style.left="-1000px";form.target=id;form.method="POST";form.setAttribute("accept-charset","utf-8");area.name="d";form.appendChild(area);document.body.appendChild(form);this.form=form;this.area=area}this.form.action=this.prepareUrl()+query;function complete(){initIframe();self.socket.setBuffer(false)}function initIframe(){if(self.iframe){self.form.removeChild(self.iframe)}try{iframe=document.createElement('<iframe name="'+self.iframeId+'">')}catch(e){iframe=document.createElement("iframe");iframe.name=self.iframeId}iframe.id=self.iframeId;self.form.appendChild(iframe);self.iframe=iframe}initIframe();this.area.value=io.JSON.stringify(data);try{this.form.submit()}catch(e){}if(this.iframe.attachEvent){iframe.onreadystatechange=function(){if(self.iframe.readyState=="complete"){complete()}}}else{this.iframe.onload=complete}this.socket.setBuffer(true)};JSONPPolling.prototype.get=function(){var self=this,script=document.createElement("script"),query=io.util.query(this.socket.options.query,"t="+(+new Date)+"&i="+this.index);if(this.script){this.script.parentNode.removeChild(this.script);this.script=null}script.async=true;script.src=this.prepareUrl()+query;script.onerror=function(){self.onClose()};var insertAt=document.getElementsByTagName("script")[0];insertAt.parentNode.insertBefore(script,insertAt);this.script=script;if(indicator){setTimeout(function(){var iframe=document.createElement("iframe");document.body.appendChild(iframe);document.body.removeChild(iframe)},100)}};JSONPPolling.prototype._=function(msg){this.onData(msg);if(this.open){this.get()}return this};JSONPPolling.prototype.ready=function(socket,fn){var self=this;if(!indicator){return fn.call(this)}io.util.load(function(){fn.call(self)})};JSONPPolling.check=function(){return"document"in global};JSONPPolling.xdomainCheck=function(){return true};io.transports.push("jsonp-polling")})("undefined"!=typeof io?io.Transport:module.exports,"undefined"!=typeof io?io:module.parent.exports,this);var JSON;if(!JSON){JSON={}}(function(){function f(n){return n<10?"0"+n:n}if(typeof Date.prototype.toJSON!=="function"){Date.prototype.toJSON=function(key){return isFinite(this.valueOf())?this.getUTCFullYear()+"-"+f(this.getUTCMonth()+1)+"-"+f(this.getUTCDate())+"T"+f(this.getUTCHours())+":"+f(this.getUTCMinutes())+":"+f(this.getUTCSeconds())+"Z":null};String.prototype.toJSON=Number.prototype.toJSON=Boolean.prototype.toJSON=function(key){return this.valueOf()}}var cx=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,escapable=/[\\\"\x00-\x1f\x7f-\x9f\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,gap,indent,meta={"\b":"\\b","\t":"\\t","\n":"\\n","\f":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"},rep;function quote(string){escapable.lastIndex=0;return escapable.test(string)?'"'+string.replace(escapable,function(a){var c=meta[a];return typeof c==="string"?c:"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})+'"':'"'+string+'"'}function str(key,holder){var i,k,v,length,mind=gap,partial,value=holder[key];if(value&&typeof value==="object"&&typeof value.toJSON==="function"){value=value.toJSON(key)}if(typeof rep==="function"){value=rep.call(holder,key,value)}switch(typeof value){case"string":return quote(value);case"number":return isFinite(value)?String(value):"null";case"boolean":case"null":return String(value);case"object":if(!value){return"null"}gap+=indent;partial=[];if(Object.prototype.toString.apply(value)==="[object Array]"){length=value.length;for(i=0;i<length;i+=1){partial[i]=str(i,value)||"null"}v=partial.length===0?"[]":gap?"[\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"]":"["+partial.join(",")+"]";gap=mind;return v}if(rep&&typeof rep==="object"){length=rep.length;for(i=0;i<length;i+=1){if(typeof rep[i]==="string"){k=rep[i];v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}else{for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=str(k,value);if(v){partial.push(quote(k)+(gap?": ":":")+v)}}}}v=partial.length===0?"{}":gap?"{\n"+gap+partial.join(",\n"+gap)+"\n"+mind+"}":"{"+partial.join(",")+"}";gap=mind;return v}}if(typeof JSON.stringify!=="function"){JSON.stringify=function(value,replacer,space){var i;gap="";indent="";if(typeof space==="number"){for(i=0;i<space;i+=1){indent+=" "}}else{if(typeof space==="string"){indent=space}}rep=replacer;if(replacer&&typeof replacer!=="function"&&(typeof replacer!=="object"||typeof replacer.length!=="number")){throw new Error("JSON.stringify")}return str("",{"":value})}}if(typeof JSON.parse!=="function"){JSON.parse=function(text,reviver){var j;function walk(holder,key){var k,v,value=holder[key];if(value&&typeof value==="object"){for(k in value){if(Object.prototype.hasOwnProperty.call(value,k)){v=walk(value,k);if(v!==undefined){value[k]=v}else{delete value[k]}}}}return reviver.call(holder,key,value)}text=String(text);cx.lastIndex=0;if(cx.test(text)){text=text.replace(cx,function(a){return"\\u"+("0000"+a.charCodeAt(0).toString(16)).slice(-4)})}if(/^[\],:{}\s]*$/.test(text.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,""))){j=eval("("+text+")");return typeof reviver==="function"?walk({"":j},""):j}throw new SyntaxError("JSON.parse")}}}());var base64=(function(undefined){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",u={},v=0;while(v<64){u[t.charAt(v)]=v;v++}return{encode:function(d){var i=0,j=0,n,s=d+"\0\0",l=s.length-2,r=new Array((l+2)/3<<2);while(i<l){n=(s.charCodeAt(i++)&255)<<16|(s.charCodeAt(i++)&255)<<8|(s.charCodeAt(i++)&255);r[j++]=t.charAt(n>>18&63);r[j++]=t.charAt(n>>12&63);r[j++]=t.charAt(n>>6&63);r[j++]=t.charAt(n&63)}while(i>l){r[--j]="=";i--}return r.join("")},decode:function(d){var i=0,j=0,n,s=d.replace(/[^A-Za-z0-9\+\/]/g,"")+"AAA",l=s.length-3,r=new Array((l+3>>2)*3),x=String.fromCharCode;while(i<l){n=u[s.charAt(i++)]<<18|u[s.charAt(i++)]<<12|u[s.charAt(i++)]<<6|u[s.charAt(i++)];r[j++]=x(n>>16&255);r[j++]=x(n>>8&255);r[j++]=x(n&255)}r.length=j-i+l;return r.join("")}}})();bpe=0;mask=0;radix=mask+1;digitsStr="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz_=!@#$%^&*()[]{}|;:,.<>/?`~ \\'\"+-";for(bpe=0;(1<<(bpe+1))>(1<<bpe);bpe++){}bpe>>=1;mask=(1<<bpe)-1;radix=mask+1;one=int2bigInt(1,1,1);t=new Array(0);ss=t;s0=t;s1=t;s2=t;s3=t;s4=t;s5=t;s6=t;s7=t;T=t;sa=t;mr_x1=t;mr_r=t;mr_a=t;eg_v=t;eg_u=t;eg_A=t;eg_B=t;eg_C=t;eg_D=t;md_q1=t;md_q2=t;md_q3=t;md_r=t;md_r1=t;md_r2=t;md_tt=t;primes=t;pows=t;s_i=t;s_i2=t;s_R=t;s_rm=t;s_q=t;s_n1=t;s_a=t;s_r2=t;s_n=t;s_b=t;s_d=t;s_x1=t;s_x2=t,s_aa=t;rpprb=t;function findPrimes(n){var i,s,p,ans;s=new Array(n);for(i=0;i<n;i++){s[i]=0}s[0]=2;p=0;for(;s[p]<n;){for(i=s[p]*s[p];i<n;i+=s[p]){s[i]=1}p++;s[p]=s[p-1]+1;for(;s[p]<n&&s[s[p]];s[p]++){}}ans=new Array(p);for(i=0;i<p;i++){ans[i]=s[i]}return ans}function millerRabinInt(x,b){if(mr_x1.length!=x.length){mr_x1=dup(x);mr_r=dup(x);mr_a=dup(x)}copyInt_(mr_a,b);return millerRabin(x,mr_a)}function millerRabin(x,b){var i,j,k,s;if(mr_x1.length!=x.length){mr_x1=dup(x);mr_r=dup(x);mr_a=dup(x)}copy_(mr_a,b);copy_(mr_r,x);copy_(mr_x1,x);addInt_(mr_r,-1);addInt_(mr_x1,-1);k=0;for(i=0;i<mr_r.length;i++){for(j=1;j<mask;j<<=1){if(x[i]&j){s=(k<mr_r.length+bpe?k:0);i=mr_r.length;j=mask}else{k++}}}if(s){rightShift_(mr_r,s)}powMod_(mr_a,mr_r,x);if(!equalsInt(mr_a,1)&&!equals(mr_a,mr_x1)){j=1;while(j<=s-1&&!equals(mr_a,mr_x1)){squareMod_(mr_a,x);if(equalsInt(mr_a,1)){return 0}j++}if(!equals(mr_a,mr_x1)){return 0}}return 1}function bitSize(x){var j,z,w;for(j=x.length-1;(x[j]==0)&&(j>0);j--){}for(z=0,w=x[j];w;(w>>=1),z++){}z+=bpe*j;return z}function expand(x,n){var ans=int2bigInt(0,(x.length>n?x.length:n)*bpe,0);copy_(ans,x);return ans}function randTruePrime(k){var ans=int2bigInt(0,k,0);randTruePrime_(ans,k);return trim(ans,1)}function randProbPrime(k){if(k>=600){return randProbPrimeRounds(k,2)}if(k>=550){return randProbPrimeRounds(k,4)}if(k>=500){return randProbPrimeRounds(k,5)}if(k>=400){return randProbPrimeRounds(k,6)}if(k>=350){return randProbPrimeRounds(k,7)}if(k>=300){return randProbPrimeRounds(k,9)}if(k>=250){return randProbPrimeRounds(k,12)}if(k>=200){return randProbPrimeRounds(k,15)}if(k>=150){return randProbPrimeRounds(k,18)}if(k>=100){return randProbPrimeRounds(k,27)}return randProbPrimeRounds(k,40)}function randProbPrimeRounds(k,n){var ans,i,divisible,B;B=30000;ans=int2bigInt(0,k,0);if(primes.length==0){primes=findPrimes(30000)}if(rpprb.length!=ans.length){rpprb=dup(ans)}for(;;){randBigInt_(ans,k,0);ans[0]|=1;divisible=0;for(i=0;(i<primes.length)&&(primes[i]<=B);i++){if(modInt(ans,primes[i])==0&&!equalsInt(ans,primes[i])){divisible=1;break}}for(i=0;i<n&&!divisible;i++){randBigInt_(rpprb,k,0);while(!greater(ans,rpprb)){randBigInt_(rpprb,k,0)}if(!millerRabin(ans,rpprb)){divisible=1}}if(!divisible){return ans}}}function mod(x,n){var ans=dup(x);mod_(ans,n);return trim(ans,1)}function addInt(x,n){var ans=expand(x,x.length+1);addInt_(ans,n);return trim(ans,1)}function mult(x,y){var ans=expand(x,x.length+y.length);mult_(ans,y);return trim(ans,1)}function powMod(x,y,n){var ans=expand(x,n.length);powMod_(ans,trim(y,2),trim(n,2),0);return trim(ans,1)}function sub(x,y){var ans=expand(x,(x.length>y.length?x.length+1:y.length+1));sub_(ans,y);return trim(ans,1)}function add(x,y){var ans=expand(x,(x.length>y.length?x.length+1:y.length+1));add_(ans,y);return trim(ans,1)}function inverseMod(x,n){var ans=expand(x,n.length);var s;s=inverseMod_(ans,n);return s?trim(ans,1):null}function multMod(x,y,n){var ans=expand(x,n.length);multMod_(ans,y,n);return trim(ans,1)}function randTruePrime_(ans,k){var c,m,pm,dd,j,r,B,divisible,z,zz,recSize;if(primes.length==0){primes=findPrimes(30000)}if(pows.length==0){pows=new Array(512);for(j=0;j<512;j++){pows[j]=Math.pow(2,j/511-1)}}c=0.1;m=20;recLimit=20;if(s_i2.length!=ans.length){s_i2=dup(ans);s_R=dup(ans);s_n1=dup(ans);s_r2=dup(ans);s_d=dup(ans);s_x1=dup(ans);s_x2=dup(ans);s_b=dup(ans);s_n=dup(ans);s_i=dup(ans);s_rm=dup(ans);s_q=dup(ans);s_a=dup(ans);s_aa=dup(ans)}if(k<=recLimit){pm=(1<<((k+2)>>1))-1;copyInt_(ans,0);for(dd=1;dd;){dd=0;ans[0]=1|(1<<(k-1))|Math.floor(Math.random()*(1<<k));for(j=1;(j<primes.length)&&((primes[j]&pm)==primes[j]);j++){if(0==(ans[0]%primes[j])){dd=1;break}}}carry_(ans);return}B=c*k*k;if(k>2*m){for(r=1;k-k*r<=m;){r=pows[Math.floor(Math.random()*512)]}}else{r=0.5}recSize=Math.floor(r*k)+1;randTruePrime_(s_q,recSize);copyInt_(s_i2,0);s_i2[Math.floor((k-2)/bpe)]|=(1<<((k-2)%bpe));divide_(s_i2,s_q,s_i,s_rm);z=bitSize(s_i);for(;;){for(;;){randBigInt_(s_R,z,0);if(greater(s_i,s_R)){break}}addInt_(s_R,1);add_(s_R,s_i);copy_(s_n,s_q);mult_(s_n,s_R);multInt_(s_n,2);addInt_(s_n,1);copy_(s_r2,s_R);multInt_(s_r2,2);for(divisible=0,j=0;(j<primes.length)&&(primes[j]<B);j++){if(modInt(s_n,primes[j])==0&&!equalsInt(s_n,primes[j])){divisible=1;break}}if(!divisible){if(!millerRabinInt(s_n,2)){divisible=1}}if(!divisible){addInt_(s_n,-3);for(j=s_n.length-1;(s_n[j]==0)&&(j>0);j--){}for(zz=0,w=s_n[j];w;(w>>=1),zz++){}zz+=bpe*j;for(;;){randBigInt_(s_a,zz,0);if(greater(s_n,s_a)){break}}addInt_(s_n,3);addInt_(s_a,2);copy_(s_b,s_a);copy_(s_n1,s_n);addInt_(s_n1,-1);powMod_(s_b,s_n1,s_n);addInt_(s_b,-1);if(isZero(s_b)){copy_(s_b,s_a);powMod_(s_b,s_r2,s_n);addInt_(s_b,-1);copy_(s_aa,s_n);copy_(s_d,s_b);GCD_(s_d,s_n);if(equalsInt(s_d,1)){copy_(ans,s_aa);return}}}}}function randBigInt(n,s){var a,b;a=Math.floor((n-1)/bpe)+2;b=int2bigInt(0,0,a);randBigInt_(b,n,s);return b}function randBigInt_(b,n,s){var i,a;for(i=0;i<b.length;i++){b[i]=0}a=Math.floor((n-1)/bpe)+1;for(i=0;i<a;i++){b[i]=Math.floor(Math.random()*(1<<(bpe-1)))}b[a-1]&=(2<<((n-1)%bpe))-1;if(s==1){b[a-1]|=(1<<((n-1)%bpe))}}function GCD(x,y){var xc,yc;xc=dup(x);yc=dup(y);GCD_(xc,yc);return xc}function GCD_(x,y){var i,xp,yp,A,B,C,D,q,sing;if(T.length!=x.length){T=dup(x)}sing=1;while(sing){sing=0;for(i=1;i<y.length;i++){if(y[i]){sing=1;break}}if(!sing){break}for(i=x.length;!x[i]&&i>=0;i--){}xp=x[i];yp=y[i];A=1;B=0;C=0;D=1;while((yp+C)&&(yp+D)){q=Math.floor((xp+A)/(yp+C));qp=Math.floor((xp+B)/(yp+D));if(q!=qp){break}t=A-q*C;A=C;C=t;t=B-q*D;B=D;D=t;t=xp-q*yp;xp=yp;yp=t}if(B){copy_(T,x);linComb_(x,y,A,B);linComb_(y,T,D,C)}else{mod_(x,y);copy_(T,x);copy_(x,y);copy_(y,T)}}if(y[0]==0){return}t=modInt(x,y[0]);copyInt_(x,y[0]);y[0]=t;while(y[0]){x[0]%=y[0];t=x[0];x[0]=y[0];y[0]=t}}function inverseMod_(x,n){var k=1+2*Math.max(x.length,n.length);if(!(x[0]&1)&&!(n[0]&1)){copyInt_(x,0);return 0}if(eg_u.length!=k){eg_u=new Array(k);eg_v=new Array(k);eg_A=new Array(k);eg_B=new Array(k);eg_C=new Array(k);eg_D=new Array(k)}copy_(eg_u,x);copy_(eg_v,n);copyInt_(eg_A,1);copyInt_(eg_B,0);copyInt_(eg_C,0);copyInt_(eg_D,1);for(;;){while(!(eg_u[0]&1)){halve_(eg_u);if(!(eg_A[0]&1)&&!(eg_B[0]&1)){halve_(eg_A);halve_(eg_B)}else{add_(eg_A,n);halve_(eg_A);sub_(eg_B,x);halve_(eg_B)}}while(!(eg_v[0]&1)){halve_(eg_v);if(!(eg_C[0]&1)&&!(eg_D[0]&1)){halve_(eg_C);halve_(eg_D)}else{add_(eg_C,n);halve_(eg_C);sub_(eg_D,x);halve_(eg_D)}}if(!greater(eg_v,eg_u)){sub_(eg_u,eg_v);sub_(eg_A,eg_C);sub_(eg_B,eg_D)}else{sub_(eg_v,eg_u);sub_(eg_C,eg_A);sub_(eg_D,eg_B)}if(equalsInt(eg_u,0)){if(negative(eg_C)){add_(eg_C,n)}copy_(x,eg_C);if(!equalsInt(eg_v,1)){copyInt_(x,0);return 0}return 1}}}function inverseModInt(x,n){var a=1,b=0,t;for(;;){if(x==1){return a}if(x==0){return 0}b-=a*Math.floor(n/x);n%=x;if(n==1){return b}if(n==0){return 0}a-=b*Math.floor(x/n);x%=n}}function inverseModInt_(x,n){return inverseModInt(x,n)}function eGCD_(x,y,v,a,b){var g=0;var k=Math.max(x.length,y.length);if(eg_u.length!=k){eg_u=new Array(k);eg_A=new Array(k);eg_B=new Array(k);eg_C=new Array(k);eg_D=new Array(k)}while(!(x[0]&1)&&!(y[0]&1)){halve_(x);halve_(y);g++}copy_(eg_u,x);copy_(v,y);copyInt_(eg_A,1);copyInt_(eg_B,0);copyInt_(eg_C,0);copyInt_(eg_D,1);for(;;){while(!(eg_u[0]&1)){halve_(eg_u);if(!(eg_A[0]&1)&&!(eg_B[0]&1)){halve_(eg_A);halve_(eg_B)}else{add_(eg_A,y);halve_(eg_A);sub_(eg_B,x);halve_(eg_B)}}while(!(v[0]&1)){halve_(v);if(!(eg_C[0]&1)&&!(eg_D[0]&1)){halve_(eg_C);halve_(eg_D)}else{add_(eg_C,y);halve_(eg_C);sub_(eg_D,x);halve_(eg_D)}}if(!greater(v,eg_u)){sub_(eg_u,v);sub_(eg_A,eg_C);sub_(eg_B,eg_D)}else{sub_(v,eg_u);sub_(eg_C,eg_A);sub_(eg_D,eg_B)}if(equalsInt(eg_u,0)){if(negative(eg_C)){add_(eg_C,y);sub_(eg_D,x)}multInt_(eg_D,-1);copy_(a,eg_C);copy_(b,eg_D);leftShift_(v,g);return}}}function negative(x){return((x[x.length-1]>>(bpe-1))&1)}function greaterShift(x,y,shift){var i,kx=x.length,ky=y.length;k=((kx+shift)<ky)?(kx+shift):ky;for(i=ky-1-shift;i<kx&&i>=0;i++){if(x[i]>0){return 1}}for(i=kx-1+shift;i<ky;i++){if(y[i]>0){return 0}}for(i=k-1;i>=shift;i--){if(x[i-shift]>y[i]){return 1}else{if(x[i-shift]<y[i]){return 0}}}return 0}function greater(x,y){var i;var k=(x.length<y.length)?x.length:y.length;for(i=x.length;i<y.length;i++){if(y[i]){return 0}}for(i=y.length;i<x.length;i++){if(x[i]){return 1}}for(i=k-1;i>=0;i--){if(x[i]>y[i]){return 1}else{if(x[i]<y[i]){return 0}}}return 0}function divide_(x,y,q,r){var kx,ky;var i,j,y1,y2,c,a,b;copy_(r,x);for(ky=y.length;y[ky-1]==0;ky--){}b=y[ky-1];for(a=0;b;a++){b>>=1}a=bpe-a;leftShift_(y,a);leftShift_(r,a);for(kx=r.length;r[kx-1]==0&&kx>ky;kx--){}copyInt_(q,0);while(!greaterShift(y,r,kx-ky)){subShift_(r,y,kx-ky);q[kx-ky]++}for(i=kx-1;i>=ky;i--){if(r[i]==y[ky-1]){q[i-ky]=mask}else{q[i-ky]=Math.floor((r[i]*radix+r[i-1])/y[ky-1])}for(;;){y2=(ky>1?y[ky-2]:0)*q[i-ky];c=y2>>bpe;y2=y2&mask;y1=c+q[i-ky]*y[ky-1];c=y1>>bpe;y1=y1&mask;if(c==r[i]?y1==r[i-1]?y2>(i>1?r[i-2]:0):y1>r[i-1]:c>r[i]){q[i-ky]--}else{break}}linCombShift_(r,y,-q[i-ky],i-ky);if(negative(r)){addShift_(r,y,i-ky);q[i-ky]--}}rightShift_(y,a);rightShift_(r,a)}function carry_(x){var i,k,c,b;k=x.length;c=0;for(i=0;i<k;i++){c+=x[i];b=0;if(c<0){b=-(c>>bpe);c+=b*radix}x[i]=c&mask;c=(c>>bpe)-b}}function modInt(x,n){var i,c=0;for(i=x.length-1;i>=0;i--){c=(c*radix+x[i])%n}return c}function int2bigInt(t,bits,minSize){var i,k;k=Math.ceil(bits/bpe)+1;k=minSize>k?minSize:k;buff=new Array(k);copyInt_(buff,t);return buff}function str2bigInt(s,base,minSize){var d,i,j,x,y,kk;var k=s.length;if(base==-1){x=new Array(0);for(;;){y=new Array(x.length+1);for(i=0;i<x.length;i++){y[i+1]=x[i]}y[0]=parseInt(s,10);x=y;d=s.indexOf(",",0);if(d<1){break}s=s.substring(d+1);if(s.length==0){break}}if(x.length<minSize){y=new Array(minSize);copy_(y,x);return y}return x}x=int2bigInt(0,base*k,0);for(i=0;i<k;i++){d=digitsStr.indexOf(s.substring(i,i+1),0);if(base<=36&&d>=36){d-=26}if(d>=base||d<0){break}multInt_(x,base);addInt_(x,d)}for(k=x.length;k>0&&!x[k-1];k--){}k=minSize>k+1?minSize:k+1;y=new Array(k);kk=k<x.length?k:x.length;for(i=0;i<kk;i++){y[i]=x[i]}for(;i<k;i++){y[i]=0}return y}function equalsInt(x,y){var i;if(x[0]!=y){return 0}for(i=1;i<x.length;i++){if(x[i]){return 0}}return 1}function equals(x,y){var i;var k=x.length<y.length?x.length:y.length;for(i=0;i<k;i++){if(x[i]!=y[i]){return 0}}if(x.length>y.length){for(;i<x.length;i++){if(x[i]){return 0}}}else{for(;i<y.length;i++){if(y[i]){return 0}}}return 1}function isZero(x){var i;for(i=0;i<x.length;i++){if(x[i]){return 0}}return 1}function bigInt2str(x,base){var i,t,s="";if(s6.length!=x.length){s6=dup(x)}else{copy_(s6,x)}if(base==-1){for(i=x.length-1;i>0;i--){s+=x[i]+","}s+=x[0]}else{while(!isZero(s6)){t=divInt_(s6,base);s=digitsStr.substring(t,t+1)+s}}if(s.length==0){s="0"}return s}function dup(x){var i;buff=new Array(x.length);copy_(buff,x);return buff}function copy_(x,y){var i;var k=x.length<y.length?x.length:y.length;for(i=0;i<k;i++){x[i]=y[i]}for(i=k;i<x.length;i++){x[i]=0}}function copyInt_(x,n){var i,c;for(c=n,i=0;i<x.length;i++){x[i]=c&mask;c>>=bpe}}function addInt_(x,n){var i,k,c,b;x[0]+=n;k=x.length;c=0;for(i=0;i<k;i++){c+=x[i];b=0;if(c<0){b=-(c>>bpe);c+=b*radix}x[i]=c&mask;c=(c>>bpe)-b;if(!c){return}}}function rightShift_(x,n){var i;var k=Math.floor(n/bpe);if(k){for(i=0;i<x.length-k;i++){x[i]=x[i+k]}for(;i<x.length;i++){x[i]=0}n%=bpe}for(i=0;i<x.length-1;i++){x[i]=mask&((x[i+1]<<(bpe-n))|(x[i]>>n))}x[i]>>=n}function halve_(x){var i;for(i=0;i<x.length-1;i++){x[i]=mask&((x[i+1]<<(bpe-1))|(x[i]>>1))}x[i]=(x[i]>>1)|(x[i]&(radix>>1))}function leftShift_(x,n){var i;var k=Math.floor(n/bpe);if(k){for(i=x.length;i>=k;i--){x[i]=x[i-k]}for(;i>=0;i--){x[i]=0}n%=bpe}if(!n){return}for(i=x.length-1;i>0;i--){x[i]=mask&((x[i]<<n)|(x[i-1]>>(bpe-n)))}x[i]=mask&(x[i]<<n)}function multInt_(x,n){var i,k,c,b;if(!n){return}k=x.length;c=0;for(i=0;i<k;i++){c+=x[i]*n;b=0;if(c<0){b=-(c>>bpe);c+=b*radix}x[i]=c&mask;c=(c>>bpe)-b}}function divInt_(x,n){var i,r=0,s;for(i=x.length-1;i>=0;i--){s=r*radix+x[i];x[i]=Math.floor(s/n);r=s%n}return r}function linComb_(x,y,a,b){var i,c,k,kk;k=x.length<y.length?x.length:y.length;kk=x.length;for(c=0,i=0;i<k;i++){c+=a*x[i]+b*y[i];x[i]=c&mask;c>>=bpe}for(i=k;i<kk;i++){c+=a*x[i];x[i]=c&mask;c>>=bpe}}function linCombShift_(x,y,b,ys){var i,c,k,kk;k=x.length<ys+y.length?x.length:ys+y.length;kk=x.length;for(c=0,i=ys;i<k;i++){c+=x[i]+b*y[i-ys];x[i]=c&mask;c>>=bpe}for(i=k;c&&i<kk;i++){c+=x[i];x[i]=c&mask;c>>=bpe}}function addShift_(x,y,ys){var i,c,k,kk;k=x.length<ys+y.length?x.length:ys+y.length;kk=x.length;for(c=0,i=ys;i<k;i++){c+=x[i]+y[i-ys];x[i]=c&mask;c>>=bpe}for(i=k;c&&i<kk;i++){c+=x[i];x[i]=c&mask;c>>=bpe}}function subShift_(x,y,ys){var i,c,k,kk;k=x.length<ys+y.length?x.length:ys+y.length;kk=x.length;for(c=0,i=ys;i<k;i++){c+=x[i]-y[i-ys];x[i]=c&mask;c>>=bpe}for(i=k;c&&i<kk;i++){c+=x[i];x[i]=c&mask;c>>=bpe}}function sub_(x,y){var i,c,k,kk;k=x.length<y.length?x.length:y.length;for(c=0,i=0;i<k;i++){c+=x[i]-y[i];x[i]=c&mask;c>>=bpe}for(i=k;c&&i<x.length;i++){c+=x[i];x[i]=c&mask;c>>=bpe}}function add_(x,y){var i,c,k,kk;k=x.length<y.length?x.length:y.length;for(c=0,i=0;i<k;i++){c+=x[i]+y[i];x[i]=c&mask;c>>=bpe}for(i=k;c&&i<x.length;i++){c+=x[i];x[i]=c&mask;c>>=bpe}}function mult_(x,y){var i;if(ss.length!=2*x.length){ss=new Array(2*x.length)}copyInt_(ss,0);for(i=0;i<y.length;i++){if(y[i]){linCombShift_(ss,x,y[i],i)}}copy_(x,ss)}function mod_(x,n){if(s4.length!=x.length){s4=dup(x)}else{copy_(s4,x)}if(s5.length!=x.length){s5=dup(x)}divide_(s4,n,s5,x)}function multMod_(x,y,n){var i;if(s0.length!=2*x.length){s0=new Array(2*x.length)}copyInt_(s0,0);for(i=0;i<y.length;i++){if(y[i]){linCombShift_(s0,x,y[i],i)}}mod_(s0,n);copy_(x,s0)}function squareMod_(x,n){var i,j,d,c,kx,kn,k;for(kx=x.length;kx>0&&!x[kx-1];kx--){}k=kx>n.length?2*kx:2*n.length;if(s0.length!=k){s0=new Array(k)}copyInt_(s0,0);for(i=0;i<kx;i++){c=s0[2*i]+x[i]*x[i];s0[2*i]=c&mask;c>>=bpe;for(j=i+1;j<kx;j++){c=s0[i+j]+2*x[i]*x[j]+c;s0[i+j]=(c&mask);c>>=bpe}s0[i+kx]=c}mod_(s0,n);copy_(x,s0)}function trim(x,k){var i,y;for(i=x.length;i>0&&!x[i-1];i--){}y=new Array(i+k);copy_(y,x);return y}function powMod_(x,y,n){var k1,k2,kn,np;if(s7.length!=n.length){s7=dup(n)}if((n[0]&1)==0){copy_(s7,x);copyInt_(x,1);while(!equalsInt(y,0)){if(y[0]&1){multMod_(x,s7,n)}divInt_(y,2);squareMod_(s7,n)}return}copyInt_(s7,0);for(kn=n.length;kn>0&&!n[kn-1];kn--){}np=radix-inverseModInt(modInt(n,radix),radix);s7[kn]=1;multMod_(x,s7,n);if(s3.length!=x.length){s3=dup(x)}else{copy_(s3,x)}for(k1=y.length-1;k1>0&!y[k1];k1--){}if(y[k1]==0){copyInt_(x,1);return}for(k2=1<<(bpe-1);k2&&!(y[k1]&k2);k2>>=1){}for(;;){if(!(k2>>=1)){k1--;if(k1<0){mont_(x,one,n,np);return}k2=1<<(bpe-1)}mont_(x,x,n,np);if(k2&y[k1]){mont_(x,s3,n,np)}}}function mont_(x,y,n,np){var i,j,c,ui,t,ks;var kn=n.length;var ky=y.length;if(sa.length!=kn){sa=new Array(kn)}copyInt_(sa,0);for(;kn>0&&n[kn-1]==0;kn--){}for(;ky>0&&y[ky-1]==0;ky--){}ks=sa.length-1;for(i=0;i<kn;i++){t=sa[0]+x[i]*y[0];ui=((t&mask)*np)&mask;c=(t+ui*n[0])>>bpe;t=x[i];j=1;for(;j<ky-4;){c+=sa[j]+ui*n[j]+t*y[j];sa[j-1]=c&mask;c>>=bpe;j++;c+=sa[j]+ui*n[j]+t*y[j];sa[j-1]=c&mask;c>>=bpe;j++;c+=sa[j]+ui*n[j]+t*y[j];sa[j-1]=c&mask;c>>=bpe;j++;c+=sa[j]+ui*n[j]+t*y[j];sa[j-1]=c&mask;c>>=bpe;j++;c+=sa[j]+ui*n[j]+t*y[j];sa[j-1]=c&mask;c>>=bpe;j++}for(;j<ky;){c+=sa[j]+ui*n[j]+t*y[j];sa[j-1]=c&mask;c>>=bpe;j++}for(;j<kn-4;){c+=sa[j]+ui*n[j];sa[j-1]=c&mask;c>>=bpe;j++;c+=sa[j]+ui*n[j];sa[j-1]=c&mask;c>>=bpe;j++;c+=sa[j]+ui*n[j];sa[j-1]=c&mask;c>>=bpe;j++;c+=sa[j]+ui*n[j];sa[j-1]=c&mask;c>>=bpe;j++;c+=sa[j]+ui*n[j];sa[j-1]=c&mask;c>>=bpe;j++}for(;j<kn;){c+=sa[j]+ui*n[j];sa[j-1]=c&mask;c>>=bpe;j++}for(;j<ks;){c+=sa[j];sa[j-1]=c&mask;c>>=bpe;j++}sa[j-1]=c&mask}if(!greater(n,sa)){sub_(sa,n)}copy_(x,sa)}var blowfish=(function(undefined){var P=[608135816,2242054355,320440878,57701188,2752067618,698298832,137296536,3964562569,1160258022,953160567,3193202383,887688300,3232508343,3380367581,1065670069,3041331479,2450970073,2306472731],S1=[3509652390,2564797868,805139163,3491422135,3101798381,1780907670,3128725573,4046225305,614570311,3012652279,134345442,2240740374,1667834072,1901547113,2757295779,4103290238,227898511,1921955416,1904987480,2182433518,2069144605,3260701109,2620446009,720527379,3318853667,677414384,3393288472,3101374703,2390351024,1614419982,1822297739,2954791486,3608508353,3174124327,2024746970,1432378464,3864339955,2857741204,1464375394,1676153920,1439316330,715854006,3033291828,289532110,2706671279,2087905683,3018724369,1668267050,732546397,1947742710,3462151702,2609353502,2950085171,1814351708,2050118529,680887927,999245976,1800124847,3300911131,1713906067,1641548236,4213287313,1216130144,1575780402,4018429277,3917837745,3693486850,3949271944,596196993,3549867205,258830323,2213823033,772490370,2760122372,1774776394,2652871518,566650946,4142492826,1728879713,2882767088,1783734482,3629395816,2517608232,2874225571,1861159788,326777828,3124490320,2130389656,2716951837,967770486,1724537150,2185432712,2364442137,1164943284,2105845187,998989502,3765401048,2244026483,1075463327,1455516326,1322494562,910128902,469688178,1117454909,936433444,3490320968,3675253459,1240580251,122909385,2157517691,634681816,4142456567,3825094682,3061402683,2540495037,79693498,3249098678,1084186820,1583128258,426386531,1761308591,1047286709,322548459,995290223,1845252383,2603652396,3431023940,2942221577,3202600964,3727903485,1712269319,422464435,3234572375,1170764815,3523960633,3117677531,1434042557,442511882,3600875718,1076654713,1738483198,4213154764,2393238008,3677496056,1014306527,4251020053,793779912,2902807211,842905082,4246964064,1395751752,1040244610,2656851899,3396308128,445077038,3742853595,3577915638,679411651,2892444358,2354009459,1767581616,3150600392,3791627101,3102740896,284835224,4246832056,1258075500,768725851,2589189241,3069724005,3532540348,1274779536,3789419226,2764799539,1660621633,3471099624,4011903706,913787905,3497959166,737222580,2514213453,2928710040,3937242737,1804850592,3499020752,2949064160,2386320175,2390070455,2415321851,4061277028,2290661394,2416832540,1336762016,1754252060,3520065937,3014181293,791618072,3188594551,3933548030,2332172193,3852520463,3043980520,413987798,3465142937,3030929376,4245938359,2093235073,3534596313,375366246,2157278981,2479649556,555357303,3870105701,2008414854,3344188149,4221384143,3956125452,2067696032,3594591187,2921233993,2428461,544322398,577241275,1471733935,610547355,4027169054,1432588573,1507829418,2025931657,3646575487,545086370,48609733,2200306550,1653985193,298326376,1316178497,3007786442,2064951626,458293330,2589141269,3591329599,3164325604,727753846,2179363840,146436021,1461446943,4069977195,705550613,3059967265,3887724982,4281599278,3313849956,1404054877,2845806497,146425753,1854211946],S2=[1266315497,3048417604,3681880366,3289982499,2909710000,1235738493,2632868024,2414719590,3970600049,1771706367,1449415276,3266420449,422970021,1963543593,2690192192,3826793022,1062508698,1531092325,1804592342,2583117782,2714934279,4024971509,1294809318,4028980673,1289560198,2221992742,1669523910,35572830,157838143,1052438473,1016535060,1802137761,1753167236,1386275462,3080475397,2857371447,1040679964,2145300060,2390574316,1461121720,2956646967,4031777805,4028374788,33600511,2920084762,1018524850,629373528,3691585981,3515945977,2091462646,2486323059,586499841,988145025,935516892,3367335476,2599673255,2839830854,265290510,3972581182,2759138881,3795373465,1005194799,847297441,406762289,1314163512,1332590856,1866599683,4127851711,750260880,613907577,1450815602,3165620655,3734664991,3650291728,3012275730,3704569646,1427272223,778793252,1343938022,2676280711,2052605720,1946737175,3164576444,3914038668,3967478842,3682934266,1661551462,3294938066,4011595847,840292616,3712170807,616741398,312560963,711312465,1351876610,322626781,1910503582,271666773,2175563734,1594956187,70604529,3617834859,1007753275,1495573769,4069517037,2549218298,2663038764,504708206,2263041392,3941167025,2249088522,1514023603,1998579484,1312622330,694541497,2582060303,2151582166,1382467621,776784248,2618340202,3323268794,2497899128,2784771155,503983604,4076293799,907881277,423175695,432175456,1378068232,4145222326,3954048622,3938656102,3820766613,2793130115,2977904593,26017576,3274890735,3194772133,1700274565,1756076034,4006520079,3677328699,720338349,1533947780,354530856,688349552,3973924725,1637815568,332179504,3949051286,53804574,2852348879,3044236432,1282449977,3583942155,3416972820,4006381244,1617046695,2628476075,3002303598,1686838959,431878346,2686675385,1700445008,1080580658,1009431731,832498133,3223435511,2605976345,2271191193,2516031870,1648197032,4164389018,2548247927,300782431,375919233,238389289,3353747414,2531188641,2019080857,1475708069,455242339,2609103871,448939670,3451063019,1395535956,2413381860,1841049896,1491858159,885456874,4264095073,4001119347,1565136089,3898914787,1108368660,540939232,1173283510,2745871338,3681308437,4207628240,3343053890,4016749493,1699691293,1103962373,3625875870,2256883143,3830138730,1031889488,3479347698,1535977030,4236805024,3251091107,2132092099,1774941330,1199868427,1452454533,157007616,2904115357,342012276,595725824,1480756522,206960106,497939518,591360097,863170706,2375253569,3596610801,1814182875,2094937945,3421402208,1082520231,3463918190,2785509508,435703966,3908032597,1641649973,2842273706,3305899714,1510255612,2148256476,2655287854,3276092548,4258621189,236887753,3681803219,274041037,1734335097,3815195456,3317970021,1899903192,1026095262,4050517792,356393447,2410691914,3873677099,3682840055],S3=[3913112168,2491498743,4132185628,2489919796,1091903735,1979897079,3170134830,3567386728,3557303409,857797738,1136121015,1342202287,507115054,2535736646,337727348,3213592640,1301675037,2528481711,1895095763,1721773893,3216771564,62756741,2142006736,835421444,2531993523,1442658625,3659876326,2882144922,676362277,1392781812,170690266,3921047035,1759253602,3611846912,1745797284,664899054,1329594018,3901205900,3045908486,2062866102,2865634940,3543621612,3464012697,1080764994,553557557,3656615353,3996768171,991055499,499776247,1265440854,648242737,3940784050,980351604,3713745714,1749149687,3396870395,4211799374,3640570775,1161844396,3125318951,1431517754,545492359,4268468663,3499529547,1437099964,2702547544,3433638243,2581715763,2787789398,1060185593,1593081372,2418618748,4260947970,69676912,2159744348,86519011,2512459080,3838209314,1220612927,3339683548,133810670,1090789135,1078426020,1569222167,845107691,3583754449,4072456591,1091646820,628848692,1613405280,3757631651,526609435,236106946,48312990,2942717905,3402727701,1797494240,859738849,992217954,4005476642,2243076622,3870952857,3732016268,765654824,3490871365,2511836413,1685915746,3888969200,1414112111,2273134842,3281911079,4080962846,172450625,2569994100,980381355,4109958455,2819808352,2716589560,2568741196,3681446669,3329971472,1835478071,660984891,3704678404,4045999559,3422617507,3040415634,1762651403,1719377915,3470491036,2693910283,3642056355,3138596744,1364962596,2073328063,1983633131,926494387,3423689081,2150032023,4096667949,1749200295,3328846651,309677260,2016342300,1779581495,3079819751,111262694,1274766160,443224088,298511866,1025883608,3806446537,1145181785,168956806,3641502830,3584813610,1689216846,3666258015,3200248200,1692713982,2646376535,4042768518,1618508792,1610833997,3523052358,4130873264,2001055236,3610705100,2202168115,4028541809,2961195399,1006657119,2006996926,3186142756,1430667929,3210227297,1314452623,4074634658,4101304120,2273951170,1399257539,3367210612,3027628629,1190975929,2062231137,2333990788,2221543033,2438960610,1181637006,548689776,2362791313,3372408396,3104550113,3145860560,296247880,1970579870,3078560182,3769228297,1714227617,3291629107,3898220290,166772364,1251581989,493813264,448347421,195405023,2709975567,677966185,3703036547,1463355134,2715995803,1338867538,1343315457,2802222074,2684532164,233230375,2599980071,2000651841,3277868038,1638401717,4028070440,3237316320,6314154,819756386,300326615,590932579,1405279636,3267499572,3150704214,2428286686,3959192993,3461946742,1862657033,1266418056,963775037,2089974820,2263052895,1917689273,448879540,3550394620,3981727096,150775221,3627908307,1303187396,508620638,2975983352,2726630617,1817252668,1876281319,1457606340,908771278,3720792119,3617206836,2455994898,1729034894,1080033504],S4=[976866871,3556439503,2881648439,1522871579,1555064734,1336096578,3548522304,2579274686,3574697629,3205460757,3593280638,3338716283,3079412587,564236357,2993598910,1781952180,1464380207,3163844217,3332601554,1699332808,1393555694,1183702653,3581086237,1288719814,691649499,2847557200,2895455976,3193889540,2717570544,1781354906,1676643554,2592534050,3230253752,1126444790,2770207658,2633158820,2210423226,2615765581,2414155088,3127139286,673620729,2805611233,1269405062,4015350505,3341807571,4149409754,1057255273,2012875353,2162469141,2276492801,2601117357,993977747,3918593370,2654263191,753973209,36408145,2530585658,25011837,3520020182,2088578344,530523599,2918365339,1524020338,1518925132,3760827505,3759777254,1202760957,3985898139,3906192525,674977740,4174734889,2031300136,2019492241,3983892565,4153806404,3822280332,352677332,2297720250,60907813,90501309,3286998549,1016092578,2535922412,2839152426,457141659,509813237,4120667899,652014361,1966332200,2975202805,55981186,2327461051,676427537,3255491064,2882294119,3433927263,1307055953,942726286,933058658,2468411793,3933900994,4215176142,1361170020,2001714738,2830558078,3274259782,1222529897,1679025792,2729314320,3714953764,1770335741,151462246,3013232138,1682292957,1483529935,471910574,1539241949,458788160,3436315007,1807016891,3718408830,978976581,1043663428,3165965781,1927990952,4200891579,2372276910,3208408903,3533431907,1412390302,2931980059,4132332400,1947078029,3881505623,4168226417,2941484381,1077988104,1320477388,886195818,18198404,3786409000,2509781533,112762804,3463356488,1866414978,891333506,18488651,661792760,1628790961,3885187036,3141171499,876946877,2693282273,1372485963,791857591,2686433993,3759982718,3167212022,3472953795,2716379847,445679433,3561995674,3504004811,3574258232,54117162,3331405415,2381918588,3769707343,4154350007,1140177722,4074052095,668550556,3214352940,367459370,261225585,2610173221,4209349473,3468074219,3265815641,314222801,3066103646,3808782860,282218597,3406013506,3773591054,379116347,1285071038,846784868,2669647154,3771962079,3550491691,2305946142,453669953,1268987020,3317592352,3279303384,3744833421,2610507566,3859509063,266596637,3847019092,517658769,3462560207,3443424879,370717030,4247526661,2224018117,4143653529,4112773975,2788324899,2477274417,1456262402,2901442914,1517677493,1846949527,2295493580,3734397586,2176403920,1280348187,1908823572,3871786941,846861322,1172426758,3287448474,3383383037,1655181056,3139813346,901632758,1897031941,2986607138,3066810236,3447102507,1393639104,373351379,950779232,625454576,3124240540,4148612726,2007998917,544563296,2244738638,2330496472,2058025392,1291430526,424198748,50039436,29584100,3605783033,2429876329,2791104160,1057563949,3255363231,3075367218,3463963227,1469046755,985887462],p,s1,s2,s3,s4;function i2s(i){return String.fromCharCode(i>>24&255,i>>16&255,i>>8&255,i&255)}function s2i(s,j){return(s.charCodeAt(j++)&255)<<24|(s.charCodeAt(j++)&255)<<16|(s.charCodeAt(j++)&255)<<8|(s.charCodeAt(j++)&255)}function xor(a,b){return i2s(s2i(a,0)^s2i(b,0))+i2s(s2i(a,4)^s2i(b,4))}function f(x){return(s1[x>>24&255]+s2[x>>16&255]^s3[x>>8&255])+s4[x&255]^0}function encipher(x){var i=0,t,l=s2i(x,0),r=s2i(x,4);while(i<16){l^=p[i++];r^=f(l);t=l;l=r;r=t}l^=p[i++];r^=p[i];return i2s(r)+i2s(l)}function decipher(x){var i=17,t,l=s2i(x,0),r=s2i(x,4);while(i>1){l^=p[i--];r^=f(l);t=l;l=r;r=t}l^=p[i--];r^=p[i];return i2s(r)+i2s(l)}function subkey(k){var i,x="\0\0\0\0\0\0\0\0";p=P.slice();s1=S1.slice();s2=S2.slice();s3=S3.slice();s4=S4.slice();while(k.length<72){k+=k}i=0;while(i<18){p[i]^=s2i(k,i<<2);i++}i=0;while(i<18){x=encipher(x);p[i++]=s2i(x,0);p[i++]=s2i(x,4)}i=0;while(i<256){x=encipher(x);s1[i++]=s2i(x,0);s1[i++]=s2i(x,4)}i=0;while(i<256){x=encipher(x);s2[i++]=s2i(x,0);s2[i++]=s2i(x,4)}i=0;while(i<256){x=encipher(x);s3[i++]=s2i(x,0);s3[i++]=s2i(x,4)}i=0;while(i<256){x=encipher(x);s4[i++]=s2i(x,0);s4[i++]=s2i(x,4)}}function utf8(s){var i=0,l=s.length,x=String.fromCharCode,c,r=[];while(i<l){c=s.charCodeAt(i++);if(c<128){r.push(x(c))}else{if(c<2048){r.push(x(c>>6&31|192,c&63|128))}else{if(c<65536){r.push(x(c>>12&15|224,c>>6&63|128,c&63|128))}else{if(c<2097152){r.push(x(c>>18&7|240,c>>12&63|128,c>>6&63|128,c&63|128))}else{}}}}}return r.join("")}function utf16(s){var i=0,l=s.length,x=String.fromCharCode,c,r=[];while(i<l){c=s.charCodeAt(i++);if((c&128)==0){r.push(x(c&255))}else{if((c&224)==192){if(i<l){r.push(x((c<<6&1984)|(s.charCodeAt(i++)&63)))}}else{if((c&240)==224){if(i+1<l){r.push(x((c<<12&61440)|(s.charCodeAt(i++)<<6&4032)|(s.charCodeAt(i++)&63)))}}else{if((c&248)==240){if(i+2<l){r.push(x((c<<18&1835008)|(s.charCodeAt(i++)<<12&258048)|(s.charCodeAt(i++)<<6&4032)|(s.charCodeAt(i++)&63)))}}else{}}}}}return r.join("")}return{encrypt:function(param){var i,c,v,block=[],data=param.data||"",key=param.key||"\0",mode=param.mode||"ecb",pchar=param.pchar||"\x05";subkey(key);data=utf8(data);data+=new Array((8-data.length%8)%8+1).join(pchar);if(mode=="cbc"){v=param.iv||"\0\0\0\0\0\0\0\0";block.push(v);i=0;while(i<data.length){c=encipher(xor(data.substr(i,8),v));block.push(c);v=c;i+=8}}else{i=0;while(i<data.length){block.push(encipher(data.substr(i,8)));i+=8}}return block.join("")},decrypt:function(param){var i,c,v,block=[],data=param.data||"",key=param.key||"\0",mode=param.mode||"ecb",pchar=param.pchar||"\x05";subkey(key);data+=new Array((8-data.length%8)%8+1).join("\0");if(mode=="cbc"){v=data.substr(0,8)||"\0\0\0\0\0\0\0\0";i=8;while(i<data.length){c=data.substr(i,8);block.push(xor(decipher(c),v));v=c;i+=8}}else{i=0;while(i<data.length){block.push(decipher(data.substr(i,8)));i+=8}}data=block.join("").replace(new RegExp(pchar+"+$"),"");return utf16(data)},mkIV:function(){return i2s(Math.random()*4294967296)+i2s(Math.random()*4294967296)}}})();var md5=(function(undefined){var s=[7,12,17,22,7,12,17,22,7,12,17,22,7,12,17,22,5,9,14,20,5,9,14,20,5,9,14,20,5,9,14,20,4,11,16,23,4,11,16,23,4,11,16,23,4,11,16,23,6,10,15,21,6,10,15,21,6,10,15,21,6,10,15,21],k=[3614090360,3905402710,606105819,3250441966,4118548399,1200080426,2821735955,4249261313,1770035416,2336552879,4294925233,2304563134,1804603682,4254626195,2792965006,1236535329,4129170786,3225465664,643717713,3921069994,3593408605,38016083,3634488961,3889429448,568446438,3275163606,4107603335,1163531501,2850285829,4243563512,1735328473,2368359562,4294588738,2272392833,1839030562,4259657740,2763975236,1272893353,4139469664,3200236656,681279174,3936430074,3572445317,76029189,3654602809,3873151461,530742520,3299628645,4096336452,1126891415,2878612391,4237533241,1700485571,2399980690,4293915773,2240044497,1873313359,4264355552,2734768916,1309151649,4149444226,3174756917,718787259,3951481745],p="\x80"+new Array(64).join("\0");function i2s(i){return String.fromCharCode(i&255,i>>8&255,i>>16&255,i>>24&255)}function s2i(s,j){return(s.charCodeAt(j++)&255)|(s.charCodeAt(j++)&255)<<8|(s.charCodeAt(j++)&255)<<16|(s.charCodeAt(j++))<<24}return{bin:function(data){var a0=1732584193,b0=4023233417,c0=2562383102,d0=271733878,a,b,c,d,f,g,r,i,j,m=new Array(16);data+=p.slice(0,64-(data.length+8)%64)+i2s(data.length<<3)+i2s(0);for(i=0;i<data.length;i+=64){for(j=0;j<16;j++){m[j]=s2i(data,i+(j<<2))}a=a0;b=b0;c=c0;d=d0;for(j=0;j<64;j++){if(j<16){f=(b&c)|(~b&d);g=j}else{if(j<32){f=(d&b)|(~d&c);g=j*5+1&15}else{if(j<48){f=b^c^d;g=j*3+5&15}else{f=c^(b|~d);g=j*7&15}}}r=a+f+k[j]+m[g]|0;r=(r<<s[j])|(r>>>32-s[j]);a=d;d=c;c=b;b=r+b|0}a0=a0+a|0;b0=b0+b|0;c0=c0+c|0;d0=d0+d|0}return i2s(a0)+i2s(b0)+i2s(c0)+i2s(d0)}}})();if(!window.epson){window.epson={}}window.epson.ePOSDevice=ePOSDevice})(window);;

/* /pos_hr/static/src/js/models.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_hr.employees',function(require){"use strict";var models=require('point_of_sale.models');models.load_models([{model:'hr.employee',fields:['name','id','user_id'],domain:function(self){return self.config.employee_ids.length>0?['&',['company_id','=',self.config.company_id[0]],'|',['user_id','=',self.user.id],['id','in',self.config.employee_ids],]:[['company_id','=',self.config.company_id[0]]];},loaded:function(self,employees){if(self.config.module_pos_hr){self.employees=employees;self.employee_by_id={};self.employees.forEach(function(employee){self.employee_by_id[employee.id]=employee;var hasUser=self.users.some(function(user){if(user.id===employee.user_id[0]){employee.role=user.role;return true;}
return false;});if(!hasUser){employee.role='cashier';}});}}}]);var posmodel_super=models.PosModel.prototype;models.PosModel=models.PosModel.extend({load_server_data:function(){var self=this;return posmodel_super.load_server_data.apply(this,arguments).then(function(){var employee_ids=_.map(self.employees,function(employee){return employee.id;});var records=self.rpc({model:'hr.employee',method:'get_barcodes_and_pin_hashed',args:[employee_ids],});return records.then(function(employee_data){self.employees.forEach(function(employee){var data=_.findWhere(employee_data,{'id':employee.id});if(data!==undefined){employee.barcode=data.barcode;employee.pin=data.pin;}});});});},set_cashier:function(employee){posmodel_super.set_cashier.apply(this,arguments);const selectedOrder=this.get_order();if(selectedOrder&&!selectedOrder.get_orderlines().length){selectedOrder.employee=employee;}}});var super_order_model=models.Order.prototype;models.Order=models.Order.extend({initialize:function(attributes,options){super_order_model.initialize.apply(this,arguments);if(!options.json){this.employee=this.pos.get_cashier();}},init_from_JSON:function(json){super_order_model.init_from_JSON.apply(this,arguments);if(this.pos.config.module_pos_hr&&json.employee_id){this.employee=this.pos.employee_by_id[json.employee_id];}},export_as_JSON:function(){const json=super_order_model.export_as_JSON.apply(this,arguments);if(this.pos.config.module_pos_hr){json.employee_id=this.employee?this.employee.id:false;}
return json;},});});;

/* /pos_hr/static/src/js/useSelectEmployee.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_hr.useSelectEmployee',function(require){'use strict';const{Component}=owl;function useSelectEmployee(){const current=Component.current;async function askPin(employee){const{confirmed,payload:inputPin}=await this.showPopup('NumberPopup',{isPassword:true,title:this.env._t('Password ?'),startingValue:null,});if(!confirmed)return false;if(employee.pin===Sha1.hash(inputPin)){return employee;}else{await this.showPopup('ErrorPopup',{title:this.env._t('Incorrect Password'),});return false;}}
async function selectEmployee(selectionList){const{confirmed,payload:employee}=await this.showPopup('SelectionPopup',{title:this.env._t('Change Cashier'),list:selectionList,});if(!confirmed)return false;if(!employee.pin){return employee;}
return await askPin.call(current,employee);}
return{askPin:askPin.bind(current),selectEmployee:selectEmployee.bind(current)};}
return useSelectEmployee;});;

/* /pos_hr/static/src/js/Chrome.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_hr.chrome',function(require){'use strict';const Chrome=require('point_of_sale.Chrome');const Registries=require('point_of_sale.Registries');const PosHrChrome=(Chrome)=>class extends Chrome{async start(){await super.start();this.env.pos.on('change:cashier',this.render,this);if(this.env.pos.config.module_pos_hr)this.showTempScreen('LoginScreen');}
get headerButtonIsShown(){return!this.env.pos.config.module_pos_hr||this.env.pos.get('cashier').role=='manager';}};Registries.Component.extend(Chrome,PosHrChrome);return Chrome;});;

/* /pos_hr/static/src/js/HeaderLockButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('point_of_sale.HeaderLockButton',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');const{useState}=owl;class HeaderLockButton extends PosComponent{constructor(){super(...arguments);this.state=useState({isUnlockIcon:true,title:'Unlocked'});}
async showLoginScreen(){await this.showTempScreen('LoginScreen');}
onMouseOver(isMouseOver){this.state.isUnlockIcon=!isMouseOver;this.state.title=isMouseOver?'Lock':'Unlocked';}}
Registries.Component.add(HeaderLockButton);return HeaderLockButton;});;

/* /pos_hr/static/src/js/CashierName.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_hr.CashierName',function(require){'use strict';const CashierName=require('point_of_sale.CashierName');const Registries=require('point_of_sale.Registries');const useSelectEmployee=require('pos_hr.useSelectEmployee');const{useBarcodeReader}=require('point_of_sale.custom_hooks');const PosHrCashierName=(CashierName)=>class extends CashierName{constructor(){super(...arguments);const{selectEmployee,askPin}=useSelectEmployee();this.askPin=askPin;this.selectEmployee=selectEmployee;useBarcodeReader({cashier:this._onCashierScan});}
mounted(){this.env.pos.on('change:cashier',this.render,this);}
willUnmount(){this.env.pos.off('change:cashier',null,this);}
async selectCashier(){if(!this.env.pos.config.module_pos_hr)return;const list=this.env.pos.employees.filter((employee)=>employee.id!==this.env.pos.get_cashier().id).map((employee)=>{return{id:employee.id,item:employee,label:employee.name,isSelected:false,};});const employee=await this.selectEmployee(list);if(employee){this.env.pos.set_cashier(employee);}}
async _onCashierScan(code){const employee=this.env.pos.employees.find((emp)=>emp.barcode===Sha1.hash(code.code));if(!employee||employee===this.env.pos.get_cashier())return;if(!employee.pin||(await this.askPin(employee))){this.env.pos.set_cashier(employee);}}};Registries.Component.extend(CashierName,PosHrCashierName);return CashierName;});;

/* /pos_hr/static/src/js/LoginScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_hr.LoginScreen',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');const useSelectEmployee=require('pos_hr.useSelectEmployee');const{useBarcodeReader}=require('point_of_sale.custom_hooks');class LoginScreen extends PosComponent{constructor(){super(...arguments);const{selectEmployee,askPin}=useSelectEmployee();this.selectEmployee=selectEmployee;this.askPin=askPin;useBarcodeReader({cashier:this._barcodeCashierAction,},true);}
back(){this.props.resolve({confirmed:false,payload:false});this.trigger('close-temp-screen');}
confirm(){this.props.resolve({confirmed:true,payload:true});this.trigger('close-temp-screen');}
get shopName(){return this.env.pos.config.name;}
closeSession(){this.trigger('close-pos');}
async selectCashier(){const list=this.env.pos.employees.map((employee)=>{return{id:employee.id,item:employee,label:employee.name,isSelected:false,};});const employee=await this.selectEmployee(list);if(employee){this.env.pos.set_cashier(employee);this.back();}}
async _barcodeCashierAction(code){let theEmployee;for(let employee of this.env.pos.employees){if(employee.barcode===Sha1.hash(code.code)){theEmployee=employee;break;}}
if(!theEmployee)return;if(!theEmployee.pin||(await this.askPin(theEmployee))){this.env.pos.set_cashier(theEmployee);this.back();}}}
LoginScreen.template='LoginScreen';Registries.Component.add(LoginScreen);return LoginScreen;});;

/* /pos_hr/static/src/js/PaymentScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_hr.PaymentScreen',function(require){'use strict';const PaymentScreen=require('point_of_sale.PaymentScreen');const Registries=require('point_of_sale.Registries');const PosHrPaymentScreen=(PaymentScreen_)=>class extends PaymentScreen_{async _finalizeValidation(){this.currentOrder.employee=this.env.pos.get_cashier();await super._finalizeValidation();}};Registries.Component.extend(PaymentScreen,PosHrPaymentScreen);return PaymentScreen;});;

/* /pos_restaurant/static/lib/js/jquery.ui.touch-punch.js defined in bundle 'point_of_sale.assets' */
(function($){$.support.touch=('ontouchend'in document||'ontouchstart'in document||'ontouchstart'in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0);if(!$.support.touch){return;}
var mouseProto=$.ui.mouse.prototype,_mouseInit=mouseProto._mouseInit,_mouseDestroy=mouseProto._mouseDestroy,touchHandled;function simulateMouseEvent(event,simulatedType){if(event.originalEvent.touches.length>1){return;}
event.preventDefault();var touch=event.originalEvent.changedTouches[0],simulatedEvent=document.createEvent('MouseEvents');simulatedEvent.initMouseEvent(simulatedType,true,true,window,1,touch.screenX,touch.screenY,touch.clientX,touch.clientY,false,false,false,false,0,null);event.target.dispatchEvent(simulatedEvent);}
mouseProto._touchStart=function(event){var self=this;if(touchHandled||!self._mouseCapture(event.originalEvent.changedTouches[0])){return;}
touchHandled=true;self._touchMoved=false;simulateMouseEvent(event,'mouseover');simulateMouseEvent(event,'mousemove');simulateMouseEvent(event,'mousedown');};mouseProto._touchMove=function(event){if(!touchHandled){return;}
this._touchMoved=true;simulateMouseEvent(event,'mousemove');};mouseProto._touchEnd=function(event){if(!touchHandled){return;}
simulateMouseEvent(event,'mouseup');simulateMouseEvent(event,'mouseout');if(!this._touchMoved){simulateMouseEvent(event,'click');}
touchHandled=false;};mouseProto._mouseInit=function(){var self=this;self.element.bind({touchstart:$.proxy(self,'_touchStart'),touchmove:$.proxy(self,'_touchMove'),touchend:$.proxy(self,'_touchEnd')});_mouseInit.call(self);};mouseProto._mouseDestroy=function(){var self=this;self.element.unbind({touchstart:$.proxy(self,'_touchStart'),touchmove:$.proxy(self,'_touchMove'),touchend:$.proxy(self,'_touchEnd')});_mouseDestroy.call(self);};})(jQuery);;

/* /pos_restaurant/static/src/js/multiprint.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.multiprint',function(require){"use strict";var models=require('point_of_sale.models');var core=require('web.core');var Printer=require('point_of_sale.Printer').Printer;var QWeb=core.qweb;models.PosModel=models.PosModel.extend({create_printer:function(config){var url=config.proxy_ip||'';if(url.indexOf('//')<0){url=window.location.protocol+'//'+url;}
if(url.indexOf(':',url.indexOf('//')+2)<0&&window.location.protocol!=='https:'){url=url+':8069';}
return new Printer(url,this);},});models.load_models({model:'restaurant.printer',fields:['name','proxy_ip','product_categories_ids','printer_type'],domain:null,loaded:function(self,printers){var active_printers={};for(var i=0;i<self.config.printer_ids.length;i++){active_printers[self.config.printer_ids[i]]=true;}
self.printers=[];self.printers_categories={};for(var i=0;i<printers.length;i++){if(active_printers[printers[i].id]){var printer=self.create_printer(printers[i]);printer.config=printers[i];self.printers.push(printer);for(var j=0;j<printer.config.product_categories_ids.length;j++){self.printers_categories[printer.config.product_categories_ids[j]]=true;}}}
self.printers_categories=_.keys(self.printers_categories);self.config.iface_printers=!!self.printers.length;},});var _super_orderline=models.Orderline.prototype;models.Orderline=models.Orderline.extend({initialize:function(){_super_orderline.initialize.apply(this,arguments);if(!this.pos.config.iface_printers){return;}
if(typeof this.mp_dirty==='undefined'){this.mp_dirty=this.printable()||undefined;}
if(!this.mp_skip){this.mp_skip=false;}},printable:function(){return this.pos.db.is_product_in_category(this.pos.printers_categories,this.get_product().id);},init_from_JSON:function(json){_super_orderline.init_from_JSON.apply(this,arguments);this.mp_dirty=json.mp_dirty;this.mp_skip=json.mp_skip;},export_as_JSON:function(){var json=_super_orderline.export_as_JSON.apply(this,arguments);json.mp_dirty=this.mp_dirty;json.mp_skip=this.mp_skip;return json;},set_quantity:function(quantity,keep_price){if(this.pos.config.iface_printers&&quantity!==this.quantity&&this.printable()){this.mp_dirty=true;}
_super_orderline.set_quantity.apply(this,arguments);},can_be_merged_with:function(orderline){return(!this.mp_skip)&&(!orderline.mp_skip)&&_super_orderline.can_be_merged_with.apply(this,arguments);},set_skip:function(skip){if(this.mp_dirty&&skip&&!this.mp_skip){this.mp_skip=true;this.trigger('change',this);}
if(this.mp_skip&&!skip){this.mp_dirty=true;this.mp_skip=false;this.trigger('change',this);}},set_dirty:function(dirty){if(this.mp_dirty!==dirty){this.mp_dirty=dirty;this.trigger('change',this);}},get_line_diff_hash:function(){if(this.get_note()){return this.id+'|'+this.get_note();}else{return''+this.id;}},});var _super_order=models.Order.prototype;models.Order=models.Order.extend({build_line_resume:function(){var resume={};this.orderlines.each(function(line){if(line.mp_skip){return;}
var qty=Number(line.get_quantity());var note=line.get_note();var product_id=line.get_product().id;var product_name=line.get_full_product_name();var p_key=product_id+" - "+product_name;var product_resume=p_key in resume?resume[p_key]:{pid:product_id,product_name_wrapped:line.generate_wrapped_product_name(),qties:{},};if(note in product_resume['qties'])product_resume['qties'][note]+=qty;else product_resume['qties'][note]=qty;resume[p_key]=product_resume;});return resume;},saveChanges:function(){this.saved_resume=this.build_line_resume();this.orderlines.each(function(line){line.set_dirty(false);});this.trigger('change',this);},computeChanges:function(categories){var current_res=this.build_line_resume();var old_res=this.saved_resume||{};var json=this.export_as_JSON();var add=[];var rem=[];var p_key,note;for(p_key in current_res){for(note in current_res[p_key]['qties']){var curr=current_res[p_key];var old=old_res[p_key]||{};var pid=curr.pid;var found=p_key in old_res&&note in old_res[p_key]['qties'];if(!found){add.push({'id':pid,'name':this.pos.db.get_product_by_id(pid).display_name,'name_wrapped':curr.product_name_wrapped,'note':note,'qty':curr['qties'][note],});}else if(old['qties'][note]<curr['qties'][note]){add.push({'id':pid,'name':this.pos.db.get_product_by_id(pid).display_name,'name_wrapped':curr.product_name_wrapped,'note':note,'qty':curr['qties'][note]-old['qties'][note],});}else if(old['qties'][note]>curr['qties'][note]){rem.push({'id':pid,'name':this.pos.db.get_product_by_id(pid).display_name,'name_wrapped':curr.product_name_wrapped,'note':note,'qty':old['qties'][note]-curr['qties'][note],});}}}
for(p_key in old_res){for(note in old_res[p_key]['qties']){var found=p_key in current_res&&note in current_res[p_key]['qties'];if(!found){var old=old_res[p_key];var pid=old.pid;rem.push({'id':pid,'name':this.pos.db.get_product_by_id(pid).display_name,'name_wrapped':old.product_name_wrapped,'note':note,'qty':old['qties'][note],});}}}
if(categories&&categories.length>0){var self=this;var _add=[];var _rem=[];for(var i=0;i<add.length;i++){if(self.pos.db.is_product_in_category(categories,add[i].id)){_add.push(add[i]);}}
add=_add;for(var i=0;i<rem.length;i++){if(self.pos.db.is_product_in_category(categories,rem[i].id)){_rem.push(rem[i]);}}
rem=_rem;}
var d=new Date();var hours=''+d.getHours();hours=hours.length<2?('0'+hours):hours;var minutes=''+d.getMinutes();minutes=minutes.length<2?('0'+minutes):minutes;return{'new':add,'cancelled':rem,'table':json.table||false,'floor':json.floor||false,'name':json.name||'unknown order','time':{'hours':hours,'minutes':minutes,},};},printChanges:async function(){var printers=this.pos.printers;let isPrintSuccessful=true;for(var i=0;i<printers.length;i++){var changes=this.computeChanges(printers[i].config.product_categories_ids);if(changes['new'].length>0||changes['cancelled'].length>0){var receipt=QWeb.render('OrderChangeReceipt',{changes:changes,widget:this});const result=await printers[i].print_receipt(receipt);if(!result.successful){isPrintSuccessful=false;}}}
return isPrintSuccessful;},hasChangesToPrint:function(){var printers=this.pos.printers;for(var i=0;i<printers.length;i++){var changes=this.computeChanges(printers[i].config.product_categories_ids);if(changes['new'].length>0||changes['cancelled'].length>0){return true;}}
return false;},hasSkippedChanges:function(){var orderlines=this.get_orderlines();for(var i=0;i<orderlines.length;i++){if(orderlines[i].mp_skip){return true;}}
return false;},export_as_JSON:function(){var json=_super_order.export_as_JSON.apply(this,arguments);json.multiprint_resume=JSON.stringify(this.saved_resume);return json;},init_from_JSON:function(json){_super_order.init_from_JSON.apply(this,arguments);this.saved_resume=json.multiprint_resume&&JSON.parse(json.multiprint_resume);},});});;

/* /pos_restaurant/static/src/js/floors.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.floors',function(require){"use strict";var models=require('point_of_sale.models');const{Gui}=require('point_of_sale.Gui');const{posbus}=require('point_of_sale.utils');models.load_models({model:'restaurant.floor',fields:['name','background_color','table_ids','sequence'],domain:function(self){return[['pos_config_id','=',self.config.id]];},loaded:function(self,floors){self.floors=floors;self.floors_by_id={};for(var i=0;i<floors.length;i++){floors[i].tables=[];self.floors_by_id[floors[i].id]=floors[i];}
self.floors=self.floors.sort(function(a,b){return a.sequence-b.sequence;});self.config.iface_floorplan=!!self.floors.length;},});models.load_models({model:'restaurant.table',fields:['name','width','height','position_h','position_v','shape','floor_id','color','seats'],loaded:function(self,tables){self.tables_by_id={};for(var i=0;i<tables.length;i++){self.tables_by_id[tables[i].id]=tables[i];var floor=self.floors_by_id[tables[i].floor_id[0]];if(floor){floor.tables.push(tables[i]);tables[i].floor=floor;}}},});var _super_order=models.Order.prototype;models.Order=models.Order.extend({initialize:function(attr,options){_super_order.initialize.apply(this,arguments);if(!this.table&&!options.json){this.table=this.pos.table;}
this.customer_count=this.customer_count||1;this.save_to_db();},export_as_JSON:function(){var json=_super_order.export_as_JSON.apply(this,arguments);json.table=this.table?this.table.name:undefined;json.table_id=this.table?this.table.id:false;json.floor=this.table?this.table.floor.name:false;json.floor_id=this.table?this.table.floor.id:false;json.customer_count=this.customer_count;return json;},init_from_JSON:function(json){_super_order.init_from_JSON.apply(this,arguments);this.table=this.pos.tables_by_id[json.table_id];this.floor=this.table?this.pos.floors_by_id[json.floor_id]:undefined;this.customer_count=json.customer_count||1;},export_for_printing:function(){var json=_super_order.export_for_printing.apply(this,arguments);json.table=this.table?this.table.name:undefined;json.floor=this.table?this.table.floor.name:undefined;json.customer_count=this.get_customer_count();return json;},get_customer_count:function(){return this.customer_count;},set_customer_count:function(count){this.customer_count=Math.max(count,0);this.trigger('change');},});var _super_posmodel=models.PosModel.prototype;models.PosModel=models.PosModel.extend({after_load_server_data:async function(){var res=await _super_posmodel.after_load_server_data.call(this);if(this.config.iface_floorplan){this.table=null;}
return res;},transfer_order_to_different_table:function(){this.order_to_transfer_to_different_table=this.get_order();this.set_table(null);},remove_from_server_and_set_sync_state:function(ids_to_remove){var self=this;this.set_synch('connecting',ids_to_remove.length);return self._remove_from_server(ids_to_remove).then(function(server_ids){self.set_synch('connected');}).catch(function(reason){self.set_synch('error');throw reason;});},_get_from_server:function(table_id,options){options=options||{};var timeout=typeof options.timeout==='number'?options.timeout:7500;return this.rpc({model:'pos.order',method:'get_table_draft_orders',args:[table_id],kwargs:{context:this.session.user_context},},{timeout:timeout,shadow:false,})},transfer_order_to_table:function(table){this.order_to_transfer_to_different_table.table=table;this.order_to_transfer_to_different_table.save_to_db();},push_order_for_transfer:function(order_ids,table_orders){order_ids.push(this.order_to_transfer_to_different_table.uid);table_orders.push(this.order_to_transfer_to_different_table);},clean_table_transfer:function(table){if(this.order_to_transfer_to_different_table&&table){this.order_to_transfer_to_different_table=null;this.set_table(table);}},sync_from_server:function(table,table_orders,order_ids){var self=this;var ids_to_remove=this.db.get_ids_to_remove_from_server();var orders_to_sync=this.db.get_unpaid_orders_to_sync(order_ids);if(orders_to_sync.length){this.set_synch('connecting',orders_to_sync.length);this._save_to_server(orders_to_sync,{'draft':true}).then(function(server_ids){server_ids.forEach(server_id=>self.update_table_order(server_id,table_orders));if(!ids_to_remove.length){self.set_synch('connected');}else{self.remove_from_server_and_set_sync_state(ids_to_remove);}}).catch(function(reason){self.set_synch('error');}).finally(function(){self.clean_table_transfer(table);});}else{if(ids_to_remove.length){self.remove_from_server_and_set_sync_state(ids_to_remove);}
self.clean_table_transfer(table);}},update_table_order:function(server_id,table_orders){const order=table_orders.find(o=>o.name===server_id.pos_reference);if(order){order.server_id=server_id.id;order.save_to_db();}
return order;},set_order_on_table:function(order){var orders=this.get_order_list();if(orders.length){order=order?orders.find((o)=>o.uid===order.uid):null;if(order){this.set_order(order);}else{orders=orders.filter(order=>!order.finalized);if(orders.length){this.set_order(orders[0]);}else{this.add_new_order();}}}else{this.add_new_order();}},sync_to_server:function(table,order){var self=this;var ids_to_remove=this.db.get_ids_to_remove_from_server();this.set_synch('connecting',1);this._get_from_server(table.id).then(function(server_orders){var orders=self.get_order_list();self._replace_orders(orders,server_orders);if(!ids_to_remove.length){self.set_synch('connected');}else{self.remove_from_server_and_set_sync_state(ids_to_remove);}}).catch(function(reason){self.set_synch('error');}).finally(function(){self.set_order_on_table(order);});},_replace_orders:function(orders_to_replace,new_orders){var self=this;orders_to_replace.forEach(function(order){if(order.server_id&&!order.finalized){self.get("orders").remove(order);order.destroy();}});new_orders.forEach(function(server_order){var new_order=new models.Order({},{pos:self,json:server_order});self.get("orders").add(new_order);new_order.save_to_db();});},replace_table_orders_from_server:async function(table){const server_orders=await this._get_from_server(table.id);const orders=this.get_table_orders(table);this._replace_orders(orders,server_orders);},get_order_with_uid:function(){var order_ids=[];this.get_order_list().forEach(function(o){order_ids.push(o.uid);});return order_ids;},set_table:function(table,order){if(!table){this.sync_from_server(table,this.get_order_list(),this.get_order_with_uid());this.set_order(null);this.table=null;}else if(this.order_to_transfer_to_different_table){var order_ids=this.get_order_with_uid();this.transfer_order_to_table(table);this.push_order_for_transfer(order_ids,this.get_order_list());this.sync_from_server(table,this.get_order_list(),order_ids);this.set_order(null);}else{this.table=table;this.sync_to_server(table,order);}
posbus.trigger('table-set');},set_start_order:function(){if(!this.config.iface_floorplan){_super_posmodel.set_start_order.apply(this,arguments);}},add_new_order:function(){if(this.config.iface_floorplan){if(this.table){return _super_posmodel.add_new_order.apply(this,arguments);}else{Gui.showPopup('ConfirmPopup',{title:'Unable to create order',body:'Orders cannot be created when there is no active table in restaurant mode',});return undefined;}}else{return _super_posmodel.add_new_order.apply(this,arguments);}},get_order_list:function(){var orders=_super_posmodel.get_order_list.call(this);if(!(this.config&&this.config.iface_floorplan)){return orders;}else if(!this.table){return[];}else{var t_orders=[];for(var i=0;i<orders.length;i++){if(orders[i].table===this.table){t_orders.push(orders[i]);}}
return t_orders;}},get_table_orders:function(table){var orders=_super_posmodel.get_order_list.call(this);var t_orders=[];for(var i=0;i<orders.length;i++){if(orders[i].table===table){t_orders.push(orders[i]);}}
return t_orders;},get_customer_count:function(table){var orders=this.get_table_orders(table).filter(order=>!order.finalized);var count=0;for(var i=0;i<orders.length;i++){count+=orders[i].get_customer_count();}
return count;},on_removed_order:function(removed_order,index,reason){if(this.config.iface_floorplan){var order_list=this.get_order_list();if(reason==='abandon'){this.db.set_order_to_remove_from_server(removed_order);}
if((reason==='abandon'||removed_order.temporary)&&order_list.length>0){this.set_order(order_list[index]||order_list[order_list.length-1],{silent:true});}else if(order_list.length===0){this.table?this.set_order(null):this.set_table(null);}}else{_super_posmodel.on_removed_order.apply(this,arguments);}},});var _super_paymentline=models.Paymentline.prototype;models.Paymentline=models.Paymentline.extend({canBeAdjusted:function(){if(this.payment_method.payment_terminal){return this.payment_method.payment_terminal.canBeAdjusted(this.cid);}
return!this.payment_method.is_cash_count;},});});;

/* /pos_restaurant/static/src/js/notes.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.notes',function(require){"use strict";var models=require('point_of_sale.models');var _super_orderline=models.Orderline.prototype;models.Orderline=models.Orderline.extend({initialize:function(attr,options){_super_orderline.initialize.call(this,attr,options);this.note=this.note||"";},set_note:function(note){this.note=note;this.trigger('change',this);},get_note:function(note){return this.note;},can_be_merged_with:function(orderline){if(orderline.get_note()!==this.get_note()){return false;}else{return _super_orderline.can_be_merged_with.apply(this,arguments);}},clone:function(){var orderline=_super_orderline.clone.call(this);orderline.note=this.note;return orderline;},export_as_JSON:function(){var json=_super_orderline.export_as_JSON.call(this);json.note=this.note;return json;},init_from_JSON:function(json){_super_orderline.init_from_JSON.apply(this,arguments);this.note=json.note;},});});;

/* /pos_restaurant/static/src/js/payment.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.PaymentInterface',function(require){"use strict";var PaymentInterface=require('point_of_sale.PaymentInterface');PaymentInterface.include({canBeAdjusted(cid){return false;},send_payment_adjust:function(cid){},});});;

/* /pos_restaurant/static/src/js/Resizeable.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.Resizeable',function(require){'use strict';const{useExternalListener}=owl.hooks;const{useListener}=require('web.custom_hooks');const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class Resizeable extends PosComponent{constructor(){super(...arguments);useExternalListener(document,'mousemove',this.resizeN);useExternalListener(document,'mouseup',this.endResizeN);useListener('mousedown','.resize-handle-n',this.startResizeN);useExternalListener(document,'mousemove',this.resizeS);useExternalListener(document,'mouseup',this.endResizeS);useListener('mousedown','.resize-handle-s',this.startResizeS);useExternalListener(document,'mousemove',this.resizeW);useExternalListener(document,'mouseup',this.endResizeW);useListener('mousedown','.resize-handle-w',this.startResizeW);useExternalListener(document,'mousemove',this.resizeE);useExternalListener(document,'mouseup',this.endResizeE);useListener('mousedown','.resize-handle-e',this.startResizeE);useExternalListener(document,'mousemove',this.resizeNW);useExternalListener(document,'mouseup',this.endResizeNW);useListener('mousedown','.resize-handle-nw',this.startResizeNW);useExternalListener(document,'mousemove',this.resizeNE);useExternalListener(document,'mouseup',this.endResizeNE);useListener('mousedown','.resize-handle-ne',this.startResizeNE);useExternalListener(document,'mousemove',this.resizeSW);useExternalListener(document,'mouseup',this.endResizeSW);useListener('mousedown','.resize-handle-sw',this.startResizeSW);useExternalListener(document,'mousemove',this.resizeSE);useExternalListener(document,'mouseup',this.endResizeSE);useListener('mousedown','.resize-handle-se',this.startResizeSE);useExternalListener(document,'touchmove',this.resizeN);useExternalListener(document,'touchend',this.endResizeN);useListener('touchstart','.resize-handle-n',this.startResizeN);useExternalListener(document,'touchmove',this.resizeS);useExternalListener(document,'touchend',this.endResizeS);useListener('touchstart','.resize-handle-s',this.startResizeS);useExternalListener(document,'touchmove',this.resizeW);useExternalListener(document,'touchend',this.endResizeW);useListener('touchstart','.resize-handle-w',this.startResizeW);useExternalListener(document,'touchmove',this.resizeE);useExternalListener(document,'touchend',this.endResizeE);useListener('touchstart','.resize-handle-e',this.startResizeE);useExternalListener(document,'touchmove',this.resizeNW);useExternalListener(document,'touchend',this.endResizeNW);useListener('touchstart','.resize-handle-nw',this.startResizeNW);useExternalListener(document,'touchmove',this.resizeNE);useExternalListener(document,'touchend',this.endResizeNE);useListener('touchstart','.resize-handle-ne',this.startResizeNE);useExternalListener(document,'touchmove',this.resizeSW);useExternalListener(document,'touchend',this.endResizeSW);useListener('touchstart','.resize-handle-sw',this.startResizeSW);useExternalListener(document,'touchmove',this.resizeSE);useExternalListener(document,'touchend',this.endResizeSE);useListener('touchstart','.resize-handle-se',this.startResizeSE);this.size={height:0,width:0};this.loc={top:0,left:0};this.tempSize={};}
mounted(){this.limitArea=this.props.limitArea?document.querySelector(this.props.limitArea):this.el.offsetParent;this.limitAreaBoundingRect=this.limitArea.getBoundingClientRect();if(this.limitArea===this.el.offsetParent){this.limitLeft=0;this.limitTop=0;this.limitRight=this.limitAreaBoundingRect.width;this.limitBottom=this.limitAreaBoundingRect.height;}else{this.limitLeft=-this.el.offsetParent.offsetLeft;this.limitTop=-this.el.offsetParent.offsetTop;this.limitRight=this.limitAreaBoundingRect.width-this.el.offsetParent.offsetLeft;this.limitBottom=this.limitAreaBoundingRect.height-this.el.offsetParent.offsetTop;}
this.limitAreaWidth=this.limitAreaBoundingRect.width;this.limitAreaHeight=this.limitAreaBoundingRect.height;}
startResizeN(event){let realEvent;if(event instanceof CustomEvent){realEvent=event.detail;}else{realEvent=event;}
const{y}=this._getEventLoc(realEvent);this.isResizingN=true;this.startY=y;this.size.height=this.el.offsetHeight;this.loc.top=this.el.offsetTop;event.stopPropagation();}
resizeN(event){if(this.isResizingN){const{y:newY}=this._getEventLoc(event);let dY=newY-this.startY;if(dY<0&&Math.abs(dY)>this.loc.top){dY=-this.loc.top;}else if(dY>0&&dY>this.size.height){dY=this.size.height;}
this.el.style.height=`${this.size.height - dY}px`;this.el.style.top=`${this.loc.top + dY}px`;}}
endResizeN(){if(this.isResizingN&&!this.isResizingE&&!this.isResizingW&&!this.isResizingS){this.isResizingN=false;this._triggerResizeEnd();}}
startResizeS(event){let realEvent;if(event instanceof CustomEvent){realEvent=event.detail;}else{realEvent=event;}
const{y}=this._getEventLoc(realEvent);this.isResizingS=true;this.startY=y;this.size.height=this.el.offsetHeight;this.loc.top=this.el.offsetTop;event.stopPropagation();}
resizeS(event){if(this.isResizingS){const{y:newY}=this._getEventLoc(event);let dY=newY-this.startY;if(dY>0&&dY>this.limitAreaHeight-(this.size.height+this.loc.top)){dY=this.limitAreaHeight-(this.size.height+this.loc.top);}else if(dY<0&&Math.abs(dY)>this.size.height){dY=-this.size.height;}
this.el.style.height=`${this.size.height + dY}px`;}}
endResizeS(){if(!this.isResizingN&&!this.isResizingE&&!this.isResizingW&&this.isResizingS){this.isResizingS=false;this._triggerResizeEnd();}}
startResizeW(event){let realEvent;if(event instanceof CustomEvent){realEvent=event.detail;}else{realEvent=event;}
const{x}=this._getEventLoc(realEvent);this.isResizingW=true;this.startX=x;this.size.width=this.el.offsetWidth;this.loc.left=this.el.offsetLeft;event.stopPropagation();}
resizeW(event){if(this.isResizingW){const{x:newX}=this._getEventLoc(event);let dX=newX-this.startX;if(dX>0&&dX>this.size.width){dX=this.size.width;}else if(dX<0&&Math.abs(dX)>this.loc.left+Math.abs(this.limitLeft)){dX=-this.loc.left+this.limitLeft;}
this.el.style.width=`${this.size.width - dX}px`;this.el.style.left=`${this.loc.left + dX}px`;}}
endResizeW(){if(!this.isResizingN&&!this.isResizingE&&this.isResizingW&&!this.isResizingS){this.isResizingW=false;this._triggerResizeEnd();}}
startResizeE(event){let realEvent;if(event instanceof CustomEvent){realEvent=event.detail;}else{realEvent=event;}
const{x}=this._getEventLoc(realEvent);this.isResizingE=true;this.startX=x;this.size.width=this.el.offsetWidth;this.loc.left=this.el.offsetLeft;event.stopPropagation();}
resizeE(event){if(this.isResizingE){const{x:newX}=this._getEventLoc(event);let dX=newX-this.startX;if(dX>0&&dX>this.limitAreaWidth-
(this.size.width+this.loc.left+Math.abs(this.limitLeft))){dX=this.limitAreaWidth-
(this.size.width+this.loc.left+Math.abs(this.limitLeft));}else if(dX<0&&Math.abs(dX)>this.size.width){dX=-this.size.width;}
this.el.style.width=`${this.size.width + dX}px`;}}
endResizeE(){if(!this.isResizingN&&this.isResizingE&&!this.isResizingW&&!this.isResizingS){this.isResizingE=false;this._triggerResizeEnd();}}
startResizeNW(event){this.startResizeN(event);this.startResizeW(event);}
resizeNW(event){this.resizeN(event);this.resizeW(event);}
endResizeNW(){if(this.isResizingN&&!this.isResizingE&&this.isResizingW&&!this.isResizingS){this.isResizingN=false;this.isResizingW=false;this._triggerResizeEnd();}}
startResizeNE(event){this.startResizeN(event);this.startResizeE(event);}
resizeNE(event){this.resizeN(event);this.resizeE(event);}
endResizeNE(){if(this.isResizingN&&this.isResizingE&&!this.isResizingW&&!this.isResizingS){this.isResizingN=false;this.isResizingE=false;this._triggerResizeEnd();}}
startResizeSE(event){this.startResizeS(event);this.startResizeE(event);}
resizeSE(event){this.resizeS(event);this.resizeE(event);}
endResizeSE(){if(!this.isResizingN&&this.isResizingE&&!this.isResizingW&&this.isResizingS){this.isResizingS=false;this.isResizingE=false;this._triggerResizeEnd();}}
startResizeSW(event){this.startResizeS(event);this.startResizeW(event);}
resizeSW(event){this.resizeS(event);this.resizeW(event);}
endResizeSW(){if(!this.isResizingN&&!this.isResizingE&&this.isResizingW&&this.isResizingS){this.isResizingS=false;this.isResizingW=false;this._triggerResizeEnd();}}
_getEventLoc(event){let coordX,coordY;if(event.touches&&event.touches[0]){coordX=event.touches[0].clientX;coordY=event.touches[0].clientY;}else{coordX=event.clientX;coordY=event.clientY;}
return{x:coordX,y:coordY,};}
_triggerResizeEnd(){const size={height:this.el.offsetHeight,width:this.el.offsetWidth,};const loc={top:this.el.offsetTop,left:this.el.offsetLeft,};this.trigger('resize-end',{size,loc});}}
Resizeable.template='Resizeable';Registries.Component.add(Resizeable);return Resizeable;});;

/* /pos_restaurant/static/src/js/Screens/ProductScreen/ControlButtons/OrderlineNoteButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.OrderlineNoteButton',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const ProductScreen=require('point_of_sale.ProductScreen');const{useListener}=require('web.custom_hooks');const Registries=require('point_of_sale.Registries');class OrderlineNoteButton extends PosComponent{constructor(){super(...arguments);useListener('click',this.onClick);}
get selectedOrderline(){return this.env.pos.get_order().get_selected_orderline();}
async onClick(){if(!this.selectedOrderline)return;const{confirmed,payload:inputNote}=await this.showPopup('TextAreaPopup',{startingValue:this.selectedOrderline.get_note(),title:this.env._t('Add Note'),});if(confirmed){this.selectedOrderline.set_note(inputNote);}}}
OrderlineNoteButton.template='OrderlineNoteButton';ProductScreen.addControlButton({component:OrderlineNoteButton,condition:function(){return this.env.pos.config.module_pos_restaurant;},});Registries.Component.add(OrderlineNoteButton);return OrderlineNoteButton;});;

/* /pos_restaurant/static/src/js/Screens/ProductScreen/ControlButtons/TableGuestsButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.TableGuestsButton',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const ProductScreen=require('point_of_sale.ProductScreen');const{useListener}=require('web.custom_hooks');const Registries=require('point_of_sale.Registries');class TableGuestsButton extends PosComponent{constructor(){super(...arguments);useListener('click',this.onClick);}
get currentOrder(){return this.env.pos.get_order();}
get nGuests(){return this.currentOrder?this.currentOrder.get_customer_count():0;}
async onClick(){const{confirmed,payload:inputNumber}=await this.showPopup('NumberPopup',{startingValue:this.nGuests,cheap:true,title:this.env._t('Guests ?'),});if(confirmed){this.env.pos.get_order().set_customer_count(parseInt(inputNumber,10)||1);}}}
TableGuestsButton.template='TableGuestsButton';ProductScreen.addControlButton({component:TableGuestsButton,condition:function(){return this.env.pos.config.module_pos_restaurant;},});Registries.Component.add(TableGuestsButton);return TableGuestsButton;});;

/* /pos_restaurant/static/src/js/Screens/ProductScreen/ControlButtons/PrintBillButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.PrintBillButton',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const ProductScreen=require('point_of_sale.ProductScreen');const{useListener}=require('web.custom_hooks');const Registries=require('point_of_sale.Registries');class PrintBillButton extends PosComponent{constructor(){super(...arguments);useListener('click',this.onClick);}
async onClick(){const order=this.env.pos.get_order();if(order.get_orderlines().length>0){await this.showTempScreen('BillScreen');}else{await this.showPopup('ErrorPopup',{title:this.env._t('Nothing to Print'),body:this.env._t('There are no order lines'),});}}}
PrintBillButton.template='PrintBillButton';ProductScreen.addControlButton({component:PrintBillButton,condition:function(){return this.env.pos.config.iface_printbill;},});Registries.Component.add(PrintBillButton);return PrintBillButton;});;

/* /pos_restaurant/static/src/js/Screens/ProductScreen/ControlButtons/SubmitOrderButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.SubmitOrderButton',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const ProductScreen=require('point_of_sale.ProductScreen');const{useListener}=require('web.custom_hooks');const Registries=require('point_of_sale.Registries');class SubmitOrderButton extends PosComponent{constructor(){super(...arguments);useListener('click',this.onClick);this._currentOrder=this.env.pos.get_order();this._currentOrder.orderlines.on('change',this.render,this);this.env.pos.on('change:selectedOrder',this._updateCurrentOrder,this);}
willUnmount(){this._currentOrder.orderlines.off('change',null,this);this.env.pos.off('change:selectedOrder',null,this);}
async onClick(){const order=this.env.pos.get_order();if(order.hasChangesToPrint()){const isPrintSuccessful=await order.printChanges();if(isPrintSuccessful){order.saveChanges();}else{await this.showPopup('ErrorPopup',{title:'Printing failed',body:'Failed in printing the changes in the order',});}}}
get addedClasses(){if(!this._currentOrder)return{};const changes=this._currentOrder.hasChangesToPrint();const skipped=changes?false:this._currentOrder.hasSkippedChanges();return{highlight:changes,altlight:skipped,};}
_updateCurrentOrder(pos,newSelectedOrder){this._currentOrder.orderlines.off('change',null,this);if(newSelectedOrder){this._currentOrder=newSelectedOrder;this._currentOrder.orderlines.on('change',this.render,this);}}}
SubmitOrderButton.template='SubmitOrderButton';ProductScreen.addControlButton({component:SubmitOrderButton,condition:function(){return this.env.pos.printers.length;},});Registries.Component.add(SubmitOrderButton);return SubmitOrderButton;});;

/* /pos_restaurant/static/src/js/Screens/ProductScreen/ControlButtons/SplitBillButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.SplitBillButton',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const ProductScreen=require('point_of_sale.ProductScreen');const{useListener}=require('web.custom_hooks');const Registries=require('point_of_sale.Registries');class SplitBillButton extends PosComponent{constructor(){super(...arguments);useListener('click',this.onClick);}
async onClick(){const order=this.env.pos.get_order();if(order.get_orderlines().length>0){this.showScreen('SplitBillScreen');}}}
SplitBillButton.template='SplitBillButton';ProductScreen.addControlButton({component:SplitBillButton,condition:function(){return this.env.pos.config.iface_splitbill;},});Registries.Component.add(SplitBillButton);return SplitBillButton;});;

/* /pos_restaurant/static/src/js/Screens/ProductScreen/ControlButtons/TransferOrderButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.TransferOrderButton',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const ProductScreen=require('point_of_sale.ProductScreen');const{useListener}=require('web.custom_hooks');const Registries=require('point_of_sale.Registries');class TransferOrderButton extends PosComponent{constructor(){super(...arguments);useListener('click',this.onClick);}
onClick(){this.env.pos.transfer_order_to_different_table();}}
TransferOrderButton.template='TransferOrderButton';ProductScreen.addControlButton({component:TransferOrderButton,condition:function(){return this.env.pos.config.iface_floorplan;},});Registries.Component.add(TransferOrderButton);return TransferOrderButton;});;

/* /pos_restaurant/static/src/js/Screens/ProductScreen/Orderline.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.Orderline',function(require){'use strict';const Orderline=require('point_of_sale.Orderline');const Registries=require('point_of_sale.Registries');const PosResOrderline=Orderline=>class extends Orderline{get addedClasses(){const res=super.addedClasses;Object.assign(res,{dirty:this.props.line.mp_dirty,skip:this.props.line.mp_skip,});return res;}
selectLine(){const line=this.props.line;if(this.env.pos.get_order().selected_orderline!==line){this.mp_dbclk_time=new Date().getTime();}else if(!this.mp_dbclk_time){this.mp_dbclk_time=new Date().getTime();}else if(this.mp_dbclk_time+500>new Date().getTime()){line.set_skip(!line.mp_skip);this.mp_dbclk_time=0;}else{this.mp_dbclk_time=new Date().getTime();}
super.selectLine();}};Registries.Component.extend(Orderline,PosResOrderline);return Orderline;});;

/* /pos_restaurant/static/src/js/Screens/BillScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.BillScreen',function(require){'use strict';const ReceiptScreen=require('point_of_sale.ReceiptScreen');const Registries=require('point_of_sale.Registries');const BillScreen=(ReceiptScreen)=>{class BillScreen extends ReceiptScreen{confirm(){this.props.resolve({confirmed:true,payload:null});this.trigger('close-temp-screen');}
whenClosing(){this.confirm();}
async printReceipt(){await super.printReceipt();this.currentOrder._printed=false;}}
BillScreen.template='BillScreen';return BillScreen;};Registries.Component.addByExtending(BillScreen,ReceiptScreen);return BillScreen;});;

/* /pos_restaurant/static/src/js/Screens/SplitBillScreen/SplitBillScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.SplitBillScreen',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const{useState}=owl.hooks;const{useListener}=require('web.custom_hooks');const models=require('point_of_sale.models');const Registries=require('point_of_sale.Registries');class SplitBillScreen extends PosComponent{constructor(){super(...arguments);useListener('click-line',this.onClickLine);this.splitlines=useState(this._initSplitLines(this.env.pos.get_order()));this.newOrderLines={};this.newOrder=new models.Order({},{pos:this.env.pos,temporary:true,});this._isFinal=false;}
mounted(){this.env.pos.on('change:selectedOrder',this._resetState,this);}
willUnmount(){this.env.pos.off('change:selectedOrder',null,this);}
get currentOrder(){return this.env.pos.get_order();}
get orderlines(){return this.currentOrder.get_orderlines();}
onClickLine(event){const line=event.detail;this._splitQuantity(line);this._updateNewOrder(line);}
back(){this.showScreen('ProductScreen');}
proceed(){if(_.isEmpty(this.splitlines))
return;this._isFinal=true;delete this.newOrder.temporary;if(this._isFullPayOrder()){this.showScreen('PaymentScreen');}else{this._setQuantityOnCurrentOrder();this.newOrder.set_screen_data({name:'PaymentScreen'});if(this.newOrder.saveChanges){this.currentOrder.saveChanges();this.newOrder.saveChanges();}
this.newOrder.set_customer_count(1);const newCustomerCount=this.currentOrder.get_customer_count()-1;this.currentOrder.set_customer_count(newCustomerCount||1);this.currentOrder.set_screen_data({name:'ProductScreen'});this.env.pos.get('orders').add(this.newOrder);this.env.pos.set('selectedOrder',this.newOrder);}}
_initSplitLines(order){const splitlines={};for(let line of order.get_orderlines()){splitlines[line.id]={product:line.get_product().id,quantity:0};}
return splitlines;}
_splitQuantity(line){const split=this.splitlines[line.id];let totalQuantity=0;this.env.pos.get_order().get_orderlines().forEach(function(orderLine){if(orderLine.get_product().id===split.product)
totalQuantity+=orderLine.get_quantity();});if(line.get_quantity()>0){if(!line.get_unit().is_pos_groupable){if(split.quantity!==line.get_quantity()){split.quantity=line.get_quantity();}else{split.quantity=0;}}else{if(split.quantity<totalQuantity){split.quantity+=line.get_unit().is_pos_groupable?1:line.get_unit().rounding;if(split.quantity>line.get_quantity()){split.quantity=line.get_quantity();}}else{split.quantity=0;}}}}
_updateNewOrder(line){const split=this.splitlines[line.id];let orderline=this.newOrderLines[line.id];if(split.quantity){if(!orderline){orderline=line.clone();this.newOrder.add_orderline(orderline);this.newOrderLines[line.id]=orderline;}
orderline.set_quantity(split.quantity,'do not recompute unit price');}else if(orderline){this.newOrder.remove_orderline(orderline);this.newOrderLines[line.id]=null;}}
_isFullPayOrder(){let order=this.env.pos.get_order();let full=true;let splitlines=this.splitlines;let groupedLines=_.groupBy(order.get_orderlines(),line=>line.get_product().id);Object.keys(groupedLines).forEach(function(lineId){var maxQuantity=groupedLines[lineId].reduce(((quantity,line)=>quantity+line.get_quantity()),0);Object.keys(splitlines).forEach(id=>{let split=splitlines[id];if(split.product===groupedLines[lineId][0].get_product().id)
maxQuantity-=split.quantity;});if(maxQuantity!==0)
full=false;});return full;}
_setQuantityOnCurrentOrder(){let order=this.env.pos.get_order();for(var id in this.splitlines){var split=this.splitlines[id];var line=this.currentOrder.get_orderline(parseInt(id));if(!this.props.disallow){line.set_quantity(line.get_quantity()-split.quantity,'do not recompute unit price');if(Math.abs(line.get_quantity())<0.00001){this.currentOrder.remove_orderline(line);}}else{if(split.quantity){let decreaseLine=line.clone();decreaseLine.order=order;decreaseLine.noDecrease=true;decreaseLine.set_quantity(-split.quantity);order.add_orderline(decreaseLine);}}}}
_resetState(){if(this._isFinal)return;for(let id in this.splitlines){delete this.splitlines[id];}
for(let line of this.currentOrder.get_orderlines()){this.splitlines[line.id]={quantity:0};}
this.newOrder.orderlines.reset();}}
SplitBillScreen.template='SplitBillScreen';Registries.Component.add(SplitBillScreen);return SplitBillScreen;});;

/* /pos_restaurant/static/src/js/Screens/SplitBillScreen/SplitOrderline.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.SplitOrderline',function(require){'use strict';const{useListener}=require('web.custom_hooks');const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class SplitOrderline extends PosComponent{constructor(){super(...arguments);useListener('click',this.onClick);}
get isSelected(){return this.props.split.quantity!==0;}
onClick(){this.trigger('click-line',this.props.line);}}
SplitOrderline.template='SplitOrderline';Registries.Component.add(SplitOrderline);return SplitOrderline;});;

/* /pos_restaurant/static/src/js/Screens/FloorScreen/FloorScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.FloorScreen',function(require){'use strict';const{debounce}=owl.utils;const PosComponent=require('point_of_sale.PosComponent');const{useState,useRef}=owl.hooks;const{useListener}=require('web.custom_hooks');const Registries=require('point_of_sale.Registries');class FloorScreen extends PosComponent{constructor(){super(...arguments);this._setTableColor=debounce(this._setTableColor,70);this._setFloorColor=debounce(this._setFloorColor,70);useListener('select-table',this._onSelectTable);useListener('deselect-table',this._onDeselectTable);useListener('save-table',this._onSaveTable);useListener('create-table',this._createTable);useListener('duplicate-table',this._duplicateTable);useListener('rename-table',this._renameTable);useListener('change-seats-num',this._changeSeatsNum);useListener('change-shape',this._changeShape);useListener('set-table-color',this._setTableColor);useListener('set-floor-color',this._setFloorColor);useListener('delete-table',this._deleteTable);const floor=this.props.floor?this.props.floor:this.env.pos.floors[0];this.state=useState({selectedFloorId:floor.id,selectedTableId:null,isEditMode:false,floorBackground:floor.background_color,floorMapScrollTop:0,});this.floorMapRef=useRef('floor-map-ref');}
patched(){this.floorMapRef.el.style.background=this.state.floorBackground;this.state.floorMapScrollTop=this.floorMapRef.el.getBoundingClientRect().top;}
mounted(){if(this.env.pos.table){this.env.pos.set_table(null);}
this.floorMapRef.el.style.background=this.state.floorBackground;this.state.floorMapScrollTop=this.floorMapRef.el.getBoundingClientRect().top;this._tableLongpolling();this.tableLongpolling=setInterval(this._tableLongpolling.bind(this),5000);}
willUnmount(){clearInterval(this.tableLongpolling);}
get activeFloor(){return this.env.pos.floors_by_id[this.state.selectedFloorId];}
get activeTables(){return this.activeFloor.tables;}
get isFloorEmpty(){return this.activeTables.length===0;}
get selectedTable(){return this.state.selectedTableId!==null?this.env.pos.tables_by_id[this.state.selectedTableId]:false;}
selectFloor(floor){this.state.selectedFloorId=floor.id;this.state.floorBackground=this.activeFloor.background_color;this.state.isEditMode=false;this.state.selectedTableId=null;}
toggleEditMode(){this.state.isEditMode=!this.state.isEditMode;this.state.selectedTableId=null;}
async _createTable(){const newTable=await this._createTableHelper();if(newTable){this.state.selectedTableId=newTable.id;}}
async _duplicateTable(){if(!this.selectedTable)return;const newTable=await this._createTableHelper(this.selectedTable);if(newTable){this.state.selectedTableId=newTable.id;}}
async _changeSeatsNum(){const selectedTable=this.selectedTable
if(!selectedTable)return;const{confirmed,payload:inputNumber}=await this.showPopup('NumberPopup',{startingValue:selectedTable.seats,cheap:true,title:this.env._t('Number of Seats ?'),});if(!confirmed)return;const newSeatsNum=parseInt(inputNumber,10)||selectedTable.seats;if(newSeatsNum!==selectedTable.seats){selectedTable.seats=newSeatsNum;await this._save(selectedTable);}}
async _changeShape(){if(!this.selectedTable)return;this.selectedTable.shape=this.selectedTable.shape==='square'?'round':'square';this.render();await this._save(this.selectedTable);}
async _renameTable(){const selectedTable=this.selectedTable;if(!selectedTable)return;const{confirmed,payload:newName}=await this.showPopup('TextInputPopup',{startingValue:selectedTable.name,title:this.env._t('Table Name ?'),});if(!confirmed)return;if(newName!==selectedTable.name){selectedTable.name=newName;await this._save(selectedTable);}}
async _setTableColor({detail:color}){this.selectedTable.color=color;this.render();await this._save(this.selectedTable);}
async _setFloorColor({detail:color}){this.state.floorBackground=color;this.activeFloor.background_color=color;try{await this.rpc({model:'restaurant.floor',method:'write',args:[[this.activeFloor.id],{background_color:color}],});}catch(error){if(error.message.code<0){await this.showPopup('OfflineErrorPopup',{title:this.env._t('Offline'),body:this.env._t('Unable to change background color'),});}else{throw error;}}}
async _deleteTable(){if(!this.selectedTable)return;const{confirmed}=await this.showPopup('ConfirmPopup',{title:this.env._t('Are you sure ?'),body:this.env._t('Removing a table cannot be undone'),});if(!confirmed)return;try{const originalSelectedTableId=this.state.selectedTableId;await this.rpc({model:'restaurant.table',method:'create_from_ui',args:[{active:false,id:originalSelectedTableId}],});this.activeFloor.tables=this.activeTables.filter((table)=>table.id!==originalSelectedTableId);if(this.state.selectedTableId===originalSelectedTableId){this.state.selectedTableId=null;}}catch(error){if(error.message.code<0){await this.showPopup('OfflineErrorPopup',{title:this.env._t('Offline'),body:this.env._t('Unable to delete table'),});}else{throw error;}}}
_onSelectTable(event){const table=event.detail;if(this.state.isEditMode){this.state.selectedTableId=table.id;}else{this.env.pos.set_table(table);}}
_onDeselectTable(){this.state.selectedTableId=null;}
async _createTableHelper(copyTable){let newTable;if(copyTable){newTable=Object.assign({},copyTable);newTable.position_h+=10;newTable.position_v+=10;}else{newTable={position_v:100,position_h:100,width:75,height:75,shape:'square',seats:1,};}
newTable.name=this._getNewTableName(newTable.name);delete newTable.id;newTable.floor_id=[this.activeFloor.id,''];newTable.floor=this.activeFloor;try{await this._save(newTable);this.activeTables.push(newTable);return newTable;}catch(error){if(error.message.code<0){await this.showPopup('ErrorPopup',{title:this.env._t('Offline'),body:this.env._t('Unable to create table because you are offline.'),});return;}else{throw error;}}}
_getNewTableName(name){if(name){const num=Number((name.match(/\d+/g)||[])[0]||0);const str=name.replace(/\d+/g,'');const n={num:num,str:str};n.num+=1;this._lastName=n;}else if(this._lastName){this._lastName.num+=1;}else{this._lastName={num:1,str:'T'};}
return''+this._lastName.str+this._lastName.num;}
async _save(table){const fields=this.env.pos.models.find((model)=>model.model==='restaurant.table').fields;const serializeTable={};for(let field of fields){if(typeof table[field]!=='undefined'){serializeTable[field]=table[field];}}
serializeTable.id=table.id;const tableId=await this.rpc({model:'restaurant.table',method:'create_from_ui',args:[serializeTable],});table.id=tableId;this.env.pos.tables_by_id[tableId]=table;}
async _onSaveTable(event){const table=event.detail;await this._save(table);}
async _tableLongpolling(){if(this.state.isEditMode){return;}
try{const result=await this.rpc({model:'pos.config',method:'get_tables_order_count',args:[this.env.pos.config.id],});result.forEach((table)=>{const table_obj=this.env.pos.tables_by_id[table.id];const unsynced_orders=this.env.pos.get_table_orders(table_obj).filter((o)=>o.server_id===undefined&&(o.orderlines.length!==0||o.paymentlines.length!==0)&&!o.finalized).length;table_obj.order_count=table.orders+unsynced_orders;});this.render();}catch(error){if(error.message.code<0){await this.showPopup('OfflineErrorPopup',{title:'Offline',body:'Unable to get orders count',});}else{throw error;}}}}
FloorScreen.template='FloorScreen';FloorScreen.hideOrderSelector=true;Registries.Component.add(FloorScreen);return FloorScreen;});;

/* /pos_restaurant/static/src/js/Screens/FloorScreen/EditBar.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.EditBar',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');const{useState}=owl.hooks;class EditBar extends PosComponent{constructor(){super(...arguments);this.state=useState({isColorPicker:false})}}
EditBar.template='EditBar';Registries.Component.add(EditBar);return EditBar;});;

/* /pos_restaurant/static/src/js/Screens/FloorScreen/TableWidget.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.TableWidget',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class TableWidget extends PosComponent{mounted(){const table=this.props.table;function unit(val){return`${val}px`;}
const style={width:unit(table.width),height:unit(table.height),'line-height':unit(table.height),top:unit(table.position_v),left:unit(table.position_h),'border-radius':table.shape==='round'?unit(1000):'3px',};if(table.color){style.background=table.color;}
if(table.height>=150&&table.width>=150){style['font-size']='32px';}
Object.assign(this.el.style,style);const tableCover=this.el.querySelector('.table-cover');Object.assign(tableCover.style,{height:`${Math.ceil(this.fill * 100)}%`});}
get fill(){const customerCount=this.env.pos.get_customer_count(this.props.table);return Math.min(1,Math.max(0,customerCount/this.props.table.seats));}
get orderCount(){const table=this.props.table;return table.order_count!==undefined?table.order_count:this.env.pos.get_table_orders(table).filter(o=>o.orderlines.length!==0||o.paymentlines.length!==0).length;}
get orderCountClass(){const notifications=this._getNotifications();return{'order-count':true,'notify-printing':notifications.printing,'notify-skipped':notifications.skipped,};}
_getNotifications(){const orders=this.env.pos.get_table_orders(this.props.table);let hasChangesCount=0;let hasSkippedCount=0;for(let i=0;i<orders.length;i++){if(orders[i].hasChangesToPrint()){hasChangesCount++;}else if(orders[i].hasSkippedChanges()){hasSkippedCount++;}}
return hasChangesCount?{printing:true}:hasSkippedCount?{skipped:true}:{};}}
TableWidget.template='TableWidget';Registries.Component.add(TableWidget);return TableWidget;});;

/* /pos_restaurant/static/src/js/Screens/FloorScreen/EditableTable.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.EditableTable',function(require){'use strict';const{onPatched,onMounted}=owl.hooks;const{useListener}=require('web.custom_hooks');const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');class EditableTable extends PosComponent{constructor(){super(...arguments);useListener('resize-end',this._onResizeEnd);useListener('drag-end',this._onDragEnd);onPatched(this._setElementStyle.bind(this));onMounted(this._setElementStyle.bind(this));}
_setElementStyle(){const table=this.props.table;function unit(val){return`${val}px`;}
const style={width:unit(table.width),height:unit(table.height),'line-height':unit(table.height),top:unit(table.position_v),left:unit(table.position_h),'border-radius':table.shape==='round'?unit(1000):'3px',};if(table.color){style.background=table.color;}
if(table.height>=150&&table.width>=150){style['font-size']='32px';}
Object.assign(this.el.style,style);}
_onResizeEnd(event){const{size,loc}=event.detail;const table=this.props.table;table.width=size.width;table.height=size.height;table.position_v=loc.top;table.position_h=loc.left;this.trigger('save-table',this.props.table);}
_onDragEnd(event){const{loc}=event.detail;const table=this.props.table;table.position_v=loc.top;table.position_h=loc.left;this.trigger('save-table',this.props.table);}}
EditableTable.template='EditableTable';Registries.Component.add(EditableTable);return EditableTable;});;

/* /pos_restaurant/static/src/js/Screens/OrderManagementScreen/OrderManagementScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.OrderManagementScreen',function(require){'use strict';const OrderManagementScreen=require('point_of_sale.OrderManagementScreen');const Registries=require('point_of_sale.Registries');const PosResOrderManagementScreen=(OrderManagementScreen)=>class extends OrderManagementScreen{_setOrder(order){if(this.env.pos.config.module_pos_restaurant){const currentOrder=this.env.pos.get_order();this.env.pos.set_table(order.table,order);if(currentOrder&&currentOrder.uid===order.uid){this.close();}}else{super._setOrder(order);}}};Registries.Component.extend(OrderManagementScreen,PosResOrderManagementScreen);return OrderManagementScreen;});;

/* /pos_restaurant/static/src/js/Screens/OrderManagementScreen/OrderRow.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.OrderRow',function(require){'use strict';const OrderRow=require('point_of_sale.OrderRow');const Registries=require('point_of_sale.Registries');const PosResOrderRow=(OrderRow)=>class extends OrderRow{get table(){return this.order.table?this.order.table.name:'';}};Registries.Component.extend(OrderRow,PosResOrderRow);return OrderRow;});;

/* /pos_restaurant/static/src/js/Screens/TicketScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.TicketScreen',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const TicketScreen=require('point_of_sale.TicketScreen');const Registries=require('point_of_sale.Registries');const{useAutofocus}=require('web.custom_hooks');const{posbus}=require('point_of_sale.utils');const{parse}=require('web.field_utils');const{useState,useContext}=owl.hooks;const PosResTicketScreen=(TicketScreen)=>class extends TicketScreen{close(){super.close();if(!this.env.pos.config.iface_floorplan){posbus.trigger('table-set');}}
get filterOptions(){const{Payment,Open,Tipping}=this.getOrderStates();var filterOptions=super.filterOptions;if(this.env.pos.config.set_tip_after_payment){var idx=filterOptions.indexOf(Payment);filterOptions[idx]=Open;}
return[...filterOptions,Tipping];}
get _screenToStatusMap(){const{Open,Tipping}=this.getOrderStates();return Object.assign(super._screenToStatusMap,{PaymentScreen:this.env.pos.config.set_tip_after_payment?Open:super._screenToStatusMap.PaymentScreen,TipScreen:Tipping,});}
getTable(order){return`${order.table.floor.name} (${order.table.name})`;}
get _searchFields(){if(!this.env.pos.config.iface_floorplan){return super._searchFields;}
return Object.assign({},super._searchFields,{Table:(order)=>`${order.table.floor.name} (${order.table.name})`,});}
_setOrder(order){if(!this.env.pos.config.iface_floorplan){super._setOrder(order);}else if(order!==this.env.pos.get_order()){this.env.pos.set_table(order.table,order);}}
get showNewTicketButton(){return this.env.pos.config.iface_floorplan?Boolean(this.env.pos.table):super.showNewTicketButton;}
get orderList(){if(this.env.pos.table){return super.orderList;}else{return this.env.pos.get('orders').models;}}
async settleTips(){for(const order of this.filteredOrderList){const tipAmount=parse.float(order.uiState.TipScreen.state.inputTipAmount||'0');const serverId=this.env.pos.validated_orders_name_server_id_map[order.name];if(!serverId){console.warn(`${order.name} is not yet sync. Sync it to server before setting a tip.`);}else{const result=await this.setTip(order,serverId,tipAmount);if(!result)break;}}}
async setTip(order,serverId,amount){try{const paymentline=order.get_paymentlines()[0];if(paymentline.payment_method.payment_terminal){paymentline.amount+=amount;this.env.pos.set_order(order,{silent:true});await paymentline.payment_method.payment_terminal.send_payment_adjust(paymentline.cid);}
if(!amount){await this.setNoTip();}else{order.finalized=false;order.set_tip(amount);order.finalized=true;const tip_line=order.selected_orderline;await this.rpc({method:'set_tip',model:'pos.order',args:[serverId,tip_line.export_as_JSON()],});}
order.finalize();return true;}catch(error){const{confirmed}=await this.showPopup('ConfirmPopup',{title:'Failed to set tip',body:`Failed to set tip to ${order.name}. Do you want to proceed on setting the tips of the remaining?`,});return confirmed;}}
async setNoTip(){await this.rpc({method:'set_no_tip',model:'pos.order',args:[serverId],});}
getOrderStates(){return Object.assign(super.getOrderStates(),{Tipping:this.env._t('Tipping'),Open:this.env._t('Open'),});}};Registries.Component.extend(TicketScreen,PosResTicketScreen);class TipCell extends PosComponent{constructor(){super(...arguments);this.state=useState({isEditing:false});this.orderUiState=useContext(this.props.order.uiState.TipScreen);useAutofocus({selector:'input'});}
get tipAmountStr(){return this.env.pos.format_currency(parse.float(this.orderUiState.inputTipAmount||'0'));}
onBlur(){this.state.isEditing=false;}
onKeydown(event){if(event.key==='Enter'){this.state.isEditing=false;}}
editTip(){this.state.isEditing=true;}}
TipCell.template='TipCell';Registries.Component.add(TipCell);return{TicketScreen,TipCell};});;

/* /pos_restaurant/static/src/js/ChromeWidgets/BackToFloorButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.BackToFloorButton',function(require){'use strict';const PosComponent=require('point_of_sale.PosComponent');const Registries=require('point_of_sale.Registries');const{posbus}=require('point_of_sale.utils');class BackToFloorButton extends PosComponent{mounted(){posbus.on('table-set',this,this.render);}
willUnmount(){posbus.on('table-set',this);}
get table(){return(this.env.pos&&this.env.pos.table)||null;}
get floor(){const table=this.table;return table?table.floor:null;}
get hasTable(){return this.table!==null;}
backToFloorScreen(){this.showScreen('FloorScreen',{floor:this.floor});}}
BackToFloorButton.template='BackToFloorButton';Registries.Component.add(BackToFloorButton);return BackToFloorButton;});;

/* /pos_restaurant/static/src/js/ChromeWidgets/TicketButton.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.TicketButton',function(require){'use strict';const TicketButton=require('point_of_sale.TicketButton');const Registries=require('point_of_sale.Registries');const{posbus}=require('point_of_sale.utils');const PosResTicketButton=(TicketButton)=>class extends TicketButton{async onClick(){if(this.env.pos.config.iface_floorplan&&!this.props.isTicketScreenShown&&!this.env.pos.table){await this._syncAllFromServer();this.showScreen('TicketScreen');}else{super.onClick();}}
async _syncAllFromServer(){const pos=this.env.pos;try{for(const floor of pos.floors){for(const table of floor.tables){await pos.replace_table_orders_from_server(table);}}}catch(e){await this.showPopup('ErrorPopup',{title:this.env._t('Connection Error'),body:this.env._t('Due to a connection error, the orders are not synchronized.'),});}}
mounted(){posbus.on('table-set',this,this.render);}
willUnmount(){posbus.off('table-set',this);}
get count(){if(!this.env.pos||!this.env.pos.config)return 0;if(this.env.pos.config.iface_floorplan&&!this.env.pos.table){return this.env.pos.get('orders').models.length;}else{return super.count;}}};Registries.Component.extend(TicketButton,PosResTicketButton);return TicketButton;});;

/* /pos_restaurant/static/src/js/Chrome.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.chrome',function(require){'use strict';const Chrome=require('point_of_sale.Chrome');const Registries=require('point_of_sale.Registries');const NON_IDLE_EVENTS='mousemove mousedown touchstart touchend touchmove click scroll keypress'.split(/\s+/);let IDLE_TIMER_SETTER;const PosResChrome=(Chrome)=>class extends Chrome{async start(){await super.start();if(this.env.pos.config.iface_floorplan){this._setActivityListeners();}}
_setScreenData(name){if(name==='FloorScreen')return;super._setScreenData(...arguments);}
get startScreen(){if(this.env.pos.config.iface_floorplan){const table=this.env.pos.table;return{name:'FloorScreen',props:{floor:table?table.floor:null}};}else{return super.startScreen;}}
_showSavedScreen(pos,newSelectedOrder){if(!newSelectedOrder){this.showScreen('FloorScreen',{floor:pos.table?pos.table.floor:null});}else{super._showSavedScreen(pos,newSelectedOrder);}}
_setActivityListeners(){IDLE_TIMER_SETTER=this._setIdleTimer.bind(this);for(const event of NON_IDLE_EVENTS){window.addEventListener(event,IDLE_TIMER_SETTER);}}
_setIdleTimer(){if(this._shouldResetIdleTimer()){clearTimeout(this.idleTimer);this.idleTimer=setTimeout(()=>{this._actionAfterIdle();},60000);}}
_actionAfterIdle(){if(this.tempScreen.isShown){this.trigger('close-temp-screen');}
const table=this.env.pos.table;this.showScreen('FloorScreen',{floor:table?table.floor:null});}
_shouldResetIdleTimer(){return this.env.pos.config.iface_floorplan&&this.mainScreen.name!=='FloorScreen';}
__showScreen(){super.__showScreen(...arguments);this._setIdleTimer();}
async _closePos(){if(IDLE_TIMER_SETTER){for(const event of NON_IDLE_EVENTS){window.removeEventListener(event,IDLE_TIMER_SETTER);}}
await super._closePos();}};Registries.Component.extend(Chrome,PosResChrome);return Chrome;});;

/* /pos_restaurant/static/src/js/Screens/ReceiptScreen/ReceiptScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.ReceiptScreen',function(require){'use strict';const ReceiptScreen=require('point_of_sale.ReceiptScreen');const Registries=require('point_of_sale.Registries');const PosResReceiptScreen=ReceiptScreen=>class extends ReceiptScreen{get nextScreen(){if(this.env.pos.config.module_pos_restaurant&&this.env.pos.config.iface_floorplan){const table=this.env.pos.table;return{name:'FloorScreen',props:{floor:table?table.floor:null}};}else{return super.nextScreen;}}};Registries.Component.extend(ReceiptScreen,PosResReceiptScreen);return ReceiptScreen;});;

/* /pos_restaurant/static/src/js/Screens/PaymentScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.PosResPaymentScreen',function(require){'use strict';const PaymentScreen=require('point_of_sale.PaymentScreen');const{useListener}=require('web.custom_hooks');const Registries=require('point_of_sale.Registries');const PosResPaymentScreen=(PaymentScreen)=>class extends PaymentScreen{constructor(){super(...arguments);useListener('send-payment-adjust',this._sendPaymentAdjust);}
async _sendPaymentAdjust({detail:line}){const previous_amount=line.get_amount();const amount_diff=line.order.get_total_with_tax()-line.order.get_total_paid();line.set_amount(previous_amount+amount_diff);line.set_payment_status('waiting');const payment_terminal=line.payment_method.payment_terminal;const isAdjustSuccessful=await payment_terminal.send_payment_adjust(line.cid);if(isAdjustSuccessful){line.set_payment_status('done');}else{line.set_amount(previous_amount);line.set_payment_status('done');}}
get nextScreen(){const order=this.currentOrder;if(!this.env.pos.config.set_tip_after_payment||order.is_tipped){return super.nextScreen;}
const mainPayment=order.get_paymentlines()[0];if(mainPayment.canBeAdjusted()){return'TipScreen';}
return super.nextScreen;}};Registries.Component.extend(PaymentScreen,PosResPaymentScreen);return PosResPaymentScreen;});;

/* /pos_restaurant/static/src/js/Screens/TipScreen.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_restaurant.TipScreen',function(require){'use strict';const Registries=require('point_of_sale.Registries');const PosComponent=require('point_of_sale.PosComponent');const{parse}=require('web.field_utils');const{useContext}=owl.hooks;class TipScreen extends PosComponent{constructor(){super(...arguments);this.state=useContext(this.currentOrder.uiState.TipScreen);this._totalAmount=this.currentOrder.get_total_with_tax();}
mounted(){this.printTipReceipt();}
get overallAmountStr(){const tipAmount=parse.float(this.state.inputTipAmount||'0');const original=this.env.pos.format_currency(this.totalAmount);const tip=this.env.pos.format_currency(tipAmount);const overall=this.env.pos.format_currency(this.totalAmount+tipAmount);return`${original} + ${tip} tip = ${overall}`;}
get totalAmount(){return this._totalAmount;}
get currentOrder(){return this.env.pos.get_order();}
get percentageTips(){return[{percentage:'15%',amount:0.15*this.totalAmount},{percentage:'20%',amount:0.2*this.totalAmount},{percentage:'25%',amount:0.25*this.totalAmount},];}
async validateTip(){const amount=parse.float(this.state.inputTipAmount)||0;const order=this.env.pos.get_order();const serverId=this.env.pos.validated_orders_name_server_id_map[order.name];if(!serverId){this.showPopup('ErrorPopup',{title:'Unsynced order',body:'This order is not yet synced to server. Make sure it is synced then try again.',});return;}
if(!amount){await this.rpc({method:'set_no_tip',model:'pos.order',args:[serverId],});this.goNextScreen();return;}
if(amount>0.25*this.totalAmount){const{confirmed}=await this.showPopup('ConfirmPopup',{title:'Are you sure?',body:`${this.env.pos.format_currency(
                        amount
                    )} is more than 25% of the order's total amount. Are you sure of this tip amount?`,});if(!confirmed)return;}
order.finalized=false;order.set_tip(amount);order.finalized=true;const paymentline=this.env.pos.get_order().get_paymentlines()[0];if(paymentline.payment_method.payment_terminal){paymentline.amount+=amount;await paymentline.payment_method.payment_terminal.send_payment_adjust(paymentline.cid);}
const tip_line=order.selected_orderline;await this.rpc({method:'set_tip',model:'pos.order',args:[serverId,tip_line.export_as_JSON()],});this.goNextScreen();}
goNextScreen(){this.env.pos.get_order().finalize();const{name,props}=this.nextScreen;this.showScreen(name,props);}
get nextScreen(){if(this.env.pos.config.module_pos_restaurant&&this.env.pos.config.iface_floorplan){const table=this.env.pos.table;return{name:'FloorScreen',props:{floor:table?table.floor:null}};}else{return{name:'ProductScreen'};}}
async printTipReceipt(){const receipts=[this.currentOrder.selected_paymentline.ticket,this.currentOrder.selected_paymentline.cashier_receipt];for(let i=0;i<receipts.length;i++){const data=receipts[i];var receipt=this.env.qweb.renderToString('TipReceipt',{receipt:this.currentOrder.getOrderReceiptEnv().receipt,data:data,total:this.env.pos.format_currency(this.totalAmount),});if(this.env.pos.proxy.printer){await this._printIoT(receipt);}else{await this._printWeb(receipt);}}}
async _printIoT(receipt){const printResult=await this.env.pos.proxy.printer.print_receipt(receipt);if(!printResult.successful){await this.showPopup('ErrorPopup',{title:printResult.message.title,body:printResult.message.body,});}}
async _printWeb(receipt){try{$(this.el).find('.pos-receipt-container').html(receipt);window.print();}catch(err){await this.showPopup('ErrorPopup',{title:this.env._t('Printing is not supported on some browsers'),body:this.env._t('Printing is not supported on some browsers due to no default printing protocol '+'is available. It is possible to print your tickets by making use of an IoT Box.'),});}}}
TipScreen.template='pos_restaurant.TipScreen';Registries.Component.add(TipScreen);return TipScreen;});;

/* /pos_epson_printer_restaurant/static/src/js/multiprint.js defined in bundle 'point_of_sale.assets' */
odoo.define('pos_epson_printer_restaurant.multiprint',function(require){"use strict";var models=require('point_of_sale.models');var EpsonPrinter=require('pos_epson_printer.Printer');require('pos_restaurant.multiprint');models.load_fields("restaurant.printer",["epson_printer_ip"]);var _super_posmodel=models.PosModel.prototype;models.PosModel=models.PosModel.extend({create_printer:function(config){if(config.printer_type==="epson_epos"){return new EpsonPrinter(config.epson_printer_ip,posmodel);}else{return _super_posmodel.create_printer.apply(this,arguments);}},});});